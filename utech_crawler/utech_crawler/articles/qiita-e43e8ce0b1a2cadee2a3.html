<!DOCTYPE html><html xmlns:og="http://ogp.me/ns#"><head><meta charset="UTF-8" /><title>VAXによる機械語入門 - Qiita</title><meta content="width=device-width,initial-scale=1" name="viewport" /><meta content="VAXとはPDP-11の後継となる32bitマシンです。UNIX V7をVAXに移植したUNIX/32Vがあります。バイナリを通してUNIXを学習します。

この記事は以前開催していた池袋バイナリ勉強会の初回編で教えていた内容をVAX向けに書き直したものです。

この記事には姉妹編があります。



PDP-11による機械語入門 2015.11.08

8086による機械語入門 2015.11.09



環境設定

UNIX/32Vのバイナリを動かすためのインタプリタ..." name="description" /><meta content="summary" name="twitter:card" /><meta content="@Qiita" name="twitter:site" /><meta content="7shi" name="twitter:creator" /><meta content="VAXによる機械語入門 - Qiita" property="og:title" /><meta content="article" property="og:type" /><meta content="http://qiita.com/7shi/items/e43e8ce0b1a2cadee2a3" property="og:url" /><meta content="http://cdn.qiita.com/assets/qiita-fb-2887e7b4aad86fd8c25cea84846f2236.png" property="og:image" /><meta content="VAXとはPDP-11の後継となる32bitマシンです。UNIX V7をVAXに移植したUNIX/32Vがあります。バイナリを通してUNIXを学習します。

この記事は以前開催していた[池袋バイナリ勉強会](http://connpa..." property="og:description" /><meta content="Qiita" property="og:site_name" /><meta content="564524038" property="fb:admins" /><link rel="shortcut icon" type="image/x-icon" href="http://cdn.qiita.com/assets/favicons/public/production-4ff10c1e1e2b5fcb353ff9cafdd56c70.ico" /><link rel="apple-touch-icon" type="image/png" href="http://cdn.qiita.com/assets/favicons/public/apple-touch-icon-f9a6afad761ec2306e10db2736187c8b.png" /><link href="/opensearch.xml" rel="search" title="Qiita" type="application/opensearchdescription+xml" /><link rel="stylesheet" media="all" href="http://cdn.qiita.com/assets/public-e8d29e8ff1879118096f0f5877946857.min.css" /><meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="jx6B/AfttJ50abO8qIucpNtfIRjrWR0DGQ7/GwCJjzPhnBqknMON1Yu6BqDYfiL9uxgFq3ydR/Ql0Pbg4YeB9Q==" /></head><body class="without-js" id=""><noscript><iframe height="0" src="//www.googletagmanager.com/ns.html?id=GTM-TBQWPN" style="display:none;visibility:hidden" width="0"></iframe></noscript><script>
  document.body.className = document.body.className.replace('without-js', '') + ' with-js';
  window.Qiita = {"asset_host":"cdn.qiita.com","TLD":"com","controller_path":"public/items","controller_action":"public/items#show","controller":"items","action":"show","env":"production","flash":{},"is_landing_page":false,"is_team_page":false,"root_domain":"qiita.com","variant":null,"config":{"mixpanel":{"career":"dd35af27e959781713d63fd7ca898a8d","per_team":"c0a2116368b33b44b5029ebd2cc9b094","public":"be87616606b0e26a87689099aab2c4e5","team":"b7c0342acba2dbc8742484d98788efb3"},"default_locale":"ja","locale":"en"},"team":null,"user":null,"GIT_BRANCH":null,"DEBUG":false};

</script>
<div class="headerContainer headerContainer-public" role="navigation"><div data-react-class="T.HeaderContainer" data-react-props="{&quot;user&quot;:null,&quot;team&quot;:null,&quot;news&quot;:{&quot;type&quot;:&quot;Hot&quot;,&quot;content&quot;:&quot;Markdownによる情報共有サービス、Qiita:Team&quot;,&quot;url&quot;:&quot;https://teams.qiita.com?utm_source=qiita\u0026utm_medium=header_news&quot;},&quot;initial_unread_count&quot;:null,&quot;siteid_image&quot;:&quot;http://cdn.qiita.com/siteid-reverse.png&quot;,&quot;is_team_page&quot;:false,&quot;on_team_setting&quot;:false,&quot;show_post_menu&quot;:true,&quot;show_search_menu&quot;:true,&quot;is_fluid&quot;:false,&quot;locale&quot;:&quot;en&quot;}"></div></div><div id="main"><ol class="itemBreadcrumbs" itemscope="" itemtype="http://schema.org/BreadcrumbList"><li itemprop="itemListElement" itemscope="" itemtype="http://schema.org/ListItem"><a itemprop="item" href="/"><span itemprop="name">Qiita</span></a><meta content="1" itemprop="position" /></li><li itemprop="itemListElement" itemscope="" itemtype="http://schema.org/ListItem"><a itemprop="item" href="/items"><span itemprop="name">Items</span></a><meta content="2" itemprop="position" /></li><li itemprop="itemListElement" itemscope="" itemtype="http://schema.org/ListItem"><a itemprop="item" href="/tags/VAX"><span itemprop="name">VAX</span></a><meta content="3" itemprop="position" /></li></ol><article itemscope="" itemtype="http://schema.org/Article"><div class="ArticleMainHeader "><div class="container"></div><div class="container"><div class="row s-flex-align-center"><div class="col-sm-9"><h1 class="ArticleMainHeader__title">VAXによる機械語入門</h1><ul class="TagList"><li class="TagList__item" data-count="4"><a class="u-link-unstyled TagList__label" href="/tags/VAX"><img alt="VAX" class="TagList__icon" src="//cdn.qiita.com/assets/icons/medium/missing-2e17009a0b32a6423572b0e6dc56727e.png" /><span>VAX</span></a></li></ul></div><div class="col-sm-3"><div class="itemsShowHeaderStock"><ul class="list-unstyled itemsShowHeaderStock_statusList"><li><div class="itemsShowHeaderStock_count stock"><span class="fa fa-thumbs-up"></span><span class="js-likecount">7</span></div><div class="itemsShowHeaderStock_countText">Like</div></li><li><div class="itemsShowHeaderStock_count" content="0 UserComments" itemprop="interactionCount"><span class="fa fa-comment"></span>0</div><div class="itemsShowHeaderStock_countText">Comment</div></li></ul></div><div class="js-likebutton" data-props="{&quot;like_status&quot;:false,&quot;like_count&quot;:7,&quot;uuid&quot;:&quot;e43e8ce0b1a2cadee2a3&quot;,&quot;likable_type&quot;:&quot;Article&quot;,&quot;position&quot;:&quot;article-header&quot;}"></div><ul class="list-inline ArticleMainHeader__users"><li class="js-hovercard" data-hovercard-target-name="shuhei"><a itemprop="url" href="/shuhei"><img alt="shuhei" class="thumb thumb--xs" src="https://qiita-image-store.s3.amazonaws.com/0/3732/profile-images/1473683476" /></a></li><li class="js-hovercard" data-hovercard-target-name="ShigekiKarita"><a itemprop="url" href="/ShigekiKarita"><img alt="ShigekiKarita" class="thumb thumb--xs" src="https://qiita-image-store.s3.amazonaws.com/0/37859/profile-images/1473687564" /></a></li><li class="js-hovercard" data-hovercard-target-name="heliac2000"><a itemprop="url" href="/heliac2000"><img alt="heliac2000" class="thumb thumb--xs" src="https://qiita-image-store.s3.amazonaws.com/0/44994/profile-images/1473690106" /></a></li><li class="js-hovercard" data-hovercard-target-name="tateyama"><a itemprop="url" href="/tateyama"><img alt="tateyama" class="thumb thumb--xs" src="https://secure.gravatar.com/avatar/ed63904775780c14c66dba406a3fa034?d=https://a248.e.akamai.net/assets.github.com%2Fimages%2Fgravatars%2Fgravatar-user-420.png" /></a></li><li class="js-hovercard" data-hovercard-target-name="minewebstaff"><a itemprop="url" href="/minewebstaff"><img alt="minewebstaff" class="thumb thumb--xs" src="https://qiita-image-store.s3.amazonaws.com/0/46049/profile-images/1473690517" /></a></li><li class="js-hovercard" data-hovercard-target-name="houmei"><a itemprop="url" href="/houmei"><img alt="houmei" class="thumb thumb--xs" src="https://qiita-image-store.s3.amazonaws.com/0/935/profile-images/1473755344" /></a></li><li class="js-hovercard" data-hovercard-target-name="kosaki"><a itemprop="url" href="/kosaki"><img alt="kosaki" class="thumb thumb--xs" src="https://qiita-image-store.s3.amazonaws.com/0/14289/profile-images/1473683273" /></a></li></ul></div></div></div></div><div class="ArticleAsideHeader"><div class="container"><div class="u-flex u-space-between"><div class="u-flex u-flex-wrap"><div class="u-flex u-align-center s-pdv-5 u-flex-wrap"><div class="ArticleAsideHeader__author"><a href="/7shi"><img class="thumb thumb--xs" src="https://qiita-image-store.s3.amazonaws.com/0/32057/profile-images/1473685823" alt="1473685823" /></a> <a class="u-link-unstyled" href="/7shi">7shi</a> </div><div class="ArticleAsideHeader__date"><span data-toggle="tooltip" title="posted at 2016-02-14">Edited at <time datetime="2016-02-16T16:55:30+09:00" itemprop="dateModified">2016-02-16</time></span></div></div><div class="u-flex u-align-center s-pdv-5 mobile-hidden"><div class="ArticleAsideHeader__revision"> <a data-toggle="tooltip" title="Revisions" href="/7shi/items/e43e8ce0b1a2cadee2a3/revisions"><span class="fa fa-history"></span></a><span class="ArticleAsideHeader__revisionCount">3</span></div></div><div class="u-flex u-align-center s-pdv-5 mobile-hidden"></div></div><div class="u-flex u-align-center s-flex-justiry-between s-pdv-5 u-shrink-0"><div class="ArticleAsideHeader__stock"><div class="js-stockbutton" data-position="top" data-props="{&quot;stock_status&quot;:false}"></div></div><div class="dropdown"><a class="dropdown-toggle" data-toggle="dropdown" href="#"><span class="fa fa-ellipsis-h fa-lg"></span></a><ul class="dropdown-menu dropdown-menu-right"><li class="dropdown__item--mobile"><a href="/7shi/items/e43e8ce0b1a2cadee2a3/revisions"><span class="fa fa-fw fa-history"></span> Revisions<span>(3)</span></a></li><li><a href="/7shi/items/e43e8ce0b1a2cadee2a3.md"><span class="fa fa-fw fa-file-text-o"></span> Show article as Markdown</a></li><li><a data-target=".js-report-form" data-toggle="modal" href="#"><span class="fa fa-fw fa-flag"></span> Report article</a></li></ul></div></div></div></div></div><div class="container"><div class="row" id="article-body-wrapper"><div class="col-sm-9"><section class="markdownContent markdownContent-headingEnabled js-task-list-container clearfix position-relative" id="item-e43e8ce0b1a2cadee2a3" itemprop="articleBody"><div class="alert alert-warning"><i class="fa fa-clock-o"></i> More than 1 year has passed since last update.</div><p>VAXとはPDP-11の後継となる32bitマシンです。UNIX V7をVAXに移植したUNIX/32Vがあります。バイナリを通してUNIXを学習します。</p>

<p>この記事は以前開催していた<a href="http://connpass.com/series/182/" rel="nofollow noopener" target="_blank">池袋バイナリ勉強会</a>の初回編で教えていた内容をVAX向けに書き直したものです。</p>

<p>この記事には姉妹編があります。</p>

<ul>
<li>
<a href="http://qiita.com/7shi/items/86724696518df3a174dc" id="reference-3fac694890d3e6931aca">PDP-11による機械語入門</a> 2015.11.08</li>
<li>
<a href="http://qiita.com/7shi/items/b3911948f9d97b05395e" id="reference-9a2d26a080710a4b736b">8086による機械語入門</a> 2015.11.09</li>
</ul>

<h1>
<span id="環境設定" class="fragment"></span><a href="#%E7%92%B0%E5%A2%83%E8%A8%AD%E5%AE%9A"><i class="fa fa-link"></i></a>環境設定</h1>

<p>UNIX/32Vのバイナリを動かすためのインタプリタと、その上で動く当時のコンパイラを使用します。</p>

<p>インタプリタはJavaで作られているためJDKが必要です。</p>

<ul>
<li><a href="http://www.oracle.com/technetwork/java/javase/downloads/index.html" class="autolink" rel="nofollow noopener" target="_blank">http://www.oracle.com/technetwork/java/javase/downloads/index.html</a></li>
</ul>

<p>WindowsではMSYS2が必要です。</p>

<ul>
<li>
<a href="http://qiita.com/7shi/items/894fdd849658880bf6c9" id="reference-2938bb289d1856c01149">MSYS2でRicty Diminishedを使う設定など</a> 2015.01.29</li>
</ul>

<p>READMEに従ってインタプリタ一式をインストールしてください。</p>

<ul>
<li><a href="https://bitbucket.org/7shi/vaxrun" class="autolink" rel="nofollow noopener" target="_blank">https://bitbucket.org/7shi/vaxrun</a></li>
</ul>

<h2>
<span id="コンパイル" class="fragment"></span><a href="#%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%AB"><i class="fa fa-link"></i></a>コンパイル</h2>

<p>ハローワールドでテストします。</p>

<div class="code-frame" data-lang="c">
<div class="code-lang"><span class="bold">hello.c</span></div>
<div class="highlight"><pre>
<span class="cp">#include &lt;stdio.h&gt;</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"hello</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>

<p>先ほどインストールしたコンパイラでVAX用のバイナリを生成します。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre>
$ vaxcc hello.c
</pre></div></div>

<p>※ vaxccはシェルスクリプトで、インタプリタ上で当時のコンパイラ（VAXバイナリ）を実行しています。</p>

<p>a.outというファイルが出力されます。ファイルの種類を確認してもVAXとまでは認識されません。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre>
$ file a.out
a.out: a.out little-endian 32-bit pure executable not stripped
</pre></div></div>

<h2>
<span id="実行" class="fragment"></span><a href="#%E5%AE%9F%E8%A1%8C"><i class="fa fa-link"></i></a>実行</h2>

<p>出力されたバイナリをインタプリタで実行します。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre>
$ vaxrun a.out
hello
</pre></div></div>

<h2>
<span id="逆アセンブル" class="fragment"></span><a href="#%E9%80%86%E3%82%A2%E3%82%BB%E3%83%B3%E3%83%96%E3%83%AB"><i class="fa fa-link"></i></a>逆アセンブル</h2>

<p>バイナリの中にどのような命令が入っているかを分析します。この操作を<strong>逆アセンブル</strong>と呼びます。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre>
$ vaxdis a.out
magic = 00000108, text  = 00000b04, data   = 0000016c, bss    = 00000404
syms  = 00000300, entry = 00000000, trsize = 00000000, drsize = 00000000
[crt0.o]
start:
00000000: 00 00                    .word 0
00000002: c2 08 5e                 subl2 $8,sp
00000005: d0 ae 08 6e              movl 8(sp),(sp)
00000009: 9e ae 0c 50              movab 0xc(sp),r0
（略）
</pre></div></div>

<p>簡単なプログラムなのにすごく複雑だと感じられたと思います。入門にはあまりに複雑過ぎるため、今回の記事ではもっと簡単なものから始めます。基礎を固めてから、このバイナリに挑戦していただきます。</p>

<h3>
<span id="読み方" class="fragment"></span><a href="#%E8%AA%AD%E3%81%BF%E6%96%B9"><i class="fa fa-link"></i></a>読み方</h3>

<p><code>magic = ...</code> などはヘッダで、ファイル構造についての情報です。</p>

<p><code>[crt0.o]</code>や<code>start</code>は<strong>シンボル</strong>と呼ばれ、見出しのようなものです。</p>

<p>その後は次のような構成になっています。</p>

<table>
<thead>
<tr>
<th>アドレス</th>
<th>機械語</th>
<th>アセンブリ言語</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>00000000:</code></td>
<td><code>00 00</code></td>
<td><code>.word 0</code></td>
</tr>
<tr>
<td><code>00000002:</code></td>
<td><code>c2 08 5e</code></td>
<td><code>subl2 $8,sp</code></td>
</tr>
<tr>
<td><code>00000005:</code></td>
<td><code>d0 ae 08 6e</code></td>
<td><code>movl 8(sp),(sp)</code></td>
</tr>
<tr>
<td><code>00000009:</code></td>
<td><code>9e ae 0c 50</code></td>
<td><code>movab 0xc(sp),r0</code></td>
</tr>
</tbody>
</table>

<ul>
<li>
<strong>アドレス</strong>は行番号のようなものです。そこにCPUに対する命令が入っています。</li>
<li>命令は数字で構成されており<strong>機械語</strong>と呼ばれます。ここでは16進数表記されています。</li>
<li>機械語は人間には読みにくいため、意味を英語の略語などで表記したものが<strong>アセンブリ言語</strong>です。</li>
</ul>

<p>機械語やアセンブリ言語については後で詳しく見ていきます。</p>

<h2>
<span id="トレース" class="fragment"></span><a href="#%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B9"><i class="fa fa-link"></i></a>トレース</h2>

<p>命令やレジスタなどのログを表示しながら実行できます。この操作を<strong>トレース</strong>と呼びます。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre>
$ vaxrun -d a.out
00000000 00000000 00000000 00000000 00000000 00000000 : subl2 $0x8,sp
00000000 00000000 00000000 00000000 00000000 00000000 : c2085e
00000000 00000000 0007ffe4 00000002 ---- : [03]08
00000000 00000000 00000000 00000000 00000000 00000000 : movl 0x8(sp),(sp)
00000000 00000000 00000000 00000000 00000000 00000000 : d0ae086e
00000000 00000000 0007ffdc 00000005 ---- : [7ffe4]01[7ffdc]00
（略）
</pre></div></div>

<p>逆アセンブルと異なるのは、命令が実行される順番に表示される点です。基本的には上から順番に実行されますが、分岐や関数呼び出しなどでアドレスが飛びます。</p>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">例</span></div>
<div class="highlight"><pre>
0007fff0 00000000 00000000 00000000 00000000 00000000 : calls $0x3,0x3c
00000000 00000000 00000000 00000000 00000000 00000000 : fb03ef0d000000
00000000 00000000 0007ffdc 00000028 ---C : [29]03[3c]00
0007fff0 00000000 00000000 00000000 00000000 00000000 : subl2 $0x00000000,sp
00000000 00000000 00000000 00000000 00000000 00000000 : c28f000000005e
0007ffd8 0007ffc4 0007ffc4 0000003e ---- : [40]00
</pre></div>
</div>

<p>アドレス（最後の8桁16進数）が飛んでいることを確認してください: <code>00000028</code> → <code>0000003e</code></p>

<h2>
<span id="シンボル" class="fragment"></span><a href="#%E3%82%B7%E3%83%B3%E3%83%9C%E3%83%AB"><i class="fa fa-link"></i></a>シンボル</h2>

<p>逆アセンブルのときに出て来たシンボルを一覧表示します。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre>
$ vaxnm a.out
00000000 a .F1
00000000 a .R1
00000782 T __cleanu
（略）
000005b4 t strout.o
00000aa4 t stty.o
00000ae8 t write.o
</pre></div></div>

<p>構成は次の通りです。</p>

<table>
<thead>
<tr>
<th>アドレス</th>
<th>種類</th>
<th>シンボル名</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>00000000</code></td>
<td><code>a</code></td>
<td><code>.F1</code></td>
</tr>
<tr>
<td><code>00000000</code></td>
<td><code>a</code></td>
<td><code>.R1</code></td>
</tr>
<tr>
<td><code>00000782</code></td>
<td><code>T</code></td>
<td><code>__cleanu</code></td>
</tr>
</tbody>
</table>

<p>種類は初めから細かく理解していなくても、大雑把に<code>T</code>が関数、<code>D</code>と<code>B</code>が変数だと考えておけば良いです。それらがどのアドレスに関連付けられているかを示しています。</p>

<p>※ 関数や変数以外にも種類はありますが、当面は必要ありません。</p>

<h2>
<span id="ファイルサイズの縮小" class="fragment"></span><a href="#%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%B5%E3%82%A4%E3%82%BA%E3%81%AE%E7%B8%AE%E5%B0%8F"><i class="fa fa-link"></i></a>ファイルサイズの縮小</h2>

<p>シンボルは付加的情報で実行には必要不可欠なものではありません。シンボルを削ってファイルサイズが縮小できます。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre>
$ wc -c a.out
3984 a.out
$ vaxstrip a.out
$ wc -c a.out
3216 a.out
</pre></div></div>

<p>シンボルがなくなっていることを確認します。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre>
$ vaxnm a.out
nm: a.out-- no name list
</pre></div></div>

<p>実行には支障ありません。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre>
$ vaxrun a.out
hello
</pre></div></div>

<p>逆アセンブルでシンボルが出て来なくなります。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre>
$ vaxdis a.out
magic = 00000108, text  = 00000b04, data   = 0000016c, bss    = 00000404
syms  = 00000000, entry = 00000000, trsize = 00000000, drsize = 00000000
00000000: 00 00                    .word 0
00000002: c2 08 5e                 subl2 $8,sp
00000005: d0 ae 08 6e              movl 8(sp),(sp)
（略）
</pre></div></div>

<p>シンボルがないと関数の切れ目などが分からなくなるためデバッグや解析が困難になります。次のような運用方法が一般的です。</p>

<ul>
<li>開発時にはデバッグのためシンボルを付けておきます。</li>
<li>完成品をバイナリ配布する際には、ファイルサイズを縮小するためシンボルを取り除きます。ソース非公開の商用製品の場合、内部構造を解析されにくくする意図もあります。</li>
</ul>

<h1>
<span id="小さなバイナリ" class="fragment"></span><a href="#%E5%B0%8F%E3%81%95%E3%81%AA%E3%83%90%E3%82%A4%E3%83%8A%E3%83%AA"><i class="fa fa-link"></i></a>小さなバイナリ</h1>

<p>小さなバイナリを作って分析します。</p>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">write.s</span></div>
<div class="highlight"><pre>
.word 0

# write(1, hello, 6);
movl $args1, ap
chmk $4

# exit(0);
movl $args2, ap
chmk $1

.data
args1: .long 3, 1, hello, 6
args2: .long 1, 0
hello: .byte 'h, 'e, 'l, 'l, 'o, 10
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre>
$ vaxas write.s
$ vaxstrip a.out
$ vaxrun a.out
hello
</pre></div>
</div>

<ul>
<li>アセンブリ言語の文法はアセンブラによって方言があります。

<ul>
<li>このアセンブラでは<code>#</code>はコメントです。</li>
</ul>
</li>
<li>アセンブリ言語はCPUによって異なります。今回はVAXです。

<ul>
<li>
<code>ap</code> はレジスタと呼ばれます。変数のようなものです。</li>
<li>
<code>movl</code> は前から後ろに代入します: <code>movl $args1, ap</code> ⇒ <code>ap = args1</code>
</li>
<li>
<code>chmk</code> は割り込みを発生させる命令です。</li>
</ul>
</li>
</ul>

<h2>
<span id="システムコール" class="fragment"></span><a href="#%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E3%82%B3%E3%83%BC%E3%83%AB"><i class="fa fa-link"></i></a>システムコール</h2>

<p>割り込みでカーネルを呼び出してOSの機能を利用することを<strong>システムコール</strong>と呼びます。</p>

<ul>
<li>
<code>chmk</code> の後にシステムコール番号を書きます: <code>$1</code>, <code>$4</code> など

<ul>
<li>
<code>$1</code>: <code>exit</code>
</li>
<li>
<code>$4</code>: <code>write</code>
</li>
</ul>
</li>
<li>
<code>ap</code> は引数を示します。

<ul>
<li>引数を後ろに書いて<code>args1</code>のように名前を付けます。</li>
<li>
<code>.long</code>は4バイト値です。</li>
<li>最初の値は引数の数です。</li>
<li>
<code>write</code> の第1引数 <code>1</code> は標準出力を表します。</li>
</ul>
</li>
<li>
<code>.byte</code> は1バイト値です。

<ul>
<li>1バイト値（文字）の連続で文字列を表現します。</li>
<li>
<code>10</code>は改行コード（<code>\n</code>）です。</li>
</ul>
</li>
</ul>

<p>UNIX/32Vのシステムコール定義: <a href="http://minnie.tuhs.org/cgi-bin/utree.pl?file=32V/usr/src/sys/sys/sysent.c" rel="nofollow noopener" target="_blank">/usr/src/sys/sys/sysent.c</a></p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre>
struct sysent sysent[64] =
{
    引数の数, 未使用, 処理関数, /* システムコール番号 = システムコール名 */
    ...
};
</pre></div></div>

<ul>
<li>
<code>exit</code>: システムコール番号 1, 引数の数 1</li>
<li>
<code>write</code>: システムコール番号 4, 引数の数 3</li>
</ul>

<h2>
<span id="逆アセンブル-1" class="fragment"></span><a href="#%E9%80%86%E3%82%A2%E3%82%BB%E3%83%B3%E3%83%96%E3%83%AB-1"><i class="fa fa-link"></i></a>逆アセンブル</h2>

<p>バイナリを分析します。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre>
$ vaxdis a.out
magic = 00000108, text  = 00000014, data   = 00000020, bss    = 00000000
syms  = 00000000, entry = 00000000, trsize = 00000000, drsize = 00000000
00000000: 00 00                    .word 0
00000002: d0 8f 00 02 00 00 5c     movl $0x200,ap
00000009: bc 04                    chmk $4
0000000b: d0 8f 10 02 00 00 5c     movl $0x210,ap
00000012: bc 01                    chmk $1
</pre></div></div>

<ul>
<li>write.s →（アセンブル）→ a.out →（逆アセンブル）→ 上記結果

<ul>
<li>アセンブル: アセンブリ言語 → バイナリ</li>
<li>逆アセンブル: バイナリ → アセンブリ言語</li>
</ul>
</li>
<li>逆とは言っても完全に元に戻るわけではありません。

<ul>
<li>逆アセンブルでは対応するバイナリが確認できます。</li>
</ul>
</li>
<li>逆アセンブラの出力は一部数字になっています。

<ul>
<li>
<code>$args1</code> → <code>$0x200</code>
</li>
<li>
<code>$args2</code> → <code>$0x210</code>
</li>
</ul>
</li>
</ul>

<h2>
<span id="バイナリダンプ" class="fragment"></span><a href="#%E3%83%90%E3%82%A4%E3%83%8A%E3%83%AA%E3%83%80%E3%83%B3%E3%83%97"><i class="fa fa-link"></i></a>バイナリダンプ</h2>

<p>バイナリを16進数で出力します。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre>
$ hd a.out
00000000  08 01 00 00 14 00 00 00  20 00 00 00 00 00 00 00  |........ .......|
00000010  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000020  00 00 d0 8f 00 02 00 00  5c bc 04 d0 8f 10 02 00  |........\.......|
00000030  00 5c bc 01 03 00 00 00  01 00 00 00 18 02 00 00  |.\..............|
00000040  06 00 00 00 01 00 00 00  00 00 00 00 68 65 6c 6c  |............hell|
00000050  6f 0a 00 00                                       |o...|
00000054
</pre></div></div>

<p>※ <code>hd</code> がない環境では <code>hexdump -C</code> や <code>od -tx1z -Ax</code> を使用します。</p>

<h2>
<span id="仕様" class="fragment"></span><a href="#%E4%BB%95%E6%A7%98"><i class="fa fa-link"></i></a>仕様</h2>

<p>実装例はJavaScript風の疑似コードで示します。</p>

<ul>
<li>ヘッダ＋text（命令）＋data</li>
<li>ヘッダは最初の32バイト</li>
</ul>

<div class="code-frame" data-lang="js"><div class="highlight"><pre>
<span class="nx">aout</span> <span class="o">=</span> <span class="nx">File</span><span class="p">.</span><span class="nx">readAllBytes</span><span class="p">(</span><span class="s2">"a.out"</span><span class="p">)</span>
<span class="nx">h</span> <span class="o">=</span> <span class="nx">aout</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
</pre></div></div>

<ul>
<li>ヘッダを4バイトずつ区切って、2番目がtextのサイズ、3番目がdataのサイズ。リトルエンディアン。

<ul>
<li>今回のサンプル: <code>text = 0x00000014, data = 0x00000020</code>
</li>
</ul>
</li>
<li>それ以外の項目は当面必要ないので、説明は省略します。</li>
</ul>

<div class="code-frame" data-lang="js"><div class="highlight"><pre>
<span class="nx">text</span> <span class="o">=</span> <span class="nx">h</span><span class="p">.</span><span class="nx">read32LE</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="nx">data</span> <span class="o">=</span> <span class="nx">h</span><span class="p">.</span><span class="nx">read32LE</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<span class="nx">dataPos</span> <span class="o">=</span> <span class="mi">32</span> <span class="o">+</span> <span class="nx">text</span>
<span class="nx">textData</span> <span class="o">=</span> <span class="nx">aout</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="nx">dataPos</span><span class="p">)</span>
<span class="nx">dataData</span> <span class="o">=</span> <span class="nx">aout</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">dataPos</span><span class="p">,</span> <span class="nx">dataPos</span> <span class="o">+</span> <span class="nx">data</span><span class="p">)</span>
</pre></div></div>

<ul>
<li>ヘッダの後にtextがあり、その後にdataがあります。</li>
<li>textやdataはメモリ内でサイズが0x200の倍数に切り上げられます。

<ul>
<li>切り上げに伴って膨らんだ部分を<strong>パディング</strong>（「詰め物」の意）と呼びます。</li>
</ul>
</li>
<li>textはアドレス0からサイズ分読み込みます。</li>
</ul>

<div class="code-frame" data-lang="js"><div class="highlight"><pre>
<span class="nx">textSize</span> <span class="o">=</span> <span class="p">(</span><span class="nx">tsize</span> <span class="o">+</span> <span class="mh">0x1ff</span><span class="p">)</span> <span class="o">-</span> <span class="p">((</span><span class="nx">tsize</span> <span class="o">+</span> <span class="mh">0x1ff</span><span class="p">)</span> <span class="o">%</span> <span class="mh">0x200</span><span class="p">)</span>
<span class="nx">dataSize</span> <span class="o">=</span> <span class="p">(</span><span class="nx">dsize</span> <span class="o">+</span> <span class="mh">0x1ff</span><span class="p">)</span> <span class="o">-</span> <span class="p">((</span><span class="nx">dsize</span> <span class="o">+</span> <span class="mh">0x1ff</span><span class="p">)</span> <span class="o">%</span> <span class="mh">0x200</span><span class="p">)</span>
<span class="nx">mem</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">(</span><span class="nx">textSize</span> <span class="o">+</span> <span class="nx">dataSize</span><span class="p">)</span>
<span class="nx">mem</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">textData</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="nx">mem</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">dataData</span><span class="p">,</span> <span class="nx">textSize</span><span class="p">)</span>
</pre></div></div>

<h3>
<span id="メモリダンプ" class="fragment"></span><a href="#%E3%83%A1%E3%83%A2%E3%83%AA%E3%83%80%E3%83%B3%E3%83%97"><i class="fa fa-link"></i></a>メモリダンプ</h3>

<p>メモリに読み込んだ状態を示します。パディングは省略します。</p>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">メモリ配置</span></div>
<div class="highlight"><pre>
.text
00000000  00 00 d0 8f 00 02 00 00  5c bc 04 d0 8f 10 02 00  ........\.......
00000010  00 5c bc 01                                       .\..
.data
00000200  03 00 00 00 01 00 00 00  18 02 00 00 06 00 00 00  ................
00000210  01 00 00 00 00 00 00 00  68 65 6c 6c 6f 0a 00 00  ........hello...
</pre></div>
</div>

<p>※ <code>.text</code>や<code>.data</code>の<code>.</code>はアセンブラに合わせた表記です。</p>

<h2>
<span id="練習" class="fragment"></span><a href="#%E7%B7%B4%E7%BF%92"><i class="fa fa-link"></i></a>練習</h2>

<p>※ 時間は目安です。</p>

<p>【問1-1:20分】ファイルをそのままバイナリダンプするプログラムを作ってください。（<code>hd a.out</code> 相当）</p>

<p>【問1-2:20分】メモリに読み込んだ状態をバイナリダンプするプログラムを作ってください。</p>

<p>【問2-1:1時間】逆アセンブラを作ってください。（<code>vaxdis a.out</code> 相当）</p>

<p>【問2-2:1時間】バイナリを実行してください。（<code>vaxrun a.out</code> 相当）</p>

<p>※ 以後、問2-2で作ったものを<strong>インタプリタ</strong>と呼びます。</p>

<h1>
<span id="少しずつ拡張" class="fragment"></span><a href="#%E5%B0%91%E3%81%97%E3%81%9A%E3%81%A4%E6%8B%A1%E5%BC%B5"><i class="fa fa-link"></i></a>少しずつ拡張</h1>

<p>先ほど作った小さなバイナリを少しずつ拡張していきます。</p>

<h2>
<span id="数値をメモリに書き込む" class="fragment"></span><a href="#%E6%95%B0%E5%80%A4%E3%82%92%E3%83%A1%E3%83%A2%E3%83%AA%E3%81%AB%E6%9B%B8%E3%81%8D%E8%BE%BC%E3%82%80"><i class="fa fa-link"></i></a>数値をメモリに書き込む</h2>

<p>メモリを操作して出力する文字列を変更します。</p>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">write-1.s</span></div>
<div class="highlight"><pre>
.word 0

# write(1, hello, 6);
movl $args1, ap
chmk $4


# r1 = hello;
# *(uint32_t *)r1 = 'H'|'E'&lt;&lt;8|'L'&lt;&lt;16|'L'&lt;&lt;24;
movl $hello, r1
movl $'H|'E&lt;8|'L&lt;16|'L&lt;24, (r1)

# write(1, hello, 6);
movl $args1, ap
chmk $4


# exit(0);
movl $args2, ap
chmk $1


.data
args1: .long 3, 1, hello, 6
args2: .long 1, 0
hello: .byte 'h, 'e, 'l, 'l, 'o, 10
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre>
$ vaxas -o write-1 write-1.s
$ vaxrun write-1
hello
HELLo
</pre></div>
</div>

<p><code>-o</code>で出力ファイル名を指定しています。</p>

<h3>
<span id="練習-1" class="fragment"></span><a href="#%E7%B7%B4%E7%BF%92-1"><i class="fa fa-link"></i></a>練習</h3>

<p>【問3-1:5分】逆アセンブラを対応させてください。</p>

<p>【問3-2:10分】インタプリタを対応させてください。</p>

<h2>
<span id="ディスプレースメント" class="fragment"></span><a href="#%E3%83%87%E3%82%A3%E3%82%B9%E3%83%97%E3%83%AC%E3%83%BC%E3%82%B9%E3%83%A1%E3%83%B3%E3%83%88"><i class="fa fa-link"></i></a>ディスプレースメント</h2>

<p>相対アドレス指定によるメモリ操作を行います。</p>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">write-2.s</span></div>
<div class="highlight"><pre>
.word 0

# write(1, hello, 6);
movl $args1, ap
chmk $4


# r1 = hello;
# *(uint32_t *)(r1 + 1) = 'E'|'L'&lt;&lt;8|'L'&lt;&lt;16|'O'&lt;&lt;24;
movl $hello, r1
movl $'E|'L&lt;8|'L&lt;16|'O&lt;24, 1(r1)

# write(1, hello, 6);
movl $args1, ap
chmk $4


# exit(0);
movl $args2, ap
chmk $1


.data
args1: .long 3, 1, hello, 6
args2: .long 1, 0
hello: .byte 'h, 'e, 'l, 'l, 'o, 10
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre>
$ vaxas -o write-2 write-2.s
$ vaxrun write-2
hello
hELLO
</pre></div>
</div>

<p><code>1(r1)</code> の <code>1</code> は <code>r1</code> に対する差分を表します。この差分を<strong>ディスプレースメント</strong>と呼びます。</p>

<p>意味的には <code>(r1+1)</code> です。（この構文はエラーになります）</p>

<h3>
<span id="練習-2" class="fragment"></span><a href="#%E7%B7%B4%E7%BF%92-2"><i class="fa fa-link"></i></a>練習</h3>

<p>【問4-1:5分】逆アセンブラを対応させてください。</p>

<p>【問4-2:10分】インタプリタを対応させてください。</p>

<h2>
<span id="movbmovw" class="fragment"></span><a href="#movbmovw"><i class="fa fa-link"></i></a>movb/movw</h2>

<p>1文字や2文字の書き替えを行います。</p>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">write-3.s</span></div>
<div class="highlight"><pre>
.word 0

# write(1, hello, 6);
movl $args1, ap
chmk $4


# r1 = hello;
# *(uint8_t *)r1 = 'H';
movl $hello, r1
movb $'H, (r1)

# write(1, hello, 6);
movl $args1, ap
chmk $4


# r1 = hello;
# *(uint16_t *)(r1 + 2) = 'L'|'L'&lt;&lt;8;
movl $hello, r1
movw $'L|'L&lt;8, 2(r1)

# write(1, hello, 6);
movl $args1, ap
chmk $4


# exit(0);
movl $args2, ap
chmk $1


.data
args1: .long 3, 1, hello, 6
args2: .long 1, 0
hello: .byte 'h, 'e, 'l, 'l, 'o, 10
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre>
$ vaxas -o write-3 write-3.s
$ vaxrun write-3
hello
Hello
HeLLo
</pre></div>
</div>

<p><code>movb</code> は <code>byte</code> 版、<code>movw</code> は <code>word</code> 版です。</p>

<h3>
<span id="練習-3" class="fragment"></span><a href="#%E7%B7%B4%E7%BF%92-3"><i class="fa fa-link"></i></a>練習</h3>

<p>【問5-1:5分】逆アセンブラを対応させてください。</p>

<p>【問5-2:10分】インタプリタを対応させてください。</p>

<h2>
<span id="レジスタの値をメモリに書き込む" class="fragment"></span><a href="#%E3%83%AC%E3%82%B8%E3%82%B9%E3%82%BF%E3%81%AE%E5%80%A4%E3%82%92%E3%83%A1%E3%83%A2%E3%83%AA%E3%81%AB%E6%9B%B8%E3%81%8D%E8%BE%BC%E3%82%80"><i class="fa fa-link"></i></a>レジスタの値をメモリに書き込む</h2>

<p>数値をいったんレジスタに入れてからメモリに書き込みます。</p>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">write-4.s</span></div>
<div class="highlight"><pre>
.word 0

# write(1, hello, 6);
movl $args1, ap
chmk $4


# r1 = hello;
# r0 = 'H'|'E'&lt;&lt;8|'L'&lt;&lt;16|'L'&lt;&lt;24;
# *(uint32_t *)r1 = r0;
movl $hello, r1
movl $'H|'E&lt;8|'L&lt;16|'L&lt;24, r0
movl r0, (r1)

# write(1, hello, 6);
movl $args1, ap
chmk $4


# exit(0);
movl $args2, ap
chmk $1


.data
args1: .long 3, 1, hello, 6
args2: .long 1, 0
hello: .byte 'h, 'e, 'l, 'l, 'o, 10
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre>
$ vaxas -o write-4 write-4.s
$ vaxrun write-4
hello
HELLo
</pre></div>
</div>

<h3>
<span id="練習-4" class="fragment"></span><a href="#%E7%B7%B4%E7%BF%92-4"><i class="fa fa-link"></i></a>練習</h3>

<p>【問6-1:5分】逆アセンブラを対応させてください。</p>

<p>【問6-2:15分】インタプリタを対応させてください。</p>

<h2>
<span id="バイト命令" class="fragment"></span><a href="#%E3%83%90%E3%82%A4%E3%83%88%E5%91%BD%E4%BB%A4"><i class="fa fa-link"></i></a>バイト命令</h2>

<p>レジスタを <code>movb</code> 命令のソースに使うと、下位の値だけが使われます。</p>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">write-5.s</span></div>
<div class="highlight"><pre>
.word 0

# write(1, hello, 6);
movl $args1, ap
chmk $4


# r1 = hello;
# r0 = 'H'|'E'&lt;&lt;8
# *(uint8_t *)r1 = r0;
movl $hello, r1
movl $'H|'E&lt;8, r0
movb r0, (r1)

# write(1, hello, 6);
movl $args1, ap
chmk $4


# exit(0);
movl $args2, ap
chmk $1


.data
args1: .long 3, 1, hello, 6
args2: .long 1, 0
hello: .byte 'h, 'e, 'l, 'l, 'o, 10
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre>
$ vaxas -o write-5 write-5.s
$ vaxrun write-5
hello
Hello
</pre></div>
</div>

<h3>
<span id="練習-5" class="fragment"></span><a href="#%E7%B7%B4%E7%BF%92-5"><i class="fa fa-link"></i></a>練習</h3>

<p>【問7-1:10分】逆アセンブラを対応させてください。</p>

<p>【問7-2:20分】インタプリタを対応させてください。</p>

<h2>
<span id="アドレスを直接指定" class="fragment"></span><a href="#%E3%82%A2%E3%83%89%E3%83%AC%E3%82%B9%E3%82%92%E7%9B%B4%E6%8E%A5%E6%8C%87%E5%AE%9A"><i class="fa fa-link"></i></a>アドレスを直接指定</h2>

<p>今までメモリは <code>r1</code> レジスタ経由でアクセスしていました（これを<strong>間接参照</strong>と呼びます）。アドレスを直接指定でアクセスすることも可能です（これを<strong>直接参照</strong>と呼びます）。</p>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">write-6.s</span></div>
<div class="highlight"><pre>
.word 0

# write(1, hello, 6);
movl $args1, ap
chmk $4


# *(uint32_t *)hello = 'H'|'E'&lt;&lt;8|'L'&lt;&lt;16|'L'&lt;&lt;24;
movl $'H|'E&lt;8|'L&lt;16|'L&lt;24, hello

# write(1, hello, 6);
movl $args1, ap
chmk $4


# *(uint8_t *)(hello + 4) = 'O';
movb $'O, hello + 4

# write(1, hello, 6);
movl $args1, ap
chmk $4


# exit(0);
movl $args2, ap
chmk $1


.data
args1: .long 3, 1, hello, 6
args2: .long 1, 0
hello: .byte 'h, 'e, 'l, 'l, 'o, 10
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre>
$ vaxas -o write-6 write-6.s
$ vaxrun write-6
hello
HELLo
HELLO
</pre></div>
</div>

<h3>
<span id="相対アドレス" class="fragment"></span><a href="#%E7%9B%B8%E5%AF%BE%E3%82%A2%E3%83%89%E3%83%AC%E3%82%B9"><i class="fa fa-link"></i></a>相対アドレス</h3>

<p>逆アセンブル結果から直接参照の該当箇所を抜き出します。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre>
0000000b: d0 8f 48 45 4c 4c ef 02  movl $0x4c4c4548,0x218
00000013: 02 00 00
</pre></div></div>

<p>要素に分解すると、アドレスが直接含まれていないことが分かります。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre>
0000000b: d0              # movl
0000000c: 8f 48 45 4c 4c  # $0x4c4c4548
00000011: ef 02 02 00 00  # 0x218
</pre></div></div>

<p><code>0x202</code>→<code>0x218</code>となるのは、次の命令を基点とする相対アドレスだからです。</p>

<ul>
<li>
<code>0x16</code>（基点） + <code>0x202</code>（相対アドレス） = <code>0x218</code>（絶対アドレス）</li>
</ul>

<h3>
<span id="練習-6" class="fragment"></span><a href="#%E7%B7%B4%E7%BF%92-6"><i class="fa fa-link"></i></a>練習</h3>

<p>【問8-1:5分】逆アセンブラを対応させてください。</p>

<p>【問8-2:10分】インタプリタを対応させてください。</p>

<h2>
<span id="引き算" class="fragment"></span><a href="#%E5%BC%95%E3%81%8D%E7%AE%97"><i class="fa fa-link"></i></a>引き算</h2>

<p>引き算により小文字から大文字へ変換します。</p>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">write-7.s</span></div>
<div class="highlight"><pre>
.word 0

# write(1, hello, 6);
movl $args1, ap
chmk $4


# *(uint32_t *)hello -= 0x20202020;
subl2 $0x20202020, hello

# write(1, hello, 6);
movl $args1, ap
chmk $4


# *(uint8_t *)(hello + 4) -= 0x20;
subb2 $0x20, hello + 4

# write(1, hello, 6);
movl $args1, ap
chmk $4


# exit(0);
movl $args2, ap
chmk $1


.data
args1: .long 3, 1, hello, 6
args2: .long 1, 0
hello: .byte 'h, 'e, 'l, 'l, 'o, 10
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre>
$ vaxas -o write-7 write-7.s
$ vaxrun write-7
hello
HELLo
HELLO
</pre></div>
</div>

<p><code>subl2</code>や<code>subb2</code>の<code>2</code>は引数の数です。引数が3つの<code>subl3</code>と名前で区別しています。</p>

<h3>
<span id="練習-7" class="fragment"></span><a href="#%E7%B7%B4%E7%BF%92-7"><i class="fa fa-link"></i></a>練習</h3>

<p>【問9-1:5分】逆アセンブラを対応させてください。</p>

<p>【問9-2:15分】インタプリタを対応させてください。</p>

<h1>
<span id="仕様書" class="fragment"></span><a href="#%E4%BB%95%E6%A7%98%E6%9B%B8"><i class="fa fa-link"></i></a>仕様書</h1>

<p>今まで推測していた仕様を仕様書で確認してください。</p>

<ul>
<li><a href="http://www2.hmc.edu/www_common/OVMS072-OLD/72final/4515/4515pro.html" rel="nofollow noopener" target="_blank">VAX MACRO and Instruction Set Reference Manual (英語版の命令セットマニュアル)</a></li>
</ul>

<h1>
<span id="テストコード集" class="fragment"></span><a href="#%E3%83%86%E3%82%B9%E3%83%88%E3%82%B3%E3%83%BC%E3%83%89%E9%9B%86"><i class="fa fa-link"></i></a>テストコード集</h1>

<p>自作インタプリタで順番に動作させてください。</p>

<div class="code-frame" data-lang="c">
<div class="code-lang"><span class="bold">1.c</span></div>
<div class="highlight"><pre>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">write</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">"hello</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>

<div class="code-frame" data-lang="c">
<div class="code-lang"><span class="bold">2.c</span></div>
<div class="highlight"><pre>
<span class="cp">#include &lt;stdio.h&gt;</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">putchar</span><span class="p">(</span><span class="sc">'a'</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>

<div class="code-frame" data-lang="c">
<div class="code-lang"><span class="bold">3.c</span></div>
<div class="highlight"><pre>
<span class="cp">#include &lt;stdio.h&gt;</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"hello</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>

<div class="code-frame" data-lang="c">
<div class="code-lang"><span class="bold">4.c</span></div>
<div class="highlight"><pre>
<span class="cp">#include &lt;stdio.h&gt;</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">1234</span><span class="p">;</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"a=%d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>

<div class="code-frame" data-lang="c">
<div class="code-lang"><span class="bold">5.c</span></div>
<div class="highlight"><pre>
<span class="cp">#include &lt;stdio.h&gt;</span>

<span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">)</span>
    <span class="kt">int</span> <span class="n">argc</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[];</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">argc</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"argv[%d]=%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>

<h2>
<span id="nm" class="fragment"></span><a href="#nm"><i class="fa fa-link"></i></a>nm</h2>

<p>既存のコマンドを自作インタプリタで動かしてみましょう。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre>
# nm a.out
</pre></div></div>

<h2>
<span id="cc" class="fragment"></span><a href="#cc"><i class="fa fa-link"></i></a>cc</h2>

<p>ccは内部で色々なものを呼んでいます。これらを自作インタプリタで順番に動かして、最終的にはccから一括で処理できることを目指してください。</p>

<ul>
<li>
<code>cc 1.c</code>

<ul>
<li><code>/lib/cpp 1.c /tmp/ctm4a</code></li>
<li><code>/lib/ccom /tmp/ctm4a /tmp/ctm3a</code></li>
<li><code>/bin/as -o 1.o /tmp/ctm3a</code></li>
<li><code>/bin/ld -X /lib/crt0.o 1.o /lib/libc.a -l</code></li>
</ul>
</li>
</ul>

<p>自作インタプリタでccを読んでハローワールドのビルドを目指してください。</p>

<h2>
<span id="カーネルビルドへの道" class="fragment"></span><a href="#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%93%E3%83%AB%E3%83%89%E3%81%B8%E3%81%AE%E9%81%93"><i class="fa fa-link"></i></a>カーネルビルドへの道</h2>

<p>ハローワールドがビルドできたら、以下の順にカーネルビルドを目指してください。</p>

<ol>
<li>他のテストコード（2.c～6.c）をビルドする</li>
<li>32Vカーネルをビルドする</li>
<li>アセンブラをビルドする</li>
<li>コンパイラをビルドする</li>
<li>3と4のセルフホスティングを確認する</li>
<li>セルフホスティングしたツールでカーネルをコンパイルする</li>
</ol>

<p>ここまで出来れば、バイナリのトレース練習は終了です。</p>

<p>次はUNIX/32Vそのものを動かすことに挑戦しましょう！</p>
<div class="hidden"><form class="js-task-list-update" action="/7shi/items/e43e8ce0b1a2cadee2a3" accept-charset="UTF-8" method="post"><input name="utf8" type="hidden" value="&#x2713;" /><input type="hidden" name="_method" value="patch" /><input type="hidden" name="authenticity_token" value="jyO45bocLiBd3b1T323wiVnprB8dNsqE0TJc4CIpQjThoSO9ITIXa6IOCE+vmE7QOa6IrIrykHPt7FUbwydM8g==" /><input type="hidden" name="updated_at_confirmation_in_unixtime" id="updated_at_confirmation_in_unixtime" value="1455609330" class="js-task-list-updated-at" /><textarea name="raw_body" id="raw_body" class="js-task-list-field">
VAXとはPDP-11の後継となる32bitマシンです。UNIX V7をVAXに移植したUNIX/32Vがあります。バイナリを通してUNIXを学習します。

この記事は以前開催していた[池袋バイナリ勉強会](http://connpass.com/series/182/)の初回編で教えていた内容をVAX向けに書き直したものです。

この記事には姉妹編があります。

* [PDP-11による機械語入門](http://qiita.com/7shi/items/86724696518df3a174dc) 2015.11.08
* [8086による機械語入門](http://qiita.com/7shi/items/b3911948f9d97b05395e) 2015.11.09

# 環境設定

UNIX/32Vのバイナリを動かすためのインタプリタと、その上で動く当時のコンパイラを使用します。

インタプリタはJavaで作られているためJDKが必要です。

* http://www.oracle.com/technetwork/java/javase/downloads/index.html

WindowsではMSYS2が必要です。

* [MSYS2でRicty Diminishedを使う設定など](http://qiita.com/7shi/items/894fdd849658880bf6c9) 2015.01.29

READMEに従ってインタプリタ一式をインストールしてください。

* https://bitbucket.org/7shi/vaxrun

## コンパイル

ハローワールドでテストします。

```hello.c
#include &lt;stdio.h&gt;

int main() {
    printf(&quot;hello\n&quot;);
    return 0;
}
```

先ほどインストールしたコンパイラでVAX用のバイナリを生成します。

```text
$ vaxcc hello.c
```

※ vaxccはシェルスクリプトで、インタプリタ上で当時のコンパイラ（VAXバイナリ）を実行しています。

a.outというファイルが出力されます。ファイルの種類を確認してもVAXとまでは認識されません。

```text
$ file a.out
a.out: a.out little-endian 32-bit pure executable not stripped
```

## 実行

出力されたバイナリをインタプリタで実行します。

```text
$ vaxrun a.out
hello
```

## 逆アセンブル

バイナリの中にどのような命令が入っているかを分析します。この操作を**逆アセンブル**と呼びます。

```text
$ vaxdis a.out
magic = 00000108, text  = 00000b04, data   = 0000016c, bss    = 00000404
syms  = 00000300, entry = 00000000, trsize = 00000000, drsize = 00000000
[crt0.o]
start:
00000000: 00 00                    .word 0
00000002: c2 08 5e                 subl2 $8,sp
00000005: d0 ae 08 6e              movl 8(sp),(sp)
00000009: 9e ae 0c 50              movab 0xc(sp),r0
（略）
```

簡単なプログラムなのにすごく複雑だと感じられたと思います。入門にはあまりに複雑過ぎるため、今回の記事ではもっと簡単なものから始めます。基礎を固めてから、このバイナリに挑戦していただきます。

### 読み方

`magic = ...` などはヘッダで、ファイル構造についての情報です。

`[crt0.o]`や`start`は**シンボル**と呼ばれ、見出しのようなものです。

その後は次のような構成になっています。

アドレス|機械語|アセンブリ言語
--------|------|--------------
`00000000:`|`00 00`|`.word 0`
`00000002:`|`c2 08 5e`|`subl2 $8,sp`
`00000005:`|`d0 ae 08 6e`|`movl 8(sp),(sp)`
`00000009:`|`9e ae 0c 50`|`movab 0xc(sp),r0`

* **アドレス**は行番号のようなものです。そこにCPUに対する命令が入っています。
* 命令は数字で構成されており**機械語**と呼ばれます。ここでは16進数表記されています。
* 機械語は人間には読みにくいため、意味を英語の略語などで表記したものが**アセンブリ言語**です。

機械語やアセンブリ言語については後で詳しく見ていきます。

## トレース

命令やレジスタなどのログを表示しながら実行できます。この操作を**トレース**と呼びます。

```text
$ vaxrun -d a.out
00000000 00000000 00000000 00000000 00000000 00000000 : subl2 $0x8,sp
00000000 00000000 00000000 00000000 00000000 00000000 : c2085e
00000000 00000000 0007ffe4 00000002 ---- : [03]08
00000000 00000000 00000000 00000000 00000000 00000000 : movl 0x8(sp),(sp)
00000000 00000000 00000000 00000000 00000000 00000000 : d0ae086e
00000000 00000000 0007ffdc 00000005 ---- : [7ffe4]01[7ffdc]00
（略）
```

逆アセンブルと異なるのは、命令が実行される順番に表示される点です。基本的には上から順番に実行されますが、分岐や関数呼び出しなどでアドレスが飛びます。

```text:例
0007fff0 00000000 00000000 00000000 00000000 00000000 : calls $0x3,0x3c
00000000 00000000 00000000 00000000 00000000 00000000 : fb03ef0d000000
00000000 00000000 0007ffdc 00000028 ---C : [29]03[3c]00
0007fff0 00000000 00000000 00000000 00000000 00000000 : subl2 $0x00000000,sp
00000000 00000000 00000000 00000000 00000000 00000000 : c28f000000005e
0007ffd8 0007ffc4 0007ffc4 0000003e ---- : [40]00
```

アドレス（最後の8桁16進数）が飛んでいることを確認してください: `00000028` → `0000003e`

## シンボル

逆アセンブルのときに出て来たシンボルを一覧表示します。

```text
$ vaxnm a.out
00000000 a .F1
00000000 a .R1
00000782 T __cleanu
（略）
000005b4 t strout.o
00000aa4 t stty.o
00000ae8 t write.o
```

構成は次の通りです。

アドレス|種類|シンボル名
--------|----|----------
`00000000`|`a`|`.F1`
`00000000`|`a`|`.R1`
`00000782`|`T`|`__cleanu`

種類は初めから細かく理解していなくても、大雑把に`T`が関数、`D`と`B`が変数だと考えておけば良いです。それらがどのアドレスに関連付けられているかを示しています。

※ 関数や変数以外にも種類はありますが、当面は必要ありません。

## ファイルサイズの縮小

シンボルは付加的情報で実行には必要不可欠なものではありません。シンボルを削ってファイルサイズが縮小できます。

```text
$ wc -c a.out
3984 a.out
$ vaxstrip a.out
$ wc -c a.out
3216 a.out
```

シンボルがなくなっていることを確認します。

```text
$ vaxnm a.out
nm: a.out-- no name list
```

実行には支障ありません。

```text
$ vaxrun a.out
hello
```

逆アセンブルでシンボルが出て来なくなります。

```text
$ vaxdis a.out
magic = 00000108, text  = 00000b04, data   = 0000016c, bss    = 00000404
syms  = 00000000, entry = 00000000, trsize = 00000000, drsize = 00000000
00000000: 00 00                    .word 0
00000002: c2 08 5e                 subl2 $8,sp
00000005: d0 ae 08 6e              movl 8(sp),(sp)
（略）
```

シンボルがないと関数の切れ目などが分からなくなるためデバッグや解析が困難になります。次のような運用方法が一般的です。

* 開発時にはデバッグのためシンボルを付けておきます。
* 完成品をバイナリ配布する際には、ファイルサイズを縮小するためシンボルを取り除きます。ソース非公開の商用製品の場合、内部構造を解析されにくくする意図もあります。

# 小さなバイナリ

小さなバイナリを作って分析します。

```text:write.s
.word 0

# write(1, hello, 6);
movl $args1, ap
chmk $4

# exit(0);
movl $args2, ap
chmk $1

.data
args1: .long 3, 1, hello, 6
args2: .long 1, 0
hello: .byte &#39;h, &#39;e, &#39;l, &#39;l, &#39;o, 10
```
```text:実行結果
$ vaxas write.s
$ vaxstrip a.out
$ vaxrun a.out
hello
```

* アセンブリ言語の文法はアセンブラによって方言があります。
    * このアセンブラでは`#`はコメントです。
* アセンブリ言語はCPUによって異なります。今回はVAXです。
    * `ap` はレジスタと呼ばれます。変数のようなものです。
    * `movl` は前から後ろに代入します: `movl $args1, ap` ⇒ `ap = args1`
    * `chmk` は割り込みを発生させる命令です。

## システムコール

割り込みでカーネルを呼び出してOSの機能を利用することを**システムコール**と呼びます。

* `chmk` の後にシステムコール番号を書きます: `$1`, `$4` など
    * `$1`: `exit`
    * `$4`: `write`
* `ap` は引数を示します。
    * 引数を後ろに書いて`args1`のように名前を付けます。
    * `.long`は4バイト値です。
    * 最初の値は引数の数です。
    * `write` の第1引数 `1` は標準出力を表します。
* `.byte` は1バイト値です。
    * 1バイト値（文字）の連続で文字列を表現します。
    * `10`は改行コード（`\n`）です。

UNIX/32Vのシステムコール定義: [/usr/src/sys/sys/sysent.c](http://minnie.tuhs.org/cgi-bin/utree.pl?file=32V/usr/src/sys/sys/sysent.c)

```text
struct sysent sysent[64] =
{
    引数の数, 未使用, 処理関数, /* システムコール番号 = システムコール名 */
    ...
};
```

* `exit`: システムコール番号 1, 引数の数 1
* `write`: システムコール番号 4, 引数の数 3

## 逆アセンブル

バイナリを分析します。

```text
$ vaxdis a.out
magic = 00000108, text  = 00000014, data   = 00000020, bss    = 00000000
syms  = 00000000, entry = 00000000, trsize = 00000000, drsize = 00000000
00000000: 00 00                    .word 0
00000002: d0 8f 00 02 00 00 5c     movl $0x200,ap
00000009: bc 04                    chmk $4
0000000b: d0 8f 10 02 00 00 5c     movl $0x210,ap
00000012: bc 01                    chmk $1
```

* write.s →（アセンブル）→ a.out →（逆アセンブル）→ 上記結果
    * アセンブル: アセンブリ言語 → バイナリ
    * 逆アセンブル: バイナリ → アセンブリ言語
* 逆とは言っても完全に元に戻るわけではありません。
    * 逆アセンブルでは対応するバイナリが確認できます。
* 逆アセンブラの出力は一部数字になっています。
    * `$args1` → `$0x200`
    * `$args2` → `$0x210`

## バイナリダンプ

バイナリを16進数で出力します。

```text
$ hd a.out
00000000  08 01 00 00 14 00 00 00  20 00 00 00 00 00 00 00  |........ .......|
00000010  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000020  00 00 d0 8f 00 02 00 00  5c bc 04 d0 8f 10 02 00  |........\.......|
00000030  00 5c bc 01 03 00 00 00  01 00 00 00 18 02 00 00  |.\..............|
00000040  06 00 00 00 01 00 00 00  00 00 00 00 68 65 6c 6c  |............hell|
00000050  6f 0a 00 00                                       |o...|
00000054
```

※ `hd` がない環境では `hexdump -C` や `od -tx1z -Ax` を使用します。

## 仕様

実装例はJavaScript風の疑似コードで示します。

* ヘッダ＋text（命令）＋data
* ヘッダは最初の32バイト

```js
aout = File.readAllBytes(&quot;a.out&quot;)
h = aout.slice(0, 32)
```

* ヘッダを4バイトずつ区切って、2番目がtextのサイズ、3番目がdataのサイズ。リトルエンディアン。
    * 今回のサンプル: `text = 0x00000014, data = 0x00000020`
* それ以外の項目は当面必要ないので、説明は省略します。

```js
text = h.read32LE(4)
data = h.read32LE(8)
dataPos = 32 + text
textData = aout.slice(32, dataPos)
dataData = aout.slice(dataPos, dataPos + data)
```

* ヘッダの後にtextがあり、その後にdataがあります。
* textやdataはメモリ内でサイズが0x200の倍数に切り上げられます。
    * 切り上げに伴って膨らんだ部分を**パディング**（「詰め物」の意）と呼びます。
* textはアドレス0からサイズ分読み込みます。

```js
textSize = (tsize + 0x1ff) - ((tsize + 0x1ff) % 0x200)
dataSize = (dsize + 0x1ff) - ((dsize + 0x1ff) % 0x200)
mem = new Uint8Array(textSize + dataSize)
mem.set(textData, 0)
mem.set(dataData, textSize)
```

### メモリダンプ

メモリに読み込んだ状態を示します。パディングは省略します。

```text:メモリ配置
.text
00000000  00 00 d0 8f 00 02 00 00  5c bc 04 d0 8f 10 02 00  ........\.......
00000010  00 5c bc 01                                       .\..
.data
00000200  03 00 00 00 01 00 00 00  18 02 00 00 06 00 00 00  ................
00000210  01 00 00 00 00 00 00 00  68 65 6c 6c 6f 0a 00 00  ........hello...
```

※ `.text`や`.data`の`.`はアセンブラに合わせた表記です。

## 練習

※ 時間は目安です。

【問1-1:20分】ファイルをそのままバイナリダンプするプログラムを作ってください。（`hd a.out` 相当）

【問1-2:20分】メモリに読み込んだ状態をバイナリダンプするプログラムを作ってください。

【問2-1:1時間】逆アセンブラを作ってください。（`vaxdis a.out` 相当）

【問2-2:1時間】バイナリを実行してください。（`vaxrun a.out` 相当）

※ 以後、問2-2で作ったものを**インタプリタ**と呼びます。

# 少しずつ拡張

先ほど作った小さなバイナリを少しずつ拡張していきます。

## 数値をメモリに書き込む

メモリを操作して出力する文字列を変更します。

```text:write-1.s
.word 0

# write(1, hello, 6);
movl $args1, ap
chmk $4


# r1 = hello;
# *(uint32_t *)r1 = &#39;H&#39;|&#39;E&#39;&lt;&lt;8|&#39;L&#39;&lt;&lt;16|&#39;L&#39;&lt;&lt;24;
movl $hello, r1
movl $&#39;H|&#39;E&lt;8|&#39;L&lt;16|&#39;L&lt;24, (r1)

# write(1, hello, 6);
movl $args1, ap
chmk $4


# exit(0);
movl $args2, ap
chmk $1


.data
args1: .long 3, 1, hello, 6
args2: .long 1, 0
hello: .byte &#39;h, &#39;e, &#39;l, &#39;l, &#39;o, 10
```
```text:実行結果
$ vaxas -o write-1 write-1.s
$ vaxrun write-1
hello
HELLo
```

`-o`で出力ファイル名を指定しています。

### 練習

【問3-1:5分】逆アセンブラを対応させてください。

【問3-2:10分】インタプリタを対応させてください。

## ディスプレースメント

相対アドレス指定によるメモリ操作を行います。

```text:write-2.s
.word 0

# write(1, hello, 6);
movl $args1, ap
chmk $4


# r1 = hello;
# *(uint32_t *)(r1 + 1) = &#39;E&#39;|&#39;L&#39;&lt;&lt;8|&#39;L&#39;&lt;&lt;16|&#39;O&#39;&lt;&lt;24;
movl $hello, r1
movl $&#39;E|&#39;L&lt;8|&#39;L&lt;16|&#39;O&lt;24, 1(r1)

# write(1, hello, 6);
movl $args1, ap
chmk $4


# exit(0);
movl $args2, ap
chmk $1


.data
args1: .long 3, 1, hello, 6
args2: .long 1, 0
hello: .byte &#39;h, &#39;e, &#39;l, &#39;l, &#39;o, 10
```
```text:実行結果
$ vaxas -o write-2 write-2.s
$ vaxrun write-2
hello
hELLO
```

`1(r1)` の `1` は `r1` に対する差分を表します。この差分を**ディスプレースメント**と呼びます。

意味的には `(r1+1)` です。（この構文はエラーになります）

### 練習

【問4-1:5分】逆アセンブラを対応させてください。

【問4-2:10分】インタプリタを対応させてください。

## movb/movw

1文字や2文字の書き替えを行います。

```text:write-3.s
.word 0

# write(1, hello, 6);
movl $args1, ap
chmk $4


# r1 = hello;
# *(uint8_t *)r1 = &#39;H&#39;;
movl $hello, r1
movb $&#39;H, (r1)

# write(1, hello, 6);
movl $args1, ap
chmk $4


# r1 = hello;
# *(uint16_t *)(r1 + 2) = &#39;L&#39;|&#39;L&#39;&lt;&lt;8;
movl $hello, r1
movw $&#39;L|&#39;L&lt;8, 2(r1)

# write(1, hello, 6);
movl $args1, ap
chmk $4


# exit(0);
movl $args2, ap
chmk $1


.data
args1: .long 3, 1, hello, 6
args2: .long 1, 0
hello: .byte &#39;h, &#39;e, &#39;l, &#39;l, &#39;o, 10
```
```text:実行結果
$ vaxas -o write-3 write-3.s
$ vaxrun write-3
hello
Hello
HeLLo
```

`movb` は `byte` 版、`movw` は `word` 版です。

### 練習

【問5-1:5分】逆アセンブラを対応させてください。

【問5-2:10分】インタプリタを対応させてください。

## レジスタの値をメモリに書き込む

数値をいったんレジスタに入れてからメモリに書き込みます。

```text:write-4.s
.word 0

# write(1, hello, 6);
movl $args1, ap
chmk $4


# r1 = hello;
# r0 = &#39;H&#39;|&#39;E&#39;&lt;&lt;8|&#39;L&#39;&lt;&lt;16|&#39;L&#39;&lt;&lt;24;
# *(uint32_t *)r1 = r0;
movl $hello, r1
movl $&#39;H|&#39;E&lt;8|&#39;L&lt;16|&#39;L&lt;24, r0
movl r0, (r1)

# write(1, hello, 6);
movl $args1, ap
chmk $4


# exit(0);
movl $args2, ap
chmk $1


.data
args1: .long 3, 1, hello, 6
args2: .long 1, 0
hello: .byte &#39;h, &#39;e, &#39;l, &#39;l, &#39;o, 10
```
```text:実行結果
$ vaxas -o write-4 write-4.s
$ vaxrun write-4
hello
HELLo
```

### 練習

【問6-1:5分】逆アセンブラを対応させてください。

【問6-2:15分】インタプリタを対応させてください。

## バイト命令

レジスタを `movb` 命令のソースに使うと、下位の値だけが使われます。

```text:write-5.s
.word 0

# write(1, hello, 6);
movl $args1, ap
chmk $4


# r1 = hello;
# r0 = &#39;H&#39;|&#39;E&#39;&lt;&lt;8
# *(uint8_t *)r1 = r0;
movl $hello, r1
movl $&#39;H|&#39;E&lt;8, r0
movb r0, (r1)

# write(1, hello, 6);
movl $args1, ap
chmk $4


# exit(0);
movl $args2, ap
chmk $1


.data
args1: .long 3, 1, hello, 6
args2: .long 1, 0
hello: .byte &#39;h, &#39;e, &#39;l, &#39;l, &#39;o, 10
```
```text:実行結果
$ vaxas -o write-5 write-5.s
$ vaxrun write-5
hello
Hello
```

### 練習

【問7-1:10分】逆アセンブラを対応させてください。

【問7-2:20分】インタプリタを対応させてください。

## アドレスを直接指定

今までメモリは `r1` レジスタ経由でアクセスしていました（これを**間接参照**と呼びます）。アドレスを直接指定でアクセスすることも可能です（これを**直接参照**と呼びます）。

```text:write-6.s
.word 0

# write(1, hello, 6);
movl $args1, ap
chmk $4


# *(uint32_t *)hello = &#39;H&#39;|&#39;E&#39;&lt;&lt;8|&#39;L&#39;&lt;&lt;16|&#39;L&#39;&lt;&lt;24;
movl $&#39;H|&#39;E&lt;8|&#39;L&lt;16|&#39;L&lt;24, hello

# write(1, hello, 6);
movl $args1, ap
chmk $4


# *(uint8_t *)(hello + 4) = &#39;O&#39;;
movb $&#39;O, hello + 4

# write(1, hello, 6);
movl $args1, ap
chmk $4


# exit(0);
movl $args2, ap
chmk $1


.data
args1: .long 3, 1, hello, 6
args2: .long 1, 0
hello: .byte &#39;h, &#39;e, &#39;l, &#39;l, &#39;o, 10
```
```text:実行結果
$ vaxas -o write-6 write-6.s
$ vaxrun write-6
hello
HELLo
HELLO
```

### 相対アドレス

逆アセンブル結果から直接参照の該当箇所を抜き出します。

```text
0000000b: d0 8f 48 45 4c 4c ef 02  movl $0x4c4c4548,0x218
00000013: 02 00 00
```

要素に分解すると、アドレスが直接含まれていないことが分かります。

```text
0000000b: d0              # movl
0000000c: 8f 48 45 4c 4c  # $0x4c4c4548
00000011: ef 02 02 00 00  # 0x218
```

`0x202`→`0x218`となるのは、次の命令を基点とする相対アドレスだからです。

* `0x16`（基点） + `0x202`（相対アドレス） = `0x218`（絶対アドレス）

### 練習

【問8-1:5分】逆アセンブラを対応させてください。

【問8-2:10分】インタプリタを対応させてください。

## 引き算

引き算により小文字から大文字へ変換します。

```text:write-7.s
.word 0

# write(1, hello, 6);
movl $args1, ap
chmk $4


# *(uint32_t *)hello -= 0x20202020;
subl2 $0x20202020, hello

# write(1, hello, 6);
movl $args1, ap
chmk $4


# *(uint8_t *)(hello + 4) -= 0x20;
subb2 $0x20, hello + 4

# write(1, hello, 6);
movl $args1, ap
chmk $4


# exit(0);
movl $args2, ap
chmk $1


.data
args1: .long 3, 1, hello, 6
args2: .long 1, 0
hello: .byte &#39;h, &#39;e, &#39;l, &#39;l, &#39;o, 10
```
```text:実行結果
$ vaxas -o write-7 write-7.s
$ vaxrun write-7
hello
HELLo
HELLO
```

`subl2`や`subb2`の`2`は引数の数です。引数が3つの`subl3`と名前で区別しています。

### 練習

【問9-1:5分】逆アセンブラを対応させてください。

【問9-2:15分】インタプリタを対応させてください。

# 仕様書

今まで推測していた仕様を仕様書で確認してください。

* [VAX MACRO and Instruction Set Reference Manual (英語版の命令セットマニュアル)](http://www2.hmc.edu/www_common/OVMS072-OLD/72final/4515/4515pro.html)

# テストコード集

自作インタプリタで順番に動作させてください。

```1.c
int main() {
    write(1, &quot;hello\n&quot;, 6);
    return 0;
}
```

```2.c
#include &lt;stdio.h&gt;

int main() {
    putchar(&#39;a&#39;);
    return 0;
}
```

```3.c
#include &lt;stdio.h&gt;

int main() {
    printf(&quot;hello\n&quot;);
    return 0;
}
```

```4.c
#include &lt;stdio.h&gt;

int main() {
    int a = 1234;
    printf(&quot;a=%d\n&quot;, a);
    return 0;
}
```

```5.c
#include &lt;stdio.h&gt;

int main(argc, argv)
    int argc;
    char *argv[];
{
    int i;
    for (i = 0; i &lt; argc; ++i) {
        printf(&quot;argv[%d]=%s\n&quot;, i, argv[i]);
    }
    return 0;
}
```

## nm

既存のコマンドを自作インタプリタで動かしてみましょう。

```text
# nm a.out
```

## cc

ccは内部で色々なものを呼んでいます。これらを自作インタプリタで順番に動かして、最終的にはccから一括で処理できることを目指してください。

* `cc 1.c`
    * `/lib/cpp 1.c /tmp/ctm4a`
    * `/lib/ccom /tmp/ctm4a /tmp/ctm3a`
    * `/bin/as -o 1.o /tmp/ctm3a`
    * `/bin/ld -X /lib/crt0.o 1.o /lib/libc.a -l`

自作インタプリタでccを読んでハローワールドのビルドを目指してください。

## カーネルビルドへの道

ハローワールドがビルドできたら、以下の順にカーネルビルドを目指してください。

1. 他のテストコード（2.c～6.c）をビルドする
2. 32Vカーネルをビルドする
3. アセンブラをビルドする
4. コンパイラをビルドする
5. 3と4のセルフホスティングを確認する
6. セルフホスティングしたツールでカーネルをコンパイルする

ここまで出来れば、バイナリのトレース練習は終了です。

次はUNIX/32Vそのものを動かすことに挑戦しましょう！
</textarea><input type="submit" name="commit" value="Save changes" data-disable-with="Save changes" /></form></div></section></div><div class="col-sm-3"><div class="socialButtons"><div class="socialButtons_twitter"><a class="twitter-share-button" data-text="VAXによる機械語入門 by @7shi on @Qiita" data-url="http://qiita.com/7shi/items/e43e8ce0b1a2cadee2a3" href="https://twitter.com/share">Tweet</a></div><div class="socialButtons_hatebu"><a class="hatena-bookmark-button" data-hatena-bookmark-layout="simple-balloon" data-hatena-bookmark-title="VAXによる機械語入門" href="http://b.hatena.ne.jp/entry/http://qiita.com/7shi/items/e43e8ce0b1a2cadee2a3" title="Add to Hatena Bookmark"><img alt="Add to Hatena Bookmark" height="20" src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" style="border: none;" width="20" /></a><script async="async" charset="utf-8" src="https://b.st-hatena.com/js/bookmark_button.js" type="text/javascript"></script></div><div class="socialButtons_googlePlus"><div class="g-plusone" data-href="http://qiita.com/7shi/items/e43e8ce0b1a2cadee2a3" data-size="medium"></div></div><div class="socialButtons_facebook"><div class="fb-like" data-action="like" data-href="http://qiita.com/7shi/items/e43e8ce0b1a2cadee2a3" data-layout="button_count" data-share="false" data-show-faces="false"></div></div><div class="socialButtons_pocket"><a class="pocket-btn" data-lang="en" data-pocket-count="horizontal" data-pocket-label="pocket"></a></div></div><section class="itemsShowAuthorInfo" itemprop="author" itemscope="" itemtype="http://schema.org/Person"><a href="/7shi"><img alt="" class="itemsShowAuthorInfo_userIcon" itemprop="image" src="https://qiita-image-store.s3.amazonaws.com/0/32057/profile-images/1473685823" /></a><div class="itemsShowAuthorInfo_profileStats"><strong class="itemsShowAuthorInfo_userName" itemprop="name"><a itemprop="url" href="/7shi">7shi</a></strong><div class="itemsShowAuthorInfo_contribution"><span class="itemsShowAuthorInfo_count">2522</span><span class="itemsShowAuthorInfo_unit">Contribution</span></div><div data-react-class="T.UserFollowButton" data-react-props="{&quot;url_name&quot;:&quot;7shi&quot;,&quot;initial_followed_by&quot;:false,&quot;size&quot;:&quot;btn-xs&quot;,&quot;position&quot;:&quot;author-info&quot;}"></div></div><section class="itemsShowAuthorPopularItems"><h5 class="itemsShowAuthorPopularItems_sectionTitle">Popular Posts</h5><ul class="itemsShowAuthorPopularItems_posts list-unstyled"><li itemscope="" itemtype="http://schema.org/Article"> <a itemprop="url" track="click" data-label="AuthorPopularItemsAtSidebar" href="/7shi/items/145f1234f8ec2af923ef">Haskell 超入門</a></li><li itemscope="" itemtype="http://schema.org/Article"> <a itemprop="url" track="click" data-label="AuthorPopularItemsAtSidebar" href="/7shi/items/547b6137d7a3c482fe68">モナド則がちょっと分かった？</a></li><li itemscope="" itemtype="http://schema.org/Article"> <a itemprop="url" track="click" data-label="AuthorPopularItemsAtSidebar" href="/7shi/items/cac7b3e9b90bf91b00cc">文字列で学ぶC++入門</a></li><li itemscope="" itemtype="http://schema.org/Article"> <a itemprop="url" track="click" data-label="AuthorPopularItemsAtSidebar" href="/7shi/items/85afd7bbd5d6c4115ad6">Haskell アクション 超入門</a></li><li itemscope="" itemtype="http://schema.org/Article"> <a itemprop="url" track="click" data-label="AuthorPopularItemsAtSidebar" href="/7shi/items/d1e5a0c22be6cf61d286">Haskell IDE Leksah 入門</a></li></ul></section></section><div class="scroll-chaser"><div class="google-adsense"><style>.test-text-responsible { width: 200px; height: 200px; }@media(min-width: 1200px) {  .test-text-responsible { width: 250px; height: 250px; }}@media(max-width: 979px) and (min-width: 768px) {  .test-text-responsible { width: 120px; height: 240px; }}@media(max-width: 767px) {  .test-text-responsible { width: 320px; height: 50px; }}</style><script async="" src="http://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><ins class="adsbygoogle test-text-responsible" data-ad-client="ca-pub-8127218772604357" data-ad-slot="3880091879" style="display:inline-block"></ins><script>(adsbygoogle = window.adsbygoogle || []).push({});</script></div></div><div data-react-class="T.Toc" data-react-props="{&quot;body&quot;:&quot;\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E7%92%B0%E5%A2%83%E8%A8%AD%E5%AE%9A\&quot;\u003e環境設定\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E3%82%B3%E3%83%B3%E3%83%91%E3%82%A4%E3%83%AB\&quot;\u003eコンパイル\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E5%AE%9F%E8%A1%8C\&quot;\u003e実行\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E9%80%86%E3%82%A2%E3%82%BB%E3%83%B3%E3%83%96%E3%83%AB\&quot;\u003e逆アセンブル\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E8%AA%AD%E3%81%BF%E6%96%B9\&quot;\u003e読み方\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B9\&quot;\u003eトレース\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E3%82%B7%E3%83%B3%E3%83%9C%E3%83%AB\&quot;\u003eシンボル\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%82%B5%E3%82%A4%E3%82%BA%E3%81%AE%E7%B8%AE%E5%B0%8F\&quot;\u003eファイルサイズの縮小\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E5%B0%8F%E3%81%95%E3%81%AA%E3%83%90%E3%82%A4%E3%83%8A%E3%83%AA\&quot;\u003e小さなバイナリ\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E3%82%B3%E3%83%BC%E3%83%AB\&quot;\u003eシステムコール\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E9%80%86%E3%82%A2%E3%82%BB%E3%83%B3%E3%83%96%E3%83%AB-1\&quot;\u003e逆アセンブル\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E3%83%90%E3%82%A4%E3%83%8A%E3%83%AA%E3%83%80%E3%83%B3%E3%83%97\&quot;\u003eバイナリダンプ\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E4%BB%95%E6%A7%98\&quot;\u003e仕様\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E3%83%A1%E3%83%A2%E3%83%AA%E3%83%80%E3%83%B3%E3%83%97\&quot;\u003eメモリダンプ\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E7%B7%B4%E7%BF%92\&quot;\u003e練習\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E5%B0%91%E3%81%97%E3%81%9A%E3%81%A4%E6%8B%A1%E5%BC%B5\&quot;\u003e少しずつ拡張\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E6%95%B0%E5%80%A4%E3%82%92%E3%83%A1%E3%83%A2%E3%83%AA%E3%81%AB%E6%9B%B8%E3%81%8D%E8%BE%BC%E3%82%80\&quot;\u003e数値をメモリに書き込む\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E7%B7%B4%E7%BF%92-1\&quot;\u003e練習\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E3%83%87%E3%82%A3%E3%82%B9%E3%83%97%E3%83%AC%E3%83%BC%E3%82%B9%E3%83%A1%E3%83%B3%E3%83%88\&quot;\u003eディスプレースメント\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E7%B7%B4%E7%BF%92-2\&quot;\u003e練習\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#movbmovw\&quot;\u003emovb/movw\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E7%B7%B4%E7%BF%92-3\&quot;\u003e練習\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E3%83%AC%E3%82%B8%E3%82%B9%E3%82%BF%E3%81%AE%E5%80%A4%E3%82%92%E3%83%A1%E3%83%A2%E3%83%AA%E3%81%AB%E6%9B%B8%E3%81%8D%E8%BE%BC%E3%82%80\&quot;\u003eレジスタの値をメモリに書き込む\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E7%B7%B4%E7%BF%92-4\&quot;\u003e練習\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E3%83%90%E3%82%A4%E3%83%88%E5%91%BD%E4%BB%A4\&quot;\u003eバイト命令\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E7%B7%B4%E7%BF%92-5\&quot;\u003e練習\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E3%82%A2%E3%83%89%E3%83%AC%E3%82%B9%E3%82%92%E7%9B%B4%E6%8E%A5%E6%8C%87%E5%AE%9A\&quot;\u003eアドレスを直接指定\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E7%9B%B8%E5%AF%BE%E3%82%A2%E3%83%89%E3%83%AC%E3%82%B9\&quot;\u003e相対アドレス\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E7%B7%B4%E7%BF%92-6\&quot;\u003e練習\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E5%BC%95%E3%81%8D%E7%AE%97\&quot;\u003e引き算\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E7%B7%B4%E7%BF%92-7\&quot;\u003e練習\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E4%BB%95%E6%A7%98%E6%9B%B8\&quot;\u003e仕様書\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E3%83%86%E3%82%B9%E3%83%88%E3%82%B3%E3%83%BC%E3%83%89%E9%9B%86\&quot;\u003eテストコード集\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#nm\&quot;\u003enm\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#cc\&quot;\u003ecc\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB%E3%83%93%E3%83%AB%E3%83%89%E3%81%B8%E3%81%AE%E9%81%93\&quot;\u003eカーネルビルドへの道\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n&quot;,&quot;wrapper&quot;:&quot;#article-body-wrapper&quot;}"></div></div></div><div class="row"><div class="col-sm-9"><div class="ArticleFooter__menu"><div class="s-flex-align-center"><div class="js-likebutton" data-props="{&quot;like_status&quot;:false,&quot;like_count&quot;:7,&quot;show_count&quot;:true,&quot;uuid&quot;:&quot;e43e8ce0b1a2cadee2a3&quot;,&quot;likable_type&quot;:&quot;Article&quot;,&quot;position&quot;:&quot;article-footer&quot;}"></div><div class="ArticleFooter__userList"><div class="ArticleFooter__user"><div class="js-hovercard" data-hovercard-target-name="shuhei"><a itemprop="url" href="/shuhei"><img alt="shuhei" class="thumb thumb--xs" src="https://qiita-image-store.s3.amazonaws.com/0/3732/profile-images/1473683476" /></a></div></div><div class="ArticleFooter__user"><div class="js-hovercard" data-hovercard-target-name="ShigekiKarita"><a itemprop="url" href="/ShigekiKarita"><img alt="ShigekiKarita" class="thumb thumb--xs" src="https://qiita-image-store.s3.amazonaws.com/0/37859/profile-images/1473687564" /></a></div></div><div class="ArticleFooter__user"><div class="js-hovercard" data-hovercard-target-name="heliac2000"><a itemprop="url" href="/heliac2000"><img alt="heliac2000" class="thumb thumb--xs" src="https://qiita-image-store.s3.amazonaws.com/0/44994/profile-images/1473690106" /></a></div></div><div class="ArticleFooter__user"><div class="js-hovercard" data-hovercard-target-name="tateyama"><a itemprop="url" href="/tateyama"><img alt="tateyama" class="thumb thumb--xs" src="https://secure.gravatar.com/avatar/ed63904775780c14c66dba406a3fa034?d=https://a248.e.akamai.net/assets.github.com%2Fimages%2Fgravatars%2Fgravatar-user-420.png" /></a></div></div><div class="ArticleFooter__user"><div class="js-hovercard" data-hovercard-target-name="minewebstaff"><a itemprop="url" href="/minewebstaff"><img alt="minewebstaff" class="thumb thumb--xs" src="https://qiita-image-store.s3.amazonaws.com/0/46049/profile-images/1473690517" /></a></div></div><div class="ArticleFooter__user"><div class="js-hovercard" data-hovercard-target-name="houmei"><a itemprop="url" href="/houmei"><img alt="houmei" class="thumb thumb--xs" src="https://qiita-image-store.s3.amazonaws.com/0/935/profile-images/1473755344" /></a></div></div><div class="ArticleFooter__user"><div class="js-hovercard" data-hovercard-target-name="kosaki"><a itemprop="url" href="/kosaki"><img alt="kosaki" class="thumb thumb--xs" src="https://qiita-image-store.s3.amazonaws.com/0/14289/profile-images/1473683273" /></a></div></div></div></div><div class="u-flex u-align-center"><div class="ArticleFooter__stock"><div class="js-stockbutton" data-position="footer_menu" data-props="{&quot;stock_status&quot;:false}"></div></div><div class="ArticleFooter__editRequest"><a class="u-link-no-underline" data-toggle="tooltip" title="You can propose improvements about the article to the author 💪" href="/drafts/e43e8ce0b1a2cadee2a3/edit"><span class="fa fa-send-o fa-lg"></span> <span>Edit request</span></a></div><div class="dropdown ArticleFooter__dropdown"><a class="dropdown-toggle" data-toggle="dropdown" href="#"><span class="fa fa-ellipsis-h"></span></a><ul class="dropdown-menu dropdown-menu-right"><li><a href="/7shi/items/e43e8ce0b1a2cadee2a3.md"><span class="fa fa-fw fa-file-text-o"></span> Show article as Markdown</a></li><li><a data-target=".js-report-form" data-toggle="modal" href="#"><i class="fa fa-fw fa-flag"></i> Report article</a></li></ul></div></div></div><ul class="references js-referencesView"><li class="references_header"><i class="fa fa-fw fa-link"></i> Linked from these articles</li><li class="references_reference js-reference"><span>Linked from </span><a href="/7shi/items/86724696518df3a174dc#_reference-246d0d243b4afe44ae1b"><img alt="" width="18" height="18" src="https://qiita-image-store.s3.amazonaws.com/0/32057/profile-images/1473685823" />PDP-11による機械語入門</a><time class="references_datetime js-dateTimeView" datetime="2016-02-14T01:58:14+00:00">about 1 year ago</time></li><li class="references_reference js-reference"><span>Linked from </span><a href="/7shi/items/b3911948f9d97b05395e#_reference-a4ea3ebe62b566af2d20"><img alt="" width="18" height="18" src="https://qiita-image-store.s3.amazonaws.com/0/32057/profile-images/1473685823" />8086による機械語入門</a><time class="references_datetime js-dateTimeView" datetime="2016-02-14T01:58:52+00:00">about 1 year ago</time></li></ul><div class="itemsShowBody_articleColumnFooter"><div class="socialButtons"><div class="socialButtons_twitter"><a class="twitter-share-button" data-text="VAXによる機械語入門 by @7shi on @Qiita" data-url="http://qiita.com/7shi/items/e43e8ce0b1a2cadee2a3" href="https://twitter.com/share">Tweet</a></div><div class="socialButtons_hatebu"><a class="hatena-bookmark-button" data-hatena-bookmark-layout="simple-balloon" data-hatena-bookmark-title="VAXによる機械語入門" href="http://b.hatena.ne.jp/entry/http://qiita.com/7shi/items/e43e8ce0b1a2cadee2a3" title="Add to Hatena Bookmark"><img alt="Add to Hatena Bookmark" height="20" src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" style="border: none;" width="20" /></a><script async="async" charset="utf-8" src="https://b.st-hatena.com/js/bookmark_button.js" type="text/javascript"></script></div><div class="socialButtons_googlePlus"><div class="g-plusone" data-href="http://qiita.com/7shi/items/e43e8ce0b1a2cadee2a3" data-size="medium"></div></div><div class="socialButtons_facebook"><div class="fb-like" data-action="like" data-href="http://qiita.com/7shi/items/e43e8ce0b1a2cadee2a3" data-layout="button_count" data-share="false" data-show-faces="false"></div></div><div class="socialButtons_pocket"><a class="pocket-btn" data-lang="en" data-pocket-count="horizontal" data-pocket-label="pocket"></a></div></div></div><div class="itemsShowComment_wrapper" id="comments"><div data-react-class="T.CommentListContainer" data-react-props="{&quot;currentUser&quot;:null,&quot;initialComments&quot;:[],&quot;monthly_public_image_uploadable_size_limit&quot;:null,&quot;total_uploaded_public_image_size_in_current_month&quot;:null,&quot;item&quot;:{&quot;id&quot;:369288,&quot;uuid&quot;:&quot;e43e8ce0b1a2cadee2a3&quot;,&quot;suspended&quot;:false,&quot;secret&quot;:false},&quot;owner&quot;:{&quot;url_name&quot;:&quot;7shi&quot;},&quot;is_team&quot;:false,&quot;is_project&quot;:false,&quot;logged_in&quot;:false,&quot;polling&quot;:false,&quot;mention_candidates&quot;:[{&quot;id&quot;:32057,&quot;url_name&quot;:&quot;7shi&quot;,&quot;profile_image_url&quot;:&quot;https://qiita-image-store.s3.amazonaws.com/0/32057/profile-images/1473685823&quot;}]}">Comments Loading...</div></div></div></div></div></article><div class="js-report-form modal fade reportForm"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><button name="button" type="submit" class="close" data-dismiss="modal">&times;</button><h4 class="modal-title">Report article</h4></div><div class="modal-body"><form action="/reports" accept-charset="UTF-8" method="post"><input name="utf8" type="hidden" value="&#x2713;" /><input type="hidden" name="authenticity_token" value="2c2Awu4iZAgrFZ/GZ38mqyN8XVpQCGCvmqtNPTYtSy63TxuadQxdQ9TGKtoXipjyQzt56cfMOlimdUTG1yNF6A==" /><input type="hidden" name="redirect_path" id="redirect_path" value="/7shi/items/e43e8ce0b1a2cadee2a3" /><input type="hidden" name="item_uuid" id="item_uuid" value="e43e8ce0b1a2cadee2a3" /><p>Help us understand the problem. What is going on with this item?</p><br /><div class="form-group"><ul class="list-unstyled"><li><label><input type="radio" name="report_type" id="report_type_spam" value="spam" required="required" /> It&#39;s spam </label></li><li><label><input type="radio" name="report_type" id="report_type_harassment" value="harassment" required="required" /> It&#39;s abusive or harmful </label></li><li><label><input type="radio" name="report_type" id="report_type_inappropriate_content" value="inappropriate_content" required="required" /> It contains inappropriate content </label></li></ul></div><div class="reportForm_submitButtonContainer"><button name="button" type="submit" class="btn btn-primary reportForm_submitButton"><i class="fa fa-send"></i> Submit</button></div></form></div></div></div></div><script id="js-item" type="application/json">{ "url": "http://qiita.com/7shi/items/e43e8ce0b1a2cadee2a3", "id": 369288, "uuid": "e43e8ce0b1a2cadee2a3" }</script><script class="js-user" type="application/json">{&quot;id&quot;:32057,&quot;url_name&quot;:&quot;7shi&quot;,&quot;profile_image_url&quot;:&quot;https://qiita-image-store.s3.amazonaws.com/0/32057/profile-images/1473685823&quot;}</script><script language="JavaScript" src="//cdn.bigmining.com/private/js/qiita_bigmining.js" type="text/javascript"></script></div><footer class="footer"><div class="footer_inner"><div class="footer_container"><ul class="footer_links-left"><li class="footer_link"><a class="footer_copyright" href="http://increments.co.jp">© 2011-2017 Increments Inc.</a></li><li class="footer_link"><a href="http://qiita.com/terms">Terms</a></li><li class="footer_link"><a href="http://qiita.com/privacy">Privacy</a></li><li class="footer_link"><a href="http://help.qiita.com">Help</a></li><li class="footer_link"><a href="https://increments.zendesk.com/anonymous_requests/new">Contact</a></li></ul><ul class="footer_links-right"><li class="footer_link"><a href="http://qiita.com/about">About</a></li><li class="footer_link"><a href="/users">Users</a></li><li class="footer_link"><a href="/tags">Tags</a></li><li class="footer_link"><a href="http://blog.qiita.com">Blog</a></li><li class="footer_link"><a href="http://qiita.com/api/v2/docs">API</a></li><li class="footer_link"><a href="https://teams.qiita.com/">Team</a></li><li class="footer_link"><a href="http://kobito.qiita.com">Kobito</a></li><li class="footer_link"><a class="js-public-form-feedback-link" data-target=".js-feedback-form" data-toggle="modal" href=""><i class="fa fa-heart"></i> Feedback <i class="fa fa-caret-down"></i></a></li></ul></div></div></footer><div class="js-feedback-form modal fade feedbackForm"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><button name="button" type="submit" class="close" data-dismiss="modal">&times;</button><h4 class="modal-title">Feedback</h4></div><div class="modal-body"><form class="js-feedback-form-form" action="/feedbacks" accept-charset="UTF-8" method="post"><input name="utf8" type="hidden" value="&#x2713;" /><input type="hidden" name="authenticity_token" value="VJ9t6P/CgC6hAyUCmler39gPqY3CjQy/YYhUEGcfXCo6HfawZOy5ZV7QkB7qohWGuEiNPlVJVkhdVl3rhhFS7A==" /><input type="hidden" name="redirect_path" id="redirect_path" value="/7shi/items/e43e8ce0b1a2cadee2a3" /><div class="form-group"><textarea name="feedback[message]" id="feedback_message" class="form-control js-feedback-form-text-area" placeholder="Please give us any feedback about Qiita." required="required" rows="5">
</textarea></div><div class="feedbackForm_submitButtonContainer"><button name="button" type="submit" class="btn btn-primary feedbackForm_submitButton"><i class="fa fa-send"></i> Submit</button><p class="feedbackForm_note">We don&#39;t reply to any feedback.<br />If you need help with Qiita, please send a support request from <a href="https://increments.zendesk.com/anonymous_requests/new">here</a>.</p></div><div style="position:fixed;top:-99999px;opacity:0.0001;"><input name="feedback[name]" type="text" /></div></form></div></div></div></div><script>// if (window.mixpanel instanceof Element) {
//   window.mixpanel = [];
// }
// (function(f,b){if(!b.__SV){var a,e,i,g;window.mixpanel=b;b._i=[];b.init=function(a,e,d){function f(b,h){var a=h.split(".");2==a.length&&(b=b[a[0]],h=a[1]);b[h]=function(){b.push([h].concat(Array.prototype.slice.call(arguments,0)))}}var c=b;"undefined"!==typeof d?c=b[d]=[]:d="mixpanel";c.people=c.people||[];c.toString=function(b){var a="mixpanel";"mixpanel"!==d&&(a+="."+d);b||(a+=" (stub)");return a};c.people.toString=function(){return c.toString(1)+".people (stub)"};i="disable track track_pageview track_links track_forms register register_once alias unregister identify name_tag set_config people.set people.set_once people.increment people.append people.track_charge people.clear_charges people.delete_user".split(" ");
// for(g=0;g<i.length;g++)f(c,i[g]);b._i.push([a,e,d])};b.__SV=1.2;a=f.createElement("script");a.type="text/javascript";a.async=!0;a.src="//cdn.mxpnl.com/libs/mixpanel-2.2.min.js";e=f.getElementsByTagName("script")[0];e.parentNode.insertBefore(a,e)}})(document,window.mixpanel||[]);</script><script src="http://cdn.qiita.com/assets/public-8c6201a66dc6db6f64a9017391c319bf.min.js"></script><script>
  (function () {
    var script = document.getElementsByTagName('script')[0];
    var load = function (src, id) {
      var el = document.createElement('script');
      el.async = true;
      el.src = src;
      el.id = id;
      script.parentNode.insertBefore(el, script);
    };
      // Optimizely
      load('//cdn.optimizely.com/js/52738645.js', 'optimizely-jssdk');
      // Google Analytics
      window._gaq = window._gaq || [];
      var isCareer = location.hostname.split('.')[0] == 'career';
      if (isCareer) {
        window._gaq.push(['_setAccount', 'UA-24675221-11']);
        window._gaq.push(['_setDomainName', 'qiita.com']);
      } else {
        window._gaq.push(['_setAccount', 'UA-24675221-1']);
      }
      window._gaq.push(['_setCustomVar', 1, 'logged_in', 'false', 2]);
      window._gaq.push(['_trackPageview']);
      var src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      load(src, 'google-analytics-jssdk');
    // Google Analytics - Universal Analytics
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-24675221-12', {
          
        });
        ga('set', 'dimension1', 'false');
        ga('set', 'dimension3', 'false');
      ga('require', 'displayfeatures');
      ga('set', 'forceSSL', true);
      ga('send', 'pageview');
    // Google Tag Manager
      (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
      new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
      })(window,document,'script','dataLayer','GTM-TBQWPN');
  })();
</script>
</body></html>