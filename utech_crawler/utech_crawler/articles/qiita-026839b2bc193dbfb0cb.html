<!DOCTYPE html><html xmlns:og="http://ogp.me/ns#"><head><meta charset="UTF-8" /><title>Haskellによる8086逆アセンブラ開発入門 - Qiita</title><meta content="width=device-width,initial-scale=1" name="viewport" /><meta content="8086(16bit x86)の機械語に触れる導入として、Haskellによる逆アセンブラ開発の取っ掛かりを説明します。ここから機械語の勉強を始めることを想定していますので、機械語に関する知識は特に前提とはしていません。

Haskellは初歩的な機能のみ使います。以下の内容を理解していれば十分です。


Haskell 超入門
HUnit 超入門


練習の解答例は別記事に掲載します。


【解答例】Haskellによる8086逆アセンブラ開発入門


この記事のコー..." name="description" /><meta content="summary" name="twitter:card" /><meta content="@Qiita" name="twitter:site" /><meta content="7shi" name="twitter:creator" /><meta content="Haskellによる8086逆アセンブラ開発入門 - Qiita" property="og:title" /><meta content="article" property="og:type" /><meta content="http://qiita.com/7shi/items/026839b2bc193dbfb0cb" property="og:url" /><meta content="http://cdn.qiita.com/assets/qiita-fb-2887e7b4aad86fd8c25cea84846f2236.png" property="og:image" /><meta content="8086(16bit x86)の機械語に触れる導入として、Haskellによる逆アセンブラ開発の取っ掛かりを説明します。ここから機械語の勉強を始めることを想定していますので、機械語に関する知識は特に前提とはしていません。

Haske..." property="og:description" /><meta content="Qiita" property="og:site_name" /><meta content="564524038" property="fb:admins" /><link rel="shortcut icon" type="image/x-icon" href="http://cdn.qiita.com/assets/favicons/public/production-4ff10c1e1e2b5fcb353ff9cafdd56c70.ico" /><link rel="apple-touch-icon" type="image/png" href="http://cdn.qiita.com/assets/favicons/public/apple-touch-icon-f9a6afad761ec2306e10db2736187c8b.png" /><link href="/opensearch.xml" rel="search" title="Qiita" type="application/opensearchdescription+xml" /><link rel="stylesheet" media="all" href="http://cdn.qiita.com/assets/public-e8d29e8ff1879118096f0f5877946857.min.css" /><meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="xM/aGH6LgNNCdP3ajX45R03tFcXLizjnUi3rLmtCK4KweE+k9kZCAJUPZqxnPqA+PSyKeC4irPpFKiVtVwGhJw==" /></head><body class="without-js" id=""><noscript><iframe height="0" src="//www.googletagmanager.com/ns.html?id=GTM-TBQWPN" style="display:none;visibility:hidden" width="0"></iframe></noscript><script>
  document.body.className = document.body.className.replace('without-js', '') + ' with-js';
  window.Qiita = {"asset_host":"cdn.qiita.com","TLD":"com","controller_path":"public/items","controller_action":"public/items#show","controller":"items","action":"show","env":"production","flash":{},"is_landing_page":false,"is_team_page":false,"root_domain":"qiita.com","variant":null,"config":{"mixpanel":{"career":"dd35af27e959781713d63fd7ca898a8d","per_team":"c0a2116368b33b44b5029ebd2cc9b094","public":"be87616606b0e26a87689099aab2c4e5","team":"b7c0342acba2dbc8742484d98788efb3"},"default_locale":"ja","locale":"en"},"team":null,"user":null,"GIT_BRANCH":null,"DEBUG":false};

</script>
<div class="headerContainer headerContainer-public" role="navigation"><div data-react-class="T.HeaderContainer" data-react-props="{&quot;user&quot;:null,&quot;team&quot;:null,&quot;news&quot;:{&quot;type&quot;:&quot;募集&quot;,&quot;content&quot;:&quot;QiitaやQiita:Teamを良くしたいエンジニア&quot;,&quot;url&quot;:&quot;http://increments.co.jp/jobs/engineers?utm_source=qiita\u0026utm_medium=header_news&quot;},&quot;initial_unread_count&quot;:null,&quot;siteid_image&quot;:&quot;http://cdn.qiita.com/siteid-reverse.png&quot;,&quot;is_team_page&quot;:false,&quot;on_team_setting&quot;:false,&quot;show_post_menu&quot;:true,&quot;show_search_menu&quot;:true,&quot;is_fluid&quot;:false,&quot;locale&quot;:&quot;en&quot;}"></div></div><div id="main"><ol class="itemBreadcrumbs" itemscope="" itemtype="http://schema.org/BreadcrumbList"><li itemprop="itemListElement" itemscope="" itemtype="http://schema.org/ListItem"><a itemprop="item" href="/"><span itemprop="name">Qiita</span></a><meta content="1" itemprop="position" /></li><li itemprop="itemListElement" itemscope="" itemtype="http://schema.org/ListItem"><a itemprop="item" href="/items"><span itemprop="name">Items</span></a><meta content="2" itemprop="position" /></li><li itemprop="itemListElement" itemscope="" itemtype="http://schema.org/ListItem"><a itemprop="item" href="/tags/Haskell"><span itemprop="name">Haskell</span></a><meta content="3" itemprop="position" /></li></ol><article itemscope="" itemtype="http://schema.org/Article"><div class="ArticleMainHeader "><div class="container"></div><div class="container"><div class="row s-flex-align-center"><div class="col-sm-9"><h1 class="ArticleMainHeader__title">Haskellによる8086逆アセンブラ開発入門</h1><ul class="TagList"><li class="TagList__item" data-count="1344"><a class="u-link-unstyled TagList__label" href="/tags/Haskell"><img alt="Haskell" class="TagList__icon" src="https://s3-ap-northeast-1.amazonaws.com/qiita-tag-image/373b3b0595a92712b2a45616f53dae97bc1a04e5/medium.jpg?1387913155" /><span>Haskell</span></a></li><li class="TagList__item" data-count="8"><a class="u-link-unstyled TagList__label" href="/tags/Intel8086"><img alt="Intel8086" class="TagList__icon" src="//cdn.qiita.com/assets/icons/medium/missing-2e17009a0b32a6423572b0e6dc56727e.png" /><span>Intel8086</span></a></li></ul></div><div class="col-sm-3"><div class="itemsShowHeaderStock"><ul class="list-unstyled itemsShowHeaderStock_statusList"><li><div class="itemsShowHeaderStock_count stock"><span class="fa fa-thumbs-up"></span><span class="js-likecount">54</span></div><div class="itemsShowHeaderStock_countText">Like</div></li><li><div class="itemsShowHeaderStock_count" content="0 UserComments" itemprop="interactionCount"><span class="fa fa-comment"></span>0</div><div class="itemsShowHeaderStock_countText">Comment</div></li></ul></div><div class="js-likebutton" data-props="{&quot;like_status&quot;:false,&quot;like_count&quot;:54,&quot;uuid&quot;:&quot;026839b2bc193dbfb0cb&quot;,&quot;likable_type&quot;:&quot;Article&quot;,&quot;position&quot;:&quot;article-header&quot;}"></div><ul class="list-inline ArticleMainHeader__users"><li class="js-hovercard" data-hovercard-target-name="quenhulu"><a itemprop="url" href="/quenhulu"><img alt="quenhulu" class="thumb thumb--xs" src="https://qiita-image-store.s3.amazonaws.com/0/14708/profile-images/1473683459" /></a></li><li class="js-hovercard" data-hovercard-target-name="NeXTSTEP2OSX"><a itemprop="url" href="/NeXTSTEP2OSX"><img alt="NeXTSTEP2OSX" class="thumb thumb--xs" src="https://qiita-image-store.s3.amazonaws.com/0/3190/profile-images/1473682757" /></a></li><li class="js-hovercard" data-hovercard-target-name="Reds"><a itemprop="url" href="/Reds"><img alt="Reds" class="thumb thumb--xs" src="https://0.gravatar.com/avatar/e751888e30cdc35253c1a3b241977adf?d=https%3A%2F%2Fidenticons.github.com%2F0e2f15414d97b8b642022be91ff105e0.png" /></a></li><li class="js-hovercard" data-hovercard-target-name="saltheads"><a itemprop="url" href="/saltheads"><img alt="saltheads" class="thumb thumb--xs" src="https://qiita-image-store.s3.amazonaws.com/0/11188/profile-images/1473681944" /></a></li><li class="js-hovercard" data-hovercard-target-name="kasumani"><a itemprop="url" href="/kasumani"><img alt="kasumani" class="thumb thumb--xs" src="https://qiita-image-store.s3.amazonaws.com/0/3397/profile-images/1473683087" /></a></li><li class="js-hovercard" data-hovercard-target-name="SuperAlloyZZ"><a itemprop="url" href="/SuperAlloyZZ"><img alt="SuperAlloyZZ" class="thumb thumb--xs" src="https://qiita-image-store.s3.amazonaws.com/0/46744/profile-images/1473690751" /></a></li><li class="js-hovercard" data-hovercard-target-name="tacke_jp"><a itemprop="url" href="/tacke_jp"><img alt="tacke_jp" class="thumb thumb--xs" src="https://qiita-image-store.s3.amazonaws.com/0/2284/profile-images/1473681378" /></a></li><li class="js-hovercard" data-hovercard-target-name="elfmimi"><a itemprop="url" href="/elfmimi"><img alt="elfmimi" class="thumb thumb--xs" src="https://qiita-image-store.s3.amazonaws.com/0/33067/profile-images/1473686038" /></a></li><li class="js-hovercard" data-hovercard-target-name="katochar"><a itemprop="url" href="/katochar"><img alt="katochar" class="thumb thumb--xs" src="https://qiita-image-store.s3.amazonaws.com/0/14641/profile-images/1473683433" /></a></li><li class="js-hovercard" data-hovercard-target-name="HirotoKagotani"><a itemprop="url" href="/HirotoKagotani"><img alt="HirotoKagotani" class="thumb thumb--xs" src="https://secure.gravatar.com/avatar/0a3d8eae4760b65766757df2475e09df?d=https://a248.e.akamai.net/assets.github.com%2Fimages%2Fgravatars%2Fgravatar-140.png" /></a></li><li><a href="/7shi/items/026839b2bc193dbfb0cb/likers"><span class="fa fa-ellipsis-h"></span></a></li></ul></div></div></div></div><div class="ArticleAsideHeader"><div class="container"><div class="u-flex u-space-between"><div class="u-flex u-flex-wrap"><div class="u-flex u-align-center s-pdv-5 u-flex-wrap"><div class="ArticleAsideHeader__author"><a href="/7shi"><img class="thumb thumb--xs" src="https://qiita-image-store.s3.amazonaws.com/0/32057/profile-images/1473685823" alt="1473685823" /></a> <a class="u-link-unstyled" href="/7shi">7shi</a> </div><div class="ArticleAsideHeader__date"><span data-toggle="tooltip" title="posted at 2014-08-31">Edited at <time datetime="2015-11-09T17:32:51+09:00" itemprop="dateModified">2015-11-09</time></span></div></div><div class="u-flex u-align-center s-pdv-5 mobile-hidden"><div class="ArticleAsideHeader__revision"> <a data-toggle="tooltip" title="Revisions" href="/7shi/items/026839b2bc193dbfb0cb/revisions"><span class="fa fa-history"></span></a><span class="ArticleAsideHeader__revisionCount">45</span></div></div><div class="u-flex u-align-center s-pdv-5 mobile-hidden"></div></div><div class="u-flex u-align-center s-flex-justiry-between s-pdv-5 u-shrink-0"><div class="ArticleAsideHeader__stock"><div class="js-stockbutton" data-position="top" data-props="{&quot;stock_status&quot;:false}"></div></div><div class="dropdown"><a class="dropdown-toggle" data-toggle="dropdown" href="#"><span class="fa fa-ellipsis-h fa-lg"></span></a><ul class="dropdown-menu dropdown-menu-right"><li class="dropdown__item--mobile"><a href="/7shi/items/026839b2bc193dbfb0cb/revisions"><span class="fa fa-fw fa-history"></span> Revisions<span>(45)</span></a></li><li><a href="/7shi/items/026839b2bc193dbfb0cb.md"><span class="fa fa-fw fa-file-text-o"></span> Show article as Markdown</a></li><li><a data-target=".js-report-form" data-toggle="modal" href="#"><span class="fa fa-fw fa-flag"></span> Report article</a></li></ul></div></div></div></div></div><div class="container"><div class="row" id="article-body-wrapper"><div class="col-sm-9"><section class="markdownContent markdownContent-headingEnabled js-task-list-container clearfix position-relative" id="item-026839b2bc193dbfb0cb" itemprop="articleBody"><div class="alert alert-warning"><i class="fa fa-clock-o"></i> More than 1 year has passed since last update.</div><p>8086(16bit x86)の機械語に触れる導入として、Haskellによる逆アセンブラ開発の取っ掛かりを説明します。ここから機械語の勉強を始めることを想定していますので、機械語に関する知識は特に前提とはしていません。</p>

<p>Haskellは初歩的な機能のみ使います。以下の内容を理解していれば十分です。</p>

<ul>
<li><a href="http://qiita.com/7shi/items/145f1234f8ec2af923ef" id="reference-52a67c4347904d6101b9">Haskell 超入門</a></li>
<li><a href="http://qiita.com/7shi/items/9fb326a87de6c3083784" id="reference-70af95f98d221fc50dfb">HUnit 超入門</a></li>
</ul>

<p>練習の解答例は別記事に掲載します。</p>

<ul>
<li><a href="http://qiita.com/7shi/items/6d228b6fc4734f48a33e" id="reference-ac849f1138885c45333c">【解答例】Haskellによる8086逆アセンブラ開発入門</a></li>
</ul>

<p>この記事のコードをまとめたリポジトリです。</p>

<ul>
<li><a href="https://bitbucket.org/7shi/ikebin-hs-2" class="autolink" rel="nofollow noopener" target="_blank">https://bitbucket.org/7shi/ikebin-hs-2</a></li>
</ul>

<p>この記事は勉強会のテキストとして使用していました。</p>

<ul>
<li><a href="http://connpass.com/series/593/" rel="nofollow noopener" target="_blank">機械語入門 - connpass</a></li>
</ul>

<p>この記事には姉妹編があります。</p>

<ul>
<li>
<a href="http://qiita.com/7shi/items/b3911948f9d97b05395e" id="reference-3a38734de33a6e35eedb">8086による機械語入門</a> 2015.11.09</li>
</ul>

<h1>
<span id="2進数" class="fragment"></span><a href="#2%E9%80%B2%E6%95%B0"><i class="fa fa-link"></i></a>2進数</h1>

<p>文字列で指定した2進数を数値に変換する関数です。HUnitのテストも書きます。</p>

<p>※ 使用例をメモする目的で、使用している関数のテストも書いています。</p>

<div class="code-frame" data-lang="hs">
<div class="code-lang"><span class="bold">Main.hs</span></div>
<div class="highlight"><pre>
<span class="kr">import</span> <span class="nn">Test.HUnit</span>
<span class="kr">import</span> <span class="nn">System.IO</span>

<span class="nf">binToInt</span> <span class="n">'0'</span> <span class="ow">=</span> <span class="mi">0</span>
<span class="nf">binToInt</span> <span class="n">'1'</span> <span class="ow">=</span> <span class="mi">1</span>

<span class="nf">binStrToInt</span> <span class="n">bin</span> <span class="ow">=</span> <span class="n">f</span> <span class="p">(</span><span class="n">reverse</span> <span class="n">bin</span><span class="p">)</span>
    <span class="kr">where</span>
        <span class="n">f</span> <span class="s">""</span>     <span class="ow">=</span> <span class="mi">0</span>
        <span class="n">f</span> <span class="p">(</span><span class="n">x</span><span class="kt">:</span><span class="n">xs</span><span class="p">)</span> <span class="ow">=</span> <span class="p">(</span><span class="n">binToInt</span> <span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">f</span> <span class="n">xs</span><span class="p">)</span>

<span class="nf">tests</span> <span class="ow">=</span> <span class="kt">TestList</span>
    <span class="p">[</span> <span class="s">"reverse"</span>       <span class="o">~:</span> <span class="n">reverse</span>     <span class="s">"11001"</span> <span class="o">~?=</span> <span class="s">"10011"</span>
    <span class="p">,</span> <span class="s">"binStrToInt 1"</span> <span class="o">~:</span> <span class="n">binStrToInt</span> <span class="s">"101"</span>   <span class="o">~?=</span> <span class="mi">5</span>
    <span class="p">,</span> <span class="s">"binStrToInt 2"</span> <span class="o">~:</span> <span class="n">binStrToInt</span> <span class="s">"11001"</span> <span class="o">~?=</span> <span class="mi">25</span>
    <span class="p">]</span>

<span class="nf">main</span> <span class="ow">=</span> <span class="kr">do</span>
    <span class="n">runTestText</span> <span class="p">(</span><span class="n">putTextToHandle</span> <span class="n">stderr</span> <span class="kt">False</span><span class="p">)</span> <span class="n">tests</span>
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre>
Cases: 3  Tried: 3  Errors: 0  Failures: 0
</pre></div>
</div>

<p>以降はこのコードに付け足しながら進みます。</p>

<p>⇒ <a href="https://bitbucket.org/7shi/ikebin-hs-2/commits/96bcd8d5477bfe24dae02d12600985cad23b065d" rel="nofollow noopener" target="_blank">リビジョン 0</a></p>

<h2>
<span id="練習" class="fragment"></span><a href="#%E7%B7%B4%E7%BF%92"><i class="fa fa-link"></i></a>練習</h2>

<p>【問1】数値を2進数の文字列に変換する関数<code>bin</code>をテストファーストで作成してください。</p>

<p>⇒ <a href="http://qiita.com/7shi/items/6d228b6fc4734f48a33e#2%E9%80%B2%E6%95%B0" id="reference-ac849f1138885c45333c">解答例</a></p>

<h1>
<span id="16進数" class="fragment"></span><a href="#16%E9%80%B2%E6%95%B0"><i class="fa fa-link"></i></a>16進数</h1>

<h2>
<span id="練習-1" class="fragment"></span><a href="#%E7%B7%B4%E7%BF%92-1"><i class="fa fa-link"></i></a>練習</h2>

<p>【問2】16進数の文字列を数値に変換する関数<code>hexStrToInt</code>をテストファーストで作成してください。</p>

<p>ヒント: <code>Data.Char.digitToInt</code>（<a href="https://hackage.haskell.org/package/base-4.7.0.0/docs/Data-Char.html" rel="nofollow noopener" target="_blank">リファレンス</a>）</p>

<p>【問3】数値を16進数の文字列に変換する関数<code>hex</code>をテストファーストで作成してください。</p>

<p>⇒ <a href="http://qiita.com/7shi/items/6d228b6fc4734f48a33e#16%E9%80%B2%E6%95%B0" id="reference-ac849f1138885c45333c">解答例</a></p>

<h1>
<span id="桁揃え" class="fragment"></span><a href="#%E6%A1%81%E6%8F%83%E3%81%88"><i class="fa fa-link"></i></a>桁揃え</h1>

<p>16進数の頭に0を付加して桁を揃えます。指定した桁から溢れる場合は切り揃えます。</p>

<p>テストファーストを意識して進めます。テストコードの追加分と実装を分けて掲載します。</p>

<div class="code-frame" data-lang="hs">
<div class="code-lang"><span class="bold">テスト</span></div>
<div class="highlight"><pre>
    <span class="p">,</span> <span class="s">"replicate"</span> <span class="o">~:</span> <span class="n">replicate</span> <span class="mi">5</span> <span class="n">'a'</span> <span class="o">~?=</span> <span class="s">"aaaaa"</span>
    <span class="p">,</span> <span class="s">"hexn 1"</span> <span class="o">~:</span> <span class="n">hexn</span> <span class="mi">2</span> <span class="mi">1</span>     <span class="o">~?=</span> <span class="s">"01"</span>
    <span class="p">,</span> <span class="s">"hexn 2"</span> <span class="o">~:</span> <span class="n">hexn</span> <span class="mi">2</span> <span class="mi">255</span>   <span class="o">~?=</span> <span class="s">"ff"</span>
    <span class="p">,</span> <span class="s">"hexn 3"</span> <span class="o">~:</span> <span class="n">hexn</span> <span class="mi">8</span> <span class="mi">65535</span> <span class="o">~?=</span> <span class="s">"0000ffff"</span>
    <span class="p">,</span> <span class="s">"hexn 4"</span> <span class="o">~:</span> <span class="n">hexn</span> <span class="mi">2</span> <span class="mi">256</span>   <span class="o">~?=</span> <span class="s">"00"</span>
</pre></div>
</div>

<div class="code-frame" data-lang="hs"><div class="highlight"><pre>
<span class="nf">hexn</span> <span class="n">n</span> <span class="n">x</span>
    <span class="o">|</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span>     <span class="ow">=</span> <span class="n">drop</span> <span class="p">(</span><span class="o">-</span><span class="n">r</span><span class="p">)</span> <span class="n">x'</span>
    <span class="o">|</span> <span class="n">otherwise</span> <span class="ow">=</span> <span class="n">replicate</span> <span class="n">r</span> <span class="n">'0'</span> <span class="o">++</span> <span class="n">x'</span>
    <span class="kr">where</span>
        <span class="n">x'</span> <span class="ow">=</span> <span class="n">hex</span> <span class="n">x</span>
        <span class="n">r</span>  <span class="ow">=</span> <span class="n">n</span> <span class="o">-</span> <span class="n">length</span> <span class="n">x'</span>
</pre></div></div>

<p><code>replicate</code>はリストを指定した回数だけ繰り返します。</p>

<p>⇒ <a href="https://bitbucket.org/7shi/ikebin-hs-2/commits/15571e57a0158852440720c5d5176b5114e632eb" rel="nofollow noopener" target="_blank">リビジョン 4</a></p>

<h1>
<span id="メモリをリストで表現" class="fragment"></span><a href="#%E3%83%A1%E3%83%A2%E3%83%AA%E3%82%92%E3%83%AA%E3%82%B9%E3%83%88%E3%81%A7%E8%A1%A8%E7%8F%BE"><i class="fa fa-link"></i></a>メモリをリストで表現</h1>

<p>メモリをシミュレートするためバイト区切りのリストを作成します。</p>

<h2>
<span id="16進数文字列リスト" class="fragment"></span><a href="#16%E9%80%B2%E6%95%B0%E6%96%87%E5%AD%97%E5%88%97%E3%83%AA%E3%82%B9%E3%83%88"><i class="fa fa-link"></i></a>16進数文字列→リスト</h2>

<div class="code-frame" data-lang="hs">
<div class="code-lang"><span class="bold">テスト</span></div>
<div class="highlight"><pre>
    <span class="p">,</span> <span class="s">"hexStrToList 1"</span> <span class="o">~:</span> <span class="n">hexStrToList</span> <span class="s">"123456"</span> <span class="o">~?=</span> <span class="p">[</span><span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">]</span>
    <span class="p">,</span> <span class="s">"hexStrToList 2"</span> <span class="o">~:</span> <span class="n">hexStrToList</span> <span class="s">"010203"</span> <span class="o">~?=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
</pre></div>
</div>

<div class="code-frame" data-lang="hs"><div class="highlight"><pre>
<span class="nf">hexStrToList</span> <span class="s">""</span>       <span class="ow">=</span> <span class="kt">[]</span>
<span class="nf">hexStrToList</span> <span class="p">(</span><span class="n">h</span><span class="kt">:</span><span class="n">l</span><span class="kt">:</span><span class="n">xs</span><span class="p">)</span> <span class="ow">=</span> <span class="n">hexStrToInt</span> <span class="p">[</span><span class="n">h</span><span class="p">,</span> <span class="n">l</span><span class="p">]</span> <span class="kt">:</span> <span class="n">hexStrToList</span> <span class="n">xs</span>
</pre></div></div>

<p>⇒ <a href="https://bitbucket.org/7shi/ikebin-hs-2/commits/c16febe858a5e0959b79b2d8bc1fddc9920304ab" rel="nofollow noopener" target="_blank">リビジョン 5</a></p>

<h2>
<span id="リスト16進数文字列" class="fragment"></span><a href="#%E3%83%AA%E3%82%B9%E3%83%8816%E9%80%B2%E6%95%B0%E6%96%87%E5%AD%97%E5%88%97"><i class="fa fa-link"></i></a>リスト→16進数文字列</h2>

<div class="code-frame" data-lang="hs">
<div class="code-lang"><span class="bold">テスト</span></div>
<div class="highlight"><pre>
    <span class="p">,</span> <span class="s">"listToHexStr 1"</span> <span class="o">~:</span> <span class="n">listToHexStr</span> <span class="p">[</span><span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">]</span> <span class="o">~?=</span> <span class="s">"123456"</span>
    <span class="p">,</span> <span class="s">"listToHexStr 2"</span> <span class="o">~:</span> <span class="n">listToHexStr</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>          <span class="o">~?=</span> <span class="s">"010203"</span>
</pre></div>
</div>

<div class="code-frame" data-lang="hs"><div class="highlight"><pre>
<span class="nf">listToHexStr</span> <span class="kt">[]</span>     <span class="ow">=</span> <span class="s">""</span>
<span class="nf">listToHexStr</span> <span class="p">(</span><span class="n">x</span><span class="kt">:</span><span class="n">xs</span><span class="p">)</span> <span class="ow">=</span> <span class="n">hexn</span> <span class="mi">2</span> <span class="n">x</span> <span class="o">++</span> <span class="n">listToHexStr</span> <span class="n">xs</span>
</pre></div></div>

<p>⇒ <a href="https://bitbucket.org/7shi/ikebin-hs-2/commits/8a216e610a94e966c8e7093407c57689a58028ea" rel="nofollow noopener" target="_blank">リビジョン 6</a></p>

<h1>
<span id="バイトオーダー" class="fragment"></span><a href="#%E3%83%90%E3%82%A4%E3%83%88%E3%82%AA%E3%83%BC%E3%83%80%E3%83%BC"><i class="fa fa-link"></i></a>バイトオーダー</h1>

<p>メモリはバイトごとに区切られています。1バイトに収まりきらない数値は分割して格納します。</p>

<p>バイトごと区切って並べる方法にいくつか種類があります。これを<strong>バイトオーダー</strong>と呼びます。</p>

<p>分割した際に逆順に並べ替える方式を<strong>リトルエンディアン</strong>と呼びます。並べ替えない方式は<strong>ビッグエンディアン</strong>です。</p>

<ul>
<li>リトルエンディアン: <code>0x12345678</code> → <code>[0x78, 0x56, 0x34, 0x12]</code>
</li>
<li>ビッグエンディアン: <code>0x12345678</code> → <code>[0x12, 0x34, 0x56, 0x78]</code>
</li>
</ul>

<p>【注意】バイトオーダーを考えるのは分割後です。分割前のバイトオーダーは考えません。</p>

<p>人間の目にはビッグエンディアンの方が直感的ですが、現在主流なのはリトルエンディアンです。今回対象とする8086はリトルエンディアンのみを使います。</p>

<h2>
<span id="数値リトルエンディアン" class="fragment"></span><a href="#%E6%95%B0%E5%80%A4%E3%83%AA%E3%83%88%E3%83%AB%E3%82%A8%E3%83%B3%E3%83%87%E3%82%A3%E3%82%A2%E3%83%B3"><i class="fa fa-link"></i></a>数値→リトルエンディアン</h2>

<p>バイト数を指定してリトルエンディアンを作成します。</p>

<div class="code-frame" data-lang="hs">
<div class="code-lang"><span class="bold">テスト</span></div>
<div class="highlight"><pre>
    <span class="p">,</span> <span class="s">"toLE 1"</span> <span class="o">~:</span> <span class="n">toLE</span> <span class="mi">2</span> <span class="mi">1</span>          <span class="o">~?=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="p">,</span> <span class="s">"toLE 2"</span> <span class="o">~:</span> <span class="n">toLE</span> <span class="mi">2</span> <span class="mh">0x10000</span>    <span class="o">~?=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="p">,</span> <span class="s">"toLE 3"</span> <span class="o">~:</span> <span class="n">toLE</span> <span class="mi">4</span> <span class="mh">0x12345678</span> <span class="o">~?=</span> <span class="p">[</span><span class="mh">0x78</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">]</span>
</pre></div>
</div>

<div class="code-frame" data-lang="hs"><div class="highlight"><pre>
<span class="nf">toLE</span> <span class="mi">0</span> <span class="kr">_</span> <span class="ow">=</span> <span class="kt">[]</span>
<span class="nf">toLE</span> <span class="n">n</span> <span class="n">x</span> <span class="ow">=</span> <span class="n">x</span> <span class="p">`</span><span class="n">mod</span><span class="p">`</span> <span class="mh">0x100</span> <span class="kt">:</span> <span class="n">toLE</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">(</span><span class="n">x</span> <span class="p">`</span><span class="n">div</span><span class="p">`</span> <span class="mh">0x100</span><span class="p">)</span>
</pre></div></div>

<p>⇒ <a href="https://bitbucket.org/7shi/ikebin-hs-2/commits/0a47b791f0c0216b4c3b3c1c61ec7a81854eab73" rel="nofollow noopener" target="_blank">リビジョン 7</a></p>

<h2>
<span id="リトルエンディアン数値" class="fragment"></span><a href="#%E3%83%AA%E3%83%88%E3%83%AB%E3%82%A8%E3%83%B3%E3%83%87%E3%82%A3%E3%82%A2%E3%83%B3%E6%95%B0%E5%80%A4"><i class="fa fa-link"></i></a>リトルエンディアン→数値</h2>

<p>バイト数を指定して数値を読み取ります。</p>

<div class="code-frame" data-lang="hs">
<div class="code-lang"><span class="bold">テスト</span></div>
<div class="highlight"><pre>
    <span class="p">,</span> <span class="s">"fromLE 1"</span> <span class="o">~:</span> <span class="n">fromLE</span> <span class="mi">2</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>                   <span class="o">~?=</span> <span class="mh">0x100</span>
    <span class="p">,</span> <span class="s">"fromLE 2"</span> <span class="o">~:</span> <span class="n">fromLE</span> <span class="mi">2</span> <span class="p">[</span><span class="mh">0x78</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">]</span> <span class="o">~?=</span> <span class="mh">0x5678</span>
    <span class="p">,</span> <span class="s">"fromLE 3"</span> <span class="o">~:</span> <span class="n">fromLE</span> <span class="mi">4</span> <span class="p">[</span><span class="mh">0x78</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">]</span> <span class="o">~?=</span> <span class="mh">0x12345678</span>
</pre></div>
</div>

<div class="code-frame" data-lang="hs"><div class="highlight"><pre>
<span class="nf">fromLE</span> <span class="mi">0</span> <span class="kr">_</span>      <span class="ow">=</span> <span class="mi">0</span>
<span class="nf">fromLE</span> <span class="n">n</span> <span class="p">(</span><span class="n">x</span><span class="kt">:</span><span class="n">xs</span><span class="p">)</span> <span class="ow">=</span> <span class="n">x</span> <span class="o">+</span> <span class="mh">0x100</span> <span class="o">*</span> <span class="n">fromLE</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="n">xs</span>
</pre></div></div>

<p>以上で逆アセンブラ開発の準備は完了です。</p>

<p>⇒ <a href="https://bitbucket.org/7shi/ikebin-hs-2/commits/70d01b4f885becd70833571a180cfc0126215cf9" rel="nofollow noopener" target="_blank">リビジョン 8</a></p>

<h2>
<span id="練習-2" class="fragment"></span><a href="#%E7%B7%B4%E7%BF%92-2"><i class="fa fa-link"></i></a>練習</h2>

<p>【問4】数値⇔ビッグエンディアンの相互変換を実装してください。</p>

<p>ヒント: べき乗（累乗）の演算子は<code>^</code>です。例: <code>2^3</code>（2の3乗）</p>

<p>⇒ <a href="http://qiita.com/7shi/items/6d228b6fc4734f48a33e#%E3%83%93%E3%83%83%E3%82%B0%E3%82%A8%E3%83%B3%E3%83%87%E3%82%A3%E3%82%A2%E3%83%B3" id="reference-ac849f1138885c45333c">解答例</a></p>

<h1>
<span id="ビット演算" class="fragment"></span><a href="#%E3%83%93%E3%83%83%E3%83%88%E6%BC%94%E7%AE%97"><i class="fa fa-link"></i></a>ビット演算</h1>

<p>2進数を対象にしたビット演算という操作があります。</p>

<p>Haskellでは関数名が長くてやや煩雑なため、導入はPythonで行います。簡単な式しか扱わないため、Pythonの知識は前提としません。</p>

<ul>
<li><a href="http://qiita.com/7shi/items/41d262ca11ea16d85abc" id="reference-c10b32f9757909219ca6">Python ビット演算 超入門</a></li>
</ul>

<p>HaskellではPythonとは演算子が異なるため、対応を示します。</p>

<p>※ <code>import Data.Bits</code>が必要です。</p>

<table>
<tr>
<th>操作</th>
<th>Python</th>
<th>Haskell</th>
</tr>
<tr>
<td>左シフト</td>
<td><code>&lt;&lt;</code></td>
<td><code>shiftL</code></td>
</tr>
<tr>
<td>右シフト</td>
<td><code>&gt;&gt;</code></td>
<td><code>shiftR</code></td>
</tr>
<tr>
<td>論理積</td>
<td><code>&amp;</code></td>
<td><code>.&amp;.</code></td>
</tr>
<tr>
<td>論理和</td>
<td><code>|</code></td>
<td><code>.|.</code></td>
</tr>
<tr>
<td>排他的論理和</td>
<td><code>^</code></td>
<td><code>xor</code></td>
</tr>
<tr>
<td>反転</td>
<td><code>~</code></td>
<td><code>complement</code></td>
</tr>
</table>

<p>※ Pythonの演算子はC言語やJavaとも共通です。</p>

<h2>
<span id="練習-3" class="fragment"></span><a href="#%E7%B7%B4%E7%BF%92-3"><i class="fa fa-link"></i></a>練習</h2>

<p>【問5】今まで実装した関数をビット演算で書き換えてください。</p>

<p>⇒ <a href="http://qiita.com/7shi/items/6d228b6fc4734f48a33e#%E3%83%93%E3%83%83%E3%83%88%E6%BC%94%E7%AE%97" id="reference-ac849f1138885c45333c">解答例</a></p>

<h1>
<span id="逆アセンブラ" class="fragment"></span><a href="#%E9%80%86%E3%82%A2%E3%82%BB%E3%83%B3%E3%83%96%E3%83%A9"><i class="fa fa-link"></i></a>逆アセンブラ</h1>

<p>いよいよ逆アセンブラ作りに入ります。</p>

<p>テストが長くなったので、今までのテストは分離します。</p>

<div class="code-frame" data-lang="hs">
<div class="code-lang"><span class="bold">テストを分離</span></div>
<div class="highlight"><pre>
<span class="nf">testHex</span> <span class="ow">=</span> <span class="kt">TestList</span>
    <span class="p">[</span> <span class="s">"reverse"</span>       <span class="o">~:</span> <span class="n">reverse</span>     <span class="s">"11001"</span> <span class="o">~?=</span> <span class="s">"10011"</span>
    <span class="err">（略）</span>
    <span class="p">]</span>
</pre></div>
</div>

<p><a href="https://bitbucket.org/7shi/ikebin/wiki/8086/spec" rel="nofollow noopener" target="_blank">データシート</a>を参照しながら進めます。</p>

<h2>
<span id="mov-ax-imm16" class="fragment"></span><a href="#mov-ax-imm16"><i class="fa fa-link"></i></a>mov ax, imm16</h2>

<p>簡単な命令をndisasmで逆アセンブルします。</p>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">逆アセンブル結果</span></div>
<div class="highlight"><pre>
B83412            mov ax,0x1234
</pre></div>
</div>

<p><code>B83412</code>を機械語、<code>mov</code>をニーモニック、<code>ax</code>や<code>0x1234</code>をオペランドと呼びます。</p>

<p>機械語をリストで渡して逆アセンブルします。</p>

<div class="code-frame" data-lang="hs">
<div class="code-lang"><span class="bold">実装とテスト</span></div>
<div class="highlight"><pre>
<span class="nf">disasm</span> <span class="p">(</span><span class="n">x</span><span class="kt">:</span><span class="n">xs</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">x</span> <span class="o">==</span> <span class="mh">0xb8</span> <span class="ow">=</span>
        <span class="s">"mov ax,0x"</span> <span class="o">++</span> <span class="n">hex</span> <span class="p">(</span><span class="n">fromLE</span> <span class="mi">2</span> <span class="n">xs</span><span class="p">)</span>

<span class="nf">testDisAsm</span> <span class="ow">=</span> <span class="kt">TestList</span>
    <span class="p">[</span> <span class="s">"b8 1"</span> <span class="o">~:</span> <span class="n">disasm</span> <span class="p">[</span><span class="mh">0xb8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>       <span class="o">~?=</span> <span class="s">"mov ax,0x0"</span>
    <span class="p">,</span> <span class="s">"b8 2"</span> <span class="o">~:</span> <span class="n">disasm</span> <span class="p">[</span><span class="mh">0xb8</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">]</span> <span class="o">~?=</span> <span class="s">"mov ax,0x1234"</span>
    <span class="p">]</span>

<span class="nf">main</span> <span class="ow">=</span> <span class="kr">do</span>
    <span class="n">runTestText</span> <span class="p">(</span><span class="n">putTextToHandle</span> <span class="n">stderr</span> <span class="kt">False</span><span class="p">)</span>
        <span class="p">(</span><span class="kt">TestList</span> <span class="p">[</span><span class="n">testHex</span><span class="p">,</span> <span class="n">testDisAsm</span><span class="p">])</span>
</pre></div>
</div>

<p>⇒ <a href="https://bitbucket.org/7shi/ikebin-hs-2/commits/3c05a3626bb6eff3ae33afd7768ad769c68b4d05" rel="nofollow noopener" target="_blank">リビジョン 10</a></p>

<h2>
<span id="文字列渡し" class="fragment"></span><a href="#%E6%96%87%E5%AD%97%E5%88%97%E6%B8%A1%E3%81%97"><i class="fa fa-link"></i></a>文字列渡し</h2>

<p>バイナリを16進数文字列で渡せるようにします。</p>

<div class="code-frame" data-lang="hs">
<div class="code-lang"><span class="bold">テスト</span></div>
<div class="highlight"><pre>
    <span class="p">,</span> <span class="s">"b8 3"</span> <span class="o">~:</span> <span class="n">disasm'</span> <span class="s">"b80000"</span> <span class="o">~?=</span> <span class="s">"mov ax,0x0"</span>
    <span class="p">,</span> <span class="s">"b8 4"</span> <span class="o">~:</span> <span class="n">disasm'</span> <span class="s">"b83412"</span> <span class="o">~?=</span> <span class="s">"mov ax,0x1234"</span>
</pre></div>
</div>

<div class="code-frame" data-lang="hs"><div class="highlight"><pre>
<span class="nf">disasm'</span> <span class="n">hex</span> <span class="ow">=</span> <span class="n">disasm</span> <span class="o">$</span> <span class="n">hexStrToList</span> <span class="n">hex</span>
</pre></div></div>

<p>⇒ <a href="https://bitbucket.org/7shi/ikebin-hs-2/commits/3a5edcd3bb6e7e29b490cd4f965d252c82985004" rel="nofollow noopener" target="_blank">リビジョン 11</a></p>

<h2>
<span id="mov-r16-imm16" class="fragment"></span><a href="#mov-r16-imm16"><i class="fa fa-link"></i></a>mov r16, imm16</h2>

<p>レジスタ番号で処理するように拡張します。</p>

<div class="code-frame" data-lang="hs">
<div class="code-lang"><span class="bold">テスト</span></div>
<div class="highlight"><pre>
    <span class="p">,</span> <span class="s">"b8-bf 0"</span> <span class="o">~:</span> <span class="n">disasm'</span> <span class="s">"b90100"</span> <span class="o">~?=</span> <span class="s">"mov cx,0x1"</span>
    <span class="p">,</span> <span class="s">"b8-bf 1"</span> <span class="o">~:</span> <span class="n">disasm'</span> <span class="s">"ba1000"</span> <span class="o">~?=</span> <span class="s">"mov dx,0x10"</span>
    <span class="p">,</span> <span class="s">"b8-bf 2"</span> <span class="o">~:</span> <span class="n">disasm'</span> <span class="s">"bb0001"</span> <span class="o">~?=</span> <span class="s">"mov bx,0x100"</span>
    <span class="p">,</span> <span class="s">"b8-bf 3"</span> <span class="o">~:</span> <span class="n">disasm'</span> <span class="s">"bc0010"</span> <span class="o">~?=</span> <span class="s">"mov sp,0x1000"</span>
    <span class="p">,</span> <span class="s">"b8-bf 4"</span> <span class="o">~:</span> <span class="n">disasm'</span> <span class="s">"bdff00"</span> <span class="o">~?=</span> <span class="s">"mov bp,0xff"</span>
    <span class="p">,</span> <span class="s">"b8-bf 5"</span> <span class="o">~:</span> <span class="n">disasm'</span> <span class="s">"be00ff"</span> <span class="o">~?=</span> <span class="s">"mov si,0xff00"</span>
    <span class="p">,</span> <span class="s">"b8-bf 6"</span> <span class="o">~:</span> <span class="n">disasm'</span> <span class="s">"bffeca"</span> <span class="o">~?=</span> <span class="s">"mov di,0xcafe"</span>
</pre></div>
</div>

<div class="code-frame" data-lang="hs"><div class="highlight"><pre>
<span class="nf">reg16</span> <span class="ow">=</span> <span class="p">[</span><span class="s">"ax"</span><span class="p">,</span> <span class="s">"cx"</span><span class="p">,</span> <span class="s">"dx"</span><span class="p">,</span> <span class="s">"bx"</span><span class="p">,</span> <span class="s">"sp"</span><span class="p">,</span> <span class="s">"bp"</span><span class="p">,</span> <span class="s">"si"</span><span class="p">,</span> <span class="s">"di"</span><span class="p">]</span>

<span class="nf">disasm</span> <span class="p">(</span><span class="n">x</span><span class="kt">:</span><span class="n">xs</span><span class="p">)</span>
    <span class="o">|</span> <span class="mh">0xb8</span> <span class="o">&lt;=</span> <span class="n">x</span> <span class="o">&amp;&amp;</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="mh">0xbf</span> <span class="ow">=</span>
        <span class="s">"mov "</span> <span class="o">++</span> <span class="n">reg16</span> <span class="o">!!</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="mh">0xb8</span><span class="p">)</span> <span class="o">++</span> <span class="s">",0x"</span> <span class="o">++</span> <span class="n">hex</span> <span class="p">(</span><span class="n">fromLE</span> <span class="mi">2</span> <span class="n">xs</span><span class="p">)</span>
</pre></div></div>

<p>⇒ <a href="https://bitbucket.org/7shi/ikebin-hs-2/commits/128458300876d265dee082a1bbdf7d041f230a23" rel="nofollow noopener" target="_blank">リビジョン 12</a></p>

<h2>
<span id="mov-r8-imm8" class="fragment"></span><a href="#mov-r8-imm8"><i class="fa fa-link"></i></a>mov r8, imm8</h2>

<p>8bitレジスタにも対応します。</p>

<div class="code-frame" data-lang="hs">
<div class="code-lang"><span class="bold">テスト</span></div>
<div class="highlight"><pre>
    <span class="p">,</span> <span class="s">"b0-b7 1"</span> <span class="o">~:</span> <span class="n">disasm'</span> <span class="s">"b000"</span> <span class="o">~?=</span> <span class="s">"mov al,0x0"</span>
    <span class="p">,</span> <span class="s">"b0-b7 2"</span> <span class="o">~:</span> <span class="n">disasm'</span> <span class="s">"b101"</span> <span class="o">~?=</span> <span class="s">"mov cl,0x1"</span>
    <span class="p">,</span> <span class="s">"b0-b7 3"</span> <span class="o">~:</span> <span class="n">disasm'</span> <span class="s">"b210"</span> <span class="o">~?=</span> <span class="s">"mov dl,0x10"</span>
    <span class="p">,</span> <span class="s">"b0-b7 4"</span> <span class="o">~:</span> <span class="n">disasm'</span> <span class="s">"b311"</span> <span class="o">~?=</span> <span class="s">"mov bl,0x11"</span>
    <span class="p">,</span> <span class="s">"b0-b7 5"</span> <span class="o">~:</span> <span class="n">disasm'</span> <span class="s">"b412"</span> <span class="o">~?=</span> <span class="s">"mov ah,0x12"</span>
    <span class="p">,</span> <span class="s">"b0-b7 6"</span> <span class="o">~:</span> <span class="n">disasm'</span> <span class="s">"b5ff"</span> <span class="o">~?=</span> <span class="s">"mov ch,0xff"</span>
    <span class="p">,</span> <span class="s">"b0-b7 7"</span> <span class="o">~:</span> <span class="n">disasm'</span> <span class="s">"b6ee"</span> <span class="o">~?=</span> <span class="s">"mov dh,0xee"</span>
    <span class="p">,</span> <span class="s">"b0-b7 8"</span> <span class="o">~:</span> <span class="n">disasm'</span> <span class="s">"b7ca"</span> <span class="o">~?=</span> <span class="s">"mov bh,0xca"</span>
</pre></div>
</div>

<div class="code-frame" data-lang="hs"><div class="highlight"><pre>
<span class="nf">reg8</span>  <span class="ow">=</span> <span class="p">[</span><span class="s">"al"</span><span class="p">,</span> <span class="s">"cl"</span><span class="p">,</span> <span class="s">"dl"</span><span class="p">,</span> <span class="s">"bl"</span><span class="p">,</span> <span class="s">"ah"</span><span class="p">,</span> <span class="s">"ch"</span><span class="p">,</span> <span class="s">"dh"</span><span class="p">,</span> <span class="s">"bh"</span><span class="p">]</span>

<span class="nf">disasm</span> <span class="p">(</span><span class="n">x</span><span class="kt">:</span><span class="n">xs</span><span class="p">)</span>
    <span class="o">|</span> <span class="mh">0xb0</span> <span class="o">&lt;=</span> <span class="n">x</span> <span class="o">&amp;&amp;</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="mh">0xb7</span> <span class="ow">=</span>
        <span class="s">"mov "</span> <span class="o">++</span> <span class="n">reg8</span>  <span class="o">!!</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="mh">0xb0</span><span class="p">)</span> <span class="o">++</span> <span class="s">",0x"</span> <span class="o">++</span> <span class="n">hex</span> <span class="p">(</span><span class="n">xs</span> <span class="o">!!</span> <span class="mi">0</span><span class="p">)</span>
</pre></div></div>

<p>⇒ <a href="https://bitbucket.org/7shi/ikebin-hs-2/commits/25004806f3318eaa8b113cfbb7fd3f8ddd34147c" rel="nofollow noopener" target="_blank">リビジョン 13</a></p>

<h2>
<span id="8bitと16bitの統合" class="fragment"></span><a href="#8bit%E3%81%A816bit%E3%81%AE%E7%B5%B1%E5%90%88"><i class="fa fa-link"></i></a>8bitと16bitの統合</h2>

<p>wフラグを見て切り替えます。</p>

<div class="code-frame" data-lang="hs"><div class="highlight"><pre>
<span class="nf">regs</span>  <span class="ow">=</span> <span class="p">[</span><span class="n">reg8</span><span class="p">,</span> <span class="n">reg16</span><span class="p">]</span>

<span class="nf">disasm</span> <span class="p">(</span><span class="n">x</span><span class="kt">:</span><span class="n">xs</span><span class="p">)</span>
    <span class="c1">-- DATA TRANSFER</span>
    <span class="c1">-- MOV = Move:</span>
    <span class="c1">-- Immediate to Register [1011wreg][data][data if w=1]</span>
    <span class="o">|</span> <span class="mh">0xb0</span> <span class="o">&lt;=</span> <span class="n">x</span> <span class="o">&amp;&amp;</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="mh">0xbf</span> <span class="ow">=</span>
        <span class="s">"mov "</span> <span class="o">++</span> <span class="n">reg</span> <span class="o">++</span> <span class="s">","</span> <span class="o">++</span> <span class="n">imm</span>
        <span class="kr">where</span>
            <span class="n">w</span> <span class="ow">=</span> <span class="p">(</span><span class="n">x</span> <span class="p">`</span><span class="n">shiftR</span><span class="p">`</span> <span class="mi">3</span><span class="p">)</span> <span class="o">.&amp;.</span> <span class="mi">1</span>
            <span class="n">reg</span> <span class="ow">=</span> <span class="n">regs</span> <span class="o">!!</span> <span class="n">w</span> <span class="o">!!</span> <span class="p">(</span><span class="n">x</span> <span class="o">.&amp;.</span> <span class="mi">7</span><span class="p">)</span>
            <span class="n">imm</span> <span class="ow">=</span> <span class="s">"0x"</span> <span class="o">++</span> <span class="n">hex</span> <span class="p">(</span><span class="n">fromLE</span> <span class="p">(</span><span class="n">w</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="n">xs</span><span class="p">)</span>
</pre></div></div>

<p>⇒ <a href="https://bitbucket.org/7shi/ikebin-hs-2/commits/6eb9fc1e91d364c07a729eeb27c99262ce6f799b" rel="nofollow noopener" target="_blank">リビジョン 14</a></p>

<h2>
<span id="ビットパターン" class="fragment"></span><a href="#%E3%83%93%E3%83%83%E3%83%88%E3%83%91%E3%82%BF%E3%83%BC%E3%83%B3"><i class="fa fa-link"></i></a>ビットパターン</h2>

<p>データシートには機械語が2進数で表記されていますが、ここまでの実装では16進数に変換して範囲チェックしていました。2進数のままパターンマッチできるように修正します。</p>

<h3>
<span id="ビット分解" class="fragment"></span><a href="#%E3%83%93%E3%83%83%E3%83%88%E5%88%86%E8%A7%A3"><i class="fa fa-link"></i></a>ビット分解</h3>

<p>1バイトを8ビットに分解する関数を実装します。</p>

<div class="code-frame" data-lang="hs">
<div class="code-lang"><span class="bold">テスト</span></div>
<div class="highlight"><pre>
    <span class="p">,</span> <span class="s">"getBits"</span> <span class="o">~:</span> <span class="n">getBits</span> <span class="mh">0xbd</span> <span class="o">~?=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>

<div class="code-frame" data-lang="hs"><div class="highlight"><pre>
<span class="nf">getBits</span> <span class="n">x</span> <span class="ow">=</span> <span class="p">(</span><span class="n">b</span> <span class="mi">7</span><span class="p">,</span> <span class="n">b</span> <span class="mi">6</span><span class="p">,</span> <span class="n">b</span> <span class="mi">5</span><span class="p">,</span> <span class="n">b</span> <span class="mi">4</span><span class="p">,</span> <span class="n">b</span> <span class="mi">3</span><span class="p">,</span> <span class="n">b</span> <span class="mi">2</span><span class="p">,</span> <span class="n">b</span> <span class="mi">1</span><span class="p">,</span> <span class="n">b</span> <span class="mi">0</span><span class="p">)</span>
    <span class="kr">where</span>
        <span class="n">b</span> <span class="n">n</span> <span class="ow">=</span> <span class="p">(</span><span class="n">x</span> <span class="p">`</span><span class="n">shiftR</span><span class="p">`</span> <span class="n">n</span><span class="p">)</span> <span class="o">.&amp;.</span> <span class="mi">1</span>
</pre></div></div>

<p>このままではエラーになります。</p>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">エラー内容</span></div>
<div class="highlight"><pre>
No instance for (Bits t0) arising from a use of `getBits'
The type variable `t0' is ambiguous
Possible fix: add a type signature that fixes these type variable(s)
Note: there are several potential instances:
  instance Bits Int -- Defined in `Data.Bits'
  instance Bits Integer -- Defined in `Data.Bits'
  instance Bits ghc-prim:GHC.Types.Word -- Defined in `Data.Bits'
（略）
</pre></div>
</div>

<p>テストで指定した<code>0xbd</code>が<code>Int</code>, <code>Integer</code>, <code>ghc-prim:GHC.Types.Word</code>のどの型か曖昧だというエラーメッセージです。このような場合、関数に型注釈を追加します。</p>

<div class="code-frame" data-lang="hs">
<div class="code-lang"><span class="bold">文法</span></div>
<div class="highlight"><pre>
<span class="err">名前</span> <span class="ow">::</span> <span class="err">引数の型</span> <span class="ow">-&gt;</span> <span class="err">戻り値の型</span>
</pre></div>
</div>

<div class="code-frame" data-lang="hs">
<div class="code-lang"><span class="bold">型注釈</span></div>
<div class="highlight"><pre>
<span class="nf">getBits</span> <span class="ow">::</span> <span class="kt">Int</span> <span class="ow">-&gt;</span> <span class="p">(</span><span class="kt">Int</span><span class="p">,</span><span class="kt">Int</span><span class="p">,</span><span class="kt">Int</span><span class="p">,</span><span class="kt">Int</span><span class="p">,</span><span class="kt">Int</span><span class="p">,</span><span class="kt">Int</span><span class="p">,</span><span class="kt">Int</span><span class="p">,</span><span class="kt">Int</span><span class="p">)</span>
</pre></div>
</div>

<p>これでテストが通ります。</p>

<p>※ 今までは型推論に任せて型注釈は省略していましたが、型注釈を付けるのが一般的です。</p>

<p>⇒ <a href="https://bitbucket.org/7shi/ikebin-hs-2/commits/edd293fceffc3ac2eb3a72c4add8fff3582b5f34" rel="nofollow noopener" target="_blank">リビジョン 15</a></p>

<h3>
<span id="レジスタを再構成" class="fragment"></span><a href="#%E3%83%AC%E3%82%B8%E3%82%B9%E3%82%BF%E3%82%92%E5%86%8D%E6%A7%8B%E6%88%90"><i class="fa fa-link"></i></a>レジスタを再構成</h3>

<p>レジスタは3ビットで表されますが、<code>getBits</code>によってビットごとにばらばらになってしまうため、再構成する関数を実装します。</p>

<div class="code-frame" data-lang="hs">
<div class="code-lang"><span class="bold">テスト</span></div>
<div class="highlight"><pre>
    <span class="p">,</span> <span class="s">"getReg"</span> <span class="o">~:</span> <span class="n">getReg</span> <span class="mi">1</span> <span class="mi">0</span> <span class="mi">1</span> <span class="o">~?=</span> <span class="mi">5</span>
</pre></div>
</div>

<div class="code-frame" data-lang="hs"><div class="highlight"><pre>
<span class="nf">getReg</span> <span class="ow">::</span> <span class="kt">Int</span> <span class="ow">-&gt;</span> <span class="kt">Int</span> <span class="ow">-&gt;</span> <span class="kt">Int</span> <span class="ow">-&gt;</span> <span class="kt">Int</span>
<span class="nf">getReg</span> <span class="n">r</span> <span class="n">e</span> <span class="n">g</span> <span class="ow">=</span>
    <span class="p">(</span><span class="n">r</span> <span class="p">`</span><span class="n">shiftL</span><span class="p">`</span> <span class="mi">2</span><span class="p">)</span> <span class="o">.|.</span> <span class="p">(</span><span class="n">e</span> <span class="p">`</span><span class="n">shiftL</span><span class="p">`</span> <span class="mi">1</span><span class="p">)</span> <span class="o">.|.</span> <span class="n">g</span>
</pre></div></div>

<p>これもエラー回避のため型注釈が必要です。</p>

<p>引数が複数ある場合は、このように引数を1つずつ<code>-&gt;</code>で区切って書きます。最後が戻り値の型です。</p>

<div class="code-frame" data-lang="hs">
<div class="code-lang"><span class="bold">文法</span></div>
<div class="highlight"><pre>
<span class="err">名前</span> <span class="ow">::</span> <span class="err">引数の型</span> <span class="ow">-&gt;</span> <span class="err">引数の型</span> <span class="ow">-&gt;</span> <span class="err">引数の型</span> <span class="ow">-&gt;</span> <span class="err">戻り値の型</span>
</pre></div>
</div>

<p>※ このような表記になるのはカリー化が関係していますが、詳細は省略します。</p>

<p>⇒ <a href="https://bitbucket.org/7shi/ikebin-hs-2/commits/4704a40d14012be20e6f8df33d56cfe88d6fc72d" rel="nofollow noopener" target="_blank">リビジョン 16</a></p>

<h3>
<span id="ビットでパターンマッチ" class="fragment"></span><a href="#%E3%83%93%E3%83%83%E3%83%88%E3%81%A7%E3%83%91%E3%82%BF%E3%83%BC%E3%83%B3%E3%83%9E%E3%83%83%E3%83%81"><i class="fa fa-link"></i></a>ビットでパターンマッチ</h3>

<p><code>disasm</code>でビット分解してパターンマッチ用に<code>disasmB</code>を追加します。</p>

<div class="code-frame" data-lang="hs"><div class="highlight"><pre>
<span class="nf">disasm</span> <span class="p">(</span><span class="n">x</span><span class="kt">:</span><span class="n">xs</span><span class="p">)</span> <span class="ow">=</span> <span class="n">disasmB</span> <span class="p">(</span><span class="n">getBits</span> <span class="n">x</span><span class="p">)</span> <span class="n">xs</span>

<span class="c1">-- DATA TRANSFER</span>
<span class="c1">-- MOV = Move:</span>
<span class="c1">-- Immediate to Register [1011wreg][data][data if w=1]</span>
<span class="nf">disasmB</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">g</span><span class="p">)</span> <span class="n">xs</span> <span class="ow">=</span>
    <span class="s">"mov "</span> <span class="o">++</span> <span class="n">reg</span> <span class="o">++</span> <span class="s">","</span> <span class="o">++</span> <span class="n">imm</span>
    <span class="kr">where</span>
        <span class="n">reg</span> <span class="ow">=</span> <span class="n">regs</span> <span class="o">!!</span> <span class="n">w</span> <span class="o">!!</span> <span class="n">getReg</span> <span class="n">r</span> <span class="n">e</span> <span class="n">g</span>
        <span class="n">imm</span> <span class="ow">=</span> <span class="s">"0x"</span> <span class="o">++</span> <span class="n">hex</span> <span class="p">(</span><span class="n">fromLE</span> <span class="p">(</span><span class="n">w</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="n">xs</span><span class="p">)</span>
</pre></div></div>

<p>データシートに近い表記で実装することを意図しています。</p>

<p>⇒ <a href="https://bitbucket.org/7shi/ikebin-hs-2/commits/e395d8ae25cab1e16df392adc9996f945f203252" rel="nofollow noopener" target="_blank">リビジョン 17</a></p>

<h2>
<span id="mov続き" class="fragment"></span><a href="#mov%E7%B6%9A%E3%81%8D"><i class="fa fa-link"></i></a>mov（続き）</h2>

<p>movを進めていきます。</p>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">データシートより</span></div>
<div class="highlight"><pre>
Register/Memory to/from Register [100010dw][mod reg r/m]
</pre></div>
</div>

<p>このパターンに合わせてデータを作ります。最初の1バイトを列挙します。</p>

<ul>
<li>
<code>10001000 00000000</code> → <code>88 00</code>
</li>
<li>
<code>10001001 00000000</code> → <code>89 00</code>
</li>
<li>
<code>10001010 00000000</code> → <code>8A 00</code>
</li>
<li>
<code>10001011 00000000</code> → <code>8B 00</code>
</li>
</ul>

<p>バイナリエディタで16進数を打ち込みます。この作業を<strong>ハンドアセンブル</strong>と呼びます。</p>

<p>機械語をアセンブリ言語に変換する処理を<strong>逆アセンブル</strong>と呼びます。</p>

<ul>
<li>アセンブル: アセンブリ言語 → 機械語</li>
<li>逆アセンブル: 機械語 → アセンブリ言語</li>
</ul>

<p>ndisasmで逆アセンブルします。</p>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">逆アセンブル結果</span></div>
<div class="highlight"><pre>
00000000  8800              mov [bx+si],al
00000002  8900              mov [bx+si],ax
00000004  8A00              mov al,[bx+si]
00000006  8B00              mov ax,[bx+si]
</pre></div>
</div>

<p><code>d</code>がオペランドの順番、<code>w</code>がレジスタサイズを表します。modとr/mで1つのオペランドを表します。（以後ModR/M）</p>

<div class="code-frame" data-lang="hs">
<div class="code-lang"><span class="bold">テスト</span></div>
<div class="highlight"><pre>
    <span class="p">,</span> <span class="s">"88-8b mod=00,r/m=000 1"</span> <span class="o">~:</span> <span class="n">disasm'</span> <span class="s">"8800"</span> <span class="o">~?=</span> <span class="s">"mov [bx+si],al"</span>
    <span class="p">,</span> <span class="s">"88-8b mod=00,r/m=000 2"</span> <span class="o">~:</span> <span class="n">disasm'</span> <span class="s">"8900"</span> <span class="o">~?=</span> <span class="s">"mov [bx+si],ax"</span>
    <span class="p">,</span> <span class="s">"88-8b mod=00,r/m=000 3"</span> <span class="o">~:</span> <span class="n">disasm'</span> <span class="s">"8A00"</span> <span class="o">~?=</span> <span class="s">"mov al,[bx+si]"</span>
    <span class="p">,</span> <span class="s">"88-8b mod=00,r/m=000 4"</span> <span class="o">~:</span> <span class="n">disasm'</span> <span class="s">"8B00"</span> <span class="o">~?=</span> <span class="s">"mov ax,[bx+si]"</span>
</pre></div>
</div>

<p>ModR/Mを処理する関数を実装してオペランドとregをタプルで返します。まず<code>[bx+si]</code>のみを実装します。</p>

<div class="code-frame" data-lang="hs"><div class="highlight"><pre>
<span class="nf">modrm</span> <span class="p">(</span><span class="n">x</span><span class="kt">:</span><span class="kr">_</span><span class="p">)</span> <span class="ow">=</span> <span class="p">(</span><span class="n">f</span> <span class="n">mode</span> <span class="n">rm</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span>
    <span class="kr">where</span>
        <span class="n">mode</span> <span class="ow">=</span>  <span class="n">x</span> <span class="p">`</span><span class="n">shiftR</span><span class="p">`</span> <span class="mi">6</span>
        <span class="n">reg</span>  <span class="ow">=</span> <span class="p">(</span><span class="n">x</span> <span class="p">`</span><span class="n">shiftR</span><span class="p">`</span> <span class="mi">3</span><span class="p">)</span> <span class="o">.&amp;.</span> <span class="mi">7</span>
        <span class="n">rm</span>   <span class="ow">=</span>  <span class="n">x</span>             <span class="o">.&amp;.</span> <span class="mi">7</span>
        <span class="n">f</span> <span class="mi">0</span> <span class="mi">0</span> <span class="ow">=</span> <span class="s">"[bx+si]"</span>
</pre></div></div>

<p>これを使って逆アセンブラを実装します。</p>

<div class="code-frame" data-lang="hs"><div class="highlight"><pre>
<span class="c1">-- Register/Memory to/from Register [100010dw][mod reg r/m]</span>
<span class="nf">disasmB</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">w</span><span class="p">)</span> <span class="n">xs</span>
    <span class="o">|</span> <span class="n">d</span> <span class="o">==</span> <span class="mi">0</span>    <span class="ow">=</span> <span class="s">"mov "</span> <span class="o">++</span> <span class="n">rm</span>  <span class="o">++</span> <span class="s">","</span> <span class="o">++</span> <span class="n">reg</span>
    <span class="o">|</span> <span class="n">otherwise</span> <span class="ow">=</span> <span class="s">"mov "</span> <span class="o">++</span> <span class="n">reg</span> <span class="o">++</span> <span class="s">","</span> <span class="o">++</span> <span class="n">rm</span>
    <span class="kr">where</span>
        <span class="p">(</span><span class="n">rm</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span> <span class="ow">=</span> <span class="n">modrm</span> <span class="n">xs</span>
        <span class="n">reg</span> <span class="ow">=</span> <span class="n">regs</span> <span class="o">!!</span> <span class="n">w</span> <span class="o">!!</span> <span class="n">r</span>
</pre></div></div>

<p>⇒ <a href="https://bitbucket.org/7shi/ikebin-hs-2/commits/32c4f32acc3686b01e6c6f646989a6dcc97c72e5" rel="nofollow noopener" target="_blank">リビジョン 18</a></p>

<h2>
<span id="rm" class="fragment"></span><a href="#rm"><i class="fa fa-link"></i></a>r/m</h2>

<p>r/mを増やして変化を確認します。</p>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">逆アセンブル結果</span></div>
<div class="highlight"><pre>
00000000  8901              mov [bx+di],ax
00000002  8902              mov [bp+si],ax
00000004  8903              mov [bp+di],ax
00000006  8904              mov [si],ax
00000008  8905              mov [di],ax
0000000A  89068907          mov [0x789],ax
</pre></div>
</div>

<p><code>8906</code>と<code>8907</code>がくっ付いています。</p>

<h2>
<span id="即値によるアドレス指定" class="fragment"></span><a href="#%E5%8D%B3%E5%80%A4%E3%81%AB%E3%82%88%E3%82%8B%E3%82%A2%E3%83%89%E3%83%AC%E3%82%B9%E6%8C%87%E5%AE%9A"><i class="fa fa-link"></i></a>即値によるアドレス指定</h2>

<p><code>8906</code>は mod = 00, r/m = 110 です。そのパターンを調べます。</p>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">逆アセンブル結果</span></div>
<div class="highlight"><pre>
00000000  88063412          mov [0x1234],al
00000004  89063412          mov [0x1234],ax
00000008  8A063412          mov al,[0x1234]
0000000C  8B063412          mov ax,[0x1234]
</pre></div>
</div>

<p><code>modrm</code>を拡張します。</p>

<div class="code-frame" data-lang="hs">
<div class="code-lang"><span class="bold">テスト</span></div>
<div class="highlight"><pre>
    <span class="p">,</span> <span class="s">"88-8b mod=00,r/m=110 1"</span> <span class="o">~:</span> <span class="n">disasm'</span> <span class="s">"88063412"</span> <span class="o">~?=</span> <span class="s">"mov [0x1234],al"</span>
    <span class="p">,</span> <span class="s">"88-8b mod=00,r/m=110 2"</span> <span class="o">~:</span> <span class="n">disasm'</span> <span class="s">"89063412"</span> <span class="o">~?=</span> <span class="s">"mov [0x1234],ax"</span>
    <span class="p">,</span> <span class="s">"88-8b mod=00,r/m=110 3"</span> <span class="o">~:</span> <span class="n">disasm'</span> <span class="s">"8A063412"</span> <span class="o">~?=</span> <span class="s">"mov al,[0x1234]"</span>
    <span class="p">,</span> <span class="s">"88-8b mod=00,r/m=110 4"</span> <span class="o">~:</span> <span class="n">disasm'</span> <span class="s">"8B063412"</span> <span class="o">~?=</span> <span class="s">"mov ax,[0x1234]"</span>
</pre></div>
</div>

<div class="code-frame" data-lang="hs"><div class="highlight"><pre>
<span class="nf">modrm</span> <span class="p">(</span><span class="n">x</span><span class="kt">:</span><span class="n">xs</span><span class="p">)</span> <span class="ow">=</span> <span class="p">(</span><span class="n">f</span> <span class="n">mode</span> <span class="n">rm</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span>
    <span class="kr">where</span>
        <span class="n">mode</span> <span class="ow">=</span>  <span class="n">x</span> <span class="p">`</span><span class="n">shiftR</span><span class="p">`</span> <span class="mi">6</span>
        <span class="n">reg</span>  <span class="ow">=</span> <span class="p">(</span><span class="n">x</span> <span class="p">`</span><span class="n">shiftR</span><span class="p">`</span> <span class="mi">3</span><span class="p">)</span> <span class="o">.&amp;.</span> <span class="mi">7</span>
        <span class="n">rm</span>   <span class="ow">=</span>  <span class="n">x</span>             <span class="o">.&amp;.</span> <span class="mi">7</span>
        <span class="n">f</span> <span class="mi">0</span> <span class="mi">0</span> <span class="ow">=</span> <span class="s">"[bx+si]"</span>
        <span class="n">f</span> <span class="mi">0</span> <span class="mi">6</span> <span class="ow">=</span> <span class="s">"[0x"</span> <span class="o">++</span> <span class="n">hex</span> <span class="p">(</span><span class="n">fromLE</span> <span class="mi">2</span> <span class="n">xs</span><span class="p">)</span> <span class="o">++</span> <span class="s">"]"</span>
</pre></div></div>

<p>⇒ <a href="https://bitbucket.org/7shi/ikebin-hs-2/commits/fcca40e56e06a7bd35498739a0de9a90cefff3fe" rel="nofollow noopener" target="_blank">リビジョン 19</a></p>

<h2>
<span id="レジスタによるアドレス指定" class="fragment"></span><a href="#%E3%83%AC%E3%82%B8%E3%82%B9%E3%82%BF%E3%81%AB%E3%82%88%E3%82%8B%E3%82%A2%E3%83%89%E3%83%AC%E3%82%B9%E6%8C%87%E5%AE%9A"><i class="fa fa-link"></i></a>レジスタによるアドレス指定</h2>

<p>すべての組み合わせに対応させるため、仕様書からアドレス指定の組み合わせを調べて、アセンブリ言語でテストを書きます。</p>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">test.s</span></div>
<div class="highlight"><pre>
mov [bx+si],ax
mov [bx+di],cx
mov [bp+si],dx
mov [bp+di],bx
mov [si],sp
mov [di],bp
mov [bp],si
mov [bx],di
</pre></div>
</div>

<p>nasmでアセンブルしたものをndisasmで逆アセンブルします。</p>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">逆アセンブル結果</span></div>
<div class="highlight"><pre>
00000000  8900              mov [bx+si],ax
00000002  8909              mov [bx+di],cx
00000004  8912              mov [bp+si],dx
00000006  891B              mov [bp+di],bx
00000008  8924              mov [si],sp
0000000A  892D              mov [di],bp
0000000C  897600            mov [bp+0x0],si
0000000F  893F              mov [bx],di
</pre></div>
</div>

<p><code>[bp]</code>は機械語のパターンが異なるため除外します。（アドレス指定に割り当てられているため）</p>

<p>アドレスの組み合わせを定義して<code>modrm</code>を拡張します。</p>

<div class="code-frame" data-lang="hs">
<div class="code-lang"><span class="bold">テスト</span></div>
<div class="highlight"><pre>
    <span class="p">,</span> <span class="s">"88-8b mod=00 1"</span> <span class="o">~:</span> <span class="n">disasm'</span> <span class="s">"8900"</span> <span class="o">~?=</span> <span class="s">"mov [bx+si],ax"</span>
    <span class="p">,</span> <span class="s">"88-8b mod=00 2"</span> <span class="o">~:</span> <span class="n">disasm'</span> <span class="s">"8909"</span> <span class="o">~?=</span> <span class="s">"mov [bx+di],cx"</span>
    <span class="p">,</span> <span class="s">"88-8b mod=00 3"</span> <span class="o">~:</span> <span class="n">disasm'</span> <span class="s">"8912"</span> <span class="o">~?=</span> <span class="s">"mov [bp+si],dx"</span>
    <span class="p">,</span> <span class="s">"88-8b mod=00 4"</span> <span class="o">~:</span> <span class="n">disasm'</span> <span class="s">"891b"</span> <span class="o">~?=</span> <span class="s">"mov [bp+di],bx"</span>
    <span class="p">,</span> <span class="s">"88-8b mod=00 5"</span> <span class="o">~:</span> <span class="n">disasm'</span> <span class="s">"8924"</span> <span class="o">~?=</span> <span class="s">"mov [si],sp"</span>
    <span class="p">,</span> <span class="s">"88-8b mod=00 6"</span> <span class="o">~:</span> <span class="n">disasm'</span> <span class="s">"892d"</span> <span class="o">~?=</span> <span class="s">"mov [di],bp"</span>
    <span class="p">,</span> <span class="s">"88-8b mod=00 7"</span> <span class="o">~:</span> <span class="n">disasm'</span> <span class="s">"893f"</span> <span class="o">~?=</span> <span class="s">"mov [bx],di"</span>
</pre></div>
</div>

<div class="code-frame" data-lang="hs"><div class="highlight"><pre>
<span class="nf">regad</span> <span class="ow">=</span> <span class="p">[</span><span class="s">"bx+si"</span><span class="p">,</span> <span class="s">"bx+di"</span><span class="p">,</span> <span class="s">"bp+si"</span><span class="p">,</span> <span class="s">"bp+di"</span><span class="p">,</span> <span class="s">"si"</span><span class="p">,</span> <span class="s">"di"</span><span class="p">,</span> <span class="s">"bp"</span><span class="p">,</span> <span class="s">"bx"</span><span class="p">]</span>

<span class="nf">modrm</span> <span class="p">(</span><span class="n">x</span><span class="kt">:</span><span class="n">xs</span><span class="p">)</span> <span class="ow">=</span> <span class="p">(</span><span class="n">f</span> <span class="n">mode</span> <span class="n">rm</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span>
    <span class="kr">where</span>
        <span class="n">mode</span> <span class="ow">=</span>  <span class="n">x</span> <span class="p">`</span><span class="n">shiftR</span><span class="p">`</span> <span class="mi">6</span>
        <span class="n">reg</span>  <span class="ow">=</span> <span class="p">(</span><span class="n">x</span> <span class="p">`</span><span class="n">shiftR</span><span class="p">`</span> <span class="mi">3</span><span class="p">)</span> <span class="o">.&amp;.</span> <span class="mi">7</span>
        <span class="n">rm</span>   <span class="ow">=</span>  <span class="n">x</span>             <span class="o">.&amp;.</span> <span class="mi">7</span>
        <span class="n">f</span> <span class="mi">0</span> <span class="mi">6</span>  <span class="ow">=</span> <span class="s">"[0x"</span> <span class="o">++</span> <span class="n">hex</span> <span class="p">(</span><span class="n">fromLE</span> <span class="mi">2</span> <span class="n">xs</span><span class="p">)</span> <span class="o">++</span> <span class="s">"]"</span>
        <span class="n">f</span> <span class="mi">0</span> <span class="n">rm</span> <span class="ow">=</span> <span class="s">"["</span> <span class="o">++</span> <span class="n">regad</span> <span class="o">!!</span> <span class="n">rm</span> <span class="o">++</span> <span class="s">"]"</span>
</pre></div></div>

<p>⇒ <a href="https://bitbucket.org/7shi/ikebin-hs-2/commits/32833f18954ea2e4d975627b0284069aefbf1b9c" rel="nofollow noopener" target="_blank">リビジョン 20</a></p>

<h2>
<span id="ディスプレースメント" class="fragment"></span><a href="#%E3%83%87%E3%82%A3%E3%82%B9%E3%83%97%E3%83%AC%E3%83%BC%E3%82%B9%E3%83%A1%E3%83%B3%E3%83%88"><i class="fa fa-link"></i></a>ディスプレースメント</h2>

<p>アドレスに対する差分をディスプレースメントと呼びます。<code>[bp]</code>は<code>[bp+0]</code>で表現します。</p>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">逆アセンブル結果</span></div>
<div class="highlight"><pre>
00000000  894001            mov [bx+si+0x1],ax
00000003  8949FF            mov [bx+di-0x1],cx
00000006  895202            mov [bp+si+0x2],dx
00000009  895BFE            mov [bp+di-0x2],bx
0000000C  896464            mov [si+0x64],sp
0000000F  896D9C            mov [di-0x64],bp
00000012  897600            mov [bp+0x0],si
00000015  897601            mov [bp+0x1],si
00000018  897F01            mov [bx+0x1],di
</pre></div>
</div>

<p>ディスプレースメントは符号付きです。符号の考え方は次の記事を参照してください。</p>

<ul>
<li><a href="http://qiita.com/7shi/items/6887e7939c0168a0eb21" id="reference-94db5f8bad9887ffd75b">符号あり数値の直感的な考え方</a></li>
</ul>

<p>符号付きで文字列化する関数を用意します。</p>

<div class="code-frame" data-lang="hs">
<div class="code-lang"><span class="bold">テスト</span></div>
<div class="highlight"><pre>
    <span class="p">,</span> <span class="s">"disp8 1"</span> <span class="o">~:</span> <span class="n">disp8</span> <span class="mi">0</span>    <span class="o">~?=</span> <span class="s">"+0x0"</span>
    <span class="p">,</span> <span class="s">"disp8 2"</span> <span class="o">~:</span> <span class="n">disp8</span> <span class="mh">0x7f</span> <span class="o">~?=</span> <span class="s">"+0x7f"</span>
    <span class="p">,</span> <span class="s">"disp8 3"</span> <span class="o">~:</span> <span class="n">disp8</span> <span class="mh">0x80</span> <span class="o">~?=</span> <span class="s">"-0x80"</span>
    <span class="p">,</span> <span class="s">"disp8 4"</span> <span class="o">~:</span> <span class="n">disp8</span> <span class="mh">0xff</span> <span class="o">~?=</span> <span class="s">"-0x1"</span>
</pre></div>
</div>

<div class="code-frame" data-lang="hs"><div class="highlight"><pre>
<span class="nf">disp8</span> <span class="n">x</span>
    <span class="o">|</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mh">0x80</span>  <span class="ow">=</span> <span class="s">"+0x"</span> <span class="o">++</span> <span class="n">hex</span> <span class="n">x</span>
    <span class="o">|</span> <span class="n">otherwise</span> <span class="ow">=</span> <span class="s">"-0x"</span> <span class="o">++</span> <span class="n">hex</span> <span class="p">(</span><span class="mh">0x100</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span>
</pre></div></div>

<p>⇒ <a href="https://bitbucket.org/7shi/ikebin-hs-2/commits/42f5510f9632448d256d7b7b2d38e71458c3735a" rel="nofollow noopener" target="_blank">リビジョン 21</a></p>

<p><code>modrm</code>を拡張します。</p>

<div class="code-frame" data-lang="hs">
<div class="code-lang"><span class="bold">テスト</span></div>
<div class="highlight"><pre>
    <span class="p">,</span> <span class="s">"88-8b mod=01 1"</span> <span class="o">~:</span> <span class="n">disasm'</span> <span class="s">"894001"</span> <span class="o">~?=</span> <span class="s">"mov [bx+si+0x1],ax"</span>
    <span class="p">,</span> <span class="s">"88-8b mod=01 2"</span> <span class="o">~:</span> <span class="n">disasm'</span> <span class="s">"8949FF"</span> <span class="o">~?=</span> <span class="s">"mov [bx+di-0x1],cx"</span>
    <span class="p">,</span> <span class="s">"88-8b mod=01 3"</span> <span class="o">~:</span> <span class="n">disasm'</span> <span class="s">"895202"</span> <span class="o">~?=</span> <span class="s">"mov [bp+si+0x2],dx"</span>
    <span class="p">,</span> <span class="s">"88-8b mod=01 4"</span> <span class="o">~:</span> <span class="n">disasm'</span> <span class="s">"895BFE"</span> <span class="o">~?=</span> <span class="s">"mov [bp+di-0x2],bx"</span>
    <span class="p">,</span> <span class="s">"88-8b mod=01 5"</span> <span class="o">~:</span> <span class="n">disasm'</span> <span class="s">"896464"</span> <span class="o">~?=</span> <span class="s">"mov [si+0x64],sp"</span>
    <span class="p">,</span> <span class="s">"88-8b mod=01 6"</span> <span class="o">~:</span> <span class="n">disasm'</span> <span class="s">"896D9C"</span> <span class="o">~?=</span> <span class="s">"mov [di-0x64],bp"</span>
    <span class="p">,</span> <span class="s">"88-8b mod=01 7"</span> <span class="o">~:</span> <span class="n">disasm'</span> <span class="s">"897600"</span> <span class="o">~?=</span> <span class="s">"mov [bp+0x0],si"</span>
    <span class="p">,</span> <span class="s">"88-8b mod=01 8"</span> <span class="o">~:</span> <span class="n">disasm'</span> <span class="s">"897601"</span> <span class="o">~?=</span> <span class="s">"mov [bp+0x1],si"</span>
    <span class="p">,</span> <span class="s">"88-8b mod=01 9"</span> <span class="o">~:</span> <span class="n">disasm'</span> <span class="s">"897F01"</span> <span class="o">~?=</span> <span class="s">"mov [bx+0x1],di"</span>
</pre></div>
</div>

<div class="code-frame" data-lang="hs"><div class="highlight"><pre>
<span class="nf">modrm</span> <span class="p">(</span><span class="n">x</span><span class="kt">:</span><span class="n">xs</span><span class="p">)</span> <span class="ow">=</span> <span class="p">(</span><span class="n">f</span> <span class="n">mode</span> <span class="n">rm</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span>
    <span class="kr">where</span>
        <span class="n">mode</span> <span class="ow">=</span>  <span class="n">x</span> <span class="p">`</span><span class="n">shiftR</span><span class="p">`</span> <span class="mi">6</span>
        <span class="n">reg</span>  <span class="ow">=</span> <span class="p">(</span><span class="n">x</span> <span class="p">`</span><span class="n">shiftR</span><span class="p">`</span> <span class="mi">3</span><span class="p">)</span> <span class="o">.&amp;.</span> <span class="mi">7</span>
        <span class="n">rm</span>   <span class="ow">=</span>  <span class="n">x</span>             <span class="o">.&amp;.</span> <span class="mi">7</span>
        <span class="n">f</span> <span class="mi">0</span> <span class="mi">6</span>  <span class="ow">=</span> <span class="s">"[0x"</span> <span class="o">++</span> <span class="n">hex</span> <span class="p">(</span><span class="n">fromLE</span> <span class="mi">2</span> <span class="n">xs</span><span class="p">)</span> <span class="o">++</span> <span class="s">"]"</span>
        <span class="n">f</span> <span class="mi">0</span> <span class="n">rm</span> <span class="ow">=</span> <span class="s">"["</span> <span class="o">++</span> <span class="n">regad</span> <span class="o">!!</span> <span class="n">rm</span> <span class="o">++</span> <span class="s">"]"</span>
        <span class="n">f</span> <span class="mi">1</span> <span class="n">rm</span> <span class="ow">=</span> <span class="s">"["</span> <span class="o">++</span> <span class="n">regad</span> <span class="o">!!</span> <span class="n">rm</span> <span class="o">++</span> <span class="n">disp</span> <span class="o">++</span> <span class="s">"]"</span>
            <span class="kr">where</span>
                <span class="n">disp</span> <span class="ow">=</span> <span class="n">disp8</span> <span class="p">(</span><span class="n">xs</span> <span class="o">!!</span> <span class="mi">0</span><span class="p">)</span>
</pre></div></div>

<p>⇒ <a href="https://bitbucket.org/7shi/ikebin-hs-2/commits/8584a735790030fc0e0bf809e9742db5587f8643" rel="nofollow noopener" target="_blank">リビジョン 22</a></p>

<h1>
<span id="ファイルの分割" class="fragment"></span><a href="#%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%AE%E5%88%86%E5%89%B2"><i class="fa fa-link"></i></a>ファイルの分割</h1>

<p>1ファイルが長くなって来たので分割します。</p>

<p>Leksahでの設定方法を説明します。Leksahについては以下を参照してください。</p>

<ul>
<li><a href="http://qiita.com/7shi/items/d1e5a0c22be6cf61d286" id="reference-9b399cf42242ca1f02ad">Haskell IDE Leksah 入門</a></li>
</ul>

<p>まずMain.hsの先頭にモジュール宣言を書いておきます。1ファイルだけのときは不要でしたが、ファイルを分割するときには必要となります。モジュール名はファイル名の拡張子を除いた部分と同じにします。</p>

<div class="code-frame" data-lang="hs">
<div class="code-lang"><span class="bold">Main.hsの先頭</span></div>
<div class="highlight"><pre>
<span class="kr">module</span> <span class="nn">Main</span> <span class="kr">where</span>
</pre></div>
</div>

<h2>
<span id="hex" class="fragment"></span><a href="#hex"><i class="fa fa-link"></i></a>Hex</h2>

<ul>
<li>File → New Module

<ul>
<li>Hex と入力 → [OK]</li>
</ul>
</li>
</ul>

<p>新規作成されたファイルの中身をすべて消します。</p>

<p>※ 中身を理解しないまま流用することによる問題を回避するための措置です。</p>

<p>ファイルの先頭にモジュール名を書いて、コードを移します。</p>

<div class="code-frame" data-lang="hs">
<div class="code-lang"><span class="bold">Hex.hs</span></div>
<div class="highlight"><pre>
<span class="kr">module</span> <span class="nn">Hex</span> <span class="kr">where</span>
</pre></div>
</div>

<p>Mainから参照します。</p>

<div class="code-frame" data-lang="hs">
<div class="code-lang"><span class="bold">Main.hsに追加</span></div>
<div class="highlight"><pre>
<span class="kr">import</span> <span class="nn">Hex</span>
</pre></div>
</div>

<p>⇒ <a href="https://bitbucket.org/7shi/ikebin-hs-2/commits/3429014aa59dff855f430a3417a26b274cf7c664" rel="nofollow noopener" target="_blank">リビジョン 23</a></p>

<h2>
<span id="disasm" class="fragment"></span><a href="#disasm"><i class="fa fa-link"></i></a>DisAsm</h2>

<p>逆アセンブラも同様に分割します。</p>

<ul>
<li>File → New Module

<ul>
<li>DisAsm と入力 → [OK]</li>
</ul>
</li>
</ul>

<p>新規作成されたファイルの中身をすべて消します。</p>

<p>ファイルの先頭にモジュール名を書いて、コードを移します。</p>

<div class="code-frame" data-lang="hs">
<div class="code-lang"><span class="bold">DisAsm.hs</span></div>
<div class="highlight"><pre>
<span class="kr">module</span> <span class="nn">DisAsm</span> <span class="kr">where</span>
</pre></div>
</div>

<p>Mainから参照します。</p>

<div class="code-frame" data-lang="hs">
<div class="code-lang"><span class="bold">Main.hsに追加</span></div>
<div class="highlight"><pre>
<span class="kr">import</span> <span class="nn">DisAsm</span>
</pre></div>
</div>

<p>逆アセンブラのテストはMainに残したままにした方が、テストと実装を行ったり来たりするのに都合が良いでしょう。</p>

<p>⇒ <a href="https://bitbucket.org/7shi/ikebin-hs-2/commits/ae2d0fe643bed2a78ccdb5289f891081863c1c76" rel="nofollow noopener" target="_blank">リビジョン 24</a></p>

<h1>
<span id="練習-4" class="fragment"></span><a href="#%E7%B7%B4%E7%BF%92-4"><i class="fa fa-link"></i></a>練習</h1>

<p>【問6】以下の手順で<code>modrm</code>の実装を完成させてください。</p>

<ol>
<li>mod=10,11の機械語をバイナリエディタで作る。</li>
<li>ndisasmで逆アセンブルしてアセンブリ言語を確認する。</li>
<li>テストケースを作る。</li>
<li>逆アセンブラを実装する。</li>
</ol>

<p>⇒ <a href="http://qiita.com/7shi/items/6d228b6fc4734f48a33e#modrm" id="reference-ac849f1138885c45333c">解答例</a></p>

<p>【問7】mov命令の2番目<code>Immediate to Register/Memory</code>を実装してください。</p>

<p>⇒ <a href="http://qiita.com/7shi/items/6d228b6fc4734f48a33e#mov%E5%91%BD%E4%BB%A4%E3%81%AE2%E7%95%AA%E7%9B%AE" id="reference-ac849f1138885c45333c">解答例</a></p>

<p>【問8】mov命令の残りを実装してください。</p>

<p>⇒ <a href="http://qiita.com/7shi/items/6d228b6fc4734f48a33e#mov%E5%91%BD%E4%BB%A4%E3%81%AE%E6%AE%8B%E3%82%8A" id="reference-ac849f1138885c45333c">解答例</a></p>

<p>【問9】<code>disasm</code>が命令の長さも返すように修正してください。想定される仕様をテストの修正として示します。仕様変更が<code>disasm'</code>にまで及ぶとテストの修正が大変なため、与えられたバイナリの長さと比較する修正を提示します。</p>

<div class="code-frame" data-lang="hs">
<div class="code-lang"><span class="bold">テストの修正</span></div>
<div class="highlight"><pre>
    <span class="p">[</span> <span class="s">"b8 1"</span> <span class="o">~:</span> <span class="n">disasm</span> <span class="p">[</span><span class="mh">0xb8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>       <span class="o">~?=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">"mov ax,0x0"</span><span class="p">)</span>
    <span class="p">,</span> <span class="s">"b8 2"</span> <span class="o">~:</span> <span class="n">disasm</span> <span class="p">[</span><span class="mh">0xb8</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">]</span> <span class="o">~?=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">"mov ax,0x1234"</span><span class="p">)</span>
</pre></div>
</div>

<div class="code-frame" data-lang="hs">
<div class="code-lang"><span class="bold">disasm'の修正</span></div>
<div class="highlight"><pre>
<span class="nf">disasm'</span> <span class="n">hex</span>
    <span class="o">|</span> <span class="n">length</span> <span class="n">bin</span> <span class="o">==</span> <span class="n">len</span> <span class="ow">=</span> <span class="n">snd</span> <span class="n">asm</span>
    <span class="o">|</span> <span class="n">otherwise</span>         <span class="ow">=</span> <span class="s">"length? "</span> <span class="o">++</span> <span class="n">show</span> <span class="n">len</span>
    <span class="kr">where</span>
        <span class="n">bin</span> <span class="ow">=</span> <span class="n">hexStrToList</span> <span class="n">hex</span>
        <span class="n">asm</span> <span class="ow">=</span> <span class="n">disasm</span> <span class="n">bin</span>
        <span class="n">len</span> <span class="ow">=</span> <span class="n">fst</span> <span class="n">asm</span>
</pre></div>
</div>

<ul>
<li>
<code>show</code>は引数を文字列に変換する関数です。</li>
</ul>

<p>⇒ <a href="http://qiita.com/7shi/items/6d228b6fc4734f48a33e#%E9%95%B7%E3%81%95%E3%82%82%E8%BF%94%E3%81%99" id="reference-ac849f1138885c45333c">解答例</a></p>

<p>【問10】複数の命令を含んだバイナリを渡すと逆アセンブル結果をリストで返す関数を実装してください。具体的には以下のテストを通してください。</p>

<div class="code-frame" data-lang="hs">
<div class="code-lang"><span class="bold">テスト</span></div>
<div class="highlight"><pre>
    <span class="p">,</span> <span class="s">"disasms"</span> <span class="o">~:</span> <span class="n">disasms</span> <span class="p">[</span><span class="mh">0xc6</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0xb0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="o">~?=</span> <span class="p">[(</span><span class="mi">4</span><span class="p">,</span> <span class="s">"mov byte [bx+0x1],0x1"</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">"mov al,0x1"</span><span class="p">)]</span>
    <span class="p">,</span> <span class="s">"disasms'"</span> <span class="o">~:</span> <span class="n">disasms'</span> <span class="s">"C6470101B001"</span>
        <span class="o">~?=</span> <span class="p">[</span><span class="s">"mov byte [bx+0x1],0x1"</span><span class="p">,</span> <span class="s">"mov al,0x1"</span><span class="p">]</span>
</pre></div>
</div>

<p>⇒ <a href="http://qiita.com/7shi/items/6d228b6fc4734f48a33e#%E8%A4%87%E6%95%B0%E5%91%BD%E4%BB%A4%E5%AF%BE%E5%BF%9C" id="reference-ac849f1138885c45333c">解答例</a></p>

<p>【問11】逆アセンブル結果にアドレスやダンプを含めてndisasmと同じ出力にしてください。具体的には以下のテストを通してください。</p>

<div class="code-frame" data-lang="hs">
<div class="code-lang"><span class="bold">テスト</span></div>
<div class="highlight"><pre>
    <span class="p">,</span> <span class="s">"ndisasm"</span> <span class="o">~:</span> <span class="n">ndisasm</span> <span class="mi">0</span> <span class="p">[</span><span class="mh">0xc6</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="o">~?=</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">"00000000  C6470101          mov byte [bx+0x1],0x1"</span><span class="p">)</span>
    <span class="p">,</span> <span class="s">"ndisasms"</span> <span class="o">~:</span> <span class="n">ndisasms</span> <span class="mi">0</span> <span class="p">[</span><span class="mh">0xc6</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0xb0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="o">~?=</span> <span class="p">[</span> <span class="s">"00000000  C6470101          mov byte [bx+0x1],0x1"</span>
            <span class="p">,</span> <span class="s">"00000004  B001              mov al,0x1"</span>
            <span class="p">]</span>
</pre></div>
</div>

<ul>
<li>第一引数は開始アドレスです。</li>
</ul>

<p>⇒ <a href="http://qiita.com/7shi/items/6d228b6fc4734f48a33e#ndisasm%E6%BA%96%E6%8B%A0%E5%87%BA%E5%8A%9B" id="reference-ac849f1138885c45333c">解答例</a></p>

<h1>
<span id="ファイル読み込み" class="fragment"></span><a href="#%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%81%BF"><i class="fa fa-link"></i></a>ファイル読み込み</h1>

<p><code>main</code>でコマンドライン引数を調べて、何も指定されていなければテスト、ファイルが指定されていれば読み込んで逆アセンブルするコードを示します。</p>

<p>依存パッケージにbytestringを追加してください。</p>

<div class="code-frame" data-lang="hs">
<div class="code-lang"><span class="bold">importに追加</span></div>
<div class="highlight"><pre>
<span class="kr">import</span> <span class="nn">System.Environment</span>
<span class="kr">import</span> <span class="k">qualified</span> <span class="nn">Data.ByteString</span>
</pre></div>
</div>

<p><code>qualified</code>を指定すると使用する際に名前空間まで付ける必要があります（例: <code>Data.ByteString.readFile</code>）。元々あった関数と同名の関数（例: <code>readFile</code>）が衝突するのを回避しています。</p>

<div class="code-frame" data-lang="hs">
<div class="code-lang"><span class="bold">mainを修正</span></div>
<div class="highlight"><pre>
<span class="nf">main</span> <span class="ow">=</span> <span class="kr">do</span>
    <span class="n">args</span> <span class="ow">&lt;-</span> <span class="n">getArgs</span>
    <span class="kr">if</span> <span class="n">args</span> <span class="o">==</span> <span class="kt">[]</span>
        <span class="kr">then</span> <span class="kr">do</span>
            <span class="n">runTestText</span> <span class="p">(</span><span class="n">putTextToHandle</span> <span class="n">stderr</span> <span class="kt">False</span><span class="p">)</span>
                <span class="p">(</span><span class="kt">TestList</span> <span class="p">[</span><span class="n">testHex</span><span class="p">,</span> <span class="n">testDisAsm</span><span class="p">])</span>
            <span class="n">return</span> <span class="nb">()</span>
        <span class="kr">else</span> <span class="kr">do</span>
            <span class="n">bytes</span> <span class="ow">&lt;-</span> <span class="kt">Data</span><span class="o">.</span><span class="kt">ByteString</span><span class="o">.</span><span class="n">readFile</span> <span class="o">$</span> <span class="n">args</span> <span class="o">!!</span> <span class="mi">0</span>
            <span class="n">putStr</span> <span class="o">$</span> <span class="n">unlines</span> <span class="o">$</span> <span class="n">ndisasms</span> <span class="mi">0</span>
                <span class="p">[</span><span class="n">fromIntegral</span> <span class="n">b</span> <span class="o">|</span> <span class="n">b</span> <span class="ow">&lt;-</span> <span class="kt">Data</span><span class="o">.</span><span class="kt">ByteString</span><span class="o">.</span><span class="n">unpack</span> <span class="n">bytes</span><span class="p">]</span>
</pre></div>
</div>

<p><code>&lt;-</code>はリスト内包表記の中か外かで意味が変わります。リスト内包表記の外で使われている<code>&lt;-</code>はアクションから値を取り出す構文です。<code>&lt;-</code>は<code>do</code>を指定したブロックでしか使えません。詳細は次の記事を参照してください。</p>

<ul>
<li><a href="http://qiita.com/7shi/items/85afd7bbd5d6c4115ad6" id="reference-4713f824d94e60633b82">Haskell アクション 超入門</a></li>
</ul>

<p>コマンドラインからファイルを指定して呼び出し、逆アセンブルできることを確認してください。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre>
$ ./disasm test
00000000  C60012            mov byte [bx+si],0x12
00000003  C606123456        mov byte [0x3412],0x56
00000008  C6401234          mov byte [bx+si+0x12],0x34
0000000C  C680123456        mov byte [bx+si+0x3412],0x56
00000011  B012              mov al,0x12
00000013  C7001234          mov word [bx+si],0x3412
00000017  C70612345678      mov word [0x3412],0x7856
0000001D  C740123456        mov word [bx+si+0x12],0x5634
00000022  C78012345678      mov word [bx+si+0x3412],0x7856
00000028  B81234            mov ax,0x3412
</pre></div></div>

<p>⇒ <a href="https://bitbucket.org/7shi/ikebin-hs-2/commits/a03cf4c04dfe23105a2a253edb3d1da2e4d6b95e" rel="nofollow noopener" target="_blank">リビジョン 32</a></p>

<h1>
<span id="練習-5" class="fragment"></span><a href="#%E7%B7%B4%E7%BF%92-5"><i class="fa fa-link"></i></a>練習</h1>

<p>【問12】8086の全命令を実装してください。</p>

<p>※ 解答例はありません。</p>
<div class="hidden"><form class="js-task-list-update" action="/7shi/items/026839b2bc193dbfb0cb" accept-charset="UTF-8" method="post"><input name="utf8" type="hidden" value="&#x2713;" /><input type="hidden" name="_method" value="patch" /><input type="hidden" name="authenticity_token" value="uk8xTjAgRT54qA55wpq8UMqSI+tsZRSgD8g047s0ugXO+KTyuO2H7a/TlQ8o2iUpulO8VonMgL0Yz/qgh3cwoA==" /><input type="hidden" name="updated_at_confirmation_in_unixtime" id="updated_at_confirmation_in_unixtime" value="1447057971" class="js-task-list-updated-at" /><textarea name="raw_body" id="raw_body" class="js-task-list-field">
8086(16bit x86)の機械語に触れる導入として、Haskellによる逆アセンブラ開発の取っ掛かりを説明します。ここから機械語の勉強を始めることを想定していますので、機械語に関する知識は特に前提とはしていません。

Haskellは初歩的な機能のみ使います。以下の内容を理解していれば十分です。

* [Haskell 超入門](http://qiita.com/7shi/items/145f1234f8ec2af923ef)
* [HUnit 超入門](http://qiita.com/7shi/items/9fb326a87de6c3083784)

練習の解答例は別記事に掲載します。

* [【解答例】Haskellによる8086逆アセンブラ開発入門](http://qiita.com/7shi/items/6d228b6fc4734f48a33e)

この記事のコードをまとめたリポジトリです。

* https://bitbucket.org/7shi/ikebin-hs-2

この記事は勉強会のテキストとして使用していました。

* [機械語入門 - connpass](http://connpass.com/series/593/)

この記事には姉妹編があります。

* [8086による機械語入門](http://qiita.com/7shi/items/b3911948f9d97b05395e) 2015.11.09

# 2進数

文字列で指定した2進数を数値に変換する関数です。HUnitのテストも書きます。

※ 使用例をメモする目的で、使用している関数のテストも書いています。

```hs:Main.hs
import Test.HUnit
import System.IO

binToInt &#39;0&#39; = 0
binToInt &#39;1&#39; = 1

binStrToInt bin = f (reverse bin)
    where
        f &quot;&quot;     = 0
        f (x:xs) = (binToInt x) + 2 * (f xs)

tests = TestList
    [ &quot;reverse&quot;       ~: reverse     &quot;11001&quot; ~?= &quot;10011&quot;
    , &quot;binStrToInt 1&quot; ~: binStrToInt &quot;101&quot;   ~?= 5
    , &quot;binStrToInt 2&quot; ~: binStrToInt &quot;11001&quot; ~?= 25
    ]

main = do
    runTestText (putTextToHandle stderr False) tests
```
```text:実行結果
Cases: 3  Tried: 3  Errors: 0  Failures: 0
```

以降はこのコードに付け足しながら進みます。

⇒ [リビジョン 0](https://bitbucket.org/7shi/ikebin-hs-2/commits/96bcd8d5477bfe24dae02d12600985cad23b065d)

## 練習

【問1】数値を2進数の文字列に変換する関数`bin`をテストファーストで作成してください。

⇒ [解答例](http://qiita.com/7shi/items/6d228b6fc4734f48a33e#2%E9%80%B2%E6%95%B0)

# 16進数

## 練習

【問2】16進数の文字列を数値に変換する関数`hexStrToInt`をテストファーストで作成してください。

ヒント: `Data.Char.digitToInt`（[リファレンス](https://hackage.haskell.org/package/base-4.7.0.0/docs/Data-Char.html)）

【問3】数値を16進数の文字列に変換する関数`hex`をテストファーストで作成してください。

⇒ [解答例](http://qiita.com/7shi/items/6d228b6fc4734f48a33e#16%E9%80%B2%E6%95%B0)

# 桁揃え

16進数の頭に0を付加して桁を揃えます。指定した桁から溢れる場合は切り揃えます。

テストファーストを意識して進めます。テストコードの追加分と実装を分けて掲載します。

```hs:テスト
    , &quot;replicate&quot; ~: replicate 5 &#39;a&#39; ~?= &quot;aaaaa&quot;
    , &quot;hexn 1&quot; ~: hexn 2 1     ~?= &quot;01&quot;
    , &quot;hexn 2&quot; ~: hexn 2 255   ~?= &quot;ff&quot;
    , &quot;hexn 3&quot; ~: hexn 8 65535 ~?= &quot;0000ffff&quot;
    , &quot;hexn 4&quot; ~: hexn 2 256   ~?= &quot;00&quot;
```
```hs
hexn n x
    | r &lt; 0     = drop (-r) x&#39;
    | otherwise = replicate r &#39;0&#39; ++ x&#39;
    where
        x&#39; = hex x
        r  = n - length x&#39;
```

`replicate`はリストを指定した回数だけ繰り返します。

⇒ [リビジョン 4](https://bitbucket.org/7shi/ikebin-hs-2/commits/15571e57a0158852440720c5d5176b5114e632eb)

# メモリをリストで表現

メモリをシミュレートするためバイト区切りのリストを作成します。

## 16進数文字列→リスト

```hs:テスト
    , &quot;hexStrToList 1&quot; ~: hexStrToList &quot;123456&quot; ~?= [0x12, 0x34, 0x56]
    , &quot;hexStrToList 2&quot; ~: hexStrToList &quot;010203&quot; ~?= [1, 2, 3]
```
```hs
hexStrToList &quot;&quot;       = []
hexStrToList (h:l:xs) = hexStrToInt [h, l] : hexStrToList xs
```

⇒ [リビジョン 5](https://bitbucket.org/7shi/ikebin-hs-2/commits/c16febe858a5e0959b79b2d8bc1fddc9920304ab)

## リスト→16進数文字列

```hs:テスト
    , &quot;listToHexStr 1&quot; ~: listToHexStr [0x12, 0x34, 0x56] ~?= &quot;123456&quot;
    , &quot;listToHexStr 2&quot; ~: listToHexStr [1, 2, 3]          ~?= &quot;010203&quot;
```
```hs
listToHexStr []     = &quot;&quot;
listToHexStr (x:xs) = hexn 2 x ++ listToHexStr xs
```

⇒ [リビジョン 6](https://bitbucket.org/7shi/ikebin-hs-2/commits/8a216e610a94e966c8e7093407c57689a58028ea)

# バイトオーダー

メモリはバイトごとに区切られています。1バイトに収まりきらない数値は分割して格納します。

バイトごと区切って並べる方法にいくつか種類があります。これを**バイトオーダー**と呼びます。

分割した際に逆順に並べ替える方式を**リトルエンディアン**と呼びます。並べ替えない方式は**ビッグエンディアン**です。

* リトルエンディアン: `0x12345678` → `[0x78, 0x56, 0x34, 0x12]`
* ビッグエンディアン: `0x12345678` → `[0x12, 0x34, 0x56, 0x78]`

【注意】バイトオーダーを考えるのは分割後です。分割前のバイトオーダーは考えません。

人間の目にはビッグエンディアンの方が直感的ですが、現在主流なのはリトルエンディアンです。今回対象とする8086はリトルエンディアンのみを使います。

## 数値→リトルエンディアン

バイト数を指定してリトルエンディアンを作成します。

```hs:テスト
    , &quot;toLE 1&quot; ~: toLE 2 1          ~?= [1, 0]
    , &quot;toLE 2&quot; ~: toLE 2 0x10000    ~?= [0, 0]
    , &quot;toLE 3&quot; ~: toLE 4 0x12345678 ~?= [0x78, 0x56, 0x34, 0x12]
```
```hs
toLE 0 _ = []
toLE n x = x `mod` 0x100 : toLE (n - 1) (x `div` 0x100)
```

⇒ [リビジョン 7](https://bitbucket.org/7shi/ikebin-hs-2/commits/0a47b791f0c0216b4c3b3c1c61ec7a81854eab73)

## リトルエンディアン→数値

バイト数を指定して数値を読み取ります。

```hs:テスト
    , &quot;fromLE 1&quot; ~: fromLE 2 [0, 1]                   ~?= 0x100
    , &quot;fromLE 2&quot; ~: fromLE 2 [0x78, 0x56, 0x34, 0x12] ~?= 0x5678
    , &quot;fromLE 3&quot; ~: fromLE 4 [0x78, 0x56, 0x34, 0x12] ~?= 0x12345678
```
```hs
fromLE 0 _      = 0
fromLE n (x:xs) = x + 0x100 * fromLE (n - 1) xs
```

以上で逆アセンブラ開発の準備は完了です。

⇒ [リビジョン 8](https://bitbucket.org/7shi/ikebin-hs-2/commits/70d01b4f885becd70833571a180cfc0126215cf9)

## 練習

【問4】数値⇔ビッグエンディアンの相互変換を実装してください。

ヒント: べき乗（累乗）の演算子は`^`です。例: `2^3`（2の3乗）

⇒ [解答例](http://qiita.com/7shi/items/6d228b6fc4734f48a33e#%E3%83%93%E3%83%83%E3%82%B0%E3%82%A8%E3%83%B3%E3%83%87%E3%82%A3%E3%82%A2%E3%83%B3)

# ビット演算

2進数を対象にしたビット演算という操作があります。

Haskellでは関数名が長くてやや煩雑なため、導入はPythonで行います。簡単な式しか扱わないため、Pythonの知識は前提としません。

* [Python ビット演算 超入門](http://qiita.com/7shi/items/41d262ca11ea16d85abc)

HaskellではPythonとは演算子が異なるため、対応を示します。

※ `import Data.Bits`が必要です。

&lt;table&gt;&lt;tr&gt;&lt;th&gt;操作&lt;/th&gt;&lt;th&gt;Python&lt;/th&gt;&lt;th&gt;Haskell&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;左シフト&lt;/td&gt;&lt;td&gt;&lt;code&gt;&amp;lt;&amp;lt;&lt;/code&gt;&lt;/td&gt;&lt;td&gt;&lt;code&gt;shiftL&lt;/code&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;右シフト&lt;/td&gt;&lt;td&gt;&lt;code&gt;&amp;gt;&amp;gt;&lt;/code&gt;&lt;/td&gt;&lt;td&gt;&lt;code&gt;shiftR&lt;/code&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;論理積&lt;/td&gt;&lt;td&gt;&lt;code&gt;&amp;&lt;/code&gt;&lt;/td&gt;&lt;td&gt;&lt;code&gt;.&amp;.&lt;/code&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;論理和&lt;/td&gt;&lt;td&gt;&lt;code&gt;|&lt;/code&gt;&lt;/td&gt;&lt;td&gt;&lt;code&gt;.|.&lt;/code&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;排他的論理和&lt;/td&gt;&lt;td&gt;&lt;code&gt;^&lt;/code&gt;&lt;/td&gt;&lt;td&gt;&lt;code&gt;xor&lt;/code&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;反転&lt;/td&gt;&lt;td&gt;&lt;code&gt;~&lt;/code&gt;&lt;/td&gt;&lt;td&gt;&lt;code&gt;complement&lt;/code&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;

※ Pythonの演算子はC言語やJavaとも共通です。

## 練習

【問5】今まで実装した関数をビット演算で書き換えてください。

⇒ [解答例](http://qiita.com/7shi/items/6d228b6fc4734f48a33e#%E3%83%93%E3%83%83%E3%83%88%E6%BC%94%E7%AE%97)

# 逆アセンブラ

いよいよ逆アセンブラ作りに入ります。

テストが長くなったので、今までのテストは分離します。

```hs:テストを分離
testHex = TestList
    [ &quot;reverse&quot;       ~: reverse     &quot;11001&quot; ~?= &quot;10011&quot;
    （略）
    ]
```

[データシート](https://bitbucket.org/7shi/ikebin/wiki/8086/spec)を参照しながら進めます。

## mov ax, imm16

簡単な命令をndisasmで逆アセンブルします。

```text:逆アセンブル結果
B83412            mov ax,0x1234
```

`B83412`を機械語、`mov`をニーモニック、`ax`や`0x1234`をオペランドと呼びます。

機械語をリストで渡して逆アセンブルします。

```hs:実装とテスト
disasm (x:xs)
    | x == 0xb8 =
        &quot;mov ax,0x&quot; ++ hex (fromLE 2 xs)

testDisAsm = TestList
    [ &quot;b8 1&quot; ~: disasm [0xb8, 0, 0]       ~?= &quot;mov ax,0x0&quot;
    , &quot;b8 2&quot; ~: disasm [0xb8, 0x34, 0x12] ~?= &quot;mov ax,0x1234&quot;
    ]

main = do
    runTestText (putTextToHandle stderr False)
        (TestList [testHex, testDisAsm])
```

⇒ [リビジョン 10](https://bitbucket.org/7shi/ikebin-hs-2/commits/3c05a3626bb6eff3ae33afd7768ad769c68b4d05)

## 文字列渡し

バイナリを16進数文字列で渡せるようにします。

```hs:テスト
    , &quot;b8 3&quot; ~: disasm&#39; &quot;b80000&quot; ~?= &quot;mov ax,0x0&quot;
    , &quot;b8 4&quot; ~: disasm&#39; &quot;b83412&quot; ~?= &quot;mov ax,0x1234&quot;
```
```hs
disasm&#39; hex = disasm $ hexStrToList hex
```

⇒ [リビジョン 11](https://bitbucket.org/7shi/ikebin-hs-2/commits/3a5edcd3bb6e7e29b490cd4f965d252c82985004)

## mov r16, imm16

レジスタ番号で処理するように拡張します。

```hs:テスト
    , &quot;b8-bf 0&quot; ~: disasm&#39; &quot;b90100&quot; ~?= &quot;mov cx,0x1&quot;
    , &quot;b8-bf 1&quot; ~: disasm&#39; &quot;ba1000&quot; ~?= &quot;mov dx,0x10&quot;
    , &quot;b8-bf 2&quot; ~: disasm&#39; &quot;bb0001&quot; ~?= &quot;mov bx,0x100&quot;
    , &quot;b8-bf 3&quot; ~: disasm&#39; &quot;bc0010&quot; ~?= &quot;mov sp,0x1000&quot;
    , &quot;b8-bf 4&quot; ~: disasm&#39; &quot;bdff00&quot; ~?= &quot;mov bp,0xff&quot;
    , &quot;b8-bf 5&quot; ~: disasm&#39; &quot;be00ff&quot; ~?= &quot;mov si,0xff00&quot;
    , &quot;b8-bf 6&quot; ~: disasm&#39; &quot;bffeca&quot; ~?= &quot;mov di,0xcafe&quot;
```
```hs
reg16 = [&quot;ax&quot;, &quot;cx&quot;, &quot;dx&quot;, &quot;bx&quot;, &quot;sp&quot;, &quot;bp&quot;, &quot;si&quot;, &quot;di&quot;]

disasm (x:xs)
    | 0xb8 &lt;= x &amp;&amp; x &lt;= 0xbf =
        &quot;mov &quot; ++ reg16 !! (x - 0xb8) ++ &quot;,0x&quot; ++ hex (fromLE 2 xs)
```

⇒ [リビジョン 12](https://bitbucket.org/7shi/ikebin-hs-2/commits/128458300876d265dee082a1bbdf7d041f230a23)

## mov r8, imm8

8bitレジスタにも対応します。

```hs:テスト
    , &quot;b0-b7 1&quot; ~: disasm&#39; &quot;b000&quot; ~?= &quot;mov al,0x0&quot;
    , &quot;b0-b7 2&quot; ~: disasm&#39; &quot;b101&quot; ~?= &quot;mov cl,0x1&quot;
    , &quot;b0-b7 3&quot; ~: disasm&#39; &quot;b210&quot; ~?= &quot;mov dl,0x10&quot;
    , &quot;b0-b7 4&quot; ~: disasm&#39; &quot;b311&quot; ~?= &quot;mov bl,0x11&quot;
    , &quot;b0-b7 5&quot; ~: disasm&#39; &quot;b412&quot; ~?= &quot;mov ah,0x12&quot;
    , &quot;b0-b7 6&quot; ~: disasm&#39; &quot;b5ff&quot; ~?= &quot;mov ch,0xff&quot;
    , &quot;b0-b7 7&quot; ~: disasm&#39; &quot;b6ee&quot; ~?= &quot;mov dh,0xee&quot;
    , &quot;b0-b7 8&quot; ~: disasm&#39; &quot;b7ca&quot; ~?= &quot;mov bh,0xca&quot;
```
```hs
reg8  = [&quot;al&quot;, &quot;cl&quot;, &quot;dl&quot;, &quot;bl&quot;, &quot;ah&quot;, &quot;ch&quot;, &quot;dh&quot;, &quot;bh&quot;]

disasm (x:xs)
    | 0xb0 &lt;= x &amp;&amp; x &lt;= 0xb7 =
        &quot;mov &quot; ++ reg8  !! (x - 0xb0) ++ &quot;,0x&quot; ++ hex (xs !! 0)
```

⇒ [リビジョン 13](https://bitbucket.org/7shi/ikebin-hs-2/commits/25004806f3318eaa8b113cfbb7fd3f8ddd34147c)

## 8bitと16bitの統合

wフラグを見て切り替えます。

```hs
regs  = [reg8, reg16]

disasm (x:xs)
    -- DATA TRANSFER
    -- MOV = Move:
    -- Immediate to Register [1011wreg][data][data if w=1]
    | 0xb0 &lt;= x &amp;&amp; x &lt;= 0xbf =
        &quot;mov &quot; ++ reg ++ &quot;,&quot; ++ imm
        where
            w = (x `shiftR` 3) .&amp;. 1
            reg = regs !! w !! (x .&amp;. 7)
            imm = &quot;0x&quot; ++ hex (fromLE (w + 1) xs)
```

⇒ [リビジョン 14](https://bitbucket.org/7shi/ikebin-hs-2/commits/6eb9fc1e91d364c07a729eeb27c99262ce6f799b)

## ビットパターン

データシートには機械語が2進数で表記されていますが、ここまでの実装では16進数に変換して範囲チェックしていました。2進数のままパターンマッチできるように修正します。

### ビット分解

1バイトを8ビットに分解する関数を実装します。

```hs:テスト
    , &quot;getBits&quot; ~: getBits 0xbd ~?= (1,0,1,1,1,1,0,1)
```
```hs
getBits x = (b 7, b 6, b 5, b 4, b 3, b 2, b 1, b 0)
    where
        b n = (x `shiftR` n) .&amp;. 1
```

このままではエラーになります。

```text:エラー内容
No instance for (Bits t0) arising from a use of `getBits&#39;
The type variable `t0&#39; is ambiguous
Possible fix: add a type signature that fixes these type variable(s)
Note: there are several potential instances:
  instance Bits Int -- Defined in `Data.Bits&#39;
  instance Bits Integer -- Defined in `Data.Bits&#39;
  instance Bits ghc-prim:GHC.Types.Word -- Defined in `Data.Bits&#39;
（略）
```

テストで指定した`0xbd`が`Int`, `Integer`, `ghc-prim:GHC.Types.Word`のどの型か曖昧だというエラーメッセージです。このような場合、関数に型注釈を追加します。

```hs:文法
名前 :: 引数の型 -&gt; 戻り値の型
```
```hs:型注釈
getBits :: Int -&gt; (Int,Int,Int,Int,Int,Int,Int,Int)
```

これでテストが通ります。

※ 今までは型推論に任せて型注釈は省略していましたが、型注釈を付けるのが一般的です。

⇒ [リビジョン 15](https://bitbucket.org/7shi/ikebin-hs-2/commits/edd293fceffc3ac2eb3a72c4add8fff3582b5f34)

### レジスタを再構成

レジスタは3ビットで表されますが、`getBits`によってビットごとにばらばらになってしまうため、再構成する関数を実装します。

```hs:テスト
    , &quot;getReg&quot; ~: getReg 1 0 1 ~?= 5
```
```hs
getReg :: Int -&gt; Int -&gt; Int -&gt; Int
getReg r e g =
    (r `shiftL` 2) .|. (e `shiftL` 1) .|. g
```

これもエラー回避のため型注釈が必要です。

引数が複数ある場合は、このように引数を1つずつ`-&gt;`で区切って書きます。最後が戻り値の型です。

```hs:文法
名前 :: 引数の型 -&gt; 引数の型 -&gt; 引数の型 -&gt; 戻り値の型
```

※ このような表記になるのはカリー化が関係していますが、詳細は省略します。

⇒ [リビジョン 16](https://bitbucket.org/7shi/ikebin-hs-2/commits/4704a40d14012be20e6f8df33d56cfe88d6fc72d)

### ビットでパターンマッチ

`disasm`でビット分解してパターンマッチ用に`disasmB`を追加します。

```hs
disasm (x:xs) = disasmB (getBits x) xs

-- DATA TRANSFER
-- MOV = Move:
-- Immediate to Register [1011wreg][data][data if w=1]
disasmB (1,0,1,1,w,r,e,g) xs =
    &quot;mov &quot; ++ reg ++ &quot;,&quot; ++ imm
    where
        reg = regs !! w !! getReg r e g
        imm = &quot;0x&quot; ++ hex (fromLE (w + 1) xs)
```

データシートに近い表記で実装することを意図しています。

⇒ [リビジョン 17](https://bitbucket.org/7shi/ikebin-hs-2/commits/e395d8ae25cab1e16df392adc9996f945f203252)

## mov（続き）

movを進めていきます。

```text:データシートより
Register/Memory to/from Register [100010dw][mod reg r/m]
```

このパターンに合わせてデータを作ります。最初の1バイトを列挙します。

* `10001000 00000000` → `88 00`
* `10001001 00000000` → `89 00`
* `10001010 00000000` → `8A 00`
* `10001011 00000000` → `8B 00`

バイナリエディタで16進数を打ち込みます。この作業を**ハンドアセンブル**と呼びます。

機械語をアセンブリ言語に変換する処理を**逆アセンブル**と呼びます。

* アセンブル: アセンブリ言語 → 機械語
* 逆アセンブル: 機械語 → アセンブリ言語

ndisasmで逆アセンブルします。

```text:逆アセンブル結果
00000000  8800              mov [bx+si],al
00000002  8900              mov [bx+si],ax
00000004  8A00              mov al,[bx+si]
00000006  8B00              mov ax,[bx+si]
```

`d`がオペランドの順番、`w`がレジスタサイズを表します。modとr/mで1つのオペランドを表します。（以後ModR/M）

```hs:テスト
    , &quot;88-8b mod=00,r/m=000 1&quot; ~: disasm&#39; &quot;8800&quot; ~?= &quot;mov [bx+si],al&quot;
    , &quot;88-8b mod=00,r/m=000 2&quot; ~: disasm&#39; &quot;8900&quot; ~?= &quot;mov [bx+si],ax&quot;
    , &quot;88-8b mod=00,r/m=000 3&quot; ~: disasm&#39; &quot;8A00&quot; ~?= &quot;mov al,[bx+si]&quot;
    , &quot;88-8b mod=00,r/m=000 4&quot; ~: disasm&#39; &quot;8B00&quot; ~?= &quot;mov ax,[bx+si]&quot;
```

ModR/Mを処理する関数を実装してオペランドとregをタプルで返します。まず`[bx+si]`のみを実装します。

```hs
modrm (x:_) = (f mode rm, reg)
    where
        mode =  x `shiftR` 6
        reg  = (x `shiftR` 3) .&amp;. 7
        rm   =  x             .&amp;. 7
        f 0 0 = &quot;[bx+si]&quot;
```

これを使って逆アセンブラを実装します。

```hs
-- Register/Memory to/from Register [100010dw][mod reg r/m]
disasmB (1,0,0,0,1,0,d,w) xs
    | d == 0    = &quot;mov &quot; ++ rm  ++ &quot;,&quot; ++ reg
    | otherwise = &quot;mov &quot; ++ reg ++ &quot;,&quot; ++ rm
    where
        (rm, r) = modrm xs
        reg = regs !! w !! r
```

⇒ [リビジョン 18](https://bitbucket.org/7shi/ikebin-hs-2/commits/32c4f32acc3686b01e6c6f646989a6dcc97c72e5)

## r/m

r/mを増やして変化を確認します。

```text:逆アセンブル結果
00000000  8901              mov [bx+di],ax
00000002  8902              mov [bp+si],ax
00000004  8903              mov [bp+di],ax
00000006  8904              mov [si],ax
00000008  8905              mov [di],ax
0000000A  89068907          mov [0x789],ax
```

`8906`と`8907`がくっ付いています。

## 即値によるアドレス指定

`8906`は mod = 00, r/m = 110 です。そのパターンを調べます。

```text:逆アセンブル結果
00000000  88063412          mov [0x1234],al
00000004  89063412          mov [0x1234],ax
00000008  8A063412          mov al,[0x1234]
0000000C  8B063412          mov ax,[0x1234]
```

`modrm`を拡張します。

```hs:テスト
    , &quot;88-8b mod=00,r/m=110 1&quot; ~: disasm&#39; &quot;88063412&quot; ~?= &quot;mov [0x1234],al&quot;
    , &quot;88-8b mod=00,r/m=110 2&quot; ~: disasm&#39; &quot;89063412&quot; ~?= &quot;mov [0x1234],ax&quot;
    , &quot;88-8b mod=00,r/m=110 3&quot; ~: disasm&#39; &quot;8A063412&quot; ~?= &quot;mov al,[0x1234]&quot;
    , &quot;88-8b mod=00,r/m=110 4&quot; ~: disasm&#39; &quot;8B063412&quot; ~?= &quot;mov ax,[0x1234]&quot;
```
```hs
modrm (x:xs) = (f mode rm, reg)
    where
        mode =  x `shiftR` 6
        reg  = (x `shiftR` 3) .&amp;. 7
        rm   =  x             .&amp;. 7
        f 0 0 = &quot;[bx+si]&quot;
        f 0 6 = &quot;[0x&quot; ++ hex (fromLE 2 xs) ++ &quot;]&quot;
```

⇒ [リビジョン 19](https://bitbucket.org/7shi/ikebin-hs-2/commits/fcca40e56e06a7bd35498739a0de9a90cefff3fe)

## レジスタによるアドレス指定

すべての組み合わせに対応させるため、仕様書からアドレス指定の組み合わせを調べて、アセンブリ言語でテストを書きます。

```text:test.s
mov [bx+si],ax
mov [bx+di],cx
mov [bp+si],dx
mov [bp+di],bx
mov [si],sp
mov [di],bp
mov [bp],si
mov [bx],di
```

nasmでアセンブルしたものをndisasmで逆アセンブルします。

```text:逆アセンブル結果
00000000  8900              mov [bx+si],ax
00000002  8909              mov [bx+di],cx
00000004  8912              mov [bp+si],dx
00000006  891B              mov [bp+di],bx
00000008  8924              mov [si],sp
0000000A  892D              mov [di],bp
0000000C  897600            mov [bp+0x0],si
0000000F  893F              mov [bx],di
```

`[bp]`は機械語のパターンが異なるため除外します。（アドレス指定に割り当てられているため）

アドレスの組み合わせを定義して`modrm`を拡張します。

```hs:テスト
    , &quot;88-8b mod=00 1&quot; ~: disasm&#39; &quot;8900&quot; ~?= &quot;mov [bx+si],ax&quot;
    , &quot;88-8b mod=00 2&quot; ~: disasm&#39; &quot;8909&quot; ~?= &quot;mov [bx+di],cx&quot;
    , &quot;88-8b mod=00 3&quot; ~: disasm&#39; &quot;8912&quot; ~?= &quot;mov [bp+si],dx&quot;
    , &quot;88-8b mod=00 4&quot; ~: disasm&#39; &quot;891b&quot; ~?= &quot;mov [bp+di],bx&quot;
    , &quot;88-8b mod=00 5&quot; ~: disasm&#39; &quot;8924&quot; ~?= &quot;mov [si],sp&quot;
    , &quot;88-8b mod=00 6&quot; ~: disasm&#39; &quot;892d&quot; ~?= &quot;mov [di],bp&quot;
    , &quot;88-8b mod=00 7&quot; ~: disasm&#39; &quot;893f&quot; ~?= &quot;mov [bx],di&quot;
```
```hs
regad = [&quot;bx+si&quot;, &quot;bx+di&quot;, &quot;bp+si&quot;, &quot;bp+di&quot;, &quot;si&quot;, &quot;di&quot;, &quot;bp&quot;, &quot;bx&quot;]

modrm (x:xs) = (f mode rm, reg)
    where
        mode =  x `shiftR` 6
        reg  = (x `shiftR` 3) .&amp;. 7
        rm   =  x             .&amp;. 7
        f 0 6  = &quot;[0x&quot; ++ hex (fromLE 2 xs) ++ &quot;]&quot;
        f 0 rm = &quot;[&quot; ++ regad !! rm ++ &quot;]&quot;
```

⇒ [リビジョン 20](https://bitbucket.org/7shi/ikebin-hs-2/commits/32833f18954ea2e4d975627b0284069aefbf1b9c)

## ディスプレースメント

アドレスに対する差分をディスプレースメントと呼びます。`[bp]`は`[bp+0]`で表現します。

```text:逆アセンブル結果
00000000  894001            mov [bx+si+0x1],ax
00000003  8949FF            mov [bx+di-0x1],cx
00000006  895202            mov [bp+si+0x2],dx
00000009  895BFE            mov [bp+di-0x2],bx
0000000C  896464            mov [si+0x64],sp
0000000F  896D9C            mov [di-0x64],bp
00000012  897600            mov [bp+0x0],si
00000015  897601            mov [bp+0x1],si
00000018  897F01            mov [bx+0x1],di
```

ディスプレースメントは符号付きです。符号の考え方は次の記事を参照してください。

* [符号あり数値の直感的な考え方](http://qiita.com/7shi/items/6887e7939c0168a0eb21)

符号付きで文字列化する関数を用意します。

```hs:テスト
    , &quot;disp8 1&quot; ~: disp8 0    ~?= &quot;+0x0&quot;
    , &quot;disp8 2&quot; ~: disp8 0x7f ~?= &quot;+0x7f&quot;
    , &quot;disp8 3&quot; ~: disp8 0x80 ~?= &quot;-0x80&quot;
    , &quot;disp8 4&quot; ~: disp8 0xff ~?= &quot;-0x1&quot;
```
```hs
disp8 x
    | x &lt; 0x80  = &quot;+0x&quot; ++ hex x
    | otherwise = &quot;-0x&quot; ++ hex (0x100 - x)
```

⇒ [リビジョン 21](https://bitbucket.org/7shi/ikebin-hs-2/commits/42f5510f9632448d256d7b7b2d38e71458c3735a)

`modrm`を拡張します。

```hs:テスト
    , &quot;88-8b mod=01 1&quot; ~: disasm&#39; &quot;894001&quot; ~?= &quot;mov [bx+si+0x1],ax&quot;
    , &quot;88-8b mod=01 2&quot; ~: disasm&#39; &quot;8949FF&quot; ~?= &quot;mov [bx+di-0x1],cx&quot;
    , &quot;88-8b mod=01 3&quot; ~: disasm&#39; &quot;895202&quot; ~?= &quot;mov [bp+si+0x2],dx&quot;
    , &quot;88-8b mod=01 4&quot; ~: disasm&#39; &quot;895BFE&quot; ~?= &quot;mov [bp+di-0x2],bx&quot;
    , &quot;88-8b mod=01 5&quot; ~: disasm&#39; &quot;896464&quot; ~?= &quot;mov [si+0x64],sp&quot;
    , &quot;88-8b mod=01 6&quot; ~: disasm&#39; &quot;896D9C&quot; ~?= &quot;mov [di-0x64],bp&quot;
    , &quot;88-8b mod=01 7&quot; ~: disasm&#39; &quot;897600&quot; ~?= &quot;mov [bp+0x0],si&quot;
    , &quot;88-8b mod=01 8&quot; ~: disasm&#39; &quot;897601&quot; ~?= &quot;mov [bp+0x1],si&quot;
    , &quot;88-8b mod=01 9&quot; ~: disasm&#39; &quot;897F01&quot; ~?= &quot;mov [bx+0x1],di&quot;
```
```hs
modrm (x:xs) = (f mode rm, reg)
    where
        mode =  x `shiftR` 6
        reg  = (x `shiftR` 3) .&amp;. 7
        rm   =  x             .&amp;. 7
        f 0 6  = &quot;[0x&quot; ++ hex (fromLE 2 xs) ++ &quot;]&quot;
        f 0 rm = &quot;[&quot; ++ regad !! rm ++ &quot;]&quot;
        f 1 rm = &quot;[&quot; ++ regad !! rm ++ disp ++ &quot;]&quot;
            where
                disp = disp8 (xs !! 0)
```

⇒ [リビジョン 22](https://bitbucket.org/7shi/ikebin-hs-2/commits/8584a735790030fc0e0bf809e9742db5587f8643)

# ファイルの分割

1ファイルが長くなって来たので分割します。

Leksahでの設定方法を説明します。Leksahについては以下を参照してください。

* [Haskell IDE Leksah 入門](http://qiita.com/7shi/items/d1e5a0c22be6cf61d286)

まずMain.hsの先頭にモジュール宣言を書いておきます。1ファイルだけのときは不要でしたが、ファイルを分割するときには必要となります。モジュール名はファイル名の拡張子を除いた部分と同じにします。

```hs:Main.hsの先頭
module Main where
```

## Hex

* File → New Module
    * Hex と入力 → [OK]

新規作成されたファイルの中身をすべて消します。

※ 中身を理解しないまま流用することによる問題を回避するための措置です。

ファイルの先頭にモジュール名を書いて、コードを移します。

```hs:Hex.hs
module Hex where
```

Mainから参照します。

```hs:Main.hsに追加
import Hex
```

⇒ [リビジョン 23](https://bitbucket.org/7shi/ikebin-hs-2/commits/3429014aa59dff855f430a3417a26b274cf7c664)

## DisAsm

逆アセンブラも同様に分割します。

* File → New Module
    * DisAsm と入力 → [OK]

新規作成されたファイルの中身をすべて消します。

ファイルの先頭にモジュール名を書いて、コードを移します。

```hs:DisAsm.hs
module DisAsm where
```

Mainから参照します。

```hs:Main.hsに追加
import DisAsm
```

逆アセンブラのテストはMainに残したままにした方が、テストと実装を行ったり来たりするのに都合が良いでしょう。

⇒ [リビジョン 24](https://bitbucket.org/7shi/ikebin-hs-2/commits/ae2d0fe643bed2a78ccdb5289f891081863c1c76)

# 練習

【問6】以下の手順で`modrm`の実装を完成させてください。

1. mod=10,11の機械語をバイナリエディタで作る。
1. ndisasmで逆アセンブルしてアセンブリ言語を確認する。
1. テストケースを作る。
1. 逆アセンブラを実装する。

⇒ [解答例](http://qiita.com/7shi/items/6d228b6fc4734f48a33e#modrm)

【問7】mov命令の2番目`Immediate to Register/Memory`を実装してください。

⇒ [解答例](http://qiita.com/7shi/items/6d228b6fc4734f48a33e#mov%E5%91%BD%E4%BB%A4%E3%81%AE2%E7%95%AA%E7%9B%AE)

【問8】mov命令の残りを実装してください。

⇒ [解答例](http://qiita.com/7shi/items/6d228b6fc4734f48a33e#mov%E5%91%BD%E4%BB%A4%E3%81%AE%E6%AE%8B%E3%82%8A)

【問9】`disasm`が命令の長さも返すように修正してください。想定される仕様をテストの修正として示します。仕様変更が`disasm&#39;`にまで及ぶとテストの修正が大変なため、与えられたバイナリの長さと比較する修正を提示します。

```hs:テストの修正
    [ &quot;b8 1&quot; ~: disasm [0xb8, 0, 0]       ~?= (3, &quot;mov ax,0x0&quot;)
    , &quot;b8 2&quot; ~: disasm [0xb8, 0x34, 0x12] ~?= (3, &quot;mov ax,0x1234&quot;)
```
```hs:disasm&#39;の修正
disasm&#39; hex
    | length bin == len = snd asm
    | otherwise         = &quot;length? &quot; ++ show len
    where
        bin = hexStrToList hex
        asm = disasm bin
        len = fst asm
```

* `show`は引数を文字列に変換する関数です。

⇒ [解答例](http://qiita.com/7shi/items/6d228b6fc4734f48a33e#%E9%95%B7%E3%81%95%E3%82%82%E8%BF%94%E3%81%99)

【問10】複数の命令を含んだバイナリを渡すと逆アセンブル結果をリストで返す関数を実装してください。具体的には以下のテストを通してください。

```hs:テスト
    , &quot;disasms&quot; ~: disasms [0xc6, 0x47, 1, 1, 0xb0, 1]
        ~?= [(4, &quot;mov byte [bx+0x1],0x1&quot;), (2, &quot;mov al,0x1&quot;)]
    , &quot;disasms&#39;&quot; ~: disasms&#39; &quot;C6470101B001&quot;
        ~?= [&quot;mov byte [bx+0x1],0x1&quot;, &quot;mov al,0x1&quot;]
```

⇒ [解答例](http://qiita.com/7shi/items/6d228b6fc4734f48a33e#%E8%A4%87%E6%95%B0%E5%91%BD%E4%BB%A4%E5%AF%BE%E5%BF%9C)

【問11】逆アセンブル結果にアドレスやダンプを含めてndisasmと同じ出力にしてください。具体的には以下のテストを通してください。

```hs:テスト
    , &quot;ndisasm&quot; ~: ndisasm 0 [0xc6, 0x47, 1, 1]
        ~?= (4, &quot;00000000  C6470101          mov byte [bx+0x1],0x1&quot;)
    , &quot;ndisasms&quot; ~: ndisasms 0 [0xc6, 0x47, 1, 1, 0xb0, 1]
        ~?= [ &quot;00000000  C6470101          mov byte [bx+0x1],0x1&quot;
            , &quot;00000004  B001              mov al,0x1&quot;
            ]
```

* 第一引数は開始アドレスです。

⇒ [解答例](http://qiita.com/7shi/items/6d228b6fc4734f48a33e#ndisasm%E6%BA%96%E6%8B%A0%E5%87%BA%E5%8A%9B)

# ファイル読み込み

`main`でコマンドライン引数を調べて、何も指定されていなければテスト、ファイルが指定されていれば読み込んで逆アセンブルするコードを示します。

依存パッケージにbytestringを追加してください。

```hs:importに追加
import System.Environment
import qualified Data.ByteString
```

`qualified`を指定すると使用する際に名前空間まで付ける必要があります（例: `Data.ByteString.readFile`）。元々あった関数と同名の関数（例: `readFile`）が衝突するのを回避しています。

```hs:mainを修正
main = do
    args &lt;- getArgs
    if args == []
        then do
            runTestText (putTextToHandle stderr False)
                (TestList [testHex, testDisAsm])
            return ()
        else do
            bytes &lt;- Data.ByteString.readFile $ args !! 0
            putStr $ unlines $ ndisasms 0
                [fromIntegral b | b &lt;- Data.ByteString.unpack bytes]
```

`&lt;-`はリスト内包表記の中か外かで意味が変わります。リスト内包表記の外で使われている`&lt;-`はアクションから値を取り出す構文です。`&lt;-`は`do`を指定したブロックでしか使えません。詳細は次の記事を参照してください。

* [Haskell アクション 超入門](http://qiita.com/7shi/items/85afd7bbd5d6c4115ad6)

コマンドラインからファイルを指定して呼び出し、逆アセンブルできることを確認してください。

```text
$ ./disasm test
00000000  C60012            mov byte [bx+si],0x12
00000003  C606123456        mov byte [0x3412],0x56
00000008  C6401234          mov byte [bx+si+0x12],0x34
0000000C  C680123456        mov byte [bx+si+0x3412],0x56
00000011  B012              mov al,0x12
00000013  C7001234          mov word [bx+si],0x3412
00000017  C70612345678      mov word [0x3412],0x7856
0000001D  C740123456        mov word [bx+si+0x12],0x5634
00000022  C78012345678      mov word [bx+si+0x3412],0x7856
00000028  B81234            mov ax,0x3412
```

⇒ [リビジョン 32](https://bitbucket.org/7shi/ikebin-hs-2/commits/a03cf4c04dfe23105a2a253edb3d1da2e4d6b95e)

# 練習

【問12】8086の全命令を実装してください。

※ 解答例はありません。
</textarea><input type="submit" name="commit" value="Save changes" data-disable-with="Save changes" /></form></div></section></div><div class="col-sm-3"><div class="socialButtons"><div class="socialButtons_twitter"><a class="twitter-share-button" data-text="Haskellによる8086逆アセンブラ開発入門 by @7shi on @Qiita" data-url="http://qiita.com/7shi/items/026839b2bc193dbfb0cb" href="https://twitter.com/share">Tweet</a></div><div class="socialButtons_hatebu"><a class="hatena-bookmark-button" data-hatena-bookmark-layout="simple-balloon" data-hatena-bookmark-title="Haskellによる8086逆アセンブラ開発入門" href="http://b.hatena.ne.jp/entry/http://qiita.com/7shi/items/026839b2bc193dbfb0cb" title="Add to Hatena Bookmark"><img alt="Add to Hatena Bookmark" height="20" src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" style="border: none;" width="20" /></a><script async="async" charset="utf-8" src="https://b.st-hatena.com/js/bookmark_button.js" type="text/javascript"></script></div><div class="socialButtons_googlePlus"><div class="g-plusone" data-href="http://qiita.com/7shi/items/026839b2bc193dbfb0cb" data-size="medium"></div></div><div class="socialButtons_facebook"><div class="fb-like" data-action="like" data-href="http://qiita.com/7shi/items/026839b2bc193dbfb0cb" data-layout="button_count" data-share="false" data-show-faces="false"></div></div><div class="socialButtons_pocket"><a class="pocket-btn" data-lang="en" data-pocket-count="horizontal" data-pocket-label="pocket"></a></div></div><section class="itemsShowAuthorInfo" itemprop="author" itemscope="" itemtype="http://schema.org/Person"><a href="/7shi"><img alt="" class="itemsShowAuthorInfo_userIcon" itemprop="image" src="https://qiita-image-store.s3.amazonaws.com/0/32057/profile-images/1473685823" /></a><div class="itemsShowAuthorInfo_profileStats"><strong class="itemsShowAuthorInfo_userName" itemprop="name"><a itemprop="url" href="/7shi">7shi</a></strong><div class="itemsShowAuthorInfo_contribution"><span class="itemsShowAuthorInfo_count">2539</span><span class="itemsShowAuthorInfo_unit">Contribution</span></div><div data-react-class="T.UserFollowButton" data-react-props="{&quot;url_name&quot;:&quot;7shi&quot;,&quot;initial_followed_by&quot;:false,&quot;size&quot;:&quot;btn-xs&quot;,&quot;position&quot;:&quot;author-info&quot;}"></div></div><section class="itemsShowAuthorPopularItems"><h5 class="itemsShowAuthorPopularItems_sectionTitle">Popular Posts</h5><ul class="itemsShowAuthorPopularItems_posts list-unstyled"><li itemscope="" itemtype="http://schema.org/Article"> <a itemprop="url" track="click" data-label="AuthorPopularItemsAtSidebar" href="/7shi/items/145f1234f8ec2af923ef">Haskell 超入門</a></li><li itemscope="" itemtype="http://schema.org/Article"> <a itemprop="url" track="click" data-label="AuthorPopularItemsAtSidebar" href="/7shi/items/547b6137d7a3c482fe68">モナド則がちょっと分かった？</a></li><li itemscope="" itemtype="http://schema.org/Article"> <a itemprop="url" track="click" data-label="AuthorPopularItemsAtSidebar" href="/7shi/items/cac7b3e9b90bf91b00cc">文字列で学ぶC++入門</a></li><li itemscope="" itemtype="http://schema.org/Article"> <a itemprop="url" track="click" data-label="AuthorPopularItemsAtSidebar" href="/7shi/items/85afd7bbd5d6c4115ad6">Haskell アクション 超入門</a></li><li itemscope="" itemtype="http://schema.org/Article"> <a itemprop="url" track="click" data-label="AuthorPopularItemsAtSidebar" href="/7shi/items/d1e5a0c22be6cf61d286">Haskell IDE Leksah 入門</a></li></ul></section></section><div class="scroll-chaser"><div class="google-adsense"><style>.test-text-responsible { width: 200px; height: 200px; }@media(min-width: 1200px) {  .test-text-responsible { width: 250px; height: 250px; }}@media(max-width: 979px) and (min-width: 768px) {  .test-text-responsible { width: 120px; height: 240px; }}@media(max-width: 767px) {  .test-text-responsible { width: 320px; height: 50px; }}</style><script async="" src="http://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><ins class="adsbygoogle test-text-responsible" data-ad-client="ca-pub-8127218772604357" data-ad-slot="3880091879" style="display:inline-block"></ins><script>(adsbygoogle = window.adsbygoogle || []).push({});</script></div></div><div data-react-class="T.Toc" data-react-props="{&quot;body&quot;:&quot;\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#2%E9%80%B2%E6%95%B0\&quot;\u003e2進数\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E7%B7%B4%E7%BF%92\&quot;\u003e練習\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#16%E9%80%B2%E6%95%B0\&quot;\u003e16進数\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E7%B7%B4%E7%BF%92-1\&quot;\u003e練習\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E6%A1%81%E6%8F%83%E3%81%88\&quot;\u003e桁揃え\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E3%83%A1%E3%83%A2%E3%83%AA%E3%82%92%E3%83%AA%E3%82%B9%E3%83%88%E3%81%A7%E8%A1%A8%E7%8F%BE\&quot;\u003eメモリをリストで表現\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#16%E9%80%B2%E6%95%B0%E6%96%87%E5%AD%97%E5%88%97%E3%83%AA%E3%82%B9%E3%83%88\&quot;\u003e16進数文字列→リスト\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E3%83%AA%E3%82%B9%E3%83%8816%E9%80%B2%E6%95%B0%E6%96%87%E5%AD%97%E5%88%97\&quot;\u003eリスト→16進数文字列\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E3%83%90%E3%82%A4%E3%83%88%E3%82%AA%E3%83%BC%E3%83%80%E3%83%BC\&quot;\u003eバイトオーダー\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E6%95%B0%E5%80%A4%E3%83%AA%E3%83%88%E3%83%AB%E3%82%A8%E3%83%B3%E3%83%87%E3%82%A3%E3%82%A2%E3%83%B3\&quot;\u003e数値→リトルエンディアン\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E3%83%AA%E3%83%88%E3%83%AB%E3%82%A8%E3%83%B3%E3%83%87%E3%82%A3%E3%82%A2%E3%83%B3%E6%95%B0%E5%80%A4\&quot;\u003eリトルエンディアン→数値\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E7%B7%B4%E7%BF%92-2\&quot;\u003e練習\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E3%83%93%E3%83%83%E3%83%88%E6%BC%94%E7%AE%97\&quot;\u003eビット演算\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E7%B7%B4%E7%BF%92-3\&quot;\u003e練習\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E9%80%86%E3%82%A2%E3%82%BB%E3%83%B3%E3%83%96%E3%83%A9\&quot;\u003e逆アセンブラ\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#mov-ax-imm16\&quot;\u003emov ax, imm16\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E6%96%87%E5%AD%97%E5%88%97%E6%B8%A1%E3%81%97\&quot;\u003e文字列渡し\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#mov-r16-imm16\&quot;\u003emov r16, imm16\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#mov-r8-imm8\&quot;\u003emov r8, imm8\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#8bit%E3%81%A816bit%E3%81%AE%E7%B5%B1%E5%90%88\&quot;\u003e8bitと16bitの統合\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E3%83%93%E3%83%83%E3%83%88%E3%83%91%E3%82%BF%E3%83%BC%E3%83%B3\&quot;\u003eビットパターン\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E3%83%93%E3%83%83%E3%83%88%E5%88%86%E8%A7%A3\&quot;\u003eビット分解\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E3%83%AC%E3%82%B8%E3%82%B9%E3%82%BF%E3%82%92%E5%86%8D%E6%A7%8B%E6%88%90\&quot;\u003eレジスタを再構成\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E3%83%93%E3%83%83%E3%83%88%E3%81%A7%E3%83%91%E3%82%BF%E3%83%BC%E3%83%B3%E3%83%9E%E3%83%83%E3%83%81\&quot;\u003eビットでパターンマッチ\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#mov%E7%B6%9A%E3%81%8D\&quot;\u003emov（続き）\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#rm\&quot;\u003er/m\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E5%8D%B3%E5%80%A4%E3%81%AB%E3%82%88%E3%82%8B%E3%82%A2%E3%83%89%E3%83%AC%E3%82%B9%E6%8C%87%E5%AE%9A\&quot;\u003e即値によるアドレス指定\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E3%83%AC%E3%82%B8%E3%82%B9%E3%82%BF%E3%81%AB%E3%82%88%E3%82%8B%E3%82%A2%E3%83%89%E3%83%AC%E3%82%B9%E6%8C%87%E5%AE%9A\&quot;\u003eレジスタによるアドレス指定\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E3%83%87%E3%82%A3%E3%82%B9%E3%83%97%E3%83%AC%E3%83%BC%E3%82%B9%E3%83%A1%E3%83%B3%E3%83%88\&quot;\u003eディスプレースメント\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%AE%E5%88%86%E5%89%B2\&quot;\u003eファイルの分割\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#hex\&quot;\u003eHex\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#disasm\&quot;\u003eDisAsm\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E7%B7%B4%E7%BF%92-4\&quot;\u003e練習\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%81%BF\&quot;\u003eファイル読み込み\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E7%B7%B4%E7%BF%92-5\&quot;\u003e練習\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n&quot;,&quot;wrapper&quot;:&quot;#article-body-wrapper&quot;}"></div></div></div><div class="row"><div class="col-sm-9"><div class="ArticleFooter__menu"><div class="s-flex-align-center"><div class="js-likebutton" data-props="{&quot;like_status&quot;:false,&quot;like_count&quot;:54,&quot;show_count&quot;:true,&quot;uuid&quot;:&quot;026839b2bc193dbfb0cb&quot;,&quot;likable_type&quot;:&quot;Article&quot;,&quot;position&quot;:&quot;article-footer&quot;}"></div><div class="ArticleFooter__userList"><div class="ArticleFooter__user"><div class="js-hovercard" data-hovercard-target-name="quenhulu"><a itemprop="url" href="/quenhulu"><img alt="quenhulu" class="thumb thumb--xs" src="https://qiita-image-store.s3.amazonaws.com/0/14708/profile-images/1473683459" /></a></div></div><div class="ArticleFooter__user"><div class="js-hovercard" data-hovercard-target-name="NeXTSTEP2OSX"><a itemprop="url" href="/NeXTSTEP2OSX"><img alt="NeXTSTEP2OSX" class="thumb thumb--xs" src="https://qiita-image-store.s3.amazonaws.com/0/3190/profile-images/1473682757" /></a></div></div><div class="ArticleFooter__user"><div class="js-hovercard" data-hovercard-target-name="Reds"><a itemprop="url" href="/Reds"><img alt="Reds" class="thumb thumb--xs" src="https://0.gravatar.com/avatar/e751888e30cdc35253c1a3b241977adf?d=https%3A%2F%2Fidenticons.github.com%2F0e2f15414d97b8b642022be91ff105e0.png" /></a></div></div><div class="ArticleFooter__user"><div class="js-hovercard" data-hovercard-target-name="saltheads"><a itemprop="url" href="/saltheads"><img alt="saltheads" class="thumb thumb--xs" src="https://qiita-image-store.s3.amazonaws.com/0/11188/profile-images/1473681944" /></a></div></div><div class="ArticleFooter__user"><div class="js-hovercard" data-hovercard-target-name="kasumani"><a itemprop="url" href="/kasumani"><img alt="kasumani" class="thumb thumb--xs" src="https://qiita-image-store.s3.amazonaws.com/0/3397/profile-images/1473683087" /></a></div></div><div class="ArticleFooter__user"><div class="js-hovercard" data-hovercard-target-name="SuperAlloyZZ"><a itemprop="url" href="/SuperAlloyZZ"><img alt="SuperAlloyZZ" class="thumb thumb--xs" src="https://qiita-image-store.s3.amazonaws.com/0/46744/profile-images/1473690751" /></a></div></div><div class="ArticleFooter__user"><div class="js-hovercard" data-hovercard-target-name="tacke_jp"><a itemprop="url" href="/tacke_jp"><img alt="tacke_jp" class="thumb thumb--xs" src="https://qiita-image-store.s3.amazonaws.com/0/2284/profile-images/1473681378" /></a></div></div><div class="ArticleFooter__user"><div class="js-hovercard" data-hovercard-target-name="elfmimi"><a itemprop="url" href="/elfmimi"><img alt="elfmimi" class="thumb thumb--xs" src="https://qiita-image-store.s3.amazonaws.com/0/33067/profile-images/1473686038" /></a></div></div><div class="ArticleFooter__user"><div class="js-hovercard" data-hovercard-target-name="katochar"><a itemprop="url" href="/katochar"><img alt="katochar" class="thumb thumb--xs" src="https://qiita-image-store.s3.amazonaws.com/0/14641/profile-images/1473683433" /></a></div></div><div class="ArticleFooter__user"><div class="js-hovercard" data-hovercard-target-name="HirotoKagotani"><a itemprop="url" href="/HirotoKagotani"><img alt="HirotoKagotani" class="thumb thumb--xs" src="https://secure.gravatar.com/avatar/0a3d8eae4760b65766757df2475e09df?d=https://a248.e.akamai.net/assets.github.com%2Fimages%2Fgravatars%2Fgravatar-140.png" /></a></div></div><div class="ArticleFooter__user"><a href="/7shi/items/026839b2bc193dbfb0cb/likers"><span class="fa fa-ellipsis-h"></span></a></div></div></div><div class="u-flex u-align-center"><div class="ArticleFooter__stock"><div class="js-stockbutton" data-position="footer_menu" data-props="{&quot;stock_status&quot;:false}"></div></div><div class="ArticleFooter__editRequest"><a class="u-link-no-underline" data-toggle="tooltip" title="You can propose improvements about the article to the author 💪" href="/drafts/026839b2bc193dbfb0cb/edit"><span class="fa fa-send-o fa-lg"></span> <span>Edit request</span></a></div><div class="dropdown ArticleFooter__dropdown"><a class="dropdown-toggle" data-toggle="dropdown" href="#"><span class="fa fa-ellipsis-h"></span></a><ul class="dropdown-menu dropdown-menu-right"><li><a href="/7shi/items/026839b2bc193dbfb0cb.md"><span class="fa fa-fw fa-file-text-o"></span> Show article as Markdown</a></li><li><a data-target=".js-report-form" data-toggle="modal" href="#"><i class="fa fa-fw fa-flag"></i> Report article</a></li></ul></div></div></div><ul class="references js-referencesView"><li class="references_header"><i class="fa fa-fw fa-link"></i> Linked from these articles</li><li class="references_reference js-reference"><span>Linked from </span><a href="/7shi/items/145f1234f8ec2af923ef#_reference-3fb59e8d7265fc0c54cf"><img alt="" width="18" height="18" src="https://qiita-image-store.s3.amazonaws.com/0/32057/profile-images/1473685823" />Haskell 超入門</a><time class="references_datetime js-dateTimeView" datetime="2014-08-31T02:54:40+00:00">over 2 years ago</time></li><li class="references_reference js-reference"><span>Linked from </span><a href="/7shi/items/6d228b6fc4734f48a33e#_reference-e09b5d96bb736c14fb6f"><img alt="" width="18" height="18" src="https://qiita-image-store.s3.amazonaws.com/0/32057/profile-images/1473685823" />【解答例】Haskellによる8086逆アセンブラ開発入門</a><time class="references_datetime js-dateTimeView" datetime="2014-08-31T14:03:33+00:00">over 2 years ago</time></li><li class="references_reference js-reference"><span>Linked from </span><a href="/7shi/items/b3911948f9d97b05395e#_reference-49d9a48874d3b00a4e34"><img alt="" width="18" height="18" src="https://qiita-image-store.s3.amazonaws.com/0/32057/profile-images/1473685823" />8086による機械語入門</a><time class="references_datetime js-dateTimeView" datetime="2015-11-09T08:30:38+00:00">over 1 year ago</time></li></ul><div class="itemsShowBody_articleColumnFooter"><div class="socialButtons"><div class="socialButtons_twitter"><a class="twitter-share-button" data-text="Haskellによる8086逆アセンブラ開発入門 by @7shi on @Qiita" data-url="http://qiita.com/7shi/items/026839b2bc193dbfb0cb" href="https://twitter.com/share">Tweet</a></div><div class="socialButtons_hatebu"><a class="hatena-bookmark-button" data-hatena-bookmark-layout="simple-balloon" data-hatena-bookmark-title="Haskellによる8086逆アセンブラ開発入門" href="http://b.hatena.ne.jp/entry/http://qiita.com/7shi/items/026839b2bc193dbfb0cb" title="Add to Hatena Bookmark"><img alt="Add to Hatena Bookmark" height="20" src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" style="border: none;" width="20" /></a><script async="async" charset="utf-8" src="https://b.st-hatena.com/js/bookmark_button.js" type="text/javascript"></script></div><div class="socialButtons_googlePlus"><div class="g-plusone" data-href="http://qiita.com/7shi/items/026839b2bc193dbfb0cb" data-size="medium"></div></div><div class="socialButtons_facebook"><div class="fb-like" data-action="like" data-href="http://qiita.com/7shi/items/026839b2bc193dbfb0cb" data-layout="button_count" data-share="false" data-show-faces="false"></div></div><div class="socialButtons_pocket"><a class="pocket-btn" data-lang="en" data-pocket-count="horizontal" data-pocket-label="pocket"></a></div></div></div><div class="itemsShowComment_wrapper" id="comments"><div data-react-class="T.CommentListContainer" data-react-props="{&quot;currentUser&quot;:null,&quot;initialComments&quot;:[],&quot;monthly_public_image_uploadable_size_limit&quot;:null,&quot;total_uploaded_public_image_size_in_current_month&quot;:null,&quot;item&quot;:{&quot;id&quot;:121732,&quot;uuid&quot;:&quot;026839b2bc193dbfb0cb&quot;,&quot;suspended&quot;:false,&quot;secret&quot;:false},&quot;owner&quot;:{&quot;url_name&quot;:&quot;7shi&quot;},&quot;is_team&quot;:false,&quot;is_project&quot;:false,&quot;logged_in&quot;:false,&quot;polling&quot;:false,&quot;mention_candidates&quot;:[{&quot;id&quot;:32057,&quot;url_name&quot;:&quot;7shi&quot;,&quot;profile_image_url&quot;:&quot;https://qiita-image-store.s3.amazonaws.com/0/32057/profile-images/1473685823&quot;}]}">Comments Loading...</div></div></div></div></div></article><div class="js-report-form modal fade reportForm"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><button name="button" type="submit" class="close" data-dismiss="modal">&times;</button><h4 class="modal-title">Report article</h4></div><div class="modal-body"><form action="/reports" accept-charset="UTF-8" method="post"><input name="utf8" type="hidden" value="&#x2713;" /><input type="hidden" name="authenticity_token" value="WAiu59A65Guy37R7n2rcWvjRpVJeLUEpRbZ0wsQ55AwsvztbWPcmuGWkLw11KkUjiBA677uE1TRSsbqB+HpuqQ==" /><input type="hidden" name="redirect_path" id="redirect_path" value="/7shi/items/026839b2bc193dbfb0cb" /><input type="hidden" name="item_uuid" id="item_uuid" value="026839b2bc193dbfb0cb" /><p>Help us understand the problem. What is going on with this item?</p><br /><div class="form-group"><ul class="list-unstyled"><li><label><input type="radio" name="report_type" id="report_type_spam" value="spam" required="required" /> It&#39;s spam </label></li><li><label><input type="radio" name="report_type" id="report_type_harassment" value="harassment" required="required" /> It&#39;s abusive or harmful </label></li><li><label><input type="radio" name="report_type" id="report_type_inappropriate_content" value="inappropriate_content" required="required" /> It contains inappropriate content </label></li></ul></div><div class="reportForm_submitButtonContainer"><button name="button" type="submit" class="btn btn-primary reportForm_submitButton"><i class="fa fa-send"></i> Submit</button></div></form></div></div></div></div><script id="js-item" type="application/json">{ "url": "http://qiita.com/7shi/items/026839b2bc193dbfb0cb", "id": 121732, "uuid": "026839b2bc193dbfb0cb" }</script><script class="js-user" type="application/json">{&quot;id&quot;:32057,&quot;url_name&quot;:&quot;7shi&quot;,&quot;profile_image_url&quot;:&quot;https://qiita-image-store.s3.amazonaws.com/0/32057/profile-images/1473685823&quot;}</script><script language="JavaScript" src="//cdn.bigmining.com/private/js/qiita_bigmining.js" type="text/javascript"></script></div><footer class="footer"><div class="footer_inner"><div class="footer_container"><ul class="footer_links-left"><li class="footer_link"><a class="footer_copyright" href="http://increments.co.jp">© 2011-2017 Increments Inc.</a></li><li class="footer_link"><a href="http://qiita.com/terms">Terms</a></li><li class="footer_link"><a href="http://qiita.com/privacy">Privacy</a></li><li class="footer_link"><a href="http://help.qiita.com">Help</a></li><li class="footer_link"><a href="https://increments.zendesk.com/anonymous_requests/new">Contact</a></li></ul><ul class="footer_links-right"><li class="footer_link"><a href="http://qiita.com/about">About</a></li><li class="footer_link"><a href="/users">Users</a></li><li class="footer_link"><a href="/tags">Tags</a></li><li class="footer_link"><a href="http://blog.qiita.com">Blog</a></li><li class="footer_link"><a href="http://qiita.com/api/v2/docs">API</a></li><li class="footer_link"><a href="https://teams.qiita.com/">Team</a></li><li class="footer_link"><a href="http://kobito.qiita.com">Kobito</a></li><li class="footer_link"><a class="js-public-form-feedback-link" data-target=".js-feedback-form" data-toggle="modal" href=""><i class="fa fa-heart"></i> Feedback <i class="fa fa-caret-down"></i></a></li></ul></div></div></footer><div class="js-feedback-form modal fade feedbackForm"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><button name="button" type="submit" class="close" data-dismiss="modal">&times;</button><h4 class="modal-title">Feedback</h4></div><div class="modal-body"><form class="js-feedback-form-form" action="/feedbacks" accept-charset="UTF-8" method="post"><input name="utf8" type="hidden" value="&#x2713;" /><input type="hidden" name="authenticity_token" value="JKZJ+1VNSYgdrO8GDs3EVaDB4ri60WICZ19ZIkU4OHtQEdxH3YCLW8rXdHDkjV0s0AB9BV949h9wWJdheXuy3g==" /><input type="hidden" name="redirect_path" id="redirect_path" value="/7shi/items/026839b2bc193dbfb0cb" /><div class="form-group"><textarea name="feedback[message]" id="feedback_message" class="form-control js-feedback-form-text-area" placeholder="Please give us any feedback about Qiita." required="required" rows="5">
</textarea></div><div class="feedbackForm_submitButtonContainer"><button name="button" type="submit" class="btn btn-primary feedbackForm_submitButton"><i class="fa fa-send"></i> Submit</button><p class="feedbackForm_note">We don&#39;t reply to any feedback.<br />If you need help with Qiita, please send a support request from <a href="https://increments.zendesk.com/anonymous_requests/new">here</a>.</p></div><div style="position:fixed;top:-99999px;opacity:0.0001;"><input name="feedback[name]" type="text" /></div></form></div></div></div></div><script>// if (window.mixpanel instanceof Element) {
//   window.mixpanel = [];
// }
// (function(f,b){if(!b.__SV){var a,e,i,g;window.mixpanel=b;b._i=[];b.init=function(a,e,d){function f(b,h){var a=h.split(".");2==a.length&&(b=b[a[0]],h=a[1]);b[h]=function(){b.push([h].concat(Array.prototype.slice.call(arguments,0)))}}var c=b;"undefined"!==typeof d?c=b[d]=[]:d="mixpanel";c.people=c.people||[];c.toString=function(b){var a="mixpanel";"mixpanel"!==d&&(a+="."+d);b||(a+=" (stub)");return a};c.people.toString=function(){return c.toString(1)+".people (stub)"};i="disable track track_pageview track_links track_forms register register_once alias unregister identify name_tag set_config people.set people.set_once people.increment people.append people.track_charge people.clear_charges people.delete_user".split(" ");
// for(g=0;g<i.length;g++)f(c,i[g]);b._i.push([a,e,d])};b.__SV=1.2;a=f.createElement("script");a.type="text/javascript";a.async=!0;a.src="//cdn.mxpnl.com/libs/mixpanel-2.2.min.js";e=f.getElementsByTagName("script")[0];e.parentNode.insertBefore(a,e)}})(document,window.mixpanel||[]);</script><script src="http://cdn.qiita.com/assets/public-cdd058934ecada5328128c0b59af8de8.min.js"></script><script>
  (function () {
    var script = document.getElementsByTagName('script')[0];
    var load = function (src, id) {
      var el = document.createElement('script');
      el.async = true;
      el.src = src;
      el.id = id;
      script.parentNode.insertBefore(el, script);
    };
      // Optimizely
      load('//cdn.optimizely.com/js/52738645.js', 'optimizely-jssdk');
      // Google Analytics
      window._gaq = window._gaq || [];
      var isCareer = location.hostname.split('.')[0] == 'career';
      if (isCareer) {
        window._gaq.push(['_setAccount', 'UA-24675221-11']);
        window._gaq.push(['_setDomainName', 'qiita.com']);
      } else {
        window._gaq.push(['_setAccount', 'UA-24675221-1']);
      }
      window._gaq.push(['_setCustomVar', 1, 'logged_in', 'false', 2]);
      window._gaq.push(['_trackPageview']);
      var src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      load(src, 'google-analytics-jssdk');
    // Google Analytics - Universal Analytics
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-24675221-12', {
          
        });
        ga('set', 'dimension1', 'false');
        ga('set', 'dimension3', 'false');
      ga('require', 'displayfeatures');
      ga('set', 'forceSSL', true);
      ga('send', 'pageview');
    // Google Tag Manager
      (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
      new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
      })(window,document,'script','dataLayer','GTM-TBQWPN');
  })();
</script>
</body></html>