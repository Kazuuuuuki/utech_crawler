<!DOCTYPE html><html xmlns:og="http://ogp.me/ns#"><head><meta charset="UTF-8" /><title>Haskell モナド変換子 超入門 - Qiita</title><meta content="width=device-width,initial-scale=1" name="viewport" /><meta content="Haskellではモナドと呼ばれる部品を組み合わせてプログラムを作ります。別種のモナドを組み合わせるためのモナド変換子の使い方の初歩を説明します。ライブラリで用意されたモナド変換子を手っ取り早く使うことを目的としているため、モナド変換子の作り方や圏論には言及しません。

シリーズの記事です。


Haskell 超入門
Haskell 代数的データ型 超入門
Haskell アクション 超入門
Haskell ラムダ 超入門
Haskell アクションとラムダ 超入門
..." name="description" /><meta content="summary" name="twitter:card" /><meta content="@Qiita" name="twitter:site" /><meta content="7shi" name="twitter:creator" /><meta content="Haskell モナド変換子 超入門 - Qiita" property="og:title" /><meta content="article" property="og:type" /><meta content="http://qiita.com/7shi/items/4408b76624067c17e933" property="og:url" /><meta content="http://cdn.qiita.com/assets/qiita-fb-2887e7b4aad86fd8c25cea84846f2236.png" property="og:image" /><meta content="Haskellではモナドと呼ばれる部品を組み合わせてプログラムを作ります。別種のモナドを組み合わせるためのモナド変換子の使い方の初歩を説明します。ライブラリで用意されたモナド変換子を手っ取り早く使うことを目的としているため、モナド変換..." property="og:description" /><meta content="Qiita" property="og:site_name" /><meta content="564524038" property="fb:admins" /><link rel="shortcut icon" type="image/x-icon" href="http://cdn.qiita.com/assets/favicons/public/production-4ff10c1e1e2b5fcb353ff9cafdd56c70.ico" /><link rel="apple-touch-icon" type="image/png" href="http://cdn.qiita.com/assets/favicons/public/apple-touch-icon-f9a6afad761ec2306e10db2736187c8b.png" /><link href="/opensearch.xml" rel="search" title="Qiita" type="application/opensearchdescription+xml" /><link rel="stylesheet" media="all" href="http://cdn.qiita.com/assets/public-e8d29e8ff1879118096f0f5877946857.min.css" /><meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="yoFAkDE5Ft8lDphsYiTd1aE2eD+YkebJRELoXftsPhSkA9vIqhcvlNrdLXAS0WOMwXFcjA9VvD54nOGmGmIw0g==" /></head><body class="without-js" id=""><noscript><iframe height="0" src="//www.googletagmanager.com/ns.html?id=GTM-TBQWPN" style="display:none;visibility:hidden" width="0"></iframe></noscript><script>
  document.body.className = document.body.className.replace('without-js', '') + ' with-js';
  window.Qiita = {"asset_host":"cdn.qiita.com","TLD":"com","controller_path":"public/items","controller_action":"public/items#show","controller":"items","action":"show","env":"production","flash":{},"is_landing_page":false,"is_team_page":false,"root_domain":"qiita.com","variant":null,"config":{"mixpanel":{"career":"dd35af27e959781713d63fd7ca898a8d","per_team":"c0a2116368b33b44b5029ebd2cc9b094","public":"be87616606b0e26a87689099aab2c4e5","team":"b7c0342acba2dbc8742484d98788efb3"},"default_locale":"ja","locale":"en"},"team":null,"user":null,"GIT_BRANCH":null,"DEBUG":false};

</script>
<div class="headerContainer headerContainer-public" role="navigation"><div data-react-class="T.HeaderContainer" data-react-props="{&quot;user&quot;:null,&quot;team&quot;:null,&quot;news&quot;:{&quot;type&quot;:&quot;Hot&quot;,&quot;content&quot;:&quot;Markdownによる情報共有サービス、Qiita:Team&quot;,&quot;url&quot;:&quot;https://teams.qiita.com?utm_source=qiita\u0026utm_medium=header_news&quot;},&quot;initial_unread_count&quot;:null,&quot;siteid_image&quot;:&quot;http://cdn.qiita.com/siteid-reverse.png&quot;,&quot;is_team_page&quot;:false,&quot;on_team_setting&quot;:false,&quot;show_post_menu&quot;:true,&quot;show_search_menu&quot;:true,&quot;is_fluid&quot;:false,&quot;locale&quot;:&quot;en&quot;}"></div></div><div id="main"><ol class="itemBreadcrumbs" itemscope="" itemtype="http://schema.org/BreadcrumbList"><li itemprop="itemListElement" itemscope="" itemtype="http://schema.org/ListItem"><a itemprop="item" href="/"><span itemprop="name">Qiita</span></a><meta content="1" itemprop="position" /></li><li itemprop="itemListElement" itemscope="" itemtype="http://schema.org/ListItem"><a itemprop="item" href="/items"><span itemprop="name">Items</span></a><meta content="2" itemprop="position" /></li><li itemprop="itemListElement" itemscope="" itemtype="http://schema.org/ListItem"><a itemprop="item" href="/tags/Haskell"><span itemprop="name">Haskell</span></a><meta content="3" itemprop="position" /></li></ol><article itemscope="" itemtype="http://schema.org/Article"><div class="ArticleMainHeader "><div class="container"></div><div class="container"><div class="row s-flex-align-center"><div class="col-sm-9"><h1 class="ArticleMainHeader__title">Haskell モナド変換子 超入門</h1><ul class="TagList"><li class="TagList__item" data-count="1345"><a class="u-link-unstyled TagList__label" href="/tags/Haskell"><img alt="Haskell" class="TagList__icon" src="https://s3-ap-northeast-1.amazonaws.com/qiita-tag-image/373b3b0595a92712b2a45616f53dae97bc1a04e5/medium.jpg?1387913155" /><span>Haskell</span></a></li></ul></div><div class="col-sm-3"><div class="itemsShowHeaderStock"><ul class="list-unstyled itemsShowHeaderStock_statusList"><li><div class="itemsShowHeaderStock_count stock"><span class="fa fa-thumbs-up"></span><span class="js-likecount">47</span></div><div class="itemsShowHeaderStock_countText">Like</div></li><li><div class="itemsShowHeaderStock_count" content="0 UserComments" itemprop="interactionCount"><span class="fa fa-comment"></span>0</div><div class="itemsShowHeaderStock_countText">Comment</div></li></ul></div><div class="js-likebutton" data-props="{&quot;like_status&quot;:false,&quot;like_count&quot;:47,&quot;uuid&quot;:&quot;4408b76624067c17e933&quot;,&quot;likable_type&quot;:&quot;Article&quot;,&quot;position&quot;:&quot;article-header&quot;}"></div><ul class="list-inline ArticleMainHeader__users"><li class="js-hovercard" data-hovercard-target-name="_marony"><a itemprop="url" href="/_marony"><img alt="_marony" class="thumb thumb--xs" src="https://qiita-image-store.s3.amazonaws.com/0/714/profile-images/1473755311" /></a></li><li class="js-hovercard" data-hovercard-target-name="uchiko"><a itemprop="url" href="/uchiko"><img alt="uchiko" class="thumb thumb--xs" src="https://qiita-image-store.s3.amazonaws.com/0/2278/profile-images/1473681372" /></a></li><li class="js-hovercard" data-hovercard-target-name="tapioga"><a itemprop="url" href="/tapioga"><img alt="tapioga" class="thumb thumb--xs" src="https://qiita-image-store.s3.amazonaws.com/0/38349/profile-images/1473687732" /></a></li><li class="js-hovercard" data-hovercard-target-name="tattsun58"><a itemprop="url" href="/tattsun58"><img alt="tattsun58" class="thumb thumb--xs" src="https://qiita-image-store.s3.amazonaws.com/0/38970/profile-images/1473687941" /></a></li><li class="js-hovercard" data-hovercard-target-name="saka_bar"><a itemprop="url" href="/saka_bar"><img alt="saka_bar" class="thumb thumb--xs" src="https://qiita-image-store.s3.amazonaws.com/0/13826/profile-images/1473757920" /></a></li><li class="js-hovercard" data-hovercard-target-name="arowM"><a itemprop="url" href="/arowM"><img alt="arowM" class="thumb thumb--xs" src="https://qiita-image-store.s3.amazonaws.com/0/16345/profile-images/1473681833" /></a></li><li class="js-hovercard" data-hovercard-target-name="yoya"><a itemprop="url" href="/yoya"><img alt="yoya" class="thumb thumb--xs" src="https://qiita-image-store.s3.amazonaws.com/0/1798/profile-images/1473755697" /></a></li><li class="js-hovercard" data-hovercard-target-name="liveinwood"><a itemprop="url" href="/liveinwood"><img alt="liveinwood" class="thumb thumb--xs" src="https://gravatar.com/avatar/fd1b6ea9b7b3f46de5da87a2dabd304f?d=https%3A%2F%2Fidenticons.github.com%2F8bc232144688fdecf1de7d358e2946a8.png&amp;r=x" /></a></li><li class="js-hovercard" data-hovercard-target-name="JunKikuchi"><a itemprop="url" href="/JunKikuchi"><img alt="JunKikuchi" class="thumb thumb--xs" src="https://qiita-image-store.s3.amazonaws.com/0/13181/profile-images/1473682708" /></a></li><li class="js-hovercard" data-hovercard-target-name="igrep"><a itemprop="url" href="/igrep"><img alt="igrep" class="thumb thumb--xs" src="https://qiita-image-store.s3.amazonaws.com/0/12688/profile-images/1473682497" /></a></li><li><a href="/7shi/items/4408b76624067c17e933/likers"><span class="fa fa-ellipsis-h"></span></a></li></ul></div></div></div></div><div class="ArticleAsideHeader"><div class="container"><div class="u-flex u-space-between"><div class="u-flex u-flex-wrap"><div class="u-flex u-align-center s-pdv-5 u-flex-wrap"><div class="ArticleAsideHeader__author"><a href="/7shi"><img class="thumb thumb--xs" src="https://qiita-image-store.s3.amazonaws.com/0/32057/profile-images/1473685823" alt="1473685823" /></a> <a class="u-link-unstyled" href="/7shi">7shi</a> </div><div class="ArticleAsideHeader__date"><span data-toggle="tooltip" title="posted at 2015-01-04">Edited at <time datetime="2015-09-29T12:15:58+09:00" itemprop="dateModified">2015-09-29</time></span></div></div><div class="u-flex u-align-center s-pdv-5 mobile-hidden"><div class="ArticleAsideHeader__revision"> <a data-toggle="tooltip" title="Revisions" href="/7shi/items/4408b76624067c17e933/revisions"><span class="fa fa-history"></span></a><span class="ArticleAsideHeader__revisionCount">39</span></div></div><div class="u-flex u-align-center s-pdv-5 mobile-hidden"></div></div><div class="u-flex u-align-center s-flex-justiry-between s-pdv-5 u-shrink-0"><div class="ArticleAsideHeader__stock"><div class="js-stockbutton" data-position="top" data-props="{&quot;stock_status&quot;:false}"></div></div><div class="dropdown"><a class="dropdown-toggle" data-toggle="dropdown" href="#"><span class="fa fa-ellipsis-h fa-lg"></span></a><ul class="dropdown-menu dropdown-menu-right"><li class="dropdown__item--mobile"><a href="/7shi/items/4408b76624067c17e933/revisions"><span class="fa fa-fw fa-history"></span> Revisions<span>(39)</span></a></li><li><a href="/7shi/items/4408b76624067c17e933.md"><span class="fa fa-fw fa-file-text-o"></span> Show article as Markdown</a></li><li><a data-target=".js-report-form" data-toggle="modal" href="#"><span class="fa fa-fw fa-flag"></span> Report article</a></li></ul></div></div></div></div></div><div class="container"><div class="row" id="article-body-wrapper"><div class="col-sm-9"><section class="markdownContent markdownContent-headingEnabled js-task-list-container clearfix position-relative" id="item-4408b76624067c17e933" itemprop="articleBody"><div class="alert alert-warning"><i class="fa fa-clock-o"></i> More than 1 year has passed since last update.</div><p>Haskellではモナドと呼ばれる部品を組み合わせてプログラムを作ります。別種のモナドを組み合わせるためのモナド変換子の使い方の初歩を説明します。ライブラリで用意されたモナド変換子を手っ取り早く使うことを目的としているため、モナド変換子の作り方や圏論には言及しません。</p>

<p>シリーズの記事です。</p>

<ol>
<li><a href="http://qiita.com/7shi/items/145f1234f8ec2af923ef" id="reference-a3d6e385fd22621ae07e">Haskell 超入門</a></li>
<li><a href="http://qiita.com/7shi/items/1ce76bde464b4a55c143" id="reference-519600d614ebe8d8eed2">Haskell 代数的データ型 超入門</a></li>
<li><a href="http://qiita.com/7shi/items/85afd7bbd5d6c4115ad6" id="reference-82e61704dff0037e235f">Haskell アクション 超入門</a></li>
<li><a href="http://qiita.com/7shi/items/1345bf32003faff435cb" id="reference-4f8e0131dd64e2d992c9">Haskell ラムダ 超入門</a></li>
<li><a href="http://qiita.com/7shi/items/4a8a2807bb5186576c61" id="reference-1970cf5f1ee391ca578a">Haskell アクションとラムダ 超入門</a></li>
<li><a href="http://qiita.com/7shi/items/d3d3492ddd90d47160f2" id="reference-3b0045e27b91232ccc0d">Haskell IOモナド 超入門</a></li>
<li><a href="http://qiita.com/7shi/items/deb19c4cba933590ffbf" id="reference-847f8a25c336d434ee71">Haskell リストモナド 超入門</a></li>
<li><a href="http://qiita.com/7shi/items/c7d7eec066af0fe0688d" id="reference-34e9b8a545f740b9693e">Haskell Maybeモナド 超入門</a></li>
<li><a href="http://qiita.com/7shi/items/2e9bff5d88302de1a9e9" id="reference-ee4c0fc0fd35517b1a57">Haskell 状態系モナド 超入門</a></li>
<li>Haskell モナド変換子 超入門 ← この記事</li>
<li><a href="http://qiita.com/7shi/items/73e534c47bbebc71b37e" id="reference-7b2608dd7a5ec9db16da">Haskell 例外処理 超入門</a></li>
<li><a href="http://qiita.com/7shi/items/b8c741e78a96ea2c10fe" id="reference-18343460d60b60d45847">Haskell 構文解析 超入門</a></li>
<li>【予定】Haskell 継続モナド 超入門</li>
<li>【予定】Haskell 型クラス 超入門</li>
<li>【予定】Haskell モナドとゆかいな仲間たち</li>
<li>【予定】Haskell Freeモナド 超入門</li>
<li>【予定】Haskell Operationalモナド 超入門</li>
<li>【予定】Haskell Effモナド 超入門</li>
<li>【予定】Haskell アロー 超入門</li>
</ol>

<p>練習の解答例は別記事に掲載します。</p>

<ul>
<li><a href="http://qiita.com/7shi/items/79fe0e4c77427368ae2d" id="reference-7d6be221a8e5938ed0ab">【解答例】Haskell モナド変換子 超入門</a></li>
</ul>

<h1>
<span id="モナド変換子" class="fragment"></span><a href="#%E3%83%A2%E3%83%8A%E3%83%89%E5%A4%89%E6%8F%9B%E5%AD%90"><i class="fa fa-link"></i></a>モナド変換子</h1>

<p><code>do</code>の中では同じ種類のモナドしか使うことができません。</p>

<p>たとえば次のようにStateモナドとIOモナドを併用することはできません。</p>

<div class="code-frame" data-lang="hs">
<div class="code-lang"><span class="bold">NG</span></div>
<div class="highlight"><pre>
<span class="kr">import</span> <span class="nn">Control.Monad</span>
<span class="kr">import</span> <span class="nn">Control.Monad.State</span>

<span class="nf">sum'</span> <span class="n">xs</span> <span class="ow">=</span> <span class="p">(`</span><span class="n">execState</span><span class="p">`</span> <span class="mi">0</span><span class="p">)</span> <span class="o">$</span> <span class="kr">do</span>
    <span class="n">forM_</span> <span class="n">xs</span> <span class="o">$</span> <span class="nf">\</span><span class="n">i</span> <span class="ow">-&gt;</span> <span class="kr">do</span>
        <span class="n">modify</span> <span class="p">(</span><span class="o">+</span> <span class="n">i</span><span class="p">)</span>
        <span class="n">v</span> <span class="ow">&lt;-</span> <span class="n">get</span>
        <span class="n">putStrLn</span> <span class="o">$</span> <span class="s">"+"</span> <span class="o">++</span> <span class="n">show</span> <span class="n">i</span> <span class="o">++</span> <span class="s">" -&gt; "</span> <span class="o">++</span> <span class="n">show</span> <span class="n">v</span>  <span class="c1">-- エラー</span>

<span class="nf">main</span> <span class="ow">=</span> <span class="kr">do</span>
    <span class="n">print</span> <span class="o">$</span> <span class="n">sum'</span> <span class="p">[</span><span class="mi">1</span><span class="o">..</span><span class="mi">5</span><span class="p">]</span>
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">エラー内容</span></div>
<div class="highlight"><pre>
Couldn't match type `IO'
              with `StateT c transformers-0.3.0.0:Data.Functor.Identity.Identity'
Expected type: State c ()
  Actual type: IO ()
</pre></div>
</div>

<p>このような問題に対処するのがモナド変換子です。説明は後回しで例を示します。</p>

<div class="code-frame" data-lang="hs"><div class="highlight"><pre>
<span class="kr">import</span> <span class="nn">Control.Monad</span>
<span class="kr">import</span> <span class="nn">Control.Monad.State</span>

<span class="nf">sum'</span> <span class="n">xs</span> <span class="ow">=</span> <span class="p">(`</span><span class="n">execStateT</span><span class="p">`</span> <span class="mi">0</span><span class="p">)</span> <span class="o">$</span> <span class="kr">do</span>                              <span class="c1">-- execStateT</span>
    <span class="n">forM_</span> <span class="n">xs</span> <span class="o">$</span> <span class="nf">\</span><span class="n">i</span> <span class="ow">-&gt;</span> <span class="kr">do</span>
        <span class="n">modify</span> <span class="p">(</span><span class="o">+</span> <span class="n">i</span><span class="p">)</span>
        <span class="n">v</span> <span class="ow">&lt;-</span> <span class="n">get</span>
        <span class="n">lift</span> <span class="o">$</span> <span class="n">putStrLn</span> <span class="o">$</span> <span class="s">"+"</span> <span class="o">++</span> <span class="n">show</span> <span class="n">i</span> <span class="o">++</span> <span class="s">" -&gt; "</span> <span class="o">++</span> <span class="n">show</span> <span class="n">v</span>  <span class="c1">-- lift</span>

<span class="nf">main</span> <span class="ow">=</span> <span class="kr">do</span>
    <span class="n">print</span> <span class="o">=&lt;&lt;</span> <span class="n">sum'</span> <span class="p">[</span><span class="mi">1</span><span class="o">..</span><span class="mi">5</span><span class="p">]</span>                                    <span class="c1">-- $ → =&lt;&lt;</span>
</pre></div></div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre>
+1 -&gt; 1
+2 -&gt; 3
+3 -&gt; 6
+4 -&gt; 10
+5 -&gt; 15
15
</pre></div>
</div>

<p><code>execStateT</code>や<code>lift</code>などが新しく登場しています。<code>print</code>の次が<code>=&lt;&lt;</code>になっています。</p>

<p>これらを説明する前に必要なものから見て行きます。</p>

<h1>
<span id="identityモナド" class="fragment"></span><a href="#identity%E3%83%A2%E3%83%8A%E3%83%89"><i class="fa fa-link"></i></a>Identityモナド</h1>

<div class="code-frame" data-lang="hs">
<div class="code-lang"><span class="bold">型表記</span></div>
<div class="highlight"><pre>
<span class="kt">Identity</span> <span class="n">a</span>
</pre></div>
</div>

<p>中に値が入っているだけの最も単純なモナドです。identityは<a href="http://ja.wikipedia.org/wiki/%E6%81%92%E7%AD%89%E5%BC%8F" rel="nofollow noopener" target="_blank">恒等式</a>という意味で、Identityモナドは恒等モナドとも呼ばれます。</p>

<p>※ <a href="http://ja.wikipedia.org/wiki/%E8%87%AA%E5%B7%B1%E5%90%8C%E4%B8%80%E6%80%A7" rel="nofollow noopener" target="_blank">自己同一性</a>などと訳されるアイデンティティと同じ単語です。</p>

<p>値は<code>runIdentity</code>で取り出せます。</p>

<div class="code-frame" data-lang="hs"><div class="highlight"><pre>
<span class="kr">import</span> <span class="nn">Control.Monad.Identity</span>

<span class="nf">main</span> <span class="ow">=</span> <span class="kr">do</span>
    <span class="kr">let</span> <span class="n">a</span> <span class="ow">=</span> <span class="n">return</span> <span class="mi">1</span> <span class="ow">::</span> <span class="kt">Identity</span> <span class="kt">Int</span>  <span class="c1">-- 生成</span>
    <span class="n">print</span> <span class="o">$</span> <span class="n">runIdentity</span> <span class="n">a</span>             <span class="c1">-- 値の取り出し（評価）</span>
</pre></div></div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre>
1
</pre></div>
</div>

<p>モナドには値だけが入っていて、関数や状態が隠されてはいません。リストモナドと違って要素数は1固定です。</p>

<p>特別な機能はなく、何もしないモナドです。</p>

<h2>
<span id="id" class="fragment"></span><a href="#id"><i class="fa fa-link"></i></a>id</h2>

<div class="code-frame" data-lang="hs">
<div class="code-lang"><span class="bold">型</span></div>
<div class="highlight"><pre>
<span class="nf">id</span> <span class="ow">::</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">a</span>
</pre></div>
</div>

<p>引数をそのまま返す関数です。<code>id</code>はidentityに由来して恒等関数とも呼ばれます。</p>

<p>高階関数に何か関数を渡す際、何もして欲しくないときなどに使います。次の例での<code>f id</code>が該当します。</p>

<div class="code-frame" data-lang="hs"><div class="highlight"><pre>
<span class="nf">f</span> <span class="n">g</span> <span class="n">x</span> <span class="ow">=</span> <span class="n">g</span> <span class="n">x</span>

<span class="nf">main</span> <span class="ow">=</span> <span class="kr">do</span>
    <span class="n">print</span> <span class="mi">1</span>
    <span class="n">print</span> <span class="o">$</span> <span class="n">id</span> <span class="mi">1</span>
    <span class="n">print</span> <span class="o">$</span> <span class="n">f</span> <span class="n">id</span> <span class="mi">1</span>  <span class="c1">-- 注目</span>
</pre></div></div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre>
1
1
1
</pre></div>
</div>

<p>この例での<code>f</code>はポイントフリースタイルを進めると引数が全部消えますが、このようなときに右辺を埋めるのにも<code>id</code>は使えます。</p>

<ol>
<li><code>f g x = g x</code></li>
<li><code>f g   = g</code></li>
<li>
<code>f     =</code> ← エラー</li>
<li><code>f     = id</code></li>
</ol>

<p><code>Identity</code>はモナド、<code>id</code>は関数での、似たような位置付けのものです。</p>

<h1>
<span id="statetモナド変換子" class="fragment"></span><a href="#statet%E3%83%A2%E3%83%8A%E3%83%89%E5%A4%89%E6%8F%9B%E5%AD%90"><i class="fa fa-link"></i></a>StateTモナド変換子</h1>

<p>Stateモナドに対するモナド変換子です。</p>

<ul>
<li>Tは "transformer" の略で、モナド変換子を表す接尾辞です。</li>
<li>モナド変換子はモナドの一種です。</li>
</ul>

<h2>
<span id="型表記" class="fragment"></span><a href="#%E5%9E%8B%E8%A1%A8%E8%A8%98"><i class="fa fa-link"></i></a>型表記</h2>

<div class="code-frame" data-lang="hs"><div class="highlight"><pre>
<span class="kt">StateT</span> <span class="n">s</span> <span class="n">m</span> <span class="n">a</span>
</pre></div></div>

<ul>
<li>
<code>State s a</code>に対して<code>m</code>が増えています。</li>
<li>
<code>m</code>は任意のモナドを指定します。モナドの変換に関係します。</li>
</ul>

<h2>
<span id="stateモナドとの関係" class="fragment"></span><a href="#state%E3%83%A2%E3%83%8A%E3%83%89%E3%81%A8%E3%81%AE%E9%96%A2%E4%BF%82"><i class="fa fa-link"></i></a>Stateモナドとの関係</h2>

<div class="code-frame" data-lang="hs">
<div class="code-lang"><span class="bold">定義</span></div>
<div class="highlight"><pre>
<span class="kr">type</span> <span class="kt">State</span> <span class="n">s</span> <span class="n">a</span> <span class="ow">=</span> <span class="kt">StateT</span> <span class="n">s</span> <span class="kt">Identity</span> <span class="n">a</span>
</pre></div>
</div>

<p>StateモナドはStateTモナド変換子の<code>m</code>に<code>Identity</code>を指定したものです。何もしないIdentityモナドを指定することで、変換子を無効化して単なるモナドにしています。</p>

<p>StateTモナド変換子にIdentityモナドを指定することでStateモナドが作れることを確認します。</p>

<div class="code-frame" data-lang="hs"><div class="highlight"><pre>
<span class="kr">import</span> <span class="nn">Control.Monad.Identity</span>
<span class="kr">import</span> <span class="nn">Control.Monad.State</span>

<span class="nf">main</span> <span class="ow">=</span> <span class="kr">do</span>
    <span class="kr">let</span> <span class="n">a</span> <span class="ow">=</span> <span class="n">return</span> <span class="mi">1</span> <span class="ow">::</span> <span class="kt">StateT</span> <span class="n">s</span> <span class="kt">Identity</span> <span class="kt">Int</span>  <span class="c1">-- StateTとして生成</span>
    <span class="n">print</span> <span class="o">$</span> <span class="n">evalState</span> <span class="n">a</span> <span class="nb">()</span>                     <span class="c1">-- Stateとして評価</span>
</pre></div></div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre>
1
</pre></div>
</div>

<p>StateTモナド変換子を型指定しているのに<code>evalState</code>が適用できています。</p>

<p>Identity以外のモナドを指定すると破綻します。</p>

<div class="code-frame" data-lang="hs">
<div class="code-lang"><span class="bold">NG</span></div>
<div class="highlight"><pre>
<span class="kr">import</span> <span class="nn">Control.Monad.Identity</span>
<span class="kr">import</span> <span class="nn">Control.Monad.State</span>

<span class="nf">main</span> <span class="ow">=</span> <span class="kr">do</span>
    <span class="kr">let</span> <span class="n">a</span> <span class="ow">=</span> <span class="n">return</span> <span class="mi">1</span> <span class="ow">::</span> <span class="kt">StateT</span> <span class="n">s</span> <span class="kt">IO</span> <span class="kt">Int</span>
    <span class="n">print</span> <span class="o">$</span> <span class="n">evalState</span> <span class="n">a</span> <span class="nb">()</span>               <span class="c1">-- エラー</span>
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">エラー内容</span></div>
<div class="highlight"><pre>
Couldn't match type `IO' with `Identity'
Expected type: State () Int
  Actual type: StateT () IO Int
</pre></div>
</div>

<p>IOを指定するケースがモナド変換子の真骨頂ですが、詳細は後の方で取り上げます。</p>

<h3>
<span id="類似例" class="fragment"></span><a href="#%E9%A1%9E%E4%BC%BC%E4%BE%8B"><i class="fa fa-link"></i></a>類似例</h3>

<p>IOモナドがSTモナドの<code>s</code>に<code>RealWorld</code>を指定したものと相互変換できる関係と似ています。</p>

<ul>
<li>
<code>IO a</code> ⇔ <code>ST RealWorld a</code>
</li>
</ul>

<p>IOモナドとSTモナドの関係は等価物として変換可能ということですが、Stateモナドは実体がStateTモナド変換子のため変換は介在しません。</p>

<ul>
<li>
<code>State s a</code> == <code>StateT s Identity a</code>
</li>
</ul>

<p>STは "state-transformer" でモナド変換子のTと同じ単語ですが、STはモナド変換子ではありません。"transformer" の意味合いが異なるようです。</p>

<h2>
<span id="内部関数" class="fragment"></span><a href="#%E5%86%85%E9%83%A8%E9%96%A2%E6%95%B0"><i class="fa fa-link"></i></a>内部関数</h2>

<div class="code-frame" data-lang="hs">
<div class="code-lang"><span class="bold">型</span></div>
<div class="highlight"><pre>
<span class="nf">s</span> <span class="ow">-&gt;</span> <span class="n">m</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
</pre></div>
</div>

<p>Stateモナドでは<code>m</code>が<code>Identity</code>のため、内部関数は次のようになります。</p>

<div class="code-frame" data-lang="hs">
<div class="code-lang"><span class="bold">型</span></div>
<div class="highlight"><pre>
<span class="nf">s</span> <span class="ow">-&gt;</span> <span class="kt">Identity</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
</pre></div>
</div>

<p>Stateモナドでは<code>runState</code>に状態を渡さずに部分適用したものが内部関数だと見なせますが、実際に入っている内部関数は戻り値がIdentityモナドで包まれています。実用上はIdentityモナドを見せる必要がないため、<code>runState</code>は内部関数をラップしてIdentityモナドを隠しています。</p>

<h2>
<span id="runstatet" class="fragment"></span><a href="#runstatet"><i class="fa fa-link"></i></a>runStateT</h2>

<div class="code-frame" data-lang="hs">
<div class="code-lang"><span class="bold">型</span></div>
<div class="highlight"><pre>
<span class="nf">runStateT</span> <span class="ow">::</span> <span class="kt">StateT</span> <span class="n">s</span> <span class="n">m</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">s</span> <span class="ow">-&gt;</span> <span class="n">m</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">s</span><span class="p">)</span>
</pre></div>
</div>

<p>StateTモナド変換子から内部関数を取り出します。</p>

<p>※ runという表現に違和感があれば、rを無視してunStateTだと見立てると良いかもしれません。</p>

<p><code>runState</code>のように関数を加工することはありません。両者を比較します。</p>

<div class="code-frame" data-lang="hs"><div class="highlight"><pre>
<span class="kr">import</span> <span class="nn">Control.Monad.Identity</span>
<span class="kr">import</span> <span class="nn">Control.Monad.State</span>

<span class="nf">st</span> <span class="ow">=</span> <span class="n">return</span> <span class="mi">1</span> <span class="ow">::</span> <span class="kt">State</span> <span class="n">s</span> <span class="kt">Int</span>     <span class="c1">-- Stateを生成</span>

<span class="nf">f1</span> <span class="ow">::</span> <span class="n">s</span> <span class="ow">-&gt;</span> <span class="p">(</span><span class="kt">Int</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
<span class="nf">f1</span> <span class="ow">=</span> <span class="n">runState</span> <span class="n">st</span>                 <span class="c1">-- 加工された内部関数を取り出し</span>

<span class="nf">f2</span> <span class="ow">::</span> <span class="n">s</span> <span class="ow">-&gt;</span> <span class="kt">Identity</span> <span class="p">(</span><span class="kt">Int</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
<span class="nf">f2</span> <span class="ow">=</span> <span class="n">runStateT</span> <span class="n">st</span>                <span class="c1">-- 生の内部関数を取り出し</span>

<span class="nf">main</span> <span class="ow">=</span> <span class="kr">do</span>
    <span class="n">print</span> <span class="o">$</span> <span class="n">f1</span> <span class="nb">()</span>                <span class="c1">-- (値, 状態)</span>
    <span class="n">print</span> <span class="o">$</span> <span class="n">runIdentity</span> <span class="o">$</span> <span class="n">f2</span> <span class="nb">()</span>  <span class="c1">-- Identityで包まれている</span>
</pre></div></div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre>
(1,())
(1,())
</pre></div>
</div>

<h3>
<span id="片方だけを取得する関数" class="fragment"></span><a href="#%E7%89%87%E6%96%B9%E3%81%A0%E3%81%91%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B%E9%96%A2%E6%95%B0"><i class="fa fa-link"></i></a>片方だけを取得する関数</h3>

<p><code>runState</code>と同じように、<code>runStateT</code>にも値や状態だけを返す関数があります。</p>

<ul>
<li>値だけ: <code>evalStateT :: (Monad m) =&gt; StateT s m a -&gt; s -&gt; m a</code>
</li>
<li>状態だけ: <code>execStateT :: (Monad m) =&gt; StateT s m a -&gt; s -&gt; m s</code>
</li>
</ul>

<p>比較します。</p>

<div class="code-frame" data-lang="hs"><div class="highlight"><pre>
<span class="kr">import</span> <span class="nn">Control.Monad.Identity</span>
<span class="kr">import</span> <span class="nn">Control.Monad.State</span>

<span class="nf">main</span> <span class="ow">=</span> <span class="kr">do</span>
    <span class="kr">let</span> <span class="n">st</span> <span class="ow">=</span> <span class="n">return</span> <span class="mi">1</span> <span class="ow">::</span> <span class="kt">StateT</span> <span class="n">s</span> <span class="kt">Identity</span> <span class="kt">Int</span>
    <span class="n">print</span> <span class="o">$</span> <span class="n">runIdentity</span> <span class="o">$</span>  <span class="n">runStateT</span> <span class="n">st</span> <span class="nb">()</span>      <span class="c1">-- (値, 状態)</span>
    <span class="n">print</span> <span class="o">$</span> <span class="n">runIdentity</span> <span class="o">$</span> <span class="n">evalStateT</span> <span class="n">st</span> <span class="nb">()</span>      <span class="c1">--  値</span>
    <span class="n">print</span> <span class="o">$</span> <span class="n">runIdentity</span> <span class="o">$</span> <span class="n">execStateT</span> <span class="n">st</span> <span class="nb">()</span>      <span class="c1">--      状態</span>
</pre></div></div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre>
(1,())
1
()
</pre></div>
</div>

<h2>
<span id="statet" class="fragment"></span><a href="#statet"><i class="fa fa-link"></i></a>StateT</h2>

<div class="code-frame" data-lang="hs">
<div class="code-lang"><span class="bold">型</span></div>
<div class="highlight"><pre>
<span class="kt">StateT</span> <span class="ow">::</span> <span class="p">(</span><span class="n">s</span> <span class="ow">-&gt;</span> <span class="n">m</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">s</span><span class="p">))</span> <span class="ow">-&gt;</span> <span class="kt">StateT</span> <span class="n">s</span> <span class="n">m</span> <span class="n">a</span>
</pre></div>
</div>

<p>関数からStateTモナド変換子を生成します。<code>runStateT</code>の逆です。</p>

<p>応用として、Stateモナドを関数から自作してみます。</p>

<div class="code-frame" data-lang="hs"><div class="highlight"><pre>
<span class="kr">import</span> <span class="nn">Control.Monad.Identity</span>
<span class="kr">import</span> <span class="nn">Control.Monad.State</span>

<span class="nf">main</span> <span class="ow">=</span> <span class="kr">do</span>
    <span class="kr">let</span> <span class="n">st</span> <span class="ow">=</span> <span class="kt">StateT</span> <span class="o">$</span> <span class="nf">\</span><span class="n">s</span> <span class="ow">-&gt;</span> <span class="kt">Identity</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>  <span class="c1">-- 関数から生成</span>
    <span class="n">print</span> <span class="o">$</span> <span class="n">runIdentity</span> <span class="o">$</span> <span class="n">runStateT</span> <span class="n">st</span> <span class="nb">()</span>    <span class="c1">-- StateTとして評価</span>
    <span class="n">print</span> <span class="o">$</span> <span class="n">runState</span> <span class="n">st</span> <span class="nb">()</span>                   <span class="c1">-- Stateとして評価</span>
</pre></div></div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre>
(1,())
(1,())
</pre></div>
</div>

<p>StateTモナド変換子として作った<code>st</code>が<code>runState</code>で評価できています。</p>

<h2>
<span id="ioモナドとの比較" class="fragment"></span><a href="#io%E3%83%A2%E3%83%8A%E3%83%89%E3%81%A8%E3%81%AE%E6%AF%94%E8%BC%83"><i class="fa fa-link"></i></a>IOモナドとの比較</h2>

<p>内部関数を出し入れする関数をIOモナドと比較します。</p>

<p><a href="https://qiita-image-store.s3.amazonaws.com/0/32057/af9f600f-8169-0bc1-9901-537b495a2aa2.png" target="_blank" rel="nofollow noopener"><img src="https://qiita-image-store.s3.amazonaws.com/0/32057/af9f600f-8169-0bc1-9901-537b495a2aa2.png" alt="IO-StateT.png"></a></p>

<table>
<thead>
<tr>
<th>型</th>
<th>取り出し</th>
<th>格納</th>
</tr>
</thead>
<tbody>
<tr>
<td>IO</td>
<td>unIO</td>
<td>IO</td>
</tr>
<tr>
<td>StateT</td>
<td>runStateT</td>
<td>StateT</td>
</tr>
</tbody>
</table>

<h2>
<span id="練習" class="fragment"></span><a href="#%E7%B7%B4%E7%BF%92"><i class="fa fa-link"></i></a>練習</h2>

<p>【問1】Stateモナドを扱う<code>return</code>を<code>StateT</code>を使って、<code>runState</code>を<code>runStateT</code>を使って再実装してください。</p>

<p>具体的には次のコードが動くようにしてください。</p>

<div class="code-frame" data-lang="hs"><div class="highlight"><pre>
<span class="nf">main</span> <span class="ow">=</span> <span class="kr">do</span>
    <span class="kr">let</span> <span class="n">st</span> <span class="ow">=</span> <span class="n">return'</span> <span class="mi">1</span>
    <span class="n">print</span> <span class="o">$</span> <span class="n">runState'</span> <span class="n">st</span> <span class="nb">()</span>
</pre></div></div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre>
(1,())
</pre></div>
</div>

<p>⇒ <a href="http://qiita.com/7shi/items/79fe0e4c77427368ae2d#state%E3%83%A2%E3%83%8A%E3%83%89" id="reference-7d6be221a8e5938ed0ab">解答例</a></p>

<h1>
<span id="持ち上げ" class="fragment"></span><a href="#%E6%8C%81%E3%81%A1%E4%B8%8A%E3%81%92"><i class="fa fa-link"></i></a>持ち上げ</h1>

<p>ここからはモナド変換子によって別種のモナドを合成する方法について見て行きます。</p>

<p>サンプルの一部を再掲します。</p>

<div class="code-frame" data-lang="hs"><div class="highlight"><pre>
<span class="nf">sum'</span> <span class="n">xs</span> <span class="ow">=</span> <span class="p">(`</span><span class="n">execStateT</span><span class="p">`</span> <span class="mi">0</span><span class="p">)</span> <span class="o">$</span> <span class="kr">do</span>
    <span class="n">forM_</span> <span class="n">xs</span> <span class="o">$</span> <span class="nf">\</span><span class="n">i</span> <span class="ow">-&gt;</span> <span class="kr">do</span>
        <span class="n">modify</span> <span class="p">(</span><span class="o">+</span> <span class="n">i</span><span class="p">)</span>
        <span class="n">v</span> <span class="ow">&lt;-</span> <span class="n">get</span>
        <span class="n">lift</span> <span class="o">$</span> <span class="n">putStrLn</span> <span class="o">$</span> <span class="s">"+"</span> <span class="o">++</span> <span class="n">show</span> <span class="n">i</span> <span class="o">++</span> <span class="s">" -&gt; "</span> <span class="o">++</span> <span class="n">show</span> <span class="n">v</span>  <span class="c1">-- 注目</span>
</pre></div></div>

<p><code>lift</code>の後にIOモナドを記述することで、StateモナドとIOモナドを混ぜています。<code>lift</code>は<strong>持ち上げ</strong>と訳されます。</p>

<p>※ ウェイトリフティング（<a href="http://ja.wikipedia.org/wiki/%E9%87%8D%E9%87%8F%E6%8C%99%E3%81%92" rel="nofollow noopener" target="_blank">重量挙げ</a>）のリフトです。</p>

<p>まずStateTモナド変換子の<code>m</code>に<code>IO</code>を指定すると何が起きるかを確認します。</p>

<h2>
<span id="statet-s-io-a" class="fragment"></span><a href="#statet-s-io-a"><i class="fa fa-link"></i></a>StateT s IO a</h2>

<p>内部関数は次のようになります。</p>

<div class="code-frame" data-lang="hs">
<div class="code-lang"><span class="bold">型</span></div>
<div class="highlight"><pre>
<span class="nf">s</span> <span class="ow">-&gt;</span> <span class="kt">IO</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
</pre></div>
</div>

<p>これを入れたStateTモナド変換子を<code>runStateT</code>で初期値を指定して評価すると、IOモナドが返って来ます。StateTモナド変換子の中にIOモナドが入っていると見なせます。</p>

<p>※ <code>m</code>に<code>IO</code>を指定するとStateモナドとは互換性がなくなるため<code>runState</code>は使えません。</p>

<p><a href="https://qiita-image-store.s3.amazonaws.com/0/32057/622eea6e-17dd-5402-2151-32bcad893e53.png" target="_blank" rel="nofollow noopener"><img src="https://qiita-image-store.s3.amazonaws.com/0/32057/622eea6e-17dd-5402-2151-32bcad893e53.png" alt="runStateT.png"></a></p>

<div class="code-frame" data-lang="hs"><div class="highlight"><pre>
<span class="kr">import</span> <span class="nn">Control.Monad.State</span>

<span class="nf">f</span> <span class="ow">::</span> <span class="n">s</span> <span class="ow">-&gt;</span> <span class="kt">IO</span> <span class="p">(</span><span class="kt">Int</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>         <span class="c1">-- 内部関数</span>
<span class="nf">f</span> <span class="n">s</span> <span class="ow">=</span> <span class="n">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>

<span class="nf">a</span> <span class="ow">::</span> <span class="kt">StateT</span> <span class="n">s</span> <span class="kt">IO</span> <span class="kt">Int</span>
<span class="nf">a</span> <span class="ow">=</span> <span class="kt">StateT</span> <span class="n">f</span>                  <span class="c1">-- 関数から生成</span>

<span class="nf">main</span> <span class="ow">=</span> <span class="kr">do</span>
    <span class="n">print</span> <span class="o">=&lt;&lt;</span> <span class="n">f</span> <span class="nb">()</span>            <span class="c1">-- 関数を評価</span>
    <span class="n">print</span> <span class="o">=&lt;&lt;</span> <span class="n">runStateT</span> <span class="n">a</span> <span class="nb">()</span>  <span class="c1">-- StateTを評価</span>
</pre></div></div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre>
(1,())
(1,())
</pre></div>
</div>

<p><code>runStateT</code>は内部関数を取り出すだけです。内部関数を直接評価しても、StateTモナド変換子に入れて<code>runStateT</code>経由で評価しても、同じ結果です。後者はモナドが介在して追いにくいので、前者の動きに注目すると良いでしょう。</p>

<h2>
<span id="print" class="fragment"></span><a href="#print"><i class="fa fa-link"></i></a>print</h2>

<p>内部関数の中で<code>print</code>を使用してみます。</p>

<div class="code-frame" data-lang="hs"><div class="highlight"><pre>
<span class="kr">import</span> <span class="nn">Control.Monad.State</span>

<span class="nf">f</span> <span class="ow">::</span> <span class="n">s</span> <span class="ow">-&gt;</span> <span class="kt">IO</span> <span class="p">(</span><span class="nb">()</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>         <span class="c1">-- StateTの内部関数</span>
<span class="nf">f</span> <span class="n">s</span> <span class="ow">=</span> <span class="kr">do</span>
    <span class="n">a</span> <span class="ow">&lt;-</span> <span class="n">print</span> <span class="s">"hello"</span>       <span class="c1">-- printを使用</span>
    <span class="n">return</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>            <span class="c1">-- IOモナドを返す</span>

<span class="nf">a</span> <span class="ow">::</span> <span class="kt">StateT</span> <span class="n">s</span> <span class="kt">IO</span> <span class="nb">()</span>
<span class="nf">a</span> <span class="ow">=</span> <span class="kt">StateT</span> <span class="n">f</span>                 <span class="c1">-- 生成</span>

<span class="nf">main</span> <span class="ow">=</span> <span class="kr">do</span>
    <span class="n">print</span> <span class="o">=&lt;&lt;</span> <span class="n">f</span> <span class="mi">1</span>            <span class="c1">-- 関数を評価</span>
    <span class="n">print</span> <span class="o">=&lt;&lt;</span> <span class="n">runStateT</span> <span class="n">a</span> <span class="mi">1</span>  <span class="c1">-- StateTを評価</span>
</pre></div></div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre>
"hello"
((),1)
"hello"
((),1)
</pre></div>
</div>

<h2>
<span id="lift" class="fragment"></span><a href="#lift"><i class="fa fa-link"></i></a>lift</h2>

<div class="code-frame" data-lang="hs">
<div class="code-lang"><span class="bold">型</span></div>
<div class="highlight"><pre>
<span class="nf">lift</span> <span class="ow">::</span> <span class="p">(</span><span class="kt">Monad</span> <span class="n">m</span><span class="p">)</span> <span class="ow">=&gt;</span> <span class="n">m</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">t</span> <span class="n">m</span> <span class="n">a</span>
</pre></div>
</div>

<p>モナドからモナド変換子を生成する関数です。型注釈の<code>t</code>はモナド変換子を表します。</p>

<p>内部関数の自作と<code>lift</code>とを比較します。IOモナドをStateTモナド変換子の中に入れています。</p>

<p><a href="https://qiita-image-store.s3.amazonaws.com/0/32057/ae3e8f54-1903-afa3-d6ec-77e69d34b0aa.png" target="_blank" rel="nofollow noopener"><img src="https://qiita-image-store.s3.amazonaws.com/0/32057/ae3e8f54-1903-afa3-d6ec-77e69d34b0aa.png" alt="lift.png"></a></p>

<div class="code-frame" data-lang="hs"><div class="highlight"><pre>
<span class="kr">import</span> <span class="nn">Control.Monad.State</span>

<span class="nf">a1</span> <span class="ow">::</span> <span class="kt">StateT</span> <span class="n">s</span> <span class="kt">IO</span> <span class="nb">()</span>
<span class="nf">a1</span> <span class="ow">=</span> <span class="kt">StateT</span> <span class="o">$</span> <span class="nf">\</span><span class="n">s</span> <span class="ow">-&gt;</span> <span class="kr">do</span>        <span class="c1">-- 内部関数の自作</span>
    <span class="n">a</span> <span class="ow">&lt;-</span> <span class="n">print</span> <span class="s">"hello"</span>
    <span class="n">return</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>

<span class="nf">a2</span> <span class="ow">::</span> <span class="kt">StateT</span> <span class="n">s</span> <span class="kt">IO</span> <span class="nb">()</span>
<span class="nf">a2</span> <span class="ow">=</span> <span class="n">lift</span> <span class="o">$</span> <span class="n">print</span> <span class="s">"hello"</span>     <span class="c1">-- lift</span>

<span class="nf">main</span> <span class="ow">=</span> <span class="kr">do</span>
    <span class="n">print</span> <span class="o">=&lt;&lt;</span> <span class="n">runStateT</span> <span class="n">a1</span> <span class="mi">1</span>  <span class="c1">-- 評価結果はIOで返る</span>
    <span class="n">print</span> <span class="o">=&lt;&lt;</span> <span class="n">runStateT</span> <span class="n">a2</span> <span class="mi">1</span>  <span class="c1">-- 同上</span>
</pre></div></div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre>
"hello"
((),1)
"hello"
((),1)
</pre></div>
</div>

<h3>
<span id="捉え方" class="fragment"></span><a href="#%E6%8D%89%E3%81%88%E6%96%B9"><i class="fa fa-link"></i></a>捉え方</h3>

<p><code>lift</code>はモナド変換子版の<code>return</code>のようなものだと捉えられます。</p>

<p><a href="https://qiita-image-store.s3.amazonaws.com/0/32057/8b54dce3-9e37-d565-8d8c-ef75f34a7c90.png" target="_blank" rel="nofollow noopener"><img src="https://qiita-image-store.s3.amazonaws.com/0/32057/8b54dce3-9e37-d565-8d8c-ef75f34a7c90.png" alt="return-lift.png"></a></p>

<ul>
<li>
<code>return</code>: 値 → モナド</li>
<li>
<code>lift</code>: モナド → モナド変換子</li>
</ul>

<h2>
<span id="組み合わせ" class="fragment"></span><a href="#%E7%B5%84%E3%81%BF%E5%90%88%E3%82%8F%E3%81%9B"><i class="fa fa-link"></i></a>組み合わせ</h2>

<p>先の例のように単独で<code>lift</code>を使ってもあまり意味はありませんが、StateアクションとIOアクションとを併用するときに真価を発揮します。</p>

<p>状態を<code>get</code>で取得して<code>print</code>で表示する例です。</p>

<div class="code-frame" data-lang="hs"><div class="highlight"><pre>
<span class="kr">import</span> <span class="nn">Control.Monad.State</span>

<span class="nf">a</span> <span class="ow">::</span> <span class="kt">StateT</span> <span class="kt">String</span> <span class="kt">IO</span> <span class="nb">()</span>
<span class="nf">a</span> <span class="ow">=</span> <span class="kr">do</span>
    <span class="n">v</span> <span class="ow">&lt;-</span> <span class="n">get</span>        <span class="c1">-- Stateアクション</span>
    <span class="n">lift</span> <span class="o">$</span> <span class="n">print</span> <span class="n">v</span>  <span class="c1">-- IOアクション</span>

<span class="nf">main</span> <span class="ow">=</span> <span class="kr">do</span>
    <span class="n">runStateT</span> <span class="n">a</span> <span class="s">"hello"</span>
</pre></div></div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre>
"hello"
</pre></div>
</div>

<p><code>runStateT</code>の評価結果はIOモナドに包まれているため、IOモナドに関連した操作はすべて閉じ込められるという原則は守られています。</p>

<h2>
<span id="モナドスタック" class="fragment"></span><a href="#%E3%83%A2%E3%83%8A%E3%83%89%E3%82%B9%E3%82%BF%E3%83%83%E3%82%AF"><i class="fa fa-link"></i></a>モナドスタック</h2>

<p>モナド変換子とモナドの関係を包含関係として表現しましたが、積み重ねとしても表現できます。後者を<strong>モナドスタック</strong>と呼びます。包むか積むかという表現方法だけの違いで、意味が変わるわけではありません。</p>

<p><a href="https://qiita-image-store.s3.amazonaws.com/0/32057/612c3d4a-f8e5-5e27-d2ff-4c281e3fdafb.png" target="_blank" rel="nofollow noopener"><img src="https://qiita-image-store.s3.amazonaws.com/0/32057/612c3d4a-f8e5-5e27-d2ff-4c281e3fdafb.png" alt="inner-bottom.png"></a></p>

<p><code>print</code>はIOアクションですが、StateTモナド変換子を積むことでStateTアクションに変換されます。モナドスタックの上方のアクションに変換される様子を<strong>持ち上げ</strong>と表現します。</p>

<p><a href="https://qiita-image-store.s3.amazonaws.com/0/32057/c0e8a98d-e369-09cb-7f52-bf923883a451.png" target="_blank" rel="nofollow noopener"><img src="https://qiita-image-store.s3.amazonaws.com/0/32057/c0e8a98d-e369-09cb-7f52-bf923883a451.png" alt="lifting.png"></a></p>

<h2>
<span id="練習-1" class="fragment"></span><a href="#%E7%B7%B4%E7%BF%92-1"><i class="fa fa-link"></i></a>練習</h2>

<p>【問2】StateTモナド変換子を扱う<code>bind</code>, <code>get</code>, <code>modify</code>, <code>lift</code>を実装してください。<code>do</code>は使わないでください。<code>&gt;&gt;=</code>はStateTモナド変換子以外にのみ使ってください。</p>

<p><code>import</code>の際にオリジナルを隠してください。</p>

<div class="code-frame" data-lang="hs"><div class="highlight"><pre>
<span class="kr">import</span> <span class="nn">Control.Monad.State</span> <span class="k">hiding</span> <span class="p">(</span><span class="nf">get</span><span class="p">,</span> <span class="nf">modify</span><span class="p">,</span> <span class="nf">lift</span><span class="p">)</span>
</pre></div></div>

<p>具体的には次のコードが動くようにしてください。</p>

<div class="code-frame" data-lang="hs"><div class="highlight"><pre>
<span class="nf">fact</span> <span class="n">x</span> <span class="ow">=</span> <span class="p">(`</span><span class="n">execStateT</span><span class="p">`</span> <span class="mi">1</span><span class="p">)</span> <span class="o">$</span>
    <span class="n">forM_</span> <span class="p">[</span><span class="mi">1</span><span class="o">..</span><span class="n">x</span><span class="p">]</span> <span class="o">$</span> <span class="nf">\</span><span class="n">i</span> <span class="ow">-&gt;</span>
        <span class="n">modify</span> <span class="p">(</span><span class="o">*</span> <span class="n">i</span><span class="p">)</span> <span class="p">`</span><span class="n">bind</span><span class="p">`</span> <span class="nf">\</span><span class="kr">_</span> <span class="ow">-&gt;</span>
        <span class="n">get</span> <span class="p">`</span><span class="n">bind</span><span class="p">`</span> <span class="nf">\</span><span class="n">v</span> <span class="ow">-&gt;</span>
        <span class="n">lift</span> <span class="o">$</span> <span class="n">putStrLn</span> <span class="o">$</span> <span class="s">"*"</span> <span class="o">++</span> <span class="n">show</span> <span class="n">i</span> <span class="o">++</span> <span class="s">" -&gt; "</span> <span class="o">++</span> <span class="n">show</span> <span class="n">v</span>

<span class="nf">main</span> <span class="ow">=</span> <span class="n">fact</span> <span class="mi">5</span> <span class="o">&gt;&gt;=</span> <span class="n">print</span>
</pre></div></div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre>
*1 -&gt; 1
*2 -&gt; 2
*3 -&gt; 6
*4 -&gt; 24
*5 -&gt; 120
()
</pre></div>
</div>

<p>⇒ <a href="http://qiita.com/7shi/items/79fe0e4c77427368ae2d#%E5%86%8D%E5%AE%9F%E8%A3%85" id="reference-7d6be221a8e5938ed0ab">解答例</a></p>

<p>【問3】問2の<code>fact</code>を<code>do</code>と<code>&lt;-</code>で書き直してください。問2で再実装した関数は使わないでください。</p>

<p>⇒ <a href="http://qiita.com/7shi/items/79fe0e4c77427368ae2d#%E6%9B%B8%E3%81%8D%E7%9B%B4%E3%81%97" id="reference-7d6be221a8e5938ed0ab">解答例</a></p>

<h1>
<span id="maybeモナドとの合成" class="fragment"></span><a href="#maybe%E3%83%A2%E3%83%8A%E3%83%89%E3%81%A8%E3%81%AE%E5%90%88%E6%88%90"><i class="fa fa-link"></i></a>Maybeモナドとの合成</h1>

<p>今までの例ではStateTモナド変換子で合成するのはIOモナドばかりでしたが、もちろんそれ以外のモナドとも合成できます。</p>

<p>例としてMaybeモナドを取り上げます。</p>

<p>次の手順でサンプルを書き換える過程を示します。</p>

<ul>
<li>モナドなし

<ul>
<li>Stateモナド</li>
<li>Maybeモナド</li>
</ul>
</li>
<li>モナド変換子で合成</li>
</ul>

<h2>
<span id="モナドなし" class="fragment"></span><a href="#%E3%83%A2%E3%83%8A%E3%83%89%E3%81%AA%E3%81%97"><i class="fa fa-link"></i></a>モナドなし</h2>

<p><code>getch</code>で1文字ずつ取得して、<code>get3</code>で3文字分を返します。文字数が足らないとエラーが発生します。</p>

<div class="code-frame" data-lang="hs"><div class="highlight"><pre>
<span class="nf">getch</span> <span class="p">(</span><span class="n">x</span><span class="kt">:</span><span class="n">xs</span><span class="p">)</span> <span class="ow">=</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">xs</span><span class="p">)</span>

<span class="nf">get3</span> <span class="n">xs0</span> <span class="ow">=</span>
    <span class="kr">let</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">xs1</span><span class="p">)</span> <span class="ow">=</span> <span class="n">getch</span> <span class="n">xs0</span>
        <span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">xs2</span><span class="p">)</span> <span class="ow">=</span> <span class="n">getch</span> <span class="n">xs1</span>
        <span class="p">(</span><span class="n">x3</span><span class="p">,</span> <span class="n">xs3</span><span class="p">)</span> <span class="ow">=</span> <span class="n">getch</span> <span class="n">xs2</span>
    <span class="kr">in</span> <span class="p">[</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">x3</span><span class="p">]</span>

<span class="nf">main</span> <span class="ow">=</span> <span class="kr">do</span>
    <span class="n">print</span> <span class="o">$</span> <span class="n">get3</span> <span class="s">"abcd"</span>  <span class="c1">-- OK</span>
    <span class="n">print</span> <span class="o">$</span> <span class="n">get3</span> <span class="s">"1234"</span>  <span class="c1">-- OK</span>
    <span class="n">print</span> <span class="o">$</span> <span class="n">get3</span> <span class="s">"a"</span>     <span class="c1">-- NG</span>
</pre></div></div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果（エラー）</span></div>
<div class="highlight"><pre>
"abc"
"123"
xxx: Main.hs:1:1-22: Non-exhaustive patterns in function getch
</pre></div>
</div>

<h3>
<span id="stateモナド" class="fragment"></span><a href="#state%E3%83%A2%E3%83%8A%E3%83%89"><i class="fa fa-link"></i></a>Stateモナド</h3>

<p>状態の受け渡しが冗長なので、Stateモナドで抽象化します。依然としてエラーは発生します。</p>

<div class="code-frame" data-lang="hs"><div class="highlight"><pre>
<span class="kr">import</span> <span class="nn">Control.Monad.State</span>

<span class="nf">getch</span> <span class="ow">=</span> <span class="n">state</span> <span class="n">getch</span> <span class="kr">where</span>   <span class="c1">-- Stateモナドに関数を入れる</span>
    <span class="n">getch</span> <span class="p">(</span><span class="n">x</span><span class="kt">:</span><span class="n">xs</span><span class="p">)</span> <span class="ow">=</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">xs</span><span class="p">)</span>  <span class="c1">-- 状態 -&gt; (値, 状態)</span>

<span class="nf">get3</span> <span class="ow">=</span> <span class="n">evalState</span> <span class="o">$</span> <span class="kr">do</span>
    <span class="n">x1</span> <span class="ow">&lt;-</span> <span class="n">getch</span>
    <span class="n">x2</span> <span class="ow">&lt;-</span> <span class="n">getch</span>
    <span class="n">x3</span> <span class="ow">&lt;-</span> <span class="n">getch</span>
    <span class="n">return</span> <span class="p">[</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">x3</span><span class="p">]</span>

<span class="nf">main</span> <span class="ow">=</span> <span class="kr">do</span>
    <span class="n">print</span> <span class="o">$</span> <span class="n">get3</span> <span class="s">"abcd"</span>  <span class="c1">-- OK</span>
    <span class="n">print</span> <span class="o">$</span> <span class="n">get3</span> <span class="s">"1234"</span>  <span class="c1">-- OK</span>
    <span class="n">print</span> <span class="o">$</span> <span class="n">get3</span> <span class="s">"a"</span>     <span class="c1">-- NG</span>
</pre></div></div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre>
"abc"
"123"
xxx: Pattern match failure in do expression at Main.hs:4:5-10
</pre></div>
</div>

<h3>
<span id="maybeモナド" class="fragment"></span><a href="#maybe%E3%83%A2%E3%83%8A%E3%83%89"><i class="fa fa-link"></i></a>Maybeモナド</h3>

<p>最初のコードに戻って、エラーを避けるためにMaybeモナドで書き換えます。</p>

<div class="code-frame" data-lang="hs"><div class="highlight"><pre>
<span class="nf">getch</span> <span class="p">(</span><span class="n">x</span><span class="kt">:</span><span class="n">xs</span><span class="p">)</span> <span class="ow">=</span> <span class="kt">Just</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">xs</span><span class="p">)</span>
<span class="nf">getch</span> <span class="kr">_</span>      <span class="ow">=</span> <span class="kt">Nothing</span>

<span class="nf">get3</span> <span class="n">xs0</span> <span class="ow">=</span> <span class="kr">do</span>
    <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">xs1</span><span class="p">)</span> <span class="ow">&lt;-</span> <span class="n">getch</span> <span class="n">xs0</span>
    <span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">xs2</span><span class="p">)</span> <span class="ow">&lt;-</span> <span class="n">getch</span> <span class="n">xs1</span>
    <span class="p">(</span><span class="n">x3</span><span class="p">,</span> <span class="n">xs3</span><span class="p">)</span> <span class="ow">&lt;-</span> <span class="n">getch</span> <span class="n">xs2</span>
    <span class="n">return</span> <span class="p">[</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">x3</span><span class="p">]</span>

<span class="nf">main</span> <span class="ow">=</span> <span class="kr">do</span>
    <span class="n">print</span> <span class="o">$</span> <span class="n">get3</span> <span class="s">"abcd"</span>  <span class="c1">-- OK</span>
    <span class="n">print</span> <span class="o">$</span> <span class="n">get3</span> <span class="s">"1234"</span>  <span class="c1">-- OK</span>
    <span class="n">print</span> <span class="o">$</span> <span class="n">get3</span> <span class="s">"a"</span>     <span class="c1">-- NG</span>
</pre></div></div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre>
Just "abc"
Just "123"
Nothing
</pre></div>
</div>

<h2>
<span id="モナド変換子で合成" class="fragment"></span><a href="#%E3%83%A2%E3%83%8A%E3%83%89%E5%A4%89%E6%8F%9B%E5%AD%90%E3%81%A7%E5%90%88%E6%88%90"><i class="fa fa-link"></i></a>モナド変換子で合成</h2>

<p>StateTモナド変換子でMaybeモナドと合成すれば、StateモナドとMaybeモナドの両方の特徴が使えます。</p>

<div class="code-frame" data-lang="hs"><div class="highlight"><pre>
<span class="kr">import</span> <span class="nn">Control.Monad.State</span>

<span class="nf">getch</span> <span class="ow">=</span> <span class="kt">StateT</span> <span class="n">getch</span> <span class="kr">where</span>
    <span class="n">getch</span> <span class="p">(</span><span class="n">x</span><span class="kt">:</span><span class="n">xs</span><span class="p">)</span> <span class="ow">=</span> <span class="kt">Just</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">xs</span><span class="p">)</span>
    <span class="n">getch</span> <span class="kr">_</span>      <span class="ow">=</span> <span class="kt">Nothing</span>

<span class="nf">get3</span> <span class="ow">=</span> <span class="n">evalStateT</span> <span class="o">$</span> <span class="kr">do</span>
    <span class="n">x1</span> <span class="ow">&lt;-</span> <span class="n">getch</span>
    <span class="n">x2</span> <span class="ow">&lt;-</span> <span class="n">getch</span>
    <span class="n">x3</span> <span class="ow">&lt;-</span> <span class="n">getch</span>
    <span class="n">return</span> <span class="p">[</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">x3</span><span class="p">]</span>

<span class="nf">main</span> <span class="ow">=</span> <span class="kr">do</span>
    <span class="n">print</span> <span class="o">$</span> <span class="n">get3</span> <span class="s">"abcd"</span>  <span class="c1">-- OK</span>
    <span class="n">print</span> <span class="o">$</span> <span class="n">get3</span> <span class="s">"1234"</span>  <span class="c1">-- OK</span>
    <span class="n">print</span> <span class="o">$</span> <span class="n">get3</span> <span class="s">"a"</span>     <span class="c1">-- NG</span>
</pre></div></div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre>
Just "abc"
Just "123"
Nothing
</pre></div>
</div>

<p><code>getch</code>はMaybeモナドを返す関数をそのままStateTモナド変換子の中に入れています。StateTモナド変換子の中からMaybeモナドが出て来る構造が表現されています。</p>

<p><a href="https://qiita-image-store.s3.amazonaws.com/0/32057/0d125295-059f-cff6-19f2-c7ca473b2312.png" target="_blank" rel="nofollow noopener"><img src="https://qiita-image-store.s3.amazonaws.com/0/32057/0d125295-059f-cff6-19f2-c7ca473b2312.png" alt="StateT-Maybe-1.png"></a></p>

<p>型で考えると、<code>StateT s Maybe a</code>を評価すれば<code>Maybe a</code>となります。モナドスタックからStateTモナド変換子を取り除いて下のMaybeモナドが残るとイメージできます。</p>

<p><a href="https://qiita-image-store.s3.amazonaws.com/0/32057/36f0c6f5-2cdf-2297-9836-6023fb2eebf4.png" target="_blank" rel="nofollow noopener"><img src="https://qiita-image-store.s3.amazonaws.com/0/32057/36f0c6f5-2cdf-2297-9836-6023fb2eebf4.png" alt="StateT-Maybe-2.png"></a></p>

<p>※ ここで取り上げたサンプルに少し手を加えたものを続編の<a href="http://qiita.com/7shi/items/73e534c47bbebc71b37e">Haskell 例外処理 超入門</a>でも説明します。</p>

<h2>
<span id="練習-2" class="fragment"></span><a href="#%E7%B7%B4%E7%BF%92-2"><i class="fa fa-link"></i></a>練習</h2>

<p>【問4】次のコードは種類を判別しながら文字列を読み進めることを意図しています。Maybeモナドを使ってエラーが起きないように修正してください。モナド変換子は使わないでください。</p>

<div class="code-frame" data-lang="hs"><div class="highlight"><pre>
<span class="kr">import</span> <span class="nn">Data.Char</span>

<span class="nf">getch</span> <span class="n">f</span> <span class="p">(</span><span class="n">x</span><span class="kt">:</span><span class="n">xs</span><span class="p">)</span> <span class="o">|</span> <span class="n">f</span> <span class="n">x</span> <span class="ow">=</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">xs</span><span class="p">)</span>

<span class="nf">test</span> <span class="n">s0</span> <span class="ow">=</span>
    <span class="kr">let</span> <span class="p">(</span><span class="n">ch1</span><span class="p">,</span> <span class="n">s1</span><span class="p">)</span> <span class="ow">=</span> <span class="n">getch</span> <span class="n">isUpper</span> <span class="n">s0</span>
        <span class="p">(</span><span class="n">ch2</span><span class="p">,</span> <span class="n">s2</span><span class="p">)</span> <span class="ow">=</span> <span class="n">getch</span> <span class="n">isLower</span> <span class="n">s1</span>
        <span class="p">(</span><span class="n">ch3</span><span class="p">,</span> <span class="n">s3</span><span class="p">)</span> <span class="ow">=</span> <span class="n">getch</span> <span class="n">isDigit</span> <span class="n">s2</span>
    <span class="kr">in</span> <span class="p">[</span><span class="n">ch1</span><span class="p">,</span> <span class="n">ch2</span><span class="p">,</span> <span class="n">ch3</span><span class="p">]</span>

<span class="nf">main</span> <span class="ow">=</span> <span class="kr">do</span>
    <span class="n">print</span> <span class="o">$</span> <span class="n">test</span> <span class="s">"Aa0"</span>  <span class="c1">-- OK</span>
    <span class="n">print</span> <span class="o">$</span> <span class="n">test</span> <span class="s">"abc"</span>  <span class="c1">-- エラー</span>
</pre></div></div>

<div class="code-frame" data-lang="実行結果"><div class="highlight"><pre>
"Aa0"
Main.hs:3:1-30: Non-exhaustive patterns in function getch
</pre></div></div>

<p>⇒ <a href="http://qiita.com/7shi/items/79fe0e4c77427368ae2d#maybe%E3%83%A2%E3%83%8A%E3%83%89" id="reference-7d6be221a8e5938ed0ab">解答例</a></p>

<p>【問5】問4の解答をStateTモナド変換子を使って書き直してください。</p>

<p>⇒ <a href="http://qiita.com/7shi/items/79fe0e4c77427368ae2d#statet%E3%83%A2%E3%83%8A%E3%83%89%E5%A4%89%E6%8F%9B%E5%AD%90-1" id="reference-7d6be221a8e5938ed0ab">解答例</a></p>

<h1>
<span id="他のモナド変換子" class="fragment"></span><a href="#%E4%BB%96%E3%81%AE%E3%83%A2%E3%83%8A%E3%83%89%E5%A4%89%E6%8F%9B%E5%AD%90"><i class="fa fa-link"></i></a>他のモナド変換子</h1>

<p>State以外のモナドにも対応するモナド変換子があります。</p>

<table>
<thead>
<tr>
<th>モナド</th>
<th>モナド変換子</th>
<th>評価関数</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Reader r a</code></td>
<td><code>ReaderT r m a</code></td>
<td><code>runReaderT</code></td>
</tr>
<tr>
<td><code>Writer w a</code></td>
<td><code>WriterT r m a</code></td>
<td><code>runWriterT</code></td>
</tr>
<tr>
<td><code>[]       a</code></td>
<td><code>ListT     m a</code></td>
<td><code>runListT</code></td>
</tr>
</tbody>
</table>

<h2>
<span id="練習-3" class="fragment"></span><a href="#%E7%B7%B4%E7%BF%92-3"><i class="fa fa-link"></i></a>練習</h2>

<p>【問6】次のコードの<code>print</code>を<code>main</code>から各<code>test*</code>の<code>do</code>の中に移動してください。実行結果が同じになるように調整してください。</p>

<div class="code-frame" data-lang="hs"><div class="highlight"><pre>
<span class="kr">import</span> <span class="nn">Control.Monad.Reader</span>
<span class="kr">import</span> <span class="nn">Control.Monad.Writer</span>
<span class="kr">import</span> <span class="nn">Control.Monad.List</span>

<span class="nf">testR</span> <span class="n">x</span> <span class="ow">=</span> <span class="p">(`</span><span class="n">runReader</span><span class="p">`</span> <span class="n">x</span><span class="p">)</span> <span class="o">$</span> <span class="kr">do</span>
    <span class="n">a</span> <span class="ow">&lt;-</span> <span class="n">ask</span>
    <span class="n">return</span> <span class="o">$</span> <span class="n">a</span> <span class="o">+</span> <span class="mi">1</span>

<span class="nf">testW</span> <span class="n">x</span> <span class="ow">=</span> <span class="n">fst</span> <span class="o">$</span> <span class="n">runWriter</span> <span class="o">$</span> <span class="kr">do</span>
    <span class="n">tell</span> <span class="s">""</span>
    <span class="n">return</span> <span class="o">$</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span>

<span class="nf">testL</span> <span class="n">x</span> <span class="ow">=</span> <span class="kr">do</span>
    <span class="p">[</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

<span class="nf">main</span> <span class="ow">=</span> <span class="kr">do</span>
    <span class="n">print</span> <span class="o">$</span> <span class="n">testR</span> <span class="mi">0</span>
    <span class="n">print</span> <span class="o">$</span> <span class="n">testW</span> <span class="mi">0</span>
    <span class="n">print</span> <span class="o">$</span> <span class="n">testL</span> <span class="mi">0</span>
</pre></div></div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre>
1
1
[1]
</pre></div>
</div>

<p>⇒ <a href="http://qiita.com/7shi/items/79fe0e4c77427368ae2d#%E4%BB%96%E3%81%AE%E3%83%A2%E3%83%8A%E3%83%89%E5%A4%89%E6%8F%9B%E5%AD%90" id="reference-7d6be221a8e5938ed0ab">解答例</a></p>

<h1>
<span id="多重持ち上げ" class="fragment"></span><a href="#%E5%A4%9A%E9%87%8D%E6%8C%81%E3%81%A1%E4%B8%8A%E3%81%92"><i class="fa fa-link"></i></a>多重持ち上げ</h1>

<p>モナドがネストしていると<code>lift</code>が最上位まで届かずにエラーになります。</p>

<p><a href="https://qiita-image-store.s3.amazonaws.com/0/32057/46164a6e-d8d9-1056-d4f7-34d1ea3ef65e.png" target="_blank" rel="nofollow noopener"><img src="https://qiita-image-store.s3.amazonaws.com/0/32057/46164a6e-d8d9-1056-d4f7-34d1ea3ef65e.png" alt="lift-2-NG.png"></a></p>

<div class="code-frame" data-lang="hs">
<div class="code-lang"><span class="bold">NG</span></div>
<div class="highlight"><pre>
<span class="kr">import</span> <span class="nn">Control.Monad.State</span>
<span class="kr">import</span> <span class="nn">Control.Monad.Reader</span>

<span class="nf">test1</span> <span class="n">x</span> <span class="ow">=</span> <span class="p">(`</span><span class="n">runStateT</span><span class="p">`</span> <span class="n">x</span><span class="p">)</span> <span class="o">$</span> <span class="kr">do</span>  <span class="c1">-- StateT</span>
    <span class="n">modify</span> <span class="p">(</span><span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">a</span> <span class="ow">&lt;-</span> <span class="n">get</span>
    <span class="n">lift</span> <span class="o">$</span> <span class="n">print</span> <span class="n">a</span>              <span class="c1">-- OK</span>
    <span class="p">(`</span><span class="n">runReaderT</span><span class="p">`</span> <span class="n">a</span><span class="p">)</span> <span class="o">$</span> <span class="kr">do</span>       <span class="c1">-- ReaderT（ネスト）</span>
        <span class="n">b</span> <span class="ow">&lt;-</span> <span class="n">ask</span>
        <span class="n">lift</span> <span class="o">$</span> <span class="n">print</span> <span class="o">$</span> <span class="n">b</span> <span class="o">+</span> <span class="mi">1</span>    <span class="c1">-- エラー</span>

<span class="nf">main</span> <span class="ow">=</span> <span class="kr">do</span>
    <span class="n">test1</span> <span class="mi">1</span>
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">エラー内容</span></div>
<div class="highlight"><pre>
Couldn't match type `IO' with `StateT b m'
Expected type: StateT b m ()
  Actual type: IO ()
</pre></div>
</div>

<p>ネストした回数だけ<code>lift</code>する必要があります。</p>

<p><a href="https://qiita-image-store.s3.amazonaws.com/0/32057/fc559978-d547-3657-b562-1d7d79bbd925.png" target="_blank" rel="nofollow noopener"><img src="https://qiita-image-store.s3.amazonaws.com/0/32057/fc559978-d547-3657-b562-1d7d79bbd925.png" alt="lift-2.png"></a></p>

<div class="code-frame" data-lang="hs">
<div class="code-lang"><span class="bold">OK</span></div>
<div class="highlight"><pre>
<span class="kr">import</span> <span class="nn">Control.Monad.State</span>
<span class="kr">import</span> <span class="nn">Control.Monad.Reader</span>

<span class="nf">test1</span> <span class="n">x</span> <span class="ow">=</span> <span class="p">(`</span><span class="n">runStateT</span><span class="p">`</span> <span class="n">x</span><span class="p">)</span> <span class="o">$</span> <span class="kr">do</span>
    <span class="n">modify</span> <span class="p">(</span><span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">a</span> <span class="ow">&lt;-</span> <span class="n">get</span>
    <span class="n">lift</span> <span class="o">$</span> <span class="n">print</span> <span class="n">a</span>
    <span class="p">(`</span><span class="n">runReaderT</span><span class="p">`</span> <span class="n">a</span><span class="p">)</span> <span class="o">$</span> <span class="kr">do</span>
        <span class="n">b</span> <span class="ow">&lt;-</span> <span class="n">ask</span>
        <span class="n">lift</span> <span class="o">$</span> <span class="n">lift</span> <span class="o">$</span> <span class="n">print</span> <span class="o">$</span> <span class="n">b</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1">-- 修正</span>

<span class="nf">main</span> <span class="ow">=</span> <span class="kr">do</span>
    <span class="n">test1</span> <span class="mi">1</span>
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre>
2
3
</pre></div>
</div>

<p>その時点でのモナドスタックの最上位まで持ち上げています。</p>

<h2>
<span id="ネストの変動" class="fragment"></span><a href="#%E3%83%8D%E3%82%B9%E3%83%88%E3%81%AE%E5%A4%89%E5%8B%95"><i class="fa fa-link"></i></a>ネストの変動</h2>

<p>先ほどの例では直接ネストさせていたのでネスト回数は明白ですが、ネスト対象が分離しているとややこしくなります。</p>

<p>分離して単独で呼ぶと<code>lift</code>し過ぎでエラーになります。</p>

<p><a href="https://qiita-image-store.s3.amazonaws.com/0/32057/ddfc195f-ac7e-55c2-6b48-25372f548663.png" target="_blank" rel="nofollow noopener"><img src="https://qiita-image-store.s3.amazonaws.com/0/32057/ddfc195f-ac7e-55c2-6b48-25372f548663.png" alt="lift-2-NG-2.png"></a></p>

<div class="code-frame" data-lang="hs">
<div class="code-lang"><span class="bold">NG</span></div>
<div class="highlight"><pre>
<span class="kr">import</span> <span class="nn">Control.Monad.State</span>
<span class="kr">import</span> <span class="nn">Control.Monad.Reader</span>

<span class="nf">test1</span> <span class="n">x</span> <span class="ow">=</span> <span class="p">(`</span><span class="n">runStateT</span><span class="p">`</span> <span class="n">x</span><span class="p">)</span> <span class="o">$</span> <span class="kr">do</span>   <span class="c1">-- StateT</span>
    <span class="n">modify</span> <span class="p">(</span><span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">get</span> <span class="o">&gt;&gt;=</span> <span class="n">test2</span>                <span class="c1">-- StateTの中でReaderTを使用</span>

<span class="nf">test2</span> <span class="n">x</span> <span class="ow">=</span> <span class="p">(`</span><span class="n">runReaderT</span><span class="p">`</span> <span class="n">x</span><span class="p">)</span> <span class="o">$</span> <span class="kr">do</span>  <span class="c1">-- ReaderT</span>
    <span class="n">b</span> <span class="ow">&lt;-</span> <span class="n">ask</span>
    <span class="n">lift</span> <span class="o">$</span> <span class="n">lift</span> <span class="o">$</span> <span class="n">print</span> <span class="o">$</span> <span class="n">b</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1">-- 2階層目を想定</span>

<span class="nf">main</span> <span class="ow">=</span> <span class="kr">do</span>
    <span class="n">test1</span> <span class="mi">1</span>                      <span class="c1">-- OK</span>
    <span class="n">test2</span> <span class="mi">1</span>                      <span class="c1">-- エラー（想定階層の相違）</span>
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">エラー内容</span></div>
<div class="highlight"><pre>
Couldn't match type `t0 IO' with `IO'
Expected type: IO ()
  Actual type: t0 IO ()
</pre></div>
</div>

<h2>
<span id="liftio" class="fragment"></span><a href="#liftio"><i class="fa fa-link"></i></a>liftIO</h2>

<div class="code-frame" data-lang="hs">
<div class="code-lang"><span class="bold">型</span></div>
<div class="highlight"><pre>
<span class="nf">liftIO</span> <span class="ow">::</span> <span class="kt">IO</span> <span class="n">a</span> <span class="ow">-&gt;</span> <span class="n">m</span> <span class="n">a</span>
</pre></div>
</div>

<p>ネストの深さに関係なく最上位まで一気に持ち上げます。IOアクション専用です。</p>

<p>先ほどの例を修正します。</p>

<p><a href="https://qiita-image-store.s3.amazonaws.com/0/32057/4ef83805-bca5-8789-747f-7defb036da01.png" target="_blank" rel="nofollow noopener"><img src="https://qiita-image-store.s3.amazonaws.com/0/32057/4ef83805-bca5-8789-747f-7defb036da01.png" alt="liftIO.png"></a></p>

<div class="code-frame" data-lang="hs"><div class="highlight"><pre>
<span class="kr">import</span> <span class="nn">Control.Monad.State</span>
<span class="kr">import</span> <span class="nn">Control.Monad.Reader</span>

<span class="nf">test1</span> <span class="n">x</span> <span class="ow">=</span> <span class="p">(`</span><span class="n">runStateT</span><span class="p">`</span> <span class="n">x</span><span class="p">)</span> <span class="o">$</span> <span class="kr">do</span>
    <span class="n">modify</span> <span class="p">(</span><span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">get</span> <span class="o">&gt;&gt;=</span> <span class="n">test2</span>

<span class="nf">test2</span> <span class="n">x</span> <span class="ow">=</span> <span class="p">(`</span><span class="n">runReaderT</span><span class="p">`</span> <span class="n">x</span><span class="p">)</span> <span class="o">$</span> <span class="kr">do</span>
    <span class="n">b</span> <span class="ow">&lt;-</span> <span class="n">ask</span>
    <span class="n">liftIO</span> <span class="o">$</span> <span class="n">print</span> <span class="o">$</span> <span class="n">b</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1">-- 階層深度の影響を受けない</span>

<span class="nf">main</span> <span class="ow">=</span> <span class="kr">do</span>
    <span class="n">test1</span> <span class="mi">1</span>
    <span class="n">test2</span> <span class="mi">1</span>
</pre></div></div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre>
3
2
</pre></div>
</div>

<p><code>test2</code>がネストの深さに関係なく実行できるようになりました。</p>

<p>このようにIOアクションを持ち上げるときは<code>liftIO</code>を使った方が無難です。</p>

<h2>
<span id="練習-4" class="fragment"></span><a href="#%E7%B7%B4%E7%BF%92-4"><i class="fa fa-link"></i></a>練習</h2>

<p>【問7】問6を<code>liftIO</code>で解いてください。</p>

<p>⇒ <a href="http://qiita.com/7shi/items/79fe0e4c77427368ae2d#liftio" id="reference-7d6be221a8e5938ed0ab">解答例</a></p>

<h1>
<span id="関数の持ち上げ" class="fragment"></span><a href="#%E9%96%A2%E6%95%B0%E3%81%AE%E6%8C%81%E3%81%A1%E4%B8%8A%E3%81%92"><i class="fa fa-link"></i></a>関数の持ち上げ</h1>

<p><code>lift</code>や<code>liftIO</code>はアクションを持ち上げていましたが、関数の持ち上げもあります。</p>

<p>※ 関数の持ち上げはモナド変換子とは関係ありませんが、持ち上げに関連して取り上げます。</p>

<p>以下、モナドを代表してリストで例を示します。</p>

<h2>
<span id="値とモナドスタック" class="fragment"></span><a href="#%E5%80%A4%E3%81%A8%E3%83%A2%E3%83%8A%E3%83%89%E3%82%B9%E3%82%BF%E3%83%83%E3%82%AF"><i class="fa fa-link"></i></a>値とモナドスタック</h2>

<p>モナドによる値の包含関係もモナドスタックとして表現することができます。</p>

<p><a href="https://qiita-image-store.s3.amazonaws.com/0/32057/a4425f3f-4daa-9ed5-6f07-587300e7f446.png" target="_blank" rel="nofollow noopener"><img src="https://qiita-image-store.s3.amazonaws.com/0/32057/a4425f3f-4daa-9ed5-6f07-587300e7f446.png" alt="value.png"></a></p>

<h2>
<span id="適用不能" class="fragment"></span><a href="#%E9%81%A9%E7%94%A8%E4%B8%8D%E8%83%BD"><i class="fa fa-link"></i></a>適用不能</h2>

<p>通常の関数はモナドに入っている値に対して適用できません。</p>

<p><a href="https://qiita-image-store.s3.amazonaws.com/0/32057/d460d940-5638-dc0e-962e-d552241b1085.png" target="_blank" rel="nofollow noopener"><img src="https://qiita-image-store.s3.amazonaws.com/0/32057/d460d940-5638-dc0e-962e-d552241b1085.png" alt="liftM-NG.png"></a></p>

<div class="code-frame" data-lang="hs">
<div class="code-lang"><span class="bold">NG</span></div>
<div class="highlight"><pre>
<span class="nf">main</span> <span class="ow">=</span> <span class="n">print</span> <span class="o">$</span> <span class="p">(</span><span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1">-- エラー</span>
</pre></div>
</div>

<p>このようなときに使うのが関数の持ち上げです。</p>

<h2>
<span id="liftm" class="fragment"></span><a href="#liftm"><i class="fa fa-link"></i></a>liftM</h2>

<div class="code-frame" data-lang="hs">
<div class="code-lang"><span class="bold">型</span></div>
<div class="highlight"><pre>
<span class="nf">liftM</span> <span class="ow">::</span> <span class="kt">Monad</span> <span class="n">m</span> <span class="ow">=&gt;</span> <span class="p">(</span><span class="n">a1</span> <span class="ow">-&gt;</span> <span class="n">r</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="n">m</span> <span class="n">a1</span> <span class="ow">-&gt;</span> <span class="n">m</span> <span class="n">r</span> 
</pre></div>
</div>

<p>モナドに入っている値に対して、関数を持ち上げることで適用します。</p>

<p><a href="https://qiita-image-store.s3.amazonaws.com/0/32057/526714f2-076d-ad9c-5c19-cd4f07a85c10.png" target="_blank" rel="nofollow noopener"><img src="https://qiita-image-store.s3.amazonaws.com/0/32057/526714f2-076d-ad9c-5c19-cd4f07a85c10.png" alt="liftM-OK.png"></a></p>

<div class="code-frame" data-lang="hs"><div class="highlight"><pre>
<span class="kr">import</span> <span class="nn">Control.Monad</span>

<span class="nf">main</span> <span class="ow">=</span> <span class="n">print</span> <span class="o">$</span> <span class="n">liftM</span> <span class="p">(</span><span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</pre></div></div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre>
[2]
</pre></div>
</div>

<p>対象となるモナドと同じ高さまで関数を持ち上げています。</p>

<h2>
<span id="liftm2" class="fragment"></span><a href="#liftm2"><i class="fa fa-link"></i></a>liftM2</h2>

<div class="code-frame" data-lang="hs">
<div class="code-lang"><span class="bold">型</span></div>
<div class="highlight"><pre>
<span class="nf">liftM2</span> <span class="ow">::</span> <span class="kt">Monad</span> <span class="n">m</span> <span class="ow">=&gt;</span> <span class="p">(</span><span class="n">a1</span> <span class="ow">-&gt;</span> <span class="n">a2</span> <span class="ow">-&gt;</span> <span class="n">r</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="n">m</span> <span class="n">a1</span> <span class="ow">-&gt;</span> <span class="n">m</span> <span class="n">a2</span> <span class="ow">-&gt;</span> <span class="n">m</span> <span class="n">r</span> 
</pre></div>
</div>

<p>引数が2つある関数に対する持ち上げです。</p>

<div class="code-frame" data-lang="hs"><div class="highlight"><pre>
<span class="kr">import</span> <span class="nn">Control.Monad</span>

<span class="nf">main</span> <span class="ow">=</span> <span class="n">print</span> <span class="o">$</span> <span class="n">liftM2</span> <span class="p">(</span><span class="o">+</span><span class="p">)</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</pre></div></div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre>
[2]
</pre></div>
</div>

<p>同様に<code>liftM5</code>まで定義されています。</p>

<ul>
<li><a href="http://hackage.haskell.org/package/base-4.7.0.2/docs/Control-Monad.html#g:7" rel="nofollow noopener" target="_blank">Control.Monad: Monadic lifting operators</a></li>
</ul>

<h2>
<span id="applicativeスタイル" class="fragment"></span><a href="#applicative%E3%82%B9%E3%82%BF%E3%82%A4%E3%83%AB"><i class="fa fa-link"></i></a>Applicativeスタイル</h2>

<p>関数の持ち上げは<a href="http://qiita.com/7shi/items/85afd7bbd5d6c4115ad6">Haskell アクション 超入門</a>で取り上げたApplicativeスタイルと同じです。</p>

<p>※ そこでは「値の取り出し」という観点で統一するため、敢えて「持ち上げ」とは言わずに別の説明をしています。結果は同じなので、解釈で何かが変わるわけではありません。</p>

<p>1個目の引数は<code>&lt;$&gt;</code>、2個目以降の引数は<code>&lt;*&gt;</code>でつなぎます。</p>

<div class="code-frame" data-lang="hs"><div class="highlight"><pre>
<span class="kr">import</span> <span class="nn">Control.Applicative</span>

<span class="nf">main</span> <span class="ow">=</span> <span class="kr">do</span>
    <span class="n">print</span> <span class="o">$</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span><span class="p">)</span> <span class="o">&lt;$&gt;</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">print</span> <span class="o">$</span> <span class="p">(</span><span class="o">+</span><span class="p">)</span>   <span class="o">&lt;$&gt;</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;*&gt;</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</pre></div></div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre>
[2]
[2]
</pre></div>
</div>

<p>※ Applicativeを直訳すれば「適用可能」です。「複数の引数が<strong>適用可能</strong>」というような意味合いです。今回の範囲を超えるため詳細は省略します。</p>

<h3>
<span id="とliftm" class="fragment"></span><a href="#%E3%81%A8liftm"><i class="fa fa-link"></i></a>&lt;$&gt;とliftM</h3>

<p><code>&lt;$&gt;</code>は<code>liftM</code>の演算子版で、同じ働きです。</p>

<p>交換してみます。</p>

<p>※ 確認が目的です。実用的なコードではありません。</p>

<div class="code-frame" data-lang="hs"><div class="highlight"><pre>
<span class="kr">import</span> <span class="nn">Control.Applicative</span>
<span class="kr">import</span> <span class="nn">Control.Monad</span>

<span class="nf">main</span> <span class="ow">=</span> <span class="kr">do</span>
    <span class="n">print</span> <span class="o">$</span> <span class="n">liftM</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span><span class="p">)</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">print</span> <span class="o">$</span> <span class="p">(</span><span class="o">&lt;$&gt;</span><span class="p">)</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span><span class="p">)</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>          <span class="c1">-- &lt;$&gt;を関数化</span>

    <span class="n">print</span> <span class="o">$</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span><span class="p">)</span>   <span class="o">&lt;$&gt;</span>   <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">print</span> <span class="o">$</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span><span class="p">)</span> <span class="p">`</span><span class="n">liftM</span><span class="p">`</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>        <span class="c1">-- liftMを演算子化</span>

    <span class="n">print</span> <span class="o">$</span> <span class="p">(</span><span class="o">+</span><span class="p">)</span>   <span class="o">&lt;$&gt;</span>   <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;*&gt;</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">print</span> <span class="o">$</span> <span class="p">(</span><span class="o">+</span><span class="p">)</span> <span class="p">`</span><span class="n">liftM</span><span class="p">`</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;*&gt;</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1">-- liftMと&lt;*&gt;の組み合わせ</span>

    <span class="n">print</span> <span class="o">$</span> <span class="n">liftM</span> <span class="p">(</span><span class="o">+</span><span class="p">)</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;*&gt;</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>    <span class="c1">-- こんなこともできるが</span>
    <span class="n">print</span> <span class="o">$</span> <span class="p">(</span><span class="o">&lt;$&gt;</span><span class="p">)</span> <span class="p">(</span><span class="o">+</span><span class="p">)</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;*&gt;</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>    <span class="c1">-- あまり意味はない</span>
</pre></div></div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre>
[2]
[2]
[2]
[2]
[2]
[2]
[2]
[2]
</pre></div>
</div>

<h2>
<span id="と" class="fragment"></span><a href="#%E3%81%A8"><i class="fa fa-link"></i></a>&lt;$&gt;と&lt;*&gt;</h2>

<p>今までApplicativeスタイルは使い方しか示しませんでしたが、そもそも<code>&lt;$&gt;</code>と<code>&lt;*&gt;</code>の違いは何でしょうか。</p>

<p>再実装を通して、違いを探ります。</p>

<h3>
<span id="" class="fragment"></span><a href="#"><i class="fa fa-link"></i></a>&lt;$&gt;</h3>

<p><code>&lt;$&gt;</code>を再実装します。</p>

<div class="code-frame" data-lang="hs"><div class="highlight"><pre>
<span class="nf">f</span> <span class="o">&lt;$&gt;</span> <span class="n">m</span> <span class="ow">=</span> <span class="kr">do</span>
    <span class="n">a</span> <span class="ow">&lt;-</span> <span class="n">m</span>        <span class="c1">-- モナドから値を取り出す</span>
    <span class="n">return</span> <span class="o">$</span> <span class="n">f</span> <span class="n">a</span>  <span class="c1">-- 値を関数に適用してモナドに入れて返す</span>

<span class="nf">main</span> <span class="ow">=</span> <span class="kr">do</span>
    <span class="n">print</span> <span class="o">$</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span><span class="p">)</span> <span class="o">&lt;$&gt;</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</pre></div></div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre>
[2]
</pre></div>
</div>

<h3>
<span id="部分適用とモナド" class="fragment"></span><a href="#%E9%83%A8%E5%88%86%E9%81%A9%E7%94%A8%E3%81%A8%E3%83%A2%E3%83%8A%E3%83%89"><i class="fa fa-link"></i></a>部分適用とモナド</h3>

<p><code>&lt;$&gt;</code>を引数が2つの関数に適用するとどうなるでしょうか。</p>

<p>例: <code>(+) &lt;$&gt; [1]</code></p>

<ol>
<li>モナド<code>[1]</code>から値を取り出し → <code>1</code>
</li>
<li>関数<code>(+)</code>に<code>1</code>を部分適用 → <code>(+) 1</code> == セクション <code>(1 +)</code>
</li>
<li>戻り値<code>(1 +)</code>がモナドに入れて返される → <code>[(1 +)]</code>
</li>
</ol>

<p>引数が足りないため部分適用となり、戻された関数がモナドに入れられます。</p>

<h3>
<span id="-1" class="fragment"></span><a href="#-1"><i class="fa fa-link"></i></a>&lt;*&gt;</h3>

<p>2番目以降の引数はモナドに入った関数に適用します。</p>

<p><code>&lt;*&gt;</code>を再実装します。</p>

<div class="code-frame" data-lang="hs"><div class="highlight"><pre>
<span class="nf">f</span> <span class="o">&lt;$&gt;</span> <span class="n">m</span> <span class="ow">=</span> <span class="kr">do</span>
    <span class="n">a</span> <span class="ow">&lt;-</span> <span class="n">m</span>
    <span class="n">return</span> <span class="o">$</span> <span class="n">f</span> <span class="n">a</span>

<span class="nf">mf</span> <span class="o">&lt;*&gt;</span> <span class="n">m</span> <span class="ow">=</span> <span class="kr">do</span>
    <span class="n">f</span> <span class="ow">&lt;-</span> <span class="n">mf</span>       <span class="c1">-- モナドから関数を取り出す</span>
    <span class="n">a</span> <span class="ow">&lt;-</span> <span class="n">m</span>        <span class="c1">-- モナドから値を取り出す</span>
    <span class="n">return</span> <span class="o">$</span> <span class="n">f</span> <span class="n">a</span>  <span class="c1">-- 値を関数に適用してモナドに入れて返す</span>

<span class="nf">main</span> <span class="ow">=</span> <span class="kr">do</span>
    <span class="n">print</span> <span class="o">$</span> <span class="p">(</span><span class="o">+</span><span class="p">)</span> <span class="o">&lt;$&gt;</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;*&gt;</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</pre></div></div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre>
[2]
</pre></div>
</div>

<p><code>&lt;$&gt;</code>と<code>&lt;*&gt;</code>の違いは、関数がモナドに入っているかどうかです。</p>

<h3>
<span id="だけで書く" class="fragment"></span><a href="#%E3%81%A0%E3%81%91%E3%81%A7%E6%9B%B8%E3%81%8F"><i class="fa fa-link"></i></a>&lt;*&gt;だけで書く</h3>

<p>最初から関数をモナドに入れれば<code>&lt;*&gt;</code>だけで書けます。</p>

<div class="code-frame" data-lang="hs"><div class="highlight"><pre>
<span class="kr">import</span> <span class="nn">Control.Applicative</span>

<span class="nf">main</span> <span class="ow">=</span> <span class="kr">do</span>
    <span class="n">print</span> <span class="o">$</span> <span class="n">return</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span><span class="p">)</span> <span class="o">&lt;*&gt;</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">print</span> <span class="o">$</span> <span class="n">return</span>   <span class="p">(</span><span class="o">+</span><span class="p">)</span> <span class="o">&lt;*&gt;</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;*&gt;</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</pre></div></div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre>
[2]
[2]
</pre></div>
</div>

<p>値として関数がモナドに入れられるのがポイントです。</p>

<h2>
<span id="第一級関数" class="fragment"></span><a href="#%E7%AC%AC%E4%B8%80%E7%B4%9A%E9%96%A2%E6%95%B0"><i class="fa fa-link"></i></a>第一級関数</h2>

<p>値としてモナドに入れられる関数は、状態系モナドの内部関数とは別物です。内部関数の戻り値として生成される対象で、値と同じ扱いです。このように関数が値と同列に扱えることを<a href="http://ja.wikipedia.org/wiki/%E7%AC%AC%E4%B8%80%E7%B4%9A%E9%96%A2%E6%95%B0" rel="nofollow noopener" target="_blank">第一級関数</a>と呼びます。</p>

<p>Stateモナドとリストモナドで例を示します。</p>

<div class="code-frame" data-lang="hs"><div class="highlight"><pre>
<span class="kr">import</span> <span class="nn">Control.Monad.State</span>

<span class="nf">f1</span> <span class="ow">::</span> <span class="kt">State</span> <span class="n">s</span> <span class="p">(</span><span class="kt">Int</span> <span class="ow">-&gt;</span> <span class="kt">Int</span><span class="p">)</span>
<span class="nf">f1</span> <span class="ow">=</span> <span class="n">return</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span><span class="p">)</span>                <span class="c1">-- 関数をStateモナドに入れる</span>

<span class="nf">f2</span> <span class="ow">::</span> <span class="kt">State</span> <span class="n">s</span> <span class="p">(</span><span class="kt">Int</span> <span class="ow">-&gt;</span> <span class="kt">Int</span><span class="p">)</span>
<span class="nf">f2</span> <span class="ow">=</span> <span class="n">state</span> <span class="o">$</span> <span class="nf">\</span><span class="n">s</span> <span class="ow">-&gt;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span><span class="p">),</span> <span class="n">s</span><span class="p">)</span>    <span class="c1">-- 内部関数が戻すタプルの値が関数</span>

<span class="nf">f3</span> <span class="ow">::</span> <span class="p">[</span><span class="kt">Int</span> <span class="ow">-&gt;</span> <span class="kt">Int</span><span class="p">]</span>
<span class="nf">f3</span> <span class="ow">=</span> <span class="n">return</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span><span class="p">)</span>                <span class="c1">-- 関数をリストモナドに入れる</span>

<span class="nf">main</span> <span class="ow">=</span> <span class="kr">do</span>
    <span class="n">print</span> <span class="o">$</span> <span class="p">(</span><span class="n">evalState</span> <span class="n">f1</span> <span class="nb">()</span><span class="p">)</span> <span class="mi">1</span>  <span class="c1">-- Stateモナドから取り出した関数を評価</span>
    <span class="n">print</span> <span class="o">$</span> <span class="p">(</span><span class="n">evalState</span> <span class="n">f2</span> <span class="nb">()</span><span class="p">)</span> <span class="mi">1</span>  <span class="c1">-- Stateモナドから取り出した関数を評価</span>
    <span class="n">print</span> <span class="o">$</span> <span class="p">(</span><span class="n">f3</span> <span class="o">!!</span> <span class="mi">0</span><span class="p">)</span> <span class="mi">1</span>          <span class="c1">-- リストモナドから取り出した関数を評価</span>
</pre></div></div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre>
2
2
2
</pre></div>
</div>

<h2>
<span id="liftmとreturn" class="fragment"></span><a href="#liftm%E3%81%A8return"><i class="fa fa-link"></i></a>liftMとreturn</h2>

<p><code>return (1 +)</code>で関数をモナドに入れるのと、<code>liftM</code>による持ち上げとの違いは何でしょうか。</p>

<p><code>liftM</code>を部分適用すると、モナドを直接評価できる関数が得られます。</p>

<div class="code-frame" data-lang="hs"><div class="highlight"><pre>
<span class="kr">import</span> <span class="nn">Control.Monad</span>

<span class="nf">f</span> <span class="ow">=</span> <span class="n">liftM</span> <span class="p">(</span><span class="o">+</span> <span class="mi">1</span><span class="p">)</span>    <span class="c1">-- 関数の持ち上げ</span>

<span class="nf">main</span> <span class="ow">=</span> <span class="kr">do</span>
    <span class="n">print</span> <span class="o">$</span> <span class="n">f</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1">-- モナドを直接評価</span>
</pre></div></div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre>
[2]
</pre></div>
</div>

<p>このようにモナドを評価できるようにすることが<strong>関数の持ち上げ</strong>です。<code>f</code>の実体は部分適用された<code>liftM</code>です。</p>

<p>これに対して、関数をモナドに入れても関数としては使えません。</p>

<div class="code-frame" data-lang="hs">
<div class="code-lang"><span class="bold">NG</span></div>
<div class="highlight"><pre>
<span class="nf">f</span> <span class="ow">::</span> <span class="p">[</span><span class="kt">Int</span> <span class="ow">-&gt;</span> <span class="kt">Int</span><span class="p">]</span>
<span class="nf">f</span> <span class="ow">=</span> <span class="n">return</span> <span class="p">(</span><span class="o">+</span> <span class="mi">1</span><span class="p">)</span>   <span class="c1">-- 関数をモナドに入れる</span>

<span class="nf">main</span> <span class="ow">=</span> <span class="kr">do</span>
    <span class="n">print</span> <span class="o">$</span> <span class="n">f</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1">-- エラー</span>
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">エラー内容</span></div>
<div class="highlight"><pre>
Couldn't match expected type `[t0] -&gt; a0'
            with actual type `[Int -&gt; Int]'
The function `f' is applied to one argument,
but its type `[Int -&gt; Int]' has none
</pre></div>
</div>

<p><code>&lt;*&gt;</code>の助けが必要です。</p>

<div class="code-frame" data-lang="hs">
<div class="code-lang"><span class="bold">OK</span></div>
<div class="highlight"><pre>
<span class="kr">import</span> <span class="nn">Control.Applicative</span>

<span class="nf">f</span> <span class="ow">::</span> <span class="p">[</span><span class="kt">Int</span> <span class="ow">-&gt;</span> <span class="kt">Int</span><span class="p">]</span>
<span class="nf">f</span> <span class="ow">=</span> <span class="n">return</span> <span class="p">(</span><span class="o">+</span> <span class="mi">1</span><span class="p">)</span>       <span class="c1">-- 関数をモナドに入れる</span>

<span class="nf">main</span> <span class="ow">=</span> <span class="kr">do</span>
    <span class="n">print</span> <span class="o">$</span> <span class="n">f</span> <span class="o">&lt;*&gt;</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1">-- OK</span>
</pre></div>
</div>

<div class="code-frame" data-lang="text">
<div class="code-lang"><span class="bold">実行結果</span></div>
<div class="highlight"><pre>
[2]
</pre></div>
</div>

<h2>
<span id="練習-5" class="fragment"></span><a href="#%E7%B7%B4%E7%BF%92-5"><i class="fa fa-link"></i></a>練習</h2>

<p>【問8】次のリスト内包表記を<code>liftM</code>系の関数で書き直してください。</p>

<div class="code-frame" data-lang="hs"><div class="highlight"><pre>
<span class="nf">main</span> <span class="ow">=</span> <span class="kr">do</span>
    <span class="n">print</span> <span class="p">[(</span><span class="n">x</span> <span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="o">|</span> <span class="n">x</span> <span class="ow">&lt;-</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">y</span> <span class="ow">&lt;-</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]]</span>
    <span class="n">print</span> <span class="p">[</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>  <span class="o">|</span> <span class="n">x</span> <span class="ow">&lt;-</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">y</span> <span class="ow">&lt;-</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]]</span>
</pre></div></div>

<p>⇒ <a href="http://qiita.com/7shi/items/79fe0e4c77427368ae2d#liftm" id="reference-7d6be221a8e5938ed0ab">解答例</a></p>

<h1>
<span id="参考" class="fragment"></span><a href="#%E5%8F%82%E8%80%83"><i class="fa fa-link"></i></a>参考</h1>

<p>mtlでのStateモナドの定義は途中で変更されたそうです。</p>

<ul>
<li>
<a href="http://haskell.g.hatena.ne.jp/illillli/20120707/1341678109" rel="nofollow noopener" target="_blank">mtlが変わってる - [ pred x | x &lt;- "Ibtlfmm!ojllj" ] - haskell</a> 2012.7.7</li>
</ul>

<p><code>liftIO</code>は以下の記事を参考にしました。</p>

<ul>
<li>
<a href="https://twitter.com/fmkz___" rel="nofollow noopener" target="_blank">@fmkz___</a>: <a href="http://blog.kzfmix.com/entry/1342394344" rel="nofollow noopener" target="_blank">fmapとliftMとliftそしてliftIO</a> 2012.7.16</li>
<li>
<a href="http://haskell.g.hatena.ne.jp/illillli/20090514/1242305123" rel="nofollow noopener" target="_blank">liftとliftIOの違い - [ pred x | x &lt;- "Ibtlfmm!ojllj" ] - haskell</a> 2009.5.14</li>
</ul>

<h1>
<span id="謝辞" class="fragment"></span><a href="#%E8%AC%9D%E8%BE%9E"><i class="fa fa-link"></i></a>謝辞</h1>

<p>持ち上げやモナドスタックについては<a href="/ruicc" class="user-mention js-hovercard" title="ruicc" data-hovercard-target-type="user" data-hovercard-target-name="ruicc">@ruicc</a>先生よりご教示いただきました。</p>

<p>記事としてまとめていただきましたので、理解を深めたい方はご参照ください。</p>

<ul>
<li>
<a href="https://twitter.com/ruicc" rel="nofollow noopener" target="_blank">@ruicc</a>: <a href="http://qiita.com/ruicc/items/7512c990a1835bba444a" id="reference-3c5240f192b6fe349ee2">Haskell - モナドトランスフォーマーとその周辺 - Qiita</a> 2015.2.4</li>
</ul>
<div class="hidden"><form class="js-task-list-update" action="/7shi/items/4408b76624067c17e933" accept-charset="UTF-8" method="post"><input name="utf8" type="hidden" value="&#x2713;" /><input type="hidden" name="_method" value="patch" /><input type="hidden" name="authenticity_token" value="5lJG96Phm9xwDWCJWuhYwIVtPrRn1U2ewsQkrcW9BaiI0N2vOM+il4/e1ZUqHeaZ5SoaB/ARF2n+Gi1WJLMLbg==" /><input type="hidden" name="updated_at_confirmation_in_unixtime" id="updated_at_confirmation_in_unixtime" value="1443496558" class="js-task-list-updated-at" /><textarea name="raw_body" id="raw_body" class="js-task-list-field">
Haskellではモナドと呼ばれる部品を組み合わせてプログラムを作ります。別種のモナドを組み合わせるためのモナド変換子の使い方の初歩を説明します。ライブラリで用意されたモナド変換子を手っ取り早く使うことを目的としているため、モナド変換子の作り方や圏論には言及しません。

シリーズの記事です。

1. [Haskell 超入門](http://qiita.com/7shi/items/145f1234f8ec2af923ef)
1. [Haskell 代数的データ型 超入門](http://qiita.com/7shi/items/1ce76bde464b4a55c143)
1. [Haskell アクション 超入門](http://qiita.com/7shi/items/85afd7bbd5d6c4115ad6)
1. [Haskell ラムダ 超入門](http://qiita.com/7shi/items/1345bf32003faff435cb)
1. [Haskell アクションとラムダ 超入門](http://qiita.com/7shi/items/4a8a2807bb5186576c61)
1. [Haskell IOモナド 超入門](http://qiita.com/7shi/items/d3d3492ddd90d47160f2)
1. [Haskell リストモナド 超入門](http://qiita.com/7shi/items/deb19c4cba933590ffbf)
1. [Haskell Maybeモナド 超入門](http://qiita.com/7shi/items/c7d7eec066af0fe0688d)
1. [Haskell 状態系モナド 超入門](http://qiita.com/7shi/items/2e9bff5d88302de1a9e9)
1. Haskell モナド変換子 超入門 ← この記事
1. [Haskell 例外処理 超入門](http://qiita.com/7shi/items/73e534c47bbebc71b37e)
1. [Haskell 構文解析 超入門](http://qiita.com/7shi/items/b8c741e78a96ea2c10fe)
1. 【予定】Haskell 継続モナド 超入門
1. 【予定】Haskell 型クラス 超入門
1. 【予定】Haskell モナドとゆかいな仲間たち
1. 【予定】Haskell Freeモナド 超入門
1. 【予定】Haskell Operationalモナド 超入門
1. 【予定】Haskell Effモナド 超入門
1. 【予定】Haskell アロー 超入門

練習の解答例は別記事に掲載します。

* [【解答例】Haskell モナド変換子 超入門](http://qiita.com/7shi/items/79fe0e4c77427368ae2d)

# モナド変換子

`do`の中では同じ種類のモナドしか使うことができません。

たとえば次のようにStateモナドとIOモナドを併用することはできません。

```hs:NG
import Control.Monad
import Control.Monad.State

sum&#39; xs = (`execState` 0) $ do
    forM_ xs $ \i -&gt; do
        modify (+ i)
        v &lt;- get
        putStrLn $ &quot;+&quot; ++ show i ++ &quot; -&gt; &quot; ++ show v  -- エラー

main = do
    print $ sum&#39; [1..5]
```
```text:エラー内容
Couldn&#39;t match type `IO&#39;
              with `StateT c transformers-0.3.0.0:Data.Functor.Identity.Identity&#39;
Expected type: State c ()
  Actual type: IO ()
```

このような問題に対処するのがモナド変換子です。説明は後回しで例を示します。

```hs
import Control.Monad
import Control.Monad.State

sum&#39; xs = (`execStateT` 0) $ do                              -- execStateT
    forM_ xs $ \i -&gt; do
        modify (+ i)
        v &lt;- get
        lift $ putStrLn $ &quot;+&quot; ++ show i ++ &quot; -&gt; &quot; ++ show v  -- lift

main = do
    print =&lt;&lt; sum&#39; [1..5]                                    -- $ → =&lt;&lt;
```
```text:実行結果
+1 -&gt; 1
+2 -&gt; 3
+3 -&gt; 6
+4 -&gt; 10
+5 -&gt; 15
15
```

`execStateT`や`lift`などが新しく登場しています。`print`の次が`=&lt;&lt;`になっています。

これらを説明する前に必要なものから見て行きます。

# Identityモナド

```hs:型表記
Identity a
```

中に値が入っているだけの最も単純なモナドです。identityは[恒等式](http://ja.wikipedia.org/wiki/%E6%81%92%E7%AD%89%E5%BC%8F)という意味で、Identityモナドは恒等モナドとも呼ばれます。

※ [自己同一性](http://ja.wikipedia.org/wiki/%E8%87%AA%E5%B7%B1%E5%90%8C%E4%B8%80%E6%80%A7)などと訳されるアイデンティティと同じ単語です。

値は`runIdentity`で取り出せます。

```hs
import Control.Monad.Identity

main = do
    let a = return 1 :: Identity Int  -- 生成
    print $ runIdentity a             -- 値の取り出し（評価）
```
```text:実行結果
1
```

モナドには値だけが入っていて、関数や状態が隠されてはいません。リストモナドと違って要素数は1固定です。

特別な機能はなく、何もしないモナドです。

## id

```hs:型
id :: a -&gt; a
```

引数をそのまま返す関数です。`id`はidentityに由来して恒等関数とも呼ばれます。

高階関数に何か関数を渡す際、何もして欲しくないときなどに使います。次の例での`f id`が該当します。

```hs
f g x = g x

main = do
    print 1
    print $ id 1
    print $ f id 1  -- 注目
```
```text:実行結果
1
1
1
```

この例での`f`はポイントフリースタイルを進めると引数が全部消えますが、このようなときに右辺を埋めるのにも`id`は使えます。

1. `f g x = g x`
2. `f g   = g`
3. `f     =` ← エラー
4. `f     = id`

`Identity`はモナド、`id`は関数での、似たような位置付けのものです。

# StateTモナド変換子

Stateモナドに対するモナド変換子です。

* Tは &quot;transformer&quot; の略で、モナド変換子を表す接尾辞です。
* モナド変換子はモナドの一種です。

## 型表記

```hs
StateT s m a
```

* `State s a`に対して`m`が増えています。
* `m`は任意のモナドを指定します。モナドの変換に関係します。

## Stateモナドとの関係

```hs:定義
type State s a = StateT s Identity a
```

StateモナドはStateTモナド変換子の`m`に`Identity`を指定したものです。何もしないIdentityモナドを指定することで、変換子を無効化して単なるモナドにしています。

StateTモナド変換子にIdentityモナドを指定することでStateモナドが作れることを確認します。

```hs
import Control.Monad.Identity
import Control.Monad.State

main = do
    let a = return 1 :: StateT s Identity Int  -- StateTとして生成
    print $ evalState a ()                     -- Stateとして評価
```
```text:実行結果
1
```

StateTモナド変換子を型指定しているのに`evalState`が適用できています。

Identity以外のモナドを指定すると破綻します。

```hs:NG
import Control.Monad.Identity
import Control.Monad.State

main = do
    let a = return 1 :: StateT s IO Int
    print $ evalState a ()               -- エラー
```
```text:エラー内容
Couldn&#39;t match type `IO&#39; with `Identity&#39;
Expected type: State () Int
  Actual type: StateT () IO Int
```

IOを指定するケースがモナド変換子の真骨頂ですが、詳細は後の方で取り上げます。

### 類似例

IOモナドがSTモナドの`s`に`RealWorld`を指定したものと相互変換できる関係と似ています。

* `IO a` ⇔ `ST RealWorld a`

IOモナドとSTモナドの関係は等価物として変換可能ということですが、Stateモナドは実体がStateTモナド変換子のため変換は介在しません。

* `State s a` == `StateT s Identity a`

STは &quot;state-transformer&quot; でモナド変換子のTと同じ単語ですが、STはモナド変換子ではありません。&quot;transformer&quot; の意味合いが異なるようです。

## 内部関数

```hs:型
s -&gt; m (a, s)
```

Stateモナドでは`m`が`Identity`のため、内部関数は次のようになります。

```hs:型
s -&gt; Identity (a, s)
```

Stateモナドでは`runState`に状態を渡さずに部分適用したものが内部関数だと見なせますが、実際に入っている内部関数は戻り値がIdentityモナドで包まれています。実用上はIdentityモナドを見せる必要がないため、`runState`は内部関数をラップしてIdentityモナドを隠しています。

## runStateT

```hs:型
runStateT :: StateT s m a -&gt; s -&gt; m (a,s)
```

StateTモナド変換子から内部関数を取り出します。

※ runという表現に違和感があれば、rを無視してunStateTだと見立てると良いかもしれません。

`runState`のように関数を加工することはありません。両者を比較します。

```hs
import Control.Monad.Identity
import Control.Monad.State

st = return 1 :: State s Int     -- Stateを生成

f1 :: s -&gt; (Int, s)
f1 = runState st                 -- 加工された内部関数を取り出し

f2 :: s -&gt; Identity (Int, s)
f2 = runStateT st                -- 生の内部関数を取り出し

main = do
    print $ f1 ()                -- (値, 状態)
    print $ runIdentity $ f2 ()  -- Identityで包まれている
```
```text:実行結果
(1,())
(1,())
```

### 片方だけを取得する関数

`runState`と同じように、`runStateT`にも値や状態だけを返す関数があります。

* 値だけ: `evalStateT :: (Monad m) =&gt; StateT s m a -&gt; s -&gt; m a`
* 状態だけ: `execStateT :: (Monad m) =&gt; StateT s m a -&gt; s -&gt; m s`

比較します。

```hs
import Control.Monad.Identity
import Control.Monad.State

main = do
    let st = return 1 :: StateT s Identity Int
    print $ runIdentity $  runStateT st ()      -- (値, 状態)
    print $ runIdentity $ evalStateT st ()      --  値
    print $ runIdentity $ execStateT st ()      --      状態
```
```text:実行結果
(1,())
1
()
```

## StateT

```hs:型
StateT :: (s -&gt; m (a,s)) -&gt; StateT s m a
```

関数からStateTモナド変換子を生成します。`runStateT`の逆です。

応用として、Stateモナドを関数から自作してみます。

```hs
import Control.Monad.Identity
import Control.Monad.State

main = do
    let st = StateT $ \s -&gt; Identity (1, s)  -- 関数から生成
    print $ runIdentity $ runStateT st ()    -- StateTとして評価
    print $ runState st ()                   -- Stateとして評価
```
```text:実行結果
(1,())
(1,())
```

StateTモナド変換子として作った`st`が`runState`で評価できています。

## IOモナドとの比較

内部関数を出し入れする関数をIOモナドと比較します。

![IO-StateT.png](https://qiita-image-store.s3.amazonaws.com/0/32057/af9f600f-8169-0bc1-9901-537b495a2aa2.png)

型    |取り出し |格納
------|---------|------
IO    |unIO     |IO
StateT|runStateT|StateT

## 練習

【問1】Stateモナドを扱う`return`を`StateT`を使って、`runState`を`runStateT`を使って再実装してください。

具体的には次のコードが動くようにしてください。

```hs
main = do
    let st = return&#39; 1
    print $ runState&#39; st ()
```
```text:実行結果
(1,())
```

⇒ [解答例](http://qiita.com/7shi/items/79fe0e4c77427368ae2d#state%E3%83%A2%E3%83%8A%E3%83%89)

# 持ち上げ

ここからはモナド変換子によって別種のモナドを合成する方法について見て行きます。

サンプルの一部を再掲します。

```hs
sum&#39; xs = (`execStateT` 0) $ do
    forM_ xs $ \i -&gt; do
        modify (+ i)
        v &lt;- get
        lift $ putStrLn $ &quot;+&quot; ++ show i ++ &quot; -&gt; &quot; ++ show v  -- 注目
```

`lift`の後にIOモナドを記述することで、StateモナドとIOモナドを混ぜています。`lift`は**持ち上げ**と訳されます。

※ ウェイトリフティング（[重量挙げ](http://ja.wikipedia.org/wiki/%E9%87%8D%E9%87%8F%E6%8C%99%E3%81%92)）のリフトです。

まずStateTモナド変換子の`m`に`IO`を指定すると何が起きるかを確認します。

## StateT s IO a

内部関数は次のようになります。

```hs:型
s -&gt; IO (a, s)
```

これを入れたStateTモナド変換子を`runStateT`で初期値を指定して評価すると、IOモナドが返って来ます。StateTモナド変換子の中にIOモナドが入っていると見なせます。

※ `m`に`IO`を指定するとStateモナドとは互換性がなくなるため`runState`は使えません。

![runStateT.png](https://qiita-image-store.s3.amazonaws.com/0/32057/622eea6e-17dd-5402-2151-32bcad893e53.png)

```hs
import Control.Monad.State

f :: s -&gt; IO (Int, s)         -- 内部関数
f s = return (1, s)

a :: StateT s IO Int
a = StateT f                  -- 関数から生成

main = do
    print =&lt;&lt; f ()            -- 関数を評価
    print =&lt;&lt; runStateT a ()  -- StateTを評価
```
```text:実行結果
(1,())
(1,())
```

`runStateT`は内部関数を取り出すだけです。内部関数を直接評価しても、StateTモナド変換子に入れて`runStateT`経由で評価しても、同じ結果です。後者はモナドが介在して追いにくいので、前者の動きに注目すると良いでしょう。

## print

内部関数の中で`print`を使用してみます。

```hs
import Control.Monad.State

f :: s -&gt; IO ((), s)         -- StateTの内部関数
f s = do
    a &lt;- print &quot;hello&quot;       -- printを使用
    return (a, s)            -- IOモナドを返す

a :: StateT s IO ()
a = StateT f                 -- 生成

main = do
    print =&lt;&lt; f 1            -- 関数を評価
    print =&lt;&lt; runStateT a 1  -- StateTを評価
```
```text:実行結果
&quot;hello&quot;
((),1)
&quot;hello&quot;
((),1)
```

## lift

```hs:型
lift :: (Monad m) =&gt; m a -&gt; t m a
```

モナドからモナド変換子を生成する関数です。型注釈の`t`はモナド変換子を表します。

内部関数の自作と`lift`とを比較します。IOモナドをStateTモナド変換子の中に入れています。

![lift.png](https://qiita-image-store.s3.amazonaws.com/0/32057/ae3e8f54-1903-afa3-d6ec-77e69d34b0aa.png)

```hs
import Control.Monad.State

a1 :: StateT s IO ()
a1 = StateT $ \s -&gt; do        -- 内部関数の自作
    a &lt;- print &quot;hello&quot;
    return (a, s)

a2 :: StateT s IO ()
a2 = lift $ print &quot;hello&quot;     -- lift

main = do
    print =&lt;&lt; runStateT a1 1  -- 評価結果はIOで返る
    print =&lt;&lt; runStateT a2 1  -- 同上
```
```text:実行結果
&quot;hello&quot;
((),1)
&quot;hello&quot;
((),1)
```

### 捉え方

`lift`はモナド変換子版の`return`のようなものだと捉えられます。

![return-lift.png](https://qiita-image-store.s3.amazonaws.com/0/32057/8b54dce3-9e37-d565-8d8c-ef75f34a7c90.png)

* `return`: 値 → モナド
* `lift`: モナド → モナド変換子

## 組み合わせ

先の例のように単独で`lift`を使ってもあまり意味はありませんが、StateアクションとIOアクションとを併用するときに真価を発揮します。

状態を`get`で取得して`print`で表示する例です。

```hs
import Control.Monad.State

a :: StateT String IO ()
a = do
    v &lt;- get        -- Stateアクション
    lift $ print v  -- IOアクション

main = do
    runStateT a &quot;hello&quot;
```
```text:実行結果
&quot;hello&quot;
```

`runStateT`の評価結果はIOモナドに包まれているため、IOモナドに関連した操作はすべて閉じ込められるという原則は守られています。

## モナドスタック

モナド変換子とモナドの関係を包含関係として表現しましたが、積み重ねとしても表現できます。後者を**モナドスタック**と呼びます。包むか積むかという表現方法だけの違いで、意味が変わるわけではありません。

![inner-bottom.png](https://qiita-image-store.s3.amazonaws.com/0/32057/612c3d4a-f8e5-5e27-d2ff-4c281e3fdafb.png)

`print`はIOアクションですが、StateTモナド変換子を積むことでStateTアクションに変換されます。モナドスタックの上方のアクションに変換される様子を**持ち上げ**と表現します。

![lifting.png](https://qiita-image-store.s3.amazonaws.com/0/32057/c0e8a98d-e369-09cb-7f52-bf923883a451.png)

## 練習

【問2】StateTモナド変換子を扱う`bind`, `get`, `modify`, `lift`を実装してください。`do`は使わないでください。`&gt;&gt;=`はStateTモナド変換子以外にのみ使ってください。

`import`の際にオリジナルを隠してください。

```hs
import Control.Monad.State hiding (get, modify, lift)
```

具体的には次のコードが動くようにしてください。

```hs
fact x = (`execStateT` 1) $
    forM_ [1..x] $ \i -&gt;
        modify (* i) `bind` \_ -&gt;
        get `bind` \v -&gt;
        lift $ putStrLn $ &quot;*&quot; ++ show i ++ &quot; -&gt; &quot; ++ show v

main = fact 5 &gt;&gt;= print
```
```text:実行結果
*1 -&gt; 1
*2 -&gt; 2
*3 -&gt; 6
*4 -&gt; 24
*5 -&gt; 120
()
```

⇒ [解答例](http://qiita.com/7shi/items/79fe0e4c77427368ae2d#%E5%86%8D%E5%AE%9F%E8%A3%85)

【問3】問2の`fact`を`do`と`&lt;-`で書き直してください。問2で再実装した関数は使わないでください。

⇒ [解答例](http://qiita.com/7shi/items/79fe0e4c77427368ae2d#%E6%9B%B8%E3%81%8D%E7%9B%B4%E3%81%97)

# Maybeモナドとの合成

今までの例ではStateTモナド変換子で合成するのはIOモナドばかりでしたが、もちろんそれ以外のモナドとも合成できます。

例としてMaybeモナドを取り上げます。

次の手順でサンプルを書き換える過程を示します。

* モナドなし
    * Stateモナド
    * Maybeモナド
* モナド変換子で合成

## モナドなし

`getch`で1文字ずつ取得して、`get3`で3文字分を返します。文字数が足らないとエラーが発生します。

```hs
getch (x:xs) = (x, xs)

get3 xs0 =
    let (x1, xs1) = getch xs0
        (x2, xs2) = getch xs1
        (x3, xs3) = getch xs2
    in [x1, x2, x3]

main = do
    print $ get3 &quot;abcd&quot;  -- OK
    print $ get3 &quot;1234&quot;  -- OK
    print $ get3 &quot;a&quot;     -- NG
```
```text:実行結果（エラー）
&quot;abc&quot;
&quot;123&quot;
xxx: Main.hs:1:1-22: Non-exhaustive patterns in function getch
```

### Stateモナド

状態の受け渡しが冗長なので、Stateモナドで抽象化します。依然としてエラーは発生します。

```hs
import Control.Monad.State

getch = state getch where   -- Stateモナドに関数を入れる
    getch (x:xs) = (x, xs)  -- 状態 -&gt; (値, 状態)

get3 = evalState $ do
    x1 &lt;- getch
    x2 &lt;- getch
    x3 &lt;- getch
    return [x1, x2, x3]

main = do
    print $ get3 &quot;abcd&quot;  -- OK
    print $ get3 &quot;1234&quot;  -- OK
    print $ get3 &quot;a&quot;     -- NG
```
```text:実行結果
&quot;abc&quot;
&quot;123&quot;
xxx: Pattern match failure in do expression at Main.hs:4:5-10
```

### Maybeモナド

最初のコードに戻って、エラーを避けるためにMaybeモナドで書き換えます。

```hs
getch (x:xs) = Just (x, xs)
getch _      = Nothing

get3 xs0 = do
    (x1, xs1) &lt;- getch xs0
    (x2, xs2) &lt;- getch xs1
    (x3, xs3) &lt;- getch xs2
    return [x1, x2, x3]

main = do
    print $ get3 &quot;abcd&quot;  -- OK
    print $ get3 &quot;1234&quot;  -- OK
    print $ get3 &quot;a&quot;     -- NG
```
```text:実行結果
Just &quot;abc&quot;
Just &quot;123&quot;
Nothing
```

## モナド変換子で合成

StateTモナド変換子でMaybeモナドと合成すれば、StateモナドとMaybeモナドの両方の特徴が使えます。

```hs
import Control.Monad.State

getch = StateT getch where
    getch (x:xs) = Just (x, xs)
    getch _      = Nothing

get3 = evalStateT $ do
    x1 &lt;- getch
    x2 &lt;- getch
    x3 &lt;- getch
    return [x1, x2, x3]

main = do
    print $ get3 &quot;abcd&quot;  -- OK
    print $ get3 &quot;1234&quot;  -- OK
    print $ get3 &quot;a&quot;     -- NG
```
```text:実行結果
Just &quot;abc&quot;
Just &quot;123&quot;
Nothing
```

`getch`はMaybeモナドを返す関数をそのままStateTモナド変換子の中に入れています。StateTモナド変換子の中からMaybeモナドが出て来る構造が表現されています。

![StateT-Maybe-1.png](https://qiita-image-store.s3.amazonaws.com/0/32057/0d125295-059f-cff6-19f2-c7ca473b2312.png)

型で考えると、`StateT s Maybe a`を評価すれば`Maybe a`となります。モナドスタックからStateTモナド変換子を取り除いて下のMaybeモナドが残るとイメージできます。

![StateT-Maybe-2.png](https://qiita-image-store.s3.amazonaws.com/0/32057/36f0c6f5-2cdf-2297-9836-6023fb2eebf4.png)

※ ここで取り上げたサンプルに少し手を加えたものを続編の[Haskell 例外処理 超入門](http://qiita.com/7shi/items/73e534c47bbebc71b37e)でも説明します。

## 練習

【問4】次のコードは種類を判別しながら文字列を読み進めることを意図しています。Maybeモナドを使ってエラーが起きないように修正してください。モナド変換子は使わないでください。

```hs
import Data.Char

getch f (x:xs) | f x = (x, xs)

test s0 =
    let (ch1, s1) = getch isUpper s0
        (ch2, s2) = getch isLower s1
        (ch3, s3) = getch isDigit s2
    in [ch1, ch2, ch3]

main = do
    print $ test &quot;Aa0&quot;  -- OK
    print $ test &quot;abc&quot;  -- エラー
```
```実行結果
&quot;Aa0&quot;
Main.hs:3:1-30: Non-exhaustive patterns in function getch
```

⇒ [解答例](http://qiita.com/7shi/items/79fe0e4c77427368ae2d#maybe%E3%83%A2%E3%83%8A%E3%83%89)

【問5】問4の解答をStateTモナド変換子を使って書き直してください。

⇒ [解答例](http://qiita.com/7shi/items/79fe0e4c77427368ae2d#statet%E3%83%A2%E3%83%8A%E3%83%89%E5%A4%89%E6%8F%9B%E5%AD%90-1)

# 他のモナド変換子

State以外のモナドにも対応するモナド変換子があります。

モナド      |モナド変換子   |評価関数
------------|---------------|------------
`Reader r a`|`ReaderT r m a`|`runReaderT`
`Writer w a`|`WriterT r m a`|`runWriterT`
`[]       a`|`ListT     m a`|`runListT`

## 練習

【問6】次のコードの`print`を`main`から各`test*`の`do`の中に移動してください。実行結果が同じになるように調整してください。

```hs
import Control.Monad.Reader
import Control.Monad.Writer
import Control.Monad.List

testR x = (`runReader` x) $ do
    a &lt;- ask
    return $ a + 1

testW x = fst $ runWriter $ do
    tell &quot;&quot;
    return $ x + 1

testL x = do
    [x + 1]

main = do
    print $ testR 0
    print $ testW 0
    print $ testL 0
```
```text:実行結果
1
1
[1]
```

⇒ [解答例](http://qiita.com/7shi/items/79fe0e4c77427368ae2d#%E4%BB%96%E3%81%AE%E3%83%A2%E3%83%8A%E3%83%89%E5%A4%89%E6%8F%9B%E5%AD%90)

# 多重持ち上げ

モナドがネストしていると`lift`が最上位まで届かずにエラーになります。

![lift-2-NG.png](https://qiita-image-store.s3.amazonaws.com/0/32057/46164a6e-d8d9-1056-d4f7-34d1ea3ef65e.png)

```hs:NG
import Control.Monad.State
import Control.Monad.Reader

test1 x = (`runStateT` x) $ do  -- StateT
    modify (+ 1)
    a &lt;- get
    lift $ print a              -- OK
    (`runReaderT` a) $ do       -- ReaderT（ネスト）
        b &lt;- ask
        lift $ print $ b + 1    -- エラー

main = do
    test1 1
```
```text:エラー内容
Couldn&#39;t match type `IO&#39; with `StateT b m&#39;
Expected type: StateT b m ()
  Actual type: IO ()
```

ネストした回数だけ`lift`する必要があります。

![lift-2.png](https://qiita-image-store.s3.amazonaws.com/0/32057/fc559978-d547-3657-b562-1d7d79bbd925.png)

```hs:OK
import Control.Monad.State
import Control.Monad.Reader

test1 x = (`runStateT` x) $ do
    modify (+ 1)
    a &lt;- get
    lift $ print a
    (`runReaderT` a) $ do
        b &lt;- ask
        lift $ lift $ print $ b + 1  -- 修正

main = do
    test1 1
```
```text:実行結果
2
3
```

その時点でのモナドスタックの最上位まで持ち上げています。

## ネストの変動

先ほどの例では直接ネストさせていたのでネスト回数は明白ですが、ネスト対象が分離しているとややこしくなります。

分離して単独で呼ぶと`lift`し過ぎでエラーになります。

![lift-2-NG-2.png](https://qiita-image-store.s3.amazonaws.com/0/32057/ddfc195f-ac7e-55c2-6b48-25372f548663.png)

```hs:NG
import Control.Monad.State
import Control.Monad.Reader

test1 x = (`runStateT` x) $ do   -- StateT
    modify (+ 1)
    get &gt;&gt;= test2                -- StateTの中でReaderTを使用

test2 x = (`runReaderT` x) $ do  -- ReaderT
    b &lt;- ask
    lift $ lift $ print $ b + 1  -- 2階層目を想定

main = do
    test1 1                      -- OK
    test2 1                      -- エラー（想定階層の相違）
```
```text:エラー内容
Couldn&#39;t match type `t0 IO&#39; with `IO&#39;
Expected type: IO ()
  Actual type: t0 IO ()
```

## liftIO

```hs:型
liftIO :: IO a -&gt; m a
```

ネストの深さに関係なく最上位まで一気に持ち上げます。IOアクション専用です。

先ほどの例を修正します。

![liftIO.png](https://qiita-image-store.s3.amazonaws.com/0/32057/4ef83805-bca5-8789-747f-7defb036da01.png)

```hs
import Control.Monad.State
import Control.Monad.Reader

test1 x = (`runStateT` x) $ do
    modify (+ 1)
    get &gt;&gt;= test2

test2 x = (`runReaderT` x) $ do
    b &lt;- ask
    liftIO $ print $ b + 1  -- 階層深度の影響を受けない

main = do
    test1 1
    test2 1
```
```text:実行結果
3
2
```

`test2`がネストの深さに関係なく実行できるようになりました。

このようにIOアクションを持ち上げるときは`liftIO`を使った方が無難です。

## 練習

【問7】問6を`liftIO`で解いてください。

⇒ [解答例](http://qiita.com/7shi/items/79fe0e4c77427368ae2d#liftio)

# 関数の持ち上げ

`lift`や`liftIO`はアクションを持ち上げていましたが、関数の持ち上げもあります。

※ 関数の持ち上げはモナド変換子とは関係ありませんが、持ち上げに関連して取り上げます。

以下、モナドを代表してリストで例を示します。

## 値とモナドスタック

モナドによる値の包含関係もモナドスタックとして表現することができます。

![value.png](https://qiita-image-store.s3.amazonaws.com/0/32057/a4425f3f-4daa-9ed5-6f07-587300e7f446.png)

## 適用不能

通常の関数はモナドに入っている値に対して適用できません。

![liftM-NG.png](https://qiita-image-store.s3.amazonaws.com/0/32057/d460d940-5638-dc0e-962e-d552241b1085.png)

```hs:NG
main = print $ (+ 1) [1]  -- エラー
```

このようなときに使うのが関数の持ち上げです。

## liftM

```hs:型
liftM :: Monad m =&gt; (a1 -&gt; r) -&gt; m a1 -&gt; m r 
```

モナドに入っている値に対して、関数を持ち上げることで適用します。

![liftM-OK.png](https://qiita-image-store.s3.amazonaws.com/0/32057/526714f2-076d-ad9c-5c19-cd4f07a85c10.png)

```hs
import Control.Monad

main = print $ liftM (+ 1) [1]
```
```text:実行結果
[2]
```

対象となるモナドと同じ高さまで関数を持ち上げています。

## liftM2

```hs:型
liftM2 :: Monad m =&gt; (a1 -&gt; a2 -&gt; r) -&gt; m a1 -&gt; m a2 -&gt; m r 
```

引数が2つある関数に対する持ち上げです。

```hs
import Control.Monad

main = print $ liftM2 (+) [1] [1]
```
```text:実行結果
[2]
```

同様に`liftM5`まで定義されています。

* [Control.Monad: Monadic lifting operators](http://hackage.haskell.org/package/base-4.7.0.2/docs/Control-Monad.html#g:7)

## Applicativeスタイル

関数の持ち上げは[Haskell アクション 超入門](http://qiita.com/7shi/items/85afd7bbd5d6c4115ad6)で取り上げたApplicativeスタイルと同じです。

※ そこでは「値の取り出し」という観点で統一するため、敢えて「持ち上げ」とは言わずに別の説明をしています。結果は同じなので、解釈で何かが変わるわけではありません。

1個目の引数は`&lt;$&gt;`、2個目以降の引数は`&lt;*&gt;`でつなぎます。

```hs
import Control.Applicative

main = do
    print $ (1 +) &lt;$&gt; [1]
    print $ (+)   &lt;$&gt; [1] &lt;*&gt; [1]
```
```text:実行結果
[2]
[2]
```

※ Applicativeを直訳すれば「適用可能」です。「複数の引数が**適用可能**」というような意味合いです。今回の範囲を超えるため詳細は省略します。

### &lt;$&gt;とliftM

`&lt;$&gt;`は`liftM`の演算子版で、同じ働きです。

交換してみます。

※ 確認が目的です。実用的なコードではありません。

```hs
import Control.Applicative
import Control.Monad

main = do
    print $ liftM (1 +) [1]
    print $ (&lt;$&gt;) (1 +) [1]          -- &lt;$&gt;を関数化

    print $ (1 +)   &lt;$&gt;   [1]
    print $ (1 +) `liftM` [1]        -- liftMを演算子化

    print $ (+)   &lt;$&gt;   [1] &lt;*&gt; [1]
    print $ (+) `liftM` [1] &lt;*&gt; [1]  -- liftMと&lt;*&gt;の組み合わせ

    print $ liftM (+) [1] &lt;*&gt; [1]    -- こんなこともできるが
    print $ (&lt;$&gt;) (+) [1] &lt;*&gt; [1]    -- あまり意味はない
```
```text:実行結果
[2]
[2]
[2]
[2]
[2]
[2]
[2]
[2]
```

## &lt;$&gt;と&lt;*&gt;

今までApplicativeスタイルは使い方しか示しませんでしたが、そもそも`&lt;$&gt;`と`&lt;*&gt;`の違いは何でしょうか。

再実装を通して、違いを探ります。

### &lt;$&gt;

`&lt;$&gt;`を再実装します。

```hs
f &lt;$&gt; m = do
    a &lt;- m        -- モナドから値を取り出す
    return $ f a  -- 値を関数に適用してモナドに入れて返す

main = do
    print $ (1 +) &lt;$&gt; [1]
```
```text:実行結果
[2]
```

### 部分適用とモナド

`&lt;$&gt;`を引数が2つの関数に適用するとどうなるでしょうか。

例: `(+) &lt;$&gt; [1]`

1. モナド`[1]`から値を取り出し → `1`
2. 関数`(+)`に`1`を部分適用 → `(+) 1` == セクション `(1 +)`
3. 戻り値`(1 +)`がモナドに入れて返される → `[(1 +)]`

引数が足りないため部分適用となり、戻された関数がモナドに入れられます。

### &lt;*&gt;

2番目以降の引数はモナドに入った関数に適用します。

`&lt;*&gt;`を再実装します。

```hs
f &lt;$&gt; m = do
    a &lt;- m
    return $ f a

mf &lt;*&gt; m = do
    f &lt;- mf       -- モナドから関数を取り出す
    a &lt;- m        -- モナドから値を取り出す
    return $ f a  -- 値を関数に適用してモナドに入れて返す

main = do
    print $ (+) &lt;$&gt; [1] &lt;*&gt; [1]
```
```text:実行結果
[2]
```

`&lt;$&gt;`と`&lt;*&gt;`の違いは、関数がモナドに入っているかどうかです。

### &lt;*&gt;だけで書く

最初から関数をモナドに入れれば`&lt;*&gt;`だけで書けます。

```hs
import Control.Applicative

main = do
    print $ return (1 +) &lt;*&gt; [1]
    print $ return   (+) &lt;*&gt; [1] &lt;*&gt; [1]
```
```text:実行結果
[2]
[2]
```

値として関数がモナドに入れられるのがポイントです。

## 第一級関数

値としてモナドに入れられる関数は、状態系モナドの内部関数とは別物です。内部関数の戻り値として生成される対象で、値と同じ扱いです。このように関数が値と同列に扱えることを[第一級関数](http://ja.wikipedia.org/wiki/%E7%AC%AC%E4%B8%80%E7%B4%9A%E9%96%A2%E6%95%B0)と呼びます。

Stateモナドとリストモナドで例を示します。

```hs
import Control.Monad.State

f1 :: State s (Int -&gt; Int)
f1 = return (1 +)                -- 関数をStateモナドに入れる

f2 :: State s (Int -&gt; Int)
f2 = state $ \s -&gt; ((1 +), s)    -- 内部関数が戻すタプルの値が関数

f3 :: [Int -&gt; Int]
f3 = return (1 +)                -- 関数をリストモナドに入れる

main = do
    print $ (evalState f1 ()) 1  -- Stateモナドから取り出した関数を評価
    print $ (evalState f2 ()) 1  -- Stateモナドから取り出した関数を評価
    print $ (f3 !! 0) 1          -- リストモナドから取り出した関数を評価
```
```text:実行結果
2
2
2
```

## liftMとreturn

`return (1 +)`で関数をモナドに入れるのと、`liftM`による持ち上げとの違いは何でしょうか。

`liftM`を部分適用すると、モナドを直接評価できる関数が得られます。

```hs
import Control.Monad

f = liftM (+ 1)    -- 関数の持ち上げ

main = do
    print $ f [1]  -- モナドを直接評価
```
```text:実行結果
[2]
```

このようにモナドを評価できるようにすることが**関数の持ち上げ**です。`f`の実体は部分適用された`liftM`です。

これに対して、関数をモナドに入れても関数としては使えません。

```hs:NG
f :: [Int -&gt; Int]
f = return (+ 1)   -- 関数をモナドに入れる

main = do
    print $ f [1]  -- エラー
```
```text:エラー内容
Couldn&#39;t match expected type `[t0] -&gt; a0&#39;
            with actual type `[Int -&gt; Int]&#39;
The function `f&#39; is applied to one argument,
but its type `[Int -&gt; Int]&#39; has none
```

`&lt;*&gt;`の助けが必要です。

```hs:OK
import Control.Applicative

f :: [Int -&gt; Int]
f = return (+ 1)       -- 関数をモナドに入れる

main = do
    print $ f &lt;*&gt; [1]  -- OK
```
```text:実行結果
[2]
```

## 練習

【問8】次のリスト内包表記を`liftM`系の関数で書き直してください。

```hs
main = do
    print [(x , y) | x &lt;- [0, 1], y &lt;- [0, 2]]
    print [ x + y  | x &lt;- [0, 1], y &lt;- [0, 2]]
```

⇒ [解答例](http://qiita.com/7shi/items/79fe0e4c77427368ae2d#liftm)

# 参考

mtlでのStateモナドの定義は途中で変更されたそうです。

* [mtlが変わってる - [ pred x | x &lt;- &quot;Ibtlfmm!ojllj&quot; ] - haskell](http://haskell.g.hatena.ne.jp/illillli/20120707/1341678109) 2012.7.7

`liftIO`は以下の記事を参考にしました。

* [@fmkz___](https://twitter.com/fmkz___): [fmapとliftMとliftそしてliftIO](http://blog.kzfmix.com/entry/1342394344) 2012.7.16
* [liftとliftIOの違い - [ pred x | x &lt;- &quot;Ibtlfmm!ojllj&quot; ] - haskell](http://haskell.g.hatena.ne.jp/illillli/20090514/1242305123) 2009.5.14

# 謝辞

持ち上げやモナドスタックについては@ruicc先生よりご教示いただきました。

記事としてまとめていただきましたので、理解を深めたい方はご参照ください。

* [@ruicc](https://twitter.com/ruicc): [Haskell - モナドトランスフォーマーとその周辺 - Qiita](http://qiita.com/ruicc/items/7512c990a1835bba444a) 2015.2.4
</textarea><input type="submit" name="commit" value="Save changes" data-disable-with="Save changes" /></form></div></section></div><div class="col-sm-3"><div class="socialButtons"><div class="socialButtons_twitter"><a class="twitter-share-button" data-text="Haskell モナド変換子 超入門 by @7shi on @Qiita" data-url="http://qiita.com/7shi/items/4408b76624067c17e933" href="https://twitter.com/share">Tweet</a></div><div class="socialButtons_hatebu"><a class="hatena-bookmark-button" data-hatena-bookmark-layout="simple-balloon" data-hatena-bookmark-title="Haskell モナド変換子 超入門" href="http://b.hatena.ne.jp/entry/http://qiita.com/7shi/items/4408b76624067c17e933" title="Add to Hatena Bookmark"><img alt="Add to Hatena Bookmark" height="20" src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" style="border: none;" width="20" /></a><script async="async" charset="utf-8" src="https://b.st-hatena.com/js/bookmark_button.js" type="text/javascript"></script></div><div class="socialButtons_googlePlus"><div class="g-plusone" data-href="http://qiita.com/7shi/items/4408b76624067c17e933" data-size="medium"></div></div><div class="socialButtons_facebook"><div class="fb-like" data-action="like" data-href="http://qiita.com/7shi/items/4408b76624067c17e933" data-layout="button_count" data-share="false" data-show-faces="false"></div></div><div class="socialButtons_pocket"><a class="pocket-btn" data-lang="en" data-pocket-count="horizontal" data-pocket-label="pocket"></a></div></div><section class="itemsShowAuthorInfo" itemprop="author" itemscope="" itemtype="http://schema.org/Person"><a href="/7shi"><img alt="" class="itemsShowAuthorInfo_userIcon" itemprop="image" src="https://qiita-image-store.s3.amazonaws.com/0/32057/profile-images/1473685823" /></a><div class="itemsShowAuthorInfo_profileStats"><strong class="itemsShowAuthorInfo_userName" itemprop="name"><a itemprop="url" href="/7shi">7shi</a></strong><div class="itemsShowAuthorInfo_contribution"><span class="itemsShowAuthorInfo_count">2522</span><span class="itemsShowAuthorInfo_unit">Contribution</span></div><div data-react-class="T.UserFollowButton" data-react-props="{&quot;url_name&quot;:&quot;7shi&quot;,&quot;initial_followed_by&quot;:false,&quot;size&quot;:&quot;btn-xs&quot;,&quot;position&quot;:&quot;author-info&quot;}"></div></div><section class="itemsShowAuthorPopularItems"><h5 class="itemsShowAuthorPopularItems_sectionTitle">Popular Posts</h5><ul class="itemsShowAuthorPopularItems_posts list-unstyled"><li itemscope="" itemtype="http://schema.org/Article"> <a itemprop="url" track="click" data-label="AuthorPopularItemsAtSidebar" href="/7shi/items/145f1234f8ec2af923ef">Haskell 超入門</a></li><li itemscope="" itemtype="http://schema.org/Article"> <a itemprop="url" track="click" data-label="AuthorPopularItemsAtSidebar" href="/7shi/items/547b6137d7a3c482fe68">モナド則がちょっと分かった？</a></li><li itemscope="" itemtype="http://schema.org/Article"> <a itemprop="url" track="click" data-label="AuthorPopularItemsAtSidebar" href="/7shi/items/cac7b3e9b90bf91b00cc">文字列で学ぶC++入門</a></li><li itemscope="" itemtype="http://schema.org/Article"> <a itemprop="url" track="click" data-label="AuthorPopularItemsAtSidebar" href="/7shi/items/85afd7bbd5d6c4115ad6">Haskell アクション 超入門</a></li><li itemscope="" itemtype="http://schema.org/Article"> <a itemprop="url" track="click" data-label="AuthorPopularItemsAtSidebar" href="/7shi/items/d1e5a0c22be6cf61d286">Haskell IDE Leksah 入門</a></li></ul></section></section><div class="scroll-chaser"><div class="google-adsense"><style>.test-text-responsible { width: 200px; height: 200px; }@media(min-width: 1200px) {  .test-text-responsible { width: 250px; height: 250px; }}@media(max-width: 979px) and (min-width: 768px) {  .test-text-responsible { width: 120px; height: 240px; }}@media(max-width: 767px) {  .test-text-responsible { width: 320px; height: 50px; }}</style><script async="" src="http://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><ins class="adsbygoogle test-text-responsible" data-ad-client="ca-pub-8127218772604357" data-ad-slot="3880091879" style="display:inline-block"></ins><script>(adsbygoogle = window.adsbygoogle || []).push({});</script></div></div><div data-react-class="T.Toc" data-react-props="{&quot;body&quot;:&quot;\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E3%83%A2%E3%83%8A%E3%83%89%E5%A4%89%E6%8F%9B%E5%AD%90\&quot;\u003eモナド変換子\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#identity%E3%83%A2%E3%83%8A%E3%83%89\&quot;\u003eIdentityモナド\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#id\&quot;\u003eid\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#statet%E3%83%A2%E3%83%8A%E3%83%89%E5%A4%89%E6%8F%9B%E5%AD%90\&quot;\u003eStateTモナド変換子\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E5%9E%8B%E8%A1%A8%E8%A8%98\&quot;\u003e型表記\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#state%E3%83%A2%E3%83%8A%E3%83%89%E3%81%A8%E3%81%AE%E9%96%A2%E4%BF%82\&quot;\u003eStateモナドとの関係\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E9%A1%9E%E4%BC%BC%E4%BE%8B\&quot;\u003e類似例\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E5%86%85%E9%83%A8%E9%96%A2%E6%95%B0\&quot;\u003e内部関数\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#runstatet\&quot;\u003erunStateT\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E7%89%87%E6%96%B9%E3%81%A0%E3%81%91%E3%82%92%E5%8F%96%E5%BE%97%E3%81%99%E3%82%8B%E9%96%A2%E6%95%B0\&quot;\u003e片方だけを取得する関数\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#statet\&quot;\u003eStateT\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#io%E3%83%A2%E3%83%8A%E3%83%89%E3%81%A8%E3%81%AE%E6%AF%94%E8%BC%83\&quot;\u003eIOモナドとの比較\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E7%B7%B4%E7%BF%92\&quot;\u003e練習\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E6%8C%81%E3%81%A1%E4%B8%8A%E3%81%92\&quot;\u003e持ち上げ\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#statet-s-io-a\&quot;\u003eStateT s IO a\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#print\&quot;\u003eprint\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#lift\&quot;\u003elift\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E6%8D%89%E3%81%88%E6%96%B9\&quot;\u003e捉え方\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E7%B5%84%E3%81%BF%E5%90%88%E3%82%8F%E3%81%9B\&quot;\u003e組み合わせ\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E3%83%A2%E3%83%8A%E3%83%89%E3%82%B9%E3%82%BF%E3%83%83%E3%82%AF\&quot;\u003eモナドスタック\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E7%B7%B4%E7%BF%92-1\&quot;\u003e練習\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#maybe%E3%83%A2%E3%83%8A%E3%83%89%E3%81%A8%E3%81%AE%E5%90%88%E6%88%90\&quot;\u003eMaybeモナドとの合成\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E3%83%A2%E3%83%8A%E3%83%89%E3%81%AA%E3%81%97\&quot;\u003eモナドなし\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#state%E3%83%A2%E3%83%8A%E3%83%89\&quot;\u003eStateモナド\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#maybe%E3%83%A2%E3%83%8A%E3%83%89\&quot;\u003eMaybeモナド\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E3%83%A2%E3%83%8A%E3%83%89%E5%A4%89%E6%8F%9B%E5%AD%90%E3%81%A7%E5%90%88%E6%88%90\&quot;\u003eモナド変換子で合成\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E7%B7%B4%E7%BF%92-2\&quot;\u003e練習\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E4%BB%96%E3%81%AE%E3%83%A2%E3%83%8A%E3%83%89%E5%A4%89%E6%8F%9B%E5%AD%90\&quot;\u003e他のモナド変換子\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E7%B7%B4%E7%BF%92-3\&quot;\u003e練習\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E5%A4%9A%E9%87%8D%E6%8C%81%E3%81%A1%E4%B8%8A%E3%81%92\&quot;\u003e多重持ち上げ\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E3%83%8D%E3%82%B9%E3%83%88%E3%81%AE%E5%A4%89%E5%8B%95\&quot;\u003eネストの変動\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#liftio\&quot;\u003eliftIO\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E7%B7%B4%E7%BF%92-4\&quot;\u003e練習\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E9%96%A2%E6%95%B0%E3%81%AE%E6%8C%81%E3%81%A1%E4%B8%8A%E3%81%92\&quot;\u003e関数の持ち上げ\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E5%80%A4%E3%81%A8%E3%83%A2%E3%83%8A%E3%83%89%E3%82%B9%E3%82%BF%E3%83%83%E3%82%AF\&quot;\u003e値とモナドスタック\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E9%81%A9%E7%94%A8%E4%B8%8D%E8%83%BD\&quot;\u003e適用不能\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#liftm\&quot;\u003eliftM\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#liftm2\&quot;\u003eliftM2\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#applicative%E3%82%B9%E3%82%BF%E3%82%A4%E3%83%AB\&quot;\u003eApplicativeスタイル\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E3%81%A8liftm\&quot;\u003eとliftM\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E3%81%A8\&quot;\u003eと\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#\&quot;\u003e\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E9%83%A8%E5%88%86%E9%81%A9%E7%94%A8%E3%81%A8%E3%83%A2%E3%83%8A%E3%83%89\&quot;\u003e部分適用とモナド\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#-1\&quot;\u003e\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E3%81%A0%E3%81%91%E3%81%A7%E6%9B%B8%E3%81%8F\&quot;\u003eだけで書く\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E7%AC%AC%E4%B8%80%E7%B4%9A%E9%96%A2%E6%95%B0\&quot;\u003e第一級関数\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#liftm%E3%81%A8return\&quot;\u003eliftMとreturn\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E7%B7%B4%E7%BF%92-5\&quot;\u003e練習\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E5%8F%82%E8%80%83\&quot;\u003e参考\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E8%AC%9D%E8%BE%9E\&quot;\u003e謝辞\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n&quot;,&quot;wrapper&quot;:&quot;#article-body-wrapper&quot;}"></div></div></div><div class="row"><div class="col-sm-9"><div class="ArticleFooter__menu"><div class="s-flex-align-center"><div class="js-likebutton" data-props="{&quot;like_status&quot;:false,&quot;like_count&quot;:47,&quot;show_count&quot;:true,&quot;uuid&quot;:&quot;4408b76624067c17e933&quot;,&quot;likable_type&quot;:&quot;Article&quot;,&quot;position&quot;:&quot;article-footer&quot;}"></div><div class="ArticleFooter__userList"><div class="ArticleFooter__user"><div class="js-hovercard" data-hovercard-target-name="_marony"><a itemprop="url" href="/_marony"><img alt="_marony" class="thumb thumb--xs" src="https://qiita-image-store.s3.amazonaws.com/0/714/profile-images/1473755311" /></a></div></div><div class="ArticleFooter__user"><div class="js-hovercard" data-hovercard-target-name="uchiko"><a itemprop="url" href="/uchiko"><img alt="uchiko" class="thumb thumb--xs" src="https://qiita-image-store.s3.amazonaws.com/0/2278/profile-images/1473681372" /></a></div></div><div class="ArticleFooter__user"><div class="js-hovercard" data-hovercard-target-name="tapioga"><a itemprop="url" href="/tapioga"><img alt="tapioga" class="thumb thumb--xs" src="https://qiita-image-store.s3.amazonaws.com/0/38349/profile-images/1473687732" /></a></div></div><div class="ArticleFooter__user"><div class="js-hovercard" data-hovercard-target-name="tattsun58"><a itemprop="url" href="/tattsun58"><img alt="tattsun58" class="thumb thumb--xs" src="https://qiita-image-store.s3.amazonaws.com/0/38970/profile-images/1473687941" /></a></div></div><div class="ArticleFooter__user"><div class="js-hovercard" data-hovercard-target-name="saka_bar"><a itemprop="url" href="/saka_bar"><img alt="saka_bar" class="thumb thumb--xs" src="https://qiita-image-store.s3.amazonaws.com/0/13826/profile-images/1473757920" /></a></div></div><div class="ArticleFooter__user"><div class="js-hovercard" data-hovercard-target-name="arowM"><a itemprop="url" href="/arowM"><img alt="arowM" class="thumb thumb--xs" src="https://qiita-image-store.s3.amazonaws.com/0/16345/profile-images/1473681833" /></a></div></div><div class="ArticleFooter__user"><div class="js-hovercard" data-hovercard-target-name="yoya"><a itemprop="url" href="/yoya"><img alt="yoya" class="thumb thumb--xs" src="https://qiita-image-store.s3.amazonaws.com/0/1798/profile-images/1473755697" /></a></div></div><div class="ArticleFooter__user"><div class="js-hovercard" data-hovercard-target-name="liveinwood"><a itemprop="url" href="/liveinwood"><img alt="liveinwood" class="thumb thumb--xs" src="https://gravatar.com/avatar/fd1b6ea9b7b3f46de5da87a2dabd304f?d=https%3A%2F%2Fidenticons.github.com%2F8bc232144688fdecf1de7d358e2946a8.png&amp;r=x" /></a></div></div><div class="ArticleFooter__user"><div class="js-hovercard" data-hovercard-target-name="JunKikuchi"><a itemprop="url" href="/JunKikuchi"><img alt="JunKikuchi" class="thumb thumb--xs" src="https://qiita-image-store.s3.amazonaws.com/0/13181/profile-images/1473682708" /></a></div></div><div class="ArticleFooter__user"><div class="js-hovercard" data-hovercard-target-name="igrep"><a itemprop="url" href="/igrep"><img alt="igrep" class="thumb thumb--xs" src="https://qiita-image-store.s3.amazonaws.com/0/12688/profile-images/1473682497" /></a></div></div><div class="ArticleFooter__user"><a href="/7shi/items/4408b76624067c17e933/likers"><span class="fa fa-ellipsis-h"></span></a></div></div></div><div class="u-flex u-align-center"><div class="ArticleFooter__stock"><div class="js-stockbutton" data-position="footer_menu" data-props="{&quot;stock_status&quot;:false}"></div></div><div class="ArticleFooter__editRequest"><a class="u-link-no-underline" data-toggle="tooltip" title="You can propose improvements about the article to the author 💪" href="/drafts/4408b76624067c17e933/edit"><span class="fa fa-send-o fa-lg"></span> <span>Edit request</span></a></div><div class="dropdown ArticleFooter__dropdown"><a class="dropdown-toggle" data-toggle="dropdown" href="#"><span class="fa fa-ellipsis-h"></span></a><ul class="dropdown-menu dropdown-menu-right"><li><a href="/7shi/items/4408b76624067c17e933.md"><span class="fa fa-fw fa-file-text-o"></span> Show article as Markdown</a></li><li><a data-target=".js-report-form" data-toggle="modal" href="#"><i class="fa fa-fw fa-flag"></i> Report article</a></li></ul></div></div></div><ul class="references js-referencesView"><li class="references_header"><i class="fa fa-fw fa-link"></i> Linked from these articles</li><a class="references_toggleOldReferences js-toggleOldReferences" href="#"><i class="fa fa-expand js-toggleOldReferencesIcon"></i><span class="js-toggleOldReferencesText">Show old 12 links</span></a><li class="references_reference js-reference js-oldReference"><span>Linked from </span><a href="/7shi/items/79fe0e4c77427368ae2d#_reference-c5079394392c1ac5e78c"><img alt="" width="18" height="18" src="https://qiita-image-store.s3.amazonaws.com/0/32057/profile-images/1473685823" />【解答例】Haskell モナド変換子 超入門</a><time class="references_datetime js-dateTimeView" datetime="2015-01-04T13:33:58+00:00">about 2 years ago</time></li><li class="references_reference js-reference js-oldReference"><span>Linked from </span><a href="/7shi/items/145f1234f8ec2af923ef#_reference-04458fe5e0a7e731b113"><img alt="" width="18" height="18" src="https://qiita-image-store.s3.amazonaws.com/0/32057/profile-images/1473685823" />Haskell 超入門</a><time class="references_datetime js-dateTimeView" datetime="2015-01-04T13:51:07+00:00">about 2 years ago</time></li><li class="references_reference js-reference js-oldReference"><span>Linked from </span><a href="/7shi/items/85afd7bbd5d6c4115ad6#_reference-b6d2f2b41e262196e3e4"><img alt="" width="18" height="18" src="https://qiita-image-store.s3.amazonaws.com/0/32057/profile-images/1473685823" />Haskell アクション 超入門</a><time class="references_datetime js-dateTimeView" datetime="2015-01-04T13:53:44+00:00">about 2 years ago</time></li><li class="references_reference js-reference js-oldReference"><span>Linked from </span><a href="/7shi/items/1345bf32003faff435cb#_reference-667eef63ff62c828a75c"><img alt="" width="18" height="18" src="https://qiita-image-store.s3.amazonaws.com/0/32057/profile-images/1473685823" />Haskell ラムダ 超入門</a><time class="references_datetime js-dateTimeView" datetime="2015-01-04T13:54:35+00:00">about 2 years ago</time></li><li class="references_reference js-reference js-oldReference"><span>Linked from </span><a href="/7shi/items/4a8a2807bb5186576c61#_reference-9f063f2c12c1236eb71b"><img alt="" width="18" height="18" src="https://qiita-image-store.s3.amazonaws.com/0/32057/profile-images/1473685823" />Haskell アクションとラムダ 超入門</a><time class="references_datetime js-dateTimeView" datetime="2015-01-04T13:55:09+00:00">about 2 years ago</time></li><li class="references_reference js-reference js-oldReference"><span>Linked from </span><a href="/7shi/items/d3d3492ddd90d47160f2#_reference-2cf889d4a3bd21177512"><img alt="" width="18" height="18" src="https://qiita-image-store.s3.amazonaws.com/0/32057/profile-images/1473685823" />Haskell IOモナド 超入門</a><time class="references_datetime js-dateTimeView" datetime="2015-01-04T13:55:37+00:00">about 2 years ago</time></li><li class="references_reference js-reference js-oldReference"><span>Linked from </span><a href="/7shi/items/deb19c4cba933590ffbf#_reference-2b3421b09e364cfd34c4"><img alt="" width="18" height="18" src="https://qiita-image-store.s3.amazonaws.com/0/32057/profile-images/1473685823" />Haskell リストモナド 超入門</a><time class="references_datetime js-dateTimeView" datetime="2015-01-04T13:56:19+00:00">about 2 years ago</time></li><li class="references_reference js-reference js-oldReference"><span>Linked from </span><a href="/7shi/items/2e9bff5d88302de1a9e9#_reference-8521dec57a1428109354"><img alt="" width="18" height="18" src="https://qiita-image-store.s3.amazonaws.com/0/32057/profile-images/1473685823" />Haskell 状態系モナド 超入門</a><time class="references_datetime js-dateTimeView" datetime="2015-01-04T13:57:11+00:00">about 2 years ago</time></li><li class="references_reference js-reference js-oldReference"><span>Linked from </span><a href="/7shi/items/c7d7eec066af0fe0688d#_reference-d90c4912b1dd512609c0"><img alt="" width="18" height="18" src="https://qiita-image-store.s3.amazonaws.com/0/32057/profile-images/1473685823" />Haskell Maybeモナド 超入門</a><time class="references_datetime js-dateTimeView" datetime="2015-01-22T08:10:00+00:00">about 2 years ago</time></li><li class="references_reference js-reference js-oldReference"><span>Linked from </span><a href="/7shi/items/12036631dad1979a273b#_reference-8184c945d2284fe47207"><img alt="" width="18" height="18" src="https://qiita-image-store.s3.amazonaws.com/0/32057/profile-images/1473685823" />MaybeとStateを合成</a><time class="references_datetime js-dateTimeView" datetime="2015-04-25T02:24:12+00:00">almost 2 years ago</time></li><li class="references_reference js-reference js-oldReference"><span>Linked from </span><a href="/7shi/items/201f379443079736e18e#_reference-27c3a52a5a53eb9c44a5"><img alt="" width="18" height="18" src="https://qiita-image-store.s3.amazonaws.com/0/32057/profile-images/1473685823" />Parsecをモナド変換子で模倣</a><time class="references_datetime js-dateTimeView" datetime="2015-04-28T09:36:35+00:00">almost 2 years ago</time></li><li class="references_reference js-reference js-oldReference"><span>Linked from </span><a href="/7shi/items/ee5afe4f088f0a1fc8c2#_reference-e3d2c178f18be1b8cfa2"><img alt="" width="18" height="18" src="https://qiita-image-store.s3.amazonaws.com/0/32057/profile-images/1473685823" />Stateモナドによる中置記法の処理</a><time class="references_datetime js-dateTimeView" datetime="2015-07-24T02:53:07+00:00">over 1 year ago</time></li><li class="references_reference js-reference"><span>Linked from </span><a href="/7shi/items/73e534c47bbebc71b37e#_reference-d293e62f984c15bf58e5"><img alt="" width="18" height="18" src="https://qiita-image-store.s3.amazonaws.com/0/32057/profile-images/1473685823" />Haskell 例外処理 超入門</a><time class="references_datetime js-dateTimeView" datetime="2015-07-28T09:19:55+00:00">over 1 year ago</time></li><li class="references_reference js-reference"><span>Linked from </span><a href="/7shi/items/1ce76bde464b4a55c143#_reference-b00e94a4e14466509a0b"><img alt="" width="18" height="18" src="https://qiita-image-store.s3.amazonaws.com/0/32057/profile-images/1473685823" />Haskell 代数的データ型 超入門</a><time class="references_datetime js-dateTimeView" datetime="2015-07-28T13:19:07+00:00">over 1 year ago</time></li><li class="references_reference js-reference"><span>Linked from </span><a href="/7shi/items/b8c741e78a96ea2c10fe#_reference-2e9828a2546a1d3bf9f1"><img alt="" width="18" height="18" src="https://qiita-image-store.s3.amazonaws.com/0/32057/profile-images/1473685823" />Haskell 構文解析 超入門</a><time class="references_datetime js-dateTimeView" datetime="2015-07-31T06:47:02+00:00">over 1 year ago</time></li><li class="references_reference js-reference"><span>Linked from </span><a href="/ak1t0/items/780f6722623ec126fcdf#_reference-bf888ef8c89a5f6bc88a"><img alt="" width="18" height="18" src="https://qiita-image-store.s3.amazonaws.com/0/34193/profile-images/1473686290" />入門 StateTモナド</a><time class="references_datetime js-dateTimeView" datetime="2015-12-12T15:01:15+00:00">about 1 year ago</time></li><li class="references_reference js-reference"><span>Linked from </span><a href="/tsukimizake774/items/9c60c9e06ebc56b648b7#_reference-c4bbeacc8fdc04a127f4"><img alt="" width="18" height="18" src="https://qiita-image-store.s3.amazonaws.com/0/10604/profile-images/1473681756" />Stateモナドで遊んでみよう</a><time class="references_datetime js-dateTimeView" datetime="2016-04-02T02:08:20+00:00">11 months ago</time></li></ul><div class="itemsShowBody_articleColumnFooter"><div class="socialButtons"><div class="socialButtons_twitter"><a class="twitter-share-button" data-text="Haskell モナド変換子 超入門 by @7shi on @Qiita" data-url="http://qiita.com/7shi/items/4408b76624067c17e933" href="https://twitter.com/share">Tweet</a></div><div class="socialButtons_hatebu"><a class="hatena-bookmark-button" data-hatena-bookmark-layout="simple-balloon" data-hatena-bookmark-title="Haskell モナド変換子 超入門" href="http://b.hatena.ne.jp/entry/http://qiita.com/7shi/items/4408b76624067c17e933" title="Add to Hatena Bookmark"><img alt="Add to Hatena Bookmark" height="20" src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" style="border: none;" width="20" /></a><script async="async" charset="utf-8" src="https://b.st-hatena.com/js/bookmark_button.js" type="text/javascript"></script></div><div class="socialButtons_googlePlus"><div class="g-plusone" data-href="http://qiita.com/7shi/items/4408b76624067c17e933" data-size="medium"></div></div><div class="socialButtons_facebook"><div class="fb-like" data-action="like" data-href="http://qiita.com/7shi/items/4408b76624067c17e933" data-layout="button_count" data-share="false" data-show-faces="false"></div></div><div class="socialButtons_pocket"><a class="pocket-btn" data-lang="en" data-pocket-count="horizontal" data-pocket-label="pocket"></a></div></div></div><div class="itemsShowComment_wrapper" id="comments"><div data-react-class="T.CommentListContainer" data-react-props="{&quot;currentUser&quot;:null,&quot;initialComments&quot;:[],&quot;monthly_public_image_uploadable_size_limit&quot;:null,&quot;total_uploaded_public_image_size_in_current_month&quot;:null,&quot;item&quot;:{&quot;id&quot;:219408,&quot;uuid&quot;:&quot;4408b76624067c17e933&quot;,&quot;suspended&quot;:false,&quot;secret&quot;:false},&quot;owner&quot;:{&quot;url_name&quot;:&quot;7shi&quot;},&quot;is_team&quot;:false,&quot;is_project&quot;:false,&quot;logged_in&quot;:false,&quot;polling&quot;:false,&quot;mention_candidates&quot;:[{&quot;id&quot;:32057,&quot;url_name&quot;:&quot;7shi&quot;,&quot;profile_image_url&quot;:&quot;https://qiita-image-store.s3.amazonaws.com/0/32057/profile-images/1473685823&quot;}]}">Comments Loading...</div></div></div></div></div></article><div class="js-report-form modal fade reportForm"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><button name="button" type="submit" class="close" data-dismiss="modal">&times;</button><h4 class="modal-title">Report article</h4></div><div class="modal-body"><form action="/reports" accept-charset="UTF-8" method="post"><input name="utf8" type="hidden" value="&#x2713;" /><input type="hidden" name="authenticity_token" value="TWedcTiMXT1Twqh4GLfKx2clIy+41hP6vjPr1Pe4+Vgj5QYpo6JkdqwRHWRoQnSeB2IHnC8SSQ2C7eIvFrb3ng==" /><input type="hidden" name="redirect_path" id="redirect_path" value="/7shi/items/4408b76624067c17e933" /><input type="hidden" name="item_uuid" id="item_uuid" value="4408b76624067c17e933" /><p>Help us understand the problem. What is going on with this item?</p><br /><div class="form-group"><ul class="list-unstyled"><li><label><input type="radio" name="report_type" id="report_type_spam" value="spam" required="required" /> It&#39;s spam </label></li><li><label><input type="radio" name="report_type" id="report_type_harassment" value="harassment" required="required" /> It&#39;s abusive or harmful </label></li><li><label><input type="radio" name="report_type" id="report_type_inappropriate_content" value="inappropriate_content" required="required" /> It contains inappropriate content </label></li></ul></div><div class="reportForm_submitButtonContainer"><button name="button" type="submit" class="btn btn-primary reportForm_submitButton"><i class="fa fa-send"></i> Submit</button></div></form></div></div></div></div><script id="js-item" type="application/json">{ "url": "http://qiita.com/7shi/items/4408b76624067c17e933", "id": 219408, "uuid": "4408b76624067c17e933" }</script><script class="js-user" type="application/json">{&quot;id&quot;:32057,&quot;url_name&quot;:&quot;7shi&quot;,&quot;profile_image_url&quot;:&quot;https://qiita-image-store.s3.amazonaws.com/0/32057/profile-images/1473685823&quot;}</script><script language="JavaScript" src="//cdn.bigmining.com/private/js/qiita_bigmining.js" type="text/javascript"></script></div><footer class="footer"><div class="footer_inner"><div class="footer_container"><ul class="footer_links-left"><li class="footer_link"><a class="footer_copyright" href="http://increments.co.jp">© 2011-2017 Increments Inc.</a></li><li class="footer_link"><a href="http://qiita.com/terms">Terms</a></li><li class="footer_link"><a href="http://qiita.com/privacy">Privacy</a></li><li class="footer_link"><a href="http://help.qiita.com">Help</a></li><li class="footer_link"><a href="https://increments.zendesk.com/anonymous_requests/new">Contact</a></li></ul><ul class="footer_links-right"><li class="footer_link"><a href="http://qiita.com/about">About</a></li><li class="footer_link"><a href="/users">Users</a></li><li class="footer_link"><a href="/tags">Tags</a></li><li class="footer_link"><a href="http://blog.qiita.com">Blog</a></li><li class="footer_link"><a href="http://qiita.com/api/v2/docs">API</a></li><li class="footer_link"><a href="https://teams.qiita.com/">Team</a></li><li class="footer_link"><a href="http://kobito.qiita.com">Kobito</a></li><li class="footer_link"><a class="js-public-form-feedback-link" data-target=".js-feedback-form" data-toggle="modal" href=""><i class="fa fa-heart"></i> Feedback <i class="fa fa-caret-down"></i></a></li></ul></div></div></footer><div class="js-feedback-form modal fade feedbackForm"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><button name="button" type="submit" class="close" data-dismiss="modal">&times;</button><h4 class="modal-title">Feedback</h4></div><div class="modal-body"><form class="js-feedback-form-form" action="/feedbacks" accept-charset="UTF-8" method="post"><input name="utf8" type="hidden" value="&#x2713;" /><input type="hidden" name="authenticity_token" value="OdszU7qFwG8XIcigKg0wV79s6y1WQ3neYlUW6vACugtXWagLIav5JOjyfbxa+I4O3yvPnsGHIyleix8REQy0zQ==" /><input type="hidden" name="redirect_path" id="redirect_path" value="/7shi/items/4408b76624067c17e933" /><div class="form-group"><textarea name="feedback[message]" id="feedback_message" class="form-control js-feedback-form-text-area" placeholder="Please give us any feedback about Qiita." required="required" rows="5">
</textarea></div><div class="feedbackForm_submitButtonContainer"><button name="button" type="submit" class="btn btn-primary feedbackForm_submitButton"><i class="fa fa-send"></i> Submit</button><p class="feedbackForm_note">We don&#39;t reply to any feedback.<br />If you need help with Qiita, please send a support request from <a href="https://increments.zendesk.com/anonymous_requests/new">here</a>.</p></div><div style="position:fixed;top:-99999px;opacity:0.0001;"><input name="feedback[name]" type="text" /></div></form></div></div></div></div><script>// if (window.mixpanel instanceof Element) {
//   window.mixpanel = [];
// }
// (function(f,b){if(!b.__SV){var a,e,i,g;window.mixpanel=b;b._i=[];b.init=function(a,e,d){function f(b,h){var a=h.split(".");2==a.length&&(b=b[a[0]],h=a[1]);b[h]=function(){b.push([h].concat(Array.prototype.slice.call(arguments,0)))}}var c=b;"undefined"!==typeof d?c=b[d]=[]:d="mixpanel";c.people=c.people||[];c.toString=function(b){var a="mixpanel";"mixpanel"!==d&&(a+="."+d);b||(a+=" (stub)");return a};c.people.toString=function(){return c.toString(1)+".people (stub)"};i="disable track track_pageview track_links track_forms register register_once alias unregister identify name_tag set_config people.set people.set_once people.increment people.append people.track_charge people.clear_charges people.delete_user".split(" ");
// for(g=0;g<i.length;g++)f(c,i[g]);b._i.push([a,e,d])};b.__SV=1.2;a=f.createElement("script");a.type="text/javascript";a.async=!0;a.src="//cdn.mxpnl.com/libs/mixpanel-2.2.min.js";e=f.getElementsByTagName("script")[0];e.parentNode.insertBefore(a,e)}})(document,window.mixpanel||[]);</script><script src="http://cdn.qiita.com/assets/public-8c6201a66dc6db6f64a9017391c319bf.min.js"></script><script>
  (function () {
    var script = document.getElementsByTagName('script')[0];
    var load = function (src, id) {
      var el = document.createElement('script');
      el.async = true;
      el.src = src;
      el.id = id;
      script.parentNode.insertBefore(el, script);
    };
      // Optimizely
      load('//cdn.optimizely.com/js/52738645.js', 'optimizely-jssdk');
      // Google Analytics
      window._gaq = window._gaq || [];
      var isCareer = location.hostname.split('.')[0] == 'career';
      if (isCareer) {
        window._gaq.push(['_setAccount', 'UA-24675221-11']);
        window._gaq.push(['_setDomainName', 'qiita.com']);
      } else {
        window._gaq.push(['_setAccount', 'UA-24675221-1']);
      }
      window._gaq.push(['_setCustomVar', 1, 'logged_in', 'false', 2]);
      window._gaq.push(['_trackPageview']);
      var src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      load(src, 'google-analytics-jssdk');
    // Google Analytics - Universal Analytics
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-24675221-12', {
          
        });
        ga('set', 'dimension1', 'false');
        ga('set', 'dimension3', 'false');
      ga('require', 'displayfeatures');
      ga('set', 'forceSSL', true);
      ga('send', 'pageview');
    // Google Tag Manager
      (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
      new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
      })(window,document,'script','dataLayer','GTM-TBQWPN');
  })();
</script>
</body></html>