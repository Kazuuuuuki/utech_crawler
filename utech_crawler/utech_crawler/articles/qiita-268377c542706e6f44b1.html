<!DOCTYPE html><html xmlns:og="http://ogp.me/ns#"><head><meta charset="UTF-8" /><title>TensorFlowを使った為替(FX)のトレードシステムを作るチュートリアル  ～システムのセットアップからトレードまで～ - Qiita</title><meta content="width=device-width,initial-scale=1" name="viewport" /><meta content="機械学習ライブラリ「TensorFlow」と、オープンソースのシステムトレードフレームワーク「Jiji」を組み合わせて、機械学習を使った為替(FX)のトレードシステムを作るチュートリアルです。

システムのセットアップからはじめて、機械学習モデルの作成、トレーニング、それを使って実際にトレードを行うところまで、具体例を交えて解説します。


システム構成

次のようなシステムを作ります。




Jijiのバックテスト機能を使ってトレードデータを収集。これをTensor..." name="description" /><meta content="summary" name="twitter:card" /><meta content="@Qiita" name="twitter:site" /><meta content="jiji_platform" name="twitter:creator" /><meta content="TensorFlowを使った為替(FX)のトレードシステムを作るチュートリアル  ～システムのセットアップからトレードまで～ - Qiita" property="og:title" /><meta content="article" property="og:type" /><meta content="http://qiita.com/jiji_platform/items/268377c542706e6f44b1" property="og:url" /><meta content="http://cdn.qiita.com/assets/qiita-fb-2887e7b4aad86fd8c25cea84846f2236.png" property="og:image" /><meta content="[機械学習ライブラリ「TensorFlow」](https://www.tensorflow.org)と、[オープンソースのシステムトレードフレームワーク「Jiji」](http://jiji2.unageanu.net/)を組み合わ..." property="og:description" /><meta content="Qiita" property="og:site_name" /><meta content="564524038" property="fb:admins" /><link rel="shortcut icon" type="image/x-icon" href="http://cdn.qiita.com/assets/favicons/public/production-4ff10c1e1e2b5fcb353ff9cafdd56c70.ico" /><link rel="apple-touch-icon" type="image/png" href="http://cdn.qiita.com/assets/favicons/public/apple-touch-icon-f9a6afad761ec2306e10db2736187c8b.png" /><link href="/opensearch.xml" rel="search" title="Qiita" type="application/opensearchdescription+xml" /><link rel="stylesheet" media="all" href="http://cdn.qiita.com/assets/public-81dd63f4385f99b52aeab91266068ebd.min.css" /><meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="BNhoH/5RlN8uNUO71R8j2ZZ5xHH0y6DlUsiXphGVdUlb6WEJ9+T7jl5IJzE82ttN2owx2v0HdFw8KGJ19X32Zw==" /></head><body class="without-js" id=""><noscript><iframe height="0" src="//www.googletagmanager.com/ns.html?id=GTM-TBQWPN" style="display:none;visibility:hidden" width="0"></iframe></noscript><script>
  document.body.className = document.body.className.replace('without-js', '') + ' with-js';
  window.Qiita = {"asset_host":"cdn.qiita.com","TLD":"com","controller_path":"public/items","controller_action":"public/items#show","controller":"items","action":"show","action_path":"public/items#show","env":"production","flash":{},"is_landing_page":false,"is_team_page":false,"request_parameters":{"controller":"public/items","action":"show","user_id":"jiji_platform","type":"items","id":"268377c542706e6f44b1"},"root_domain":"qiita.com","variant":null,"config":{"mixpanel":{"career":"dd35af27e959781713d63fd7ca898a8d","per_team":"c0a2116368b33b44b5029ebd2cc9b094","public":"be87616606b0e26a87689099aab2c4e5","team":"b7c0342acba2dbc8742484d98788efb3"},"default_locale":"ja","locale":"en"},"team":null,"user":null,"GIT_BRANCH":null,"DEBUG":false};

</script>
<div class="headerContainer headerContainer-public" role="navigation"><div class="js-react-on-rails-component" data-component-name="HeaderContainer" data-props="{&quot;user&quot;:null,&quot;team&quot;:null,&quot;news&quot;:{&quot;type&quot;:&quot;News&quot;,&quot;content&quot;:&quot;ストックの他に「いいね」が追加されました&quot;,&quot;url&quot;:&quot;http://blog.qiita.com/post/153200849029/qiita-like-button&quot;},&quot;initial_unread_count&quot;:null,&quot;siteid_image&quot;:&quot;http://cdn.qiita.com/siteid-reverse.png&quot;,&quot;is_team_page&quot;:false,&quot;on_team_setting&quot;:false,&quot;show_post_menu&quot;:true,&quot;show_search_menu&quot;:true,&quot;is_fluid&quot;:false,&quot;locale&quot;:&quot;en&quot;}" data-trace="false" data-dom-id="HeaderContainer-react-component-d2a219b2-7051-422c-987a-a1f06022b692"></div>
    <div id="HeaderContainer-react-component-d2a219b2-7051-422c-987a-a1f06022b692"></div>
    
</div><div id="main"><script type="application/ld+json">{  "@context": "http://schema.org",  "@type": "BreadcrumbList",  "itemListElement": [    {      "@type": "ListItem",      "position": 1,      "item": {        "@id": "/",        "name": "Qiita"      }    },    {      "@type": "ListItem",      "position": 2,      "item": {        "@id": "/items",        "name": "Items"      }    },    {      "@type": "ListItem",      "position": 3,      "item": {        "@id": "/tags/%E6%A9%9F%E6%A2%B0%E5%AD%A6%E7%BF%92",        "name": "機械学習"      }    }  ]}</script><article itemscope="" itemtype="http://schema.org/Article"><div class="ArticleMainHeader "><div class="container"></div><div class="container"><div class="row s-flex-align-center"><div class="col-sm-9"><h1 class="ArticleMainHeader__title" itemprop="headline">TensorFlowを使った為替(FX)のトレードシステムを作るチュートリアル  ～システムのセットアップからトレードまで～</h1><ul class="TagList"><li class="TagList__item" data-count="1835"><a class="u-link-unstyled TagList__label" href="/tags/%E6%A9%9F%E6%A2%B0%E5%AD%A6%E7%BF%92"><img alt="機械学習" class="TagList__icon" src="https://s3-ap-northeast-1.amazonaws.com/qiita-tag-image/a94d4d239b3b0b83723d5b56c050ffc54b8593e7/medium.jpg?1394635775" /><span>機械学習</span></a></li><li class="TagList__item" data-count="6"><a class="u-link-unstyled TagList__label" href="/tags/%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E3%83%88%E3%83%AC%E3%83%BC%E3%83%89"><img alt="システムトレード" class="TagList__icon" src="//cdn.qiita.com/assets/icons/medium/missing-2e17009a0b32a6423572b0e6dc56727e.png" /><span>システムトレード</span></a></li><li class="TagList__item" data-count="786"><a class="u-link-unstyled TagList__label" href="/tags/TensorFlow"><img alt="TensorFlow" class="TagList__icon" src="https://s3-ap-northeast-1.amazonaws.com/qiita-tag-image/a35c51e3bff4af3c505656bda4abdef2e00684c8/medium.jpg?1447140205" /><span>TensorFlow</span></a></li><li class="TagList__item" data-count="3"><a class="u-link-unstyled TagList__label" href="/tags/jiji"><img alt="jiji" class="TagList__icon" src="//cdn.qiita.com/assets/icons/medium/missing-2e17009a0b32a6423572b0e6dc56727e.png" /><span>jiji</span></a></li></ul></div><div class="col-sm-3"><div class="itemsShowHeaderStock"><ul class="list-unstyled itemsShowHeaderStock_statusList"><li><div class="itemsShowHeaderStock_count stock"><span class="fa fa-thumbs-up"></span><span class="js-likecount">893</span></div><div class="itemsShowHeaderStock_countText">Like</div></li><li><div class="itemsShowHeaderStock_count" content="16 UserComments" itemprop="commentCount"><span class="fa fa-comment"></span>16</div><div class="itemsShowHeaderStock_countText">Comment</div></li></ul></div><div class="js-likebutton" data-props="{&quot;like_status&quot;:false,&quot;like_count&quot;:893,&quot;uuid&quot;:&quot;268377c542706e6f44b1&quot;,&quot;likable_type&quot;:&quot;Article&quot;,&quot;position&quot;:&quot;article-header&quot;}"></div><ul class="list-inline ArticleMainHeader__users"><li class="js-hovercard" data-hovercard-target-name="sliker-kiley"><a itemprop="url" href="/sliker-kiley"><img alt="sliker-kiley" class="thumb thumb--xs" src="https://qiita-image-store.s3.amazonaws.com/0/87567/profile-images/1473704134" /></a></li><li class="js-hovercard" data-hovercard-target-name="immmmmmmm"><a itemprop="url" href="/immmmmmmm"><img alt="immmmmmmm" class="thumb thumb--xs" src="https://qiita-image-store.s3.amazonaws.com/0/82303/profile-images/1473702402" /></a></li><li class="js-hovercard" data-hovercard-target-name="toyolab"><a itemprop="url" href="/toyolab"><img alt="toyolab" class="thumb thumb--xs" src="https://qiita-image-store.s3.amazonaws.com/0/131169/profile-images/1473718172" /></a></li><li class="js-hovercard" data-hovercard-target-name="Tamann17"><a itemprop="url" href="/Tamann17"><img alt="Tamann17" class="thumb thumb--xs" src="https://qiita-image-store.s3.amazonaws.com/0/41493/profile-images/1482496501" /></a></li><li class="js-hovercard" data-hovercard-target-name="high5"><a itemprop="url" href="/high5"><img alt="high5" class="thumb thumb--xs" src="https://qiita-image-store.s3.amazonaws.com/0/42885/profile-images/1473689327" /></a></li><li class="js-hovercard" data-hovercard-target-name="driller"><a itemprop="url" href="/driller"><img alt="driller" class="thumb thumb--xs" src="https://qiita-image-store.s3.amazonaws.com/0/22023/profile-images/1477644793" /></a></li><li class="js-hovercard" data-hovercard-target-name="mofoolog"><a itemprop="url" href="/mofoolog"><img alt="mofoolog" class="thumb thumb--xs" src="https://qiita-image-store.s3.amazonaws.com/0/73019/profile-images/1473699355" /></a></li><li class="js-hovercard" data-hovercard-target-name="danzig1972"><a itemprop="url" href="/danzig1972"><img alt="danzig1972" class="thumb thumb--xs" src="https://qiita-image-store.s3.amazonaws.com/0/100755/profile-images/1473708196" /></a></li><li class="js-hovercard" data-hovercard-target-name="MakitoTashiro"><a itemprop="url" href="/MakitoTashiro"><img alt="MakitoTashiro" class="thumb thumb--xs" src="https://qiita-image-store.s3.amazonaws.com/0/66608/profile-images/1473697262" /></a></li><li class="js-hovercard" data-hovercard-target-name="nabeen"><a itemprop="url" href="/nabeen"><img alt="nabeen" class="thumb thumb--xs" src="https://qiita-image-store.s3.amazonaws.com/0/44007/profile-images/1474941720" /></a></li><li><a href="/jiji_platform/items/268377c542706e6f44b1/likers"><span class="fa fa-ellipsis-h"></span></a></li></ul></div></div></div></div><div class="ArticleAsideHeader"><div class="container"><div class="u-flex u-space-between"><div class="u-flex u-flex-wrap"><div class="u-flex u-align-center s-pdv-5 u-flex-wrap"><div class="ArticleAsideHeader__author"><a href="/jiji_platform"><img class="thumb thumb--xs" src="https://qiita-image-store.s3.amazonaws.com/0/137010/profile-images/1473720139" alt="1473720139" /></a> <a class="u-link-unstyled" href="/jiji_platform">jiji_platform</a> </div><div class="ArticleAsideHeader__date"><meta content="2016-08-16T16:56:59+09:00" itemprop="datePublished" /><span data-toggle="tooltip" title="posted at 2016-08-16">Edited at <time datetime="2016-08-23T07:45:12+09:00" itemprop="dateModified">2016-08-23</time></span></div></div><div class="u-flex u-align-center s-pdv-5 mobile-hidden"><div class="ArticleAsideHeader__revision"> <a data-toggle="tooltip" title="Revisions" href="/jiji_platform/items/268377c542706e6f44b1/revisions"><span class="fa fa-history"></span></a><span class="ArticleAsideHeader__revisionCount">4</span></div></div><div class="u-flex u-align-center s-pdv-5 mobile-hidden"></div></div><div class="u-flex u-align-center s-flex-justiry-between s-pdv-5 u-shrink-0"><div class="ArticleAsideHeader__stock"><div class="js-stockbutton" data-position="top" data-props="{&quot;stock_status&quot;:false}"></div></div><div class="dropdown"><a class="dropdown-toggle" data-toggle="dropdown" href="#"><span class="fa fa-ellipsis-h fa-lg"></span></a><ul class="dropdown-menu dropdown-menu-right"><li class="dropdown__item--mobile"><a href="/jiji_platform/items/268377c542706e6f44b1/revisions"><span class="fa fa-fw fa-history"></span> Revisions<span>(4)</span></a></li><li><a href="/jiji_platform/items/268377c542706e6f44b1.md"><span class="fa fa-fw fa-file-text-o"></span> Show article as Markdown</a></li><li><a data-target=".js-report-form" data-toggle="modal" href="#"><span class="fa fa-fw fa-flag"></span> Report article</a></li></ul></div></div></div></div></div><div class="container"><div class="row" id="article-body-wrapper"><div class="col-sm-9"><section class="markdownContent markdownContent-headingEnabled js-task-list-container clearfix position-relative" id="item-268377c542706e6f44b1" itemprop="articleBody"><p><a href="https://www.tensorflow.org" rel="nofollow noopener" target="_blank">機械学習ライブラリ「TensorFlow」</a>と、<a href="http://jiji2.unageanu.net/" rel="nofollow noopener" target="_blank">オープンソースのシステムトレードフレームワーク「Jiji」</a>を組み合わせて、<b>機械学習を使った為替(FX)のトレードシステム</b>を作るチュートリアルです。</p>

<p>システムのセットアップからはじめて、機械学習モデルの作成、トレーニング、それを使って実際にトレードを行うところまで、具体例を交えて解説します。</p>

<h1>
<span id="システム構成" class="fragment"></span><a href="#%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E6%A7%8B%E6%88%90"><i class="fa fa-link"></i></a>システム構成</h1>

<p>次のようなシステムを作ります。</p>

<p><a href="https://qiita-image-store.s3.amazonaws.com/0/137010/8808e9ff-9cd3-7ed7-3d05-5d226b34db5e.png" target="_blank" rel="nofollow noopener"><img src="https://qiita-image-store.s3.amazonaws.com/0/137010/8808e9ff-9cd3-7ed7-3d05-5d226b34db5e.png" alt="システム構成.png"></a></p>

<ul>
<li>Jijiのバックテスト機能を使ってトレードデータを収集。これをTensorFlowに入力してモデルをトレーニングします。

<ul>
<li>予測する内容については後述。</li>
</ul>
</li>
<li>訓練したモデルを使って予測結果を返すREST APIを作り、トレード時にJijiから呼び出して使います。</li>
<li>レート情報の取得やトレードには、<a href="http://www.oanda.jp/api/" rel="nofollow noopener" target="_blank">OANDA REST API</a> を利用</li>
<li>トレード状況の確認やアルゴリズムの管理は、ブラウザ or スマホアプリで

<ul>
<li>外出先でも状況の確認や、緊急メンテナンスが行えるようにします。</li>
</ul>
</li>
<li>システムは、Docker上に構築します。

<ul>
<li>AWSなどDockerをサポートしているクラウド環境でも、同様の手順で構築できるはずです。</li>
<li>確認はローカルマシンにインストールしたDockerで行っています。</li>
</ul>
</li>
</ul>

<h1>
<span id="tensorflowで予測する内容" class="fragment"></span><a href="#tensorflow%E3%81%A7%E4%BA%88%E6%B8%AC%E3%81%99%E3%82%8B%E5%86%85%E5%AE%B9"><i class="fa fa-link"></i></a>TensorFlowで予測する内容</h1>

<p>機械学習の使い方はいろいろ考えられると思いますが、このチュートリアルでは<b>「トレード時の各種指標から損益を予測し、マイナスになるトレードをフィルタリングする」</b>形での利用を試してみます。</p>

<ul>
<li>移動平均の交差ルールでトレードするシンプルなアルゴリズムを作成し、トレード時の各種指標を記録。</li>
<li>記録した指標とトレードの損益データをTensorFlowに入力して学習させ、「プラス or マイナス」を予測させます。</li>
<li>予測結果が「プラス」となった場合のみトレードを行うことで、損益を改善します。</li>
</ul>

<h1>
<span id="チュートリアル" class="fragment"></span><a href="#%E3%83%81%E3%83%A5%E3%83%BC%E3%83%88%E3%83%AA%E3%82%A2%E3%83%AB"><i class="fa fa-link"></i></a>チュートリアル</h1>

<p>順に解説していきます。</p>

<h2>
<span id="0-前提条件" class="fragment"></span><a href="#0-%E5%89%8D%E6%8F%90%E6%9D%A1%E4%BB%B6"><i class="fa fa-link"></i></a>0. 前提条件</h2>

<p>docker, docker-compose を使用します。事前にインストールをお願いします。<br>
手順の確認は以下の環境で行っています。</p>

<ul>
<li>CentOS 7</li>
<li>Docker 1.10.2</li>
<li>Docker Compose 1.6.2</li>
</ul>

<h2>
<span id="1-oanda-japan-アカウントの用意" class="fragment"></span><a href="#1-oanda-japan-%E3%82%A2%E3%82%AB%E3%82%A6%E3%83%B3%E3%83%88%E3%81%AE%E7%94%A8%E6%84%8F"><i class="fa fa-link"></i></a>1. OANDA Japan アカウントの用意</h2>

<p><a href="http://www.oanda.jp/api/" rel="nofollow noopener" target="_blank">OANDA REST API</a> を利用するため、OANDA のアカウントが必要になります。<br>
とりあえず試すには、無料のデモアカウントが手軽で便利です。<a href="http://www.oanda.jp" rel="nofollow noopener" target="_blank">アカウント作成はこちらから。</a></p>

<p>アカウントを作成したら、<a href="http://jiji2.unageanu.net/install/010000_prepare_account.html" rel="nofollow noopener" target="_blank">こちら</a>の手順にしたがってパーソナルアクセストークンを発行してください。トークンはJijiの初期設定で使用します。</p>

<h2>
<span id="2-システムのセットアップ" class="fragment"></span><a href="#2-%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E3%81%AE%E3%82%BB%E3%83%83%E3%83%88%E3%82%A2%E3%83%83%E3%83%97"><i class="fa fa-link"></i></a>2. システムのセットアップ</h2>

<p><code>docker-compose.yml</code> など必要な設定ファイル/ソースコード一式は <a href="https://github.com/unageanu/jiji-with-tensorflow-example" rel="nofollow noopener" target="_blank">GitHub</a> に置いています。まずはこれをダウンロード。</p>

<div class="code-frame" data-lang="shell-session"><div class="highlight"><pre>
<span class="go">$ git clone https://github.com/unageanu/jiji-with-tensorflow-example.git</span>
<span class="go">$ cd jiji-with-tensorflow-example</span>
</pre></div></div>

<h3>
<span id="サーバー証明書の準備" class="fragment"></span><a href="#%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC%E8%A8%BC%E6%98%8E%E6%9B%B8%E3%81%AE%E6%BA%96%E5%82%99"><i class="fa fa-link"></i></a>サーバー証明書の準備</h3>

<p>通信内容を暗号化するため、TLSを使用します。<br>
ドメインがある場合は<a href="https://letsencrypt.org/" rel="nofollow noopener" target="_blank">Let’s Encrypt</a> を利用するのが良いと思いますが、ローカルマシンなのでとりあえず自己署名証明書を使います。</p>

<div class="code-frame" data-lang="shell-session"><div class="highlight"><pre>
<span class="go">$ mkdir -p ./cert</span>
<span class="go">$ cd ./cert</span>

<span class="go"># 秘密鍵を生成</span>
<span class="go">$ openssl genrsa 2048 &gt; server.key</span>
<span class="go"># CSRを作成</span>
<span class="go">$ openssl req -new -key server.key &gt; server.csr</span>
<span class="go"># サーバー証明書を作成</span>
<span class="go">$ openssl x509 -sha256 -days 365 -req -signkey server.key &lt; server.csr &gt; server.crt</span>
<span class="go"># アクセス権を制限</span>
<span class="go">$ sudo chown root.root server.key</span>
<span class="go">$ sudo chmod 600 server.key</span>

<span class="go">$ cd ../</span>
</pre></div></div>

<h3>
<span id="設定ファイルの編集" class="fragment"></span><a href="#%E8%A8%AD%E5%AE%9A%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%AE%E7%B7%A8%E9%9B%86"><i class="fa fa-link"></i></a>設定ファイルの編集</h3>

<p>次に <code>./docker-compose.yml</code> を開き、Jijiのシークレットキーを適当に変更します。</p>

<div class="code-frame" data-lang="yaml"><div class="highlight"><pre>
<span class="l-Scalar-Plain">jiji</span><span class="p-Indicator">:</span>
  <span class="c1"># 略</span>
  <span class="l-Scalar-Plain">environment</span><span class="p-Indicator">:</span>
    <span class="c1"># サーバー内部で秘匿データの暗号化に使うキー</span>
    <span class="c1"># 必ず変更して使用してください。</span>
    <span class="c1"># UIから入力を求められることはないので、任意の長い文字列を使用すればOKです。</span>
    <span class="l-Scalar-Plain">USER_SECRET</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">d41d8cd98f00b204e9800998ecf8427e</span>
</pre></div></div>

<h3>
<span id="システムの起動" class="fragment"></span><a href="#%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E3%81%AE%E8%B5%B7%E5%8B%95"><i class="fa fa-link"></i></a>システムの起動</h3>

<p>以上で準備は完了。<code>docker-compose</code> でシステムを起動します。</p>

<div class="code-frame" data-lang="shell-session"><div class="highlight"><pre>
<span class="go">$ docker-compose up -d</span>
</pre></div></div>

<p><code>jiji_example__nginx</code>, <code>jiji_example__jiji</code>, <code>jiji_example__mongodb</code>, <code>jiji_example__tensorflow</code> の各コンテナが起動していればOK。</p>

<div class="code-frame" data-lang="shell-session"><div class="highlight"><pre>
<span class="go">$ docker ps -a</span>
<span class="go">CONTAINER ID        IMAGE                                         COMMAND                  CREATED             STATUS                      PORTS                                                        NAMES</span>
<span class="go">f083efd4ab5c        unageanu/jiji-nginx:latest                    "nginx -g 'daemon off"   8 seconds ago       Up 4 seconds                80/tcp, 0.0.0.0:10443-&gt;443/tcp                               jiji_example__nginx</span>
<span class="go">ac72354363c9        unageanu/jiji:latest                          "puma -C /app/jiji2/c"   10 seconds ago      Up 8 seconds                8080/tcp                                                     jiji_example__jiji</span>
<span class="go">8acc4e79e5cb        jijiwithtensorflowexample_tensorflow          "/run_jupyter.sh"        16 seconds ago      Up 10 seconds               8888/tcp, 0.0.0.0:15000-&gt;5000/tcp, 0.0.0.0:16006-&gt;6006/tcp   jiji_example__tensorflow</span>
<span class="go">3e02f8b562f1        mongo:3.0.7                                   "/entrypoint.sh mongo"   20 seconds ago      Up 16 seconds               0.0.0.0:37017-&gt;27017/tcp                                     jiji_example__mongodb</span>
</pre></div></div>

<h3>
<span id="jijiの初期設定" class="fragment"></span><a href="#jiji%E3%81%AE%E5%88%9D%E6%9C%9F%E8%A8%AD%E5%AE%9A"><i class="fa fa-link"></i></a>Jijiの初期設定</h3>

<p>以下のURLをブラウザで開くと、Jijiの初期設定画面が開きます。</p>

<div class="code-frame" data-lang="text"><div class="highlight"><pre>
https://&lt;インストール先ホスト&gt;:10443
</pre></div></div>

<p><a href="https://qiita-image-store.s3.amazonaws.com/0/137010/bd21215c-6b5b-26fe-a960-7dd6344576c2.png" target="_blank" rel="nofollow noopener"><img src="https://qiita-image-store.s3.amazonaws.com/0/137010/bd21215c-6b5b-26fe-a960-7dd6344576c2.png" alt="初期設定.png"></a></p>

<p>画面が表示されたら、<a href="http://jiji2.unageanu.net/install/030000_initial_setting.html" rel="nofollow noopener" target="_blank">こちらの手順</a>に従って初期設定を行ってください。</p>

<h2>
<span id="3-トレードデータの収集" class="fragment"></span><a href="#3-%E3%83%88%E3%83%AC%E3%83%BC%E3%83%89%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E5%8F%8E%E9%9B%86"><i class="fa fa-link"></i></a>3. トレードデータの収集</h2>

<p>Jijiのセットアップが完了したら、トレードデータの収集に移ります。<br>
移動平均でトレードするアルゴリズムを作り、Jijiのバックテスト機能を使って実行。このとき、「トレード損益+トレード時の各種指標」をMongoDBに記録し、これをTensorFlowの訓練データとして使います。</p>

<h3>
<span id="トレードアルゴリズムエージェントを作る" class="fragment"></span><a href="#%E3%83%88%E3%83%AC%E3%83%BC%E3%83%89%E3%82%A2%E3%83%AB%E3%82%B4%E3%83%AA%E3%82%BA%E3%83%A0%E3%82%A8%E3%83%BC%E3%82%B8%E3%82%A7%E3%83%B3%E3%83%88%E3%82%92%E4%BD%9C%E3%82%8B"><i class="fa fa-link"></i></a>トレードアルゴリズム(エージェント)を作る</h3>

<p>ソースコードは<a href="https://github.com/unageanu/jiji-with-tensorflow-example/blob/master/agents/tensorflow_sample_agent.rb" rel="nofollow noopener" target="_blank">こちら</a>にあります。主要なクラスを簡単に解説しておきます。</p>

<h4>
<span id="tradeandsignals" class="fragment"></span><a href="#tradeandsignals"><i class="fa fa-link"></i></a>TradeAndSignals</h4>

<ul>
<li>トレード結果とトレード時の各種指標を格納するクラスです。</li>
<li>これをTensorFlowに入力して、トレーニングを行います。</li>
<li>指標には、移動平均の傾き/乖離率、RSI、MACDの乖離を使うようにしました。</li>
</ul>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre>
<span class="c1"># トレード結果とトレード時の各種指標。</span>
<span class="c1"># MongoDBに格納してTensorFlowの学習データにする</span>
<span class="k">class</span> <span class="nc">TradeAndSignals</span>

  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>

  <span class="n">store_in</span> <span class="ss">collection</span><span class="p">:</span> <span class="s1">'tensorflow_example_trade_and_signals'</span>

  <span class="n">field</span> <span class="ss">:macd_difference</span><span class="p">,</span>    <span class="ss">type</span><span class="p">:</span> <span class="nb">Float</span> <span class="c1"># macd - macd_signal</span>

  <span class="n">field</span> <span class="ss">:rsi</span><span class="p">,</span>                <span class="ss">type</span><span class="p">:</span> <span class="nb">Float</span>

  <span class="n">field</span> <span class="ss">:slope_10</span><span class="p">,</span>           <span class="ss">type</span><span class="p">:</span> <span class="nb">Float</span> <span class="c1"># 10日移動平均線の傾き</span>
  <span class="n">field</span> <span class="ss">:slope_25</span><span class="p">,</span>           <span class="ss">type</span><span class="p">:</span> <span class="nb">Float</span> <span class="c1"># 25日移動平均線の傾き</span>
  <span class="n">field</span> <span class="ss">:slope_50</span><span class="p">,</span>           <span class="ss">type</span><span class="p">:</span> <span class="nb">Float</span> <span class="c1"># 50日移動平均線の傾き</span>

  <span class="n">field</span> <span class="ss">:ma_10_estrangement</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">Float</span> <span class="c1"># 10日移動平均からの乖離率</span>
  <span class="n">field</span> <span class="ss">:ma_25_estrangement</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">Float</span>
  <span class="n">field</span> <span class="ss">:ma_50_estrangement</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">Float</span>

  <span class="n">field</span> <span class="ss">:profit_or_loss</span><span class="p">,</span>     <span class="ss">type</span><span class="p">:</span> <span class="nb">Float</span>
  <span class="n">field</span> <span class="ss">:sell_or_buy</span><span class="p">,</span>        <span class="ss">type</span><span class="p">:</span> <span class="no">Symbol</span>
  <span class="n">field</span> <span class="ss">:entered_at</span><span class="p">,</span>         <span class="ss">type</span><span class="p">:</span> <span class="no">Time</span>
  <span class="n">field</span> <span class="ss">:exited_at</span><span class="p">,</span>          <span class="ss">type</span><span class="p">:</span> <span class="no">Time</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">create_from</span><span class="p">(</span> <span class="n">signal_data</span><span class="p">,</span> <span class="n">position</span> <span class="p">)</span>
    <span class="no">TradeAndSignals</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span> <span class="o">|</span><span class="n">ts</span><span class="o">|</span>
      <span class="n">signal_data</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">pair</span><span class="o">|</span>
        <span class="k">next</span> <span class="k">if</span> <span class="n">pair</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">==</span> <span class="ss">:ma5</span><span class="o">||</span> <span class="n">pair</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">==</span> <span class="ss">:ma10</span>
        <span class="n">ts</span><span class="o">.</span><span class="n">send</span><span class="p">(</span> <span class="s2">"</span><span class="si">#{</span><span class="n">pair</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="si">}</span><span class="s2">="</span><span class="o">.</span><span class="n">to_sym</span><span class="p">,</span> <span class="n">pair</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="p">)</span>
      <span class="k">end</span>
      <span class="n">ts</span><span class="o">.</span><span class="n">profit_or_loss</span> <span class="o">=</span> <span class="n">position</span><span class="o">.</span><span class="n">profit_or_loss</span>
      <span class="n">ts</span><span class="o">.</span><span class="n">sell_or_buy</span>    <span class="o">=</span> <span class="n">position</span><span class="o">.</span><span class="n">sell_or_buy</span>
      <span class="n">ts</span><span class="o">.</span><span class="n">entered_at</span>     <span class="o">=</span> <span class="n">position</span><span class="o">.</span><span class="n">entered_at</span>
      <span class="n">ts</span><span class="o">.</span><span class="n">exited_at</span>      <span class="o">=</span> <span class="n">position</span><span class="o">.</span><span class="n">exited_at</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>

<h4>
<span id="signalcalculator" class="fragment"></span><a href="#signalcalculator"><i class="fa fa-link"></i></a>SignalCalculator</h4>

<ul>
<li>シグナルを計算するクラス</li>
<li>Jijiに標準添付されている <code>Signals</code> ライブラリを利用してRSIや移動平均を計算します。</li>
</ul>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre>
<span class="c1"># シグナルを計算するクラス</span>
<span class="k">class</span> <span class="nc">SignalCalculator</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">broker</span><span class="p">)</span>
    <span class="vi">@broker</span> <span class="o">=</span> <span class="n">broker</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">next_tick</span><span class="p">(</span><span class="n">tick</span><span class="p">)</span>
    <span class="n">prepare_signals</span><span class="p">(</span><span class="n">tick</span><span class="p">)</span> <span class="k">unless</span> <span class="vi">@macd</span>
    <span class="n">calculate_signals</span><span class="p">(</span><span class="n">tick</span><span class="o">[</span><span class="ss">:USDJPY</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">calculate_signals</span><span class="p">(</span><span class="n">tick</span><span class="p">)</span>
    <span class="n">price</span> <span class="o">=</span> <span class="n">tick</span><span class="o">.</span><span class="n">bid</span>
    <span class="n">macd</span> <span class="o">=</span> <span class="vi">@macd</span><span class="o">.</span><span class="n">next_data</span><span class="p">(</span><span class="n">price</span><span class="p">)</span>
    <span class="n">ma5</span>  <span class="o">=</span> <span class="vi">@ma5</span><span class="o">.</span><span class="n">next_data</span><span class="p">(</span><span class="n">price</span><span class="p">)</span>
    <span class="n">ma10</span> <span class="o">=</span> <span class="vi">@ma10</span><span class="o">.</span><span class="n">next_data</span><span class="p">(</span><span class="n">price</span><span class="p">)</span>
    <span class="n">ma25</span> <span class="o">=</span> <span class="vi">@ma25</span><span class="o">.</span><span class="n">next_data</span><span class="p">(</span><span class="n">price</span><span class="p">)</span>
    <span class="n">ma50</span> <span class="o">=</span> <span class="vi">@ma50</span><span class="o">.</span><span class="n">next_data</span><span class="p">(</span><span class="n">price</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="ss">ma5</span><span class="p">:</span>  <span class="n">ma5</span><span class="p">,</span>
      <span class="ss">ma10</span><span class="p">:</span> <span class="n">ma10</span><span class="p">,</span>
      <span class="ss">macd_difference</span><span class="p">:</span> <span class="n">macd</span> <span class="p">?</span> <span class="n">macd</span><span class="o">[</span><span class="ss">:macd</span><span class="o">]</span> <span class="o">-</span> <span class="n">macd</span><span class="o">[</span><span class="ss">:signal</span><span class="o">]</span> <span class="p">:</span> <span class="kp">nil</span><span class="p">,</span>
      <span class="ss">rsi</span><span class="p">:</span>  <span class="vi">@rsi</span><span class="o">.</span><span class="n">next_data</span><span class="p">(</span><span class="n">price</span><span class="p">),</span>
      <span class="ss">slope_10</span><span class="p">:</span> <span class="n">ma10</span> <span class="p">?</span> <span class="vi">@ma10v</span><span class="o">.</span><span class="n">next_data</span><span class="p">(</span><span class="n">ma10</span><span class="p">)</span> <span class="p">:</span> <span class="kp">nil</span><span class="p">,</span>
      <span class="ss">slope_25</span><span class="p">:</span> <span class="n">ma25</span> <span class="p">?</span> <span class="vi">@ma25v</span><span class="o">.</span><span class="n">next_data</span><span class="p">(</span><span class="n">ma25</span><span class="p">)</span> <span class="p">:</span> <span class="kp">nil</span><span class="p">,</span>
      <span class="ss">slope_50</span><span class="p">:</span> <span class="n">ma50</span> <span class="p">?</span> <span class="vi">@ma50v</span><span class="o">.</span><span class="n">next_data</span><span class="p">(</span><span class="n">ma50</span><span class="p">)</span> <span class="p">:</span> <span class="kp">nil</span><span class="p">,</span>
      <span class="ss">ma_10_estrangement</span><span class="p">:</span> <span class="n">ma10</span> <span class="p">?</span> <span class="n">calculate_estrangement</span><span class="p">(</span><span class="n">price</span><span class="p">,</span> <span class="n">ma10</span><span class="p">)</span> <span class="p">:</span> <span class="kp">nil</span><span class="p">,</span>
      <span class="ss">ma_25_estrangement</span><span class="p">:</span> <span class="n">ma25</span> <span class="p">?</span> <span class="n">calculate_estrangement</span><span class="p">(</span><span class="n">price</span><span class="p">,</span> <span class="n">ma25</span><span class="p">)</span> <span class="p">:</span> <span class="kp">nil</span><span class="p">,</span>
      <span class="ss">ma_50_estrangement</span><span class="p">:</span> <span class="n">ma50</span> <span class="p">?</span> <span class="n">calculate_estrangement</span><span class="p">(</span><span class="n">price</span><span class="p">,</span> <span class="n">ma50</span><span class="p">)</span> <span class="p">:</span> <span class="kp">nil</span>
    <span class="p">}</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">prepare_signals</span><span class="p">(</span><span class="n">tick</span><span class="p">)</span>
    <span class="n">create_signals</span>
    <span class="n">retrieve_rates</span><span class="p">(</span><span class="n">tick</span><span class="o">.</span><span class="n">timestamp</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">rate</span><span class="o">|</span>
      <span class="n">calculate_signals</span><span class="p">(</span><span class="n">rate</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create_signals</span>
    <span class="vi">@macd</span>  <span class="o">=</span> <span class="no">Signals</span><span class="o">::</span><span class="no">MACD</span><span class="o">.</span><span class="n">new</span>
    <span class="vi">@ma5</span>   <span class="o">=</span> <span class="no">Signals</span><span class="o">::</span><span class="no">MovingAverage</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="vi">@ma10</span>  <span class="o">=</span> <span class="no">Signals</span><span class="o">::</span><span class="no">MovingAverage</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
    <span class="vi">@ma25</span>  <span class="o">=</span> <span class="no">Signals</span><span class="o">::</span><span class="no">MovingAverage</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span>
    <span class="vi">@ma50</span>  <span class="o">=</span> <span class="no">Signals</span><span class="o">::</span><span class="no">MovingAverage</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
    <span class="vi">@ma5v</span>  <span class="o">=</span> <span class="no">Signals</span><span class="o">::</span><span class="no">Vector</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="vi">@ma10v</span> <span class="o">=</span> <span class="no">Signals</span><span class="o">::</span><span class="no">Vector</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
    <span class="vi">@ma25v</span> <span class="o">=</span> <span class="no">Signals</span><span class="o">::</span><span class="no">Vector</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span>
    <span class="vi">@ma50v</span> <span class="o">=</span> <span class="no">Signals</span><span class="o">::</span><span class="no">Vector</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
    <span class="vi">@rsi</span>   <span class="o">=</span> <span class="no">Signals</span><span class="o">::</span><span class="no">RSI</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">retrieve_rates</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
    <span class="vi">@broker</span><span class="o">.</span><span class="n">retrieve_rates</span><span class="p">(</span><span class="ss">:USDJPY</span><span class="p">,</span> <span class="ss">:one_day</span><span class="p">,</span> <span class="n">time</span> <span class="o">-</span> <span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">24</span><span class="o">*</span><span class="mi">60</span><span class="p">,</span> <span class="n">time</span> <span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">calculate_estrangement</span><span class="p">(</span><span class="n">price</span><span class="p">,</span> <span class="n">ma</span><span class="p">)</span>
    <span class="p">((</span><span class="no">BigDecimal</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">price</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">-</span> <span class="n">ma</span><span class="p">)</span> <span class="o">/</span> <span class="n">ma</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">to_f</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre></div></div>

<h4>
<span id="tensorflowsampleagent" class="fragment"></span><a href="#tensorflowsampleagent"><i class="fa fa-link"></i></a>TensorFlowSampleAgent</h4>

<ul>
<li>トレードアルゴリズムの本体。</li>
<li>
<code>SignalCalculator</code> で計算した5日移動平均と10日移動平均のクロスでトレードを行います。

<ul>
<li>5日移動平均 &gt; 10日移動平均 の場合、買</li>
<li>5日移動平均 &lt; 10日移動平均 の場合、売</li>
</ul>
</li>
<li>プロパティで、動作モードを次の3つから選べるようにしています。

<ul>
<li>
<code>collect</code> : トレードデータ収集時に使います。ポジションの決済時に <code>TradeAndSignals</code> をMongoDBに保存します。</li>
<li>
<code>trade</code> : TensorFlowでの予測を使用してトレードを行うモードです。訓練後の評価で使います。</li>
<li>
<code>test</code> : TensorFlowでの予測を使用せずトレードを行うモード。<code>trade</code> モードの結果を評価する際に比較用に使用します。</li>
</ul>
</li>
</ul>

<div class="code-frame" data-lang="rb"><div class="highlight"><pre>
<span class="c1"># TensorFlowと連携してトレードするエージェントのサンプル</span>
<span class="k">class</span> <span class="nc">TensorFlowSampleAgent</span>

  <span class="kp">include</span> <span class="no">Jiji</span><span class="o">::</span><span class="no">Model</span><span class="o">::</span><span class="no">Agents</span><span class="o">::</span><span class="no">Agent</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">description</span>
    <span class="o">&lt;&lt;-</span><span class="no">STR</span>
<span class="sh">TensorFlowと連携してトレードするエージェントのサンプル</span>
<span class="no">      STR</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">property_infos</span>
    <span class="o">[</span>
      <span class="no">Property</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">'exec_mode'</span><span class="p">,</span>
        <span class="s1">'動作モード("collect" or "trade" or "test")'</span><span class="p">,</span> <span class="s2">"collect"</span><span class="p">)</span>
    <span class="o">]</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">post_create</span>
    <span class="vi">@calculator</span> <span class="o">=</span> <span class="no">SignalCalculator</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">broker</span><span class="p">)</span>
    <span class="vi">@cross</span> <span class="o">=</span> <span class="no">Cross</span><span class="o">.</span><span class="n">new</span>
    <span class="vi">@mode</span>  <span class="o">=</span> <span class="n">create_mode</span><span class="p">(</span><span class="vi">@exec_mode</span><span class="p">)</span>

    <span class="vi">@graph</span> <span class="o">=</span> <span class="n">graph_factory</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="s1">'移動平均'</span><span class="p">,</span>
      <span class="ss">:rate</span><span class="p">,</span> <span class="ss">:last</span><span class="p">,</span> <span class="o">[</span><span class="s1">'#FF6633'</span><span class="p">,</span> <span class="s1">'#FFAA22'</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="c1"># 次のレートを受け取る</span>
  <span class="k">def</span> <span class="nf">next_tick</span><span class="p">(</span><span class="n">tick</span><span class="p">)</span>
    <span class="n">date</span> <span class="o">=</span> <span class="n">tick</span><span class="o">.</span><span class="n">timestamp</span><span class="o">.</span><span class="n">to_date</span>
    <span class="k">return</span> <span class="k">if</span> <span class="o">!</span><span class="vi">@current_date</span><span class="o">.</span><span class="n">nil?</span> <span class="o">&amp;&amp;</span> <span class="vi">@current_date</span> <span class="o">==</span> <span class="n">date</span>
    <span class="vi">@current_date</span> <span class="o">=</span> <span class="n">date</span>

    <span class="n">signal</span> <span class="o">=</span> <span class="vi">@calculator</span><span class="o">.</span><span class="n">next_tick</span><span class="p">(</span><span class="n">tick</span><span class="p">)</span>
    <span class="vi">@cross</span><span class="o">.</span><span class="n">next_data</span><span class="p">(</span><span class="n">signal</span><span class="o">[</span><span class="ss">:ma5</span><span class="o">]</span><span class="p">,</span> <span class="n">signal</span><span class="o">[</span><span class="ss">:ma10</span><span class="o">]</span><span class="p">)</span>

    <span class="vi">@graph</span> <span class="o">&lt;&lt;</span> <span class="o">[</span><span class="n">signal</span><span class="o">[</span><span class="ss">:ma5</span><span class="o">]</span><span class="p">,</span> <span class="n">signal</span><span class="o">[</span><span class="ss">:ma10</span><span class="o">]]</span>
    <span class="n">do_trade</span><span class="p">(</span><span class="n">signal</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">do_trade</span><span class="p">(</span><span class="n">signal</span><span class="p">)</span>
    <span class="c1"># 5日移動平均と10日移動平均のクロスでトレード</span>
    <span class="k">if</span> <span class="vi">@cross</span><span class="o">.</span><span class="n">cross_up?</span>
      <span class="n">buy</span><span class="p">(</span><span class="n">signal</span><span class="p">)</span>
    <span class="k">elsif</span> <span class="vi">@cross</span><span class="o">.</span><span class="n">cross_down?</span>
      <span class="n">sell</span><span class="p">(</span><span class="n">signal</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">buy</span><span class="p">(</span><span class="n">signal</span><span class="p">)</span>
    <span class="n">close_exist_positions</span>
    <span class="k">return</span> <span class="k">unless</span> <span class="vi">@mode</span><span class="o">.</span><span class="n">do_trade?</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="s2">"buy"</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">broker</span><span class="o">.</span><span class="n">buy</span><span class="p">(</span><span class="ss">:USDJPY</span><span class="p">,</span> <span class="mi">10000</span><span class="p">)</span>
    <span class="vi">@current_position</span> <span class="o">=</span> <span class="n">broker</span><span class="o">.</span><span class="n">positions</span><span class="o">[</span><span class="n">result</span><span class="o">.</span><span class="n">trade_opened</span><span class="o">.</span><span class="n">internal_id</span><span class="o">]</span>
    <span class="vi">@current_signal</span> <span class="o">=</span> <span class="n">signal</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">sell</span><span class="p">(</span><span class="n">signal</span><span class="p">)</span>
    <span class="n">close_exist_positions</span>
    <span class="k">return</span> <span class="k">unless</span> <span class="vi">@mode</span><span class="o">.</span><span class="n">do_trade?</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="s2">"sell"</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">broker</span><span class="o">.</span><span class="n">sell</span><span class="p">(</span><span class="ss">:USDJPY</span><span class="p">,</span> <span class="mi">10000</span><span class="p">)</span>
    <span class="vi">@current_position</span> <span class="o">=</span> <span class="n">broker</span><span class="o">.</span><span class="n">positions</span><span class="o">[</span><span class="n">result</span><span class="o">.</span><span class="n">trade_opened</span><span class="o">.</span><span class="n">internal_id</span><span class="o">]</span>
    <span class="vi">@current_signal</span> <span class="o">=</span> <span class="n">signal</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">close_exist_positions</span>
    <span class="k">return</span> <span class="k">unless</span> <span class="vi">@current_position</span>
    <span class="vi">@current_position</span><span class="o">.</span><span class="n">close</span>
    <span class="vi">@mode</span><span class="o">.</span><span class="n">after_position_closed</span><span class="p">(</span> <span class="vi">@current_signal</span><span class="p">,</span> <span class="vi">@current_position</span> <span class="p">)</span>
    <span class="vi">@current_position</span> <span class="o">=</span> <span class="kp">nil</span>
    <span class="vi">@current_signal</span> <span class="o">=</span> <span class="kp">nil</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create_mode</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
    <span class="k">case</span> <span class="n">mode</span>
    <span class="k">when</span> <span class="s1">'trade'</span> <span class="k">then</span>
      <span class="no">TradeMode</span><span class="o">.</span><span class="n">new</span>
    <span class="k">when</span> <span class="s1">'collect'</span> <span class="k">then</span>
      <span class="no">CollectMode</span><span class="o">.</span><span class="n">new</span>
    <span class="k">else</span>
      <span class="no">TestMode</span><span class="o">.</span><span class="n">new</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="c1"># データ収集モード</span>
  <span class="c1">#</span>
  <span class="c1"># TensorFlowでの予測を使用せずに移動平均のシグナルのみでトレードを行い、</span>
  <span class="c1"># 結果をDBに保存する</span>
  <span class="c1">#</span>
  <span class="k">class</span> <span class="nc">CollectMode</span>
    <span class="k">def</span> <span class="nf">do_trade?</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="n">sell_or_buy</span><span class="p">)</span>
      <span class="kp">true</span>
    <span class="k">end</span>
    <span class="c1"># ポジションが閉じられたら、トレード結果とシグナルをDBに登録する</span>
    <span class="k">def</span> <span class="nf">after_position_closed</span><span class="p">(</span> <span class="n">signal</span><span class="p">,</span> <span class="n">position</span> <span class="p">)</span>
      <span class="no">TradeAndSignals</span><span class="o">.</span><span class="n">create_from</span><span class="p">(</span> <span class="n">signal</span><span class="p">,</span> <span class="n">position</span><span class="p">)</span><span class="o">.</span><span class="n">save</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="c1"># テストモード</span>
  <span class="c1">#</span>
  <span class="c1"># TensorFlowでの予測を使用せずに移動平均のシグナルのみでトレードする</span>
  <span class="c1"># トレード結果は収集しない</span>
  <span class="c1">#</span>
  <span class="k">class</span> <span class="nc">TestMode</span>
    <span class="k">def</span> <span class="nf">do_trade?</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="n">sell_or_buy</span><span class="p">)</span>
      <span class="kp">true</span>
    <span class="k">end</span>
    <span class="k">def</span> <span class="nf">after_position_closed</span><span class="p">(</span> <span class="n">signal</span><span class="p">,</span> <span class="n">position</span> <span class="p">)</span>
      <span class="c1"># do nothing.</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="c1"># 取引モード</span>
  <span class="c1">#</span>
  <span class="c1"># TensorFlowでの予測を使用してトレードする。</span>
  <span class="c1"># トレード結果は収集しない</span>
  <span class="c1">#</span>
  <span class="k">class</span> <span class="nc">TradeMode</span>
    <span class="k">def</span> <span class="nf">initialize</span>
      <span class="vi">@client</span> <span class="o">=</span> <span class="no">HTTPClient</span><span class="o">.</span><span class="n">new</span>
    <span class="k">end</span>
    <span class="c1"># トレードを勝敗予測をtensorflowに問い合わせる</span>
    <span class="k">def</span> <span class="nf">do_trade?</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="n">sell_or_buy</span><span class="p">)</span>
      <span class="n">body</span> <span class="o">=</span> <span class="p">{</span><span class="ss">sell_or_buy</span><span class="p">:</span> <span class="n">sell_or_buy</span><span class="p">}</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">signal</span><span class="p">)</span>
      <span class="n">body</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="ss">:ma5</span><span class="p">)</span>
      <span class="n">body</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="ss">:ma10</span><span class="p">)</span>
      <span class="n">result</span> <span class="o">=</span> <span class="vi">@client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">"http://tensorflow:5000/api/estimator"</span><span class="p">,</span> <span class="p">{</span>
        <span class="ss">body</span><span class="p">:</span> <span class="no">JSON</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">body</span><span class="p">),</span>
        <span class="ss">header</span><span class="p">:</span> <span class="p">{</span>
          <span class="s1">'Content-Type'</span> <span class="o">=&gt;</span> <span class="s1">'application/json'</span>
        <span class="p">}</span>
      <span class="p">})</span>
      <span class="k">return</span> <span class="no">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">body</span><span class="p">)</span><span class="o">[</span><span class="s2">"result"</span><span class="o">]</span> <span class="o">==</span> <span class="s2">"up"</span>
      <span class="c1"># up と予測された場合のみトレード</span>
    <span class="k">end</span>
    <span class="k">def</span> <span class="nf">after_position_closed</span><span class="p">(</span> <span class="n">signal</span><span class="p">,</span> <span class="n">position</span> <span class="p">)</span>
      <span class="c1"># do nothing.</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div></div>

<h3>
<span id="訓練用データを取集する" class="fragment"></span><a href="#%E8%A8%93%E7%B7%B4%E7%94%A8%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E5%8F%96%E9%9B%86%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>訓練用データを取集する</h3>

<p>エージェントができたら、Jijiのバックテスト機能を利用してアルゴリズムを実行し、トレードデータを収集します。</p>

<h4>
<span id="エージェントの登録" class="fragment"></span><a href="#%E3%82%A8%E3%83%BC%E3%82%B8%E3%82%A7%E3%83%B3%E3%83%88%E3%81%AE%E7%99%BB%E9%8C%B2"><i class="fa fa-link"></i></a>エージェントの登録</h4>

<ol>
<li>[エージェント] 画面を開いて、「＋」ボタンで新しいエージェントを追加します。</li>
<li>エージェント名を「<code>tensorflow-sample-agent.rb</code>」に設定、エディタに <a href="https://github.com/unageanu/jiji-with-tensorflow-example/blob/master/agents/tensorflow_sample_agent.rb" rel="nofollow noopener" target="_blank">tensorflow_sample_agent.rb</a> の内容をコピペして貼り付け。</li>
<li>最後に、保存ボタンを押して、エージェントを登録します。</li>
</ol>

<p><a href="https://qiita-image-store.s3.amazonaws.com/0/137010/50759a81-9529-bc0b-6c5a-cd69953b3c2b.png" target="_blank" rel="nofollow noopener"><img src="https://qiita-image-store.s3.amazonaws.com/0/137010/50759a81-9529-bc0b-6c5a-cd69953b3c2b.png" alt="エージェント登録.png"></a></p>

<h4>
<span id="バックテストの実行" class="fragment"></span><a href="#%E3%83%90%E3%83%83%E3%82%AF%E3%83%86%E3%82%B9%E3%83%88%E3%81%AE%E5%AE%9F%E8%A1%8C"><i class="fa fa-link"></i></a>バックテストの実行</h4>

<ol>
<li>[バックテスト] - [テストの作成] を開きます。</li>
<li>テストの設定を行います。

<ul>
<li>「テスト名」は適当に入力。</li>
<li>過去10年のデータでテストができるので、2006～2014のトレード結果をトレーニングに使い、2014～2016はフィルタの評価に使用することにします。「テスト期間」は、2006-09-01 ～ 2014-08-31 に設定。</li>
<li>日足データのみ使用するため、「レート間隔」は「1日」にします。</li>
<li>「使用する通貨ペア」で「USDJPY」を選択</li>
<li>「エージェント」の「＋」ボタンを押して、<code>TensorflowSampleAgent@tensorflow_sample_agent.rb</code> を追加します。追加後、右下のプロパティで「動作モード」を <code>collect</code> に設定します。</li>
</ul>
</li>
<li>設定が完了したら、[以下の設定でバックテストを開始] ボタンを押して、テストを実行します。</li>
</ol>

<p><a href="https://qiita-image-store.s3.amazonaws.com/0/137010/cdf28009-cfd5-e0ea-c7bc-18a78315fb7a.png" target="_blank" rel="nofollow noopener"><img src="https://qiita-image-store.s3.amazonaws.com/0/137010/cdf28009-cfd5-e0ea-c7bc-18a78315fb7a.png" alt="トレーニング.png"></a></p>

<p>テストの実行が完了したら、MongoDBにトレードデータが保存されているはず。接続して確認。</p>

<div class="code-frame" data-lang="shell-session"><div class="highlight"><pre>
<span class="go">$ docker exec -it jiji_example__mongodb  mongo </span>
<span class="go">MongoDB shell version: 3.0.7</span>
<span class="go">connecting to: test</span>
<span class="go">Welcome to the MongoDB shell.</span>
<span class="go">&gt; show dbs                                                                                                                                                                                                                                                   </span>
<span class="go">jiji   0.203GB</span>
<span class="go">local  0.078GB</span>
<span class="go">&gt; use jiji                                                                                                                                                                                                                                                   </span>
<span class="go">switched to db jiji</span>
<span class="go">&gt; db.tensorflow_example_trade_and_signals.find()                                                                                                                                                                                                             </span>
<span class="go">{ "_id" : ObjectId("57b1593a52de170001577542"), "macd_difference" : 0.2377196586449014, "rsi" : 20.774818401937026, "slope_10" : 0.08290969696969225, "slope_25" : 0.05338855384616181, "slope_50" : null, "ma_10_estrangement" : -0.9403938769738917, "ma_25_estrangement" : -0.5138962727847769, "ma_50_estrangement" : -0.07730379529748173, "profit_or_loss" : -17860, "sell_or_buy" : "sell", "entered_at" : ISODate("2006-09-04T15:00:00Z"), "exited_at" : ISODate("2006-09-11T15:00:00Z") }</span>
<span class="go">{ "_id" : ObjectId("57b1593b52de170001577549"), "macd_difference" : 0.02080019102510705, "rsi" : 60.18461538461548, "slope_10" : -0.0560551515151482, "slope_25" : 0.06835978461537653, "slope_50" : null, "ma_10_estrangement" : 0.8251919080828378, "ma_25_estrangement" : 0.8220139255524603, "ma_50_estrangement" : 1.4264079514333357, "profit_or_loss" : -4970, "sell_or_buy" : "buy", "entered_at" : ISODate("2006-09-11T15:00:00Z"), "exited_at" : ISODate("2006-09-20T15:00:00Z") }</span>
<span class="go"># 略</span>
<span class="go">&gt; quit()</span>
</pre></div></div>

<p>ちなみにトレード結果は以下の通りでした。シンプルなアルゴリズムなので、こんなもんですかね。</p>

<p><a href="https://qiita-image-store.s3.amazonaws.com/0/137010/d237b381-5a0a-9e43-bd47-6bf72501f485.png" target="_blank" rel="nofollow noopener"><img src="https://qiita-image-store.s3.amazonaws.com/0/137010/d237b381-5a0a-9e43-bd47-6bf72501f485.png" alt="テスト結果_収集.png"></a></p>

<h2>
<span id="4-トレーニング" class="fragment"></span><a href="#4-%E3%83%88%E3%83%AC%E3%83%BC%E3%83%8B%E3%83%B3%E3%82%B0"><i class="fa fa-link"></i></a>4. トレーニング</h2>

<p>データができたので、TensorFlowのモデルをトレーニングしていきます。</p>

<p>訓練で必要なソースコードはコンテナ作成時にコピーしているので <code>/scripts/train.py</code> を実行すればOKだったりしますが、用意したコードを軽く解説しておきます。</p>

<h3>
<span id="traderesultsloader" class="fragment"></span><a href="#traderesultsloader"><i class="fa fa-link"></i></a>TradeResultsLoader</h3>

<ul>
<li>MongoDBからトレードデータを取得するクラスです。</li>
<li>PyMongo を使っています。</li>
</ul>

<div class="code-frame" data-lang="py"><div class="highlight"><pre>
<span class="k">class</span> <span class="nc">TradeResultsLoader</span><span class="p">:</span>

    <span class="n">DB_HOST</span><span class="o">=</span><span class="s">'mongodb'</span>
    <span class="n">DB_PORT</span><span class="o">=</span><span class="mi">27017</span>

    <span class="n">DB</span><span class="o">=</span><span class="s">'jiji'</span>
    <span class="n">COLLECTION</span><span class="o">=</span><span class="s">'tensorflow_example_trade_and_signals'</span>

    <span class="k">def</span> <span class="nf">retrieve_trade_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">pymongo</span><span class="o">.</span><span class="n">MongoClient</span><span class="p">(</span>
            <span class="n">TradeResultsLoader</span><span class="o">.</span><span class="n">DB_HOST</span><span class="p">,</span> <span class="n">TradeResultsLoader</span><span class="o">.</span><span class="n">DB_PORT</span><span class="p">)</span>
        <span class="n">collection</span> <span class="o">=</span> <span class="n">client</span><span class="p">[</span><span class="n">TradeResultsLoader</span><span class="o">.</span><span class="n">DB</span><span class="p">][</span><span class="n">TradeResultsLoader</span><span class="o">.</span><span class="n">COLLECTION</span><span class="p">]</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">find</span><span class="p">()</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s">"entered_at"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">cursor</span><span class="p">))</span>
</pre></div></div>

<h3>
<span id="traderesults" class="fragment"></span><a href="#traderesults"><i class="fa fa-link"></i></a>TradeResults</h3>

<ul>
<li>トレードデータを整形するクラス。</li>
<li>以下のような処理を行います。

<ul>
<li>データをトレーニング用とテスト用に分割。

<ul>
<li>トレードデータの 2/3 を実際の訓練に、残りをテストデータとして訓練課程でのモデルの評価に使います。 </li>
</ul>
</li>
<li>
<code>z-score</code> での値の正規化</li>
<li>目的変数とする損益データを取り出して、 <code>up</code>, <code>down</code> の <code>DataFrame</code> に変換。</li>
</ul>
</li>
</ul>

<div class="code-frame" data-lang="py"><div class="highlight"><pre>
<span class="k">class</span> <span class="nc">TradeResults</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">raw</span>  <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">TradeResults</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">TradeResults</span><span class="o">.</span><span class="n">clean</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">all_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__drop_profit_or_loss</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">train_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__drop_profit_or_loss</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__train_data</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">test_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__drop_profit_or_loss</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__test_data</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">train_profit_or_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__train_data</span><span class="p">()[</span><span class="s">"normalized_profit_or_loss"</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">test_profit_or_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__test_data</span><span class="p">()[</span><span class="s">"normalized_profit_or_loss"</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">train_up_down</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__up_down</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__train_data</span><span class="p">()[</span><span class="s">"profit_or_loss"</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">test_up_down</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__up_down</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__test_data</span><span class="p">()[</span><span class="s">"profit_or_loss"</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">__train_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># 全データの 2/3 を訓練データとして使う。</span>
        <span class="c"># トレード時の地合いの影響を分散させるため、時系列でソートしたものから均等に抜き出す。</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">%</span> <span class="mi">3</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>

    <span class="k">def</span> <span class="nf">__test_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># 全データの 1/3 をテストデータとして使う。</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">%</span> <span class="mi">3</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>

    <span class="k">def</span> <span class="nf">__drop_profit_or_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s">"profit_or_loss"</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s">"normalized_profit_or_loss"</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__up_down</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">profit_or_loss</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">profit_or_loss</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span>
                <span class="mi">1</span> <span class="k">if</span> <span class="n">p</span> <span class="o">&gt;</span>  <span class="mi">0</span>  <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
                <span class="mi">1</span> <span class="k">if</span> <span class="n">p</span> <span class="o">&lt;=</span> <span class="mi">0</span>  <span class="k">else</span> <span class="mi">0</span>
            <span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s">'up'</span><span class="p">,</span> <span class="s">'down'</span><span class="p">]))</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
        <span class="k">del</span> <span class="n">data</span><span class="p">[</span><span class="s">'_id'</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">data</span><span class="p">[</span><span class="s">'entered_at'</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">data</span><span class="p">[</span><span class="s">'exited_at'</span><span class="p">]</span>
        <span class="n">data</span><span class="p">[</span><span class="s">'sell_or_buy'</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">'sell_or_buy'</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">sell_or_buy</span><span class="p">:</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">sell_or_buy</span> <span class="o">==</span> <span class="s">"sell"</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">normalize</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
        <span class="c"># すべてのデータをz-scoreで正規化する</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s">'normalized_'</span> <span class="o">+</span> <span class="n">col</span> <span class="k">if</span> <span class="n">col</span> <span class="o">==</span> <span class="s">'profit_or_loss'</span> <span class="k">else</span> <span class="n">col</span>
            <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span><span class="o">/</span><span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">ddof</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span>
</pre></div></div>

<h3>
<span id="trainer--estimator--model" class="fragment"></span><a href="#trainer--estimator--model"><i class="fa fa-link"></i></a>Trainer &amp; Estimator &amp; Model</h3>

<ul>
<li>Modelクラスに TensorFlowのモデルを定義して、派生クラスのTrainer(訓練を行うクラス)とEstimator(予測を行うクラス)で共有する形にしています。</li>
<li>モデルはコピペです。隠れ層2のシンプルなものにしてみました。</li>
</ul>

<div class="code-frame" data-lang="py"><div class="highlight"><pre>
<span class="k">class</span> <span class="nc">Model</span><span class="p">:</span>
    <span class="n">HIDDEN_UNIT_SIZE</span>  <span class="o">=</span> <span class="mi">32</span>
    <span class="n">HIDDEN_UNIT_SIZE2</span> <span class="o">=</span> <span class="mi">16</span>
    <span class="n">COLUMN_SIZE</span> <span class="o">=</span> <span class="mi">9</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__setup_placeholder</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__setup_model</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__setup_ops</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="n">saver</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Saver</span><span class="p">()</span>
        <span class="n">saver</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">restore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="n">saver</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Saver</span><span class="p">()</span>
        <span class="n">saver</span><span class="o">.</span><span class="n">restore</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__setup_placeholder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">column_size</span> <span class="o">=</span> <span class="n">Model</span><span class="o">.</span><span class="n">COLUMN_SIZE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trade_data</span>   <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">placeholder</span><span class="p">(</span><span class="s">"float"</span><span class="p">,</span> <span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="n">column_size</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">actual_class</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">placeholder</span><span class="p">(</span><span class="s">"float"</span><span class="p">,</span> <span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keep_prob</span>    <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">placeholder</span><span class="p">(</span><span class="s">"float"</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label</span>        <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">placeholder</span><span class="p">(</span><span class="s">"string"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__setup_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">column_size</span> <span class="o">=</span> <span class="n">Model</span><span class="o">.</span><span class="n">COLUMN_SIZE</span>
        <span class="n">w1</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">truncated_normal</span><span class="p">([</span><span class="n">column_size</span><span class="p">,</span> <span class="n">Estimator</span><span class="o">.</span><span class="n">HIDDEN_UNIT_SIZE</span><span class="p">],</span> <span class="n">stddev</span><span class="o">=</span><span class="mf">0.1</span><span class="p">))</span>
        <span class="n">b1</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="n">Estimator</span><span class="o">.</span><span class="n">HIDDEN_UNIT_SIZE</span><span class="p">]))</span>
        <span class="n">h1</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trade_data</span><span class="p">,</span> <span class="n">w1</span><span class="p">)</span> <span class="o">+</span> <span class="n">b1</span><span class="p">)</span>

        <span class="n">w2</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">truncated_normal</span><span class="p">([</span><span class="n">Estimator</span><span class="o">.</span><span class="n">HIDDEN_UNIT_SIZE</span><span class="p">,</span> <span class="n">Estimator</span><span class="o">.</span><span class="n">HIDDEN_UNIT_SIZE2</span><span class="p">],</span> <span class="n">stddev</span><span class="o">=</span><span class="mf">0.1</span><span class="p">))</span>
        <span class="n">b2</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="n">Estimator</span><span class="o">.</span><span class="n">HIDDEN_UNIT_SIZE2</span><span class="p">]))</span>
        <span class="n">h2</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">h1</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span> <span class="o">+</span> <span class="n">b2</span><span class="p">)</span>

        <span class="n">h2_drop</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">h2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_prob</span><span class="p">)</span>
        <span class="n">w2</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">truncated_normal</span><span class="p">([</span><span class="n">Estimator</span><span class="o">.</span><span class="n">HIDDEN_UNIT_SIZE2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">stddev</span><span class="o">=</span><span class="mf">0.1</span><span class="p">))</span>
        <span class="n">b2</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">h2_drop</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span> <span class="o">+</span> <span class="n">b2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__setup_ops</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cross_entropy</span> <span class="o">=</span> <span class="o">-</span><span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">actual_class</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">summary</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">scalar_summary</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="n">cross_entropy</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_op</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">AdamOptimizer</span><span class="p">(</span><span class="mf">0.0001</span><span class="p">)</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">cross_entropy</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">merge_summaries</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">merge_summary</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">summary</span><span class="p">])</span>
        <span class="n">correct_prediction</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">tf</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">actual_class</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">accuracy</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">correct_prediction</span><span class="p">,</span> <span class="s">"float"</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">Trainer</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">steps</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__prepare_train</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">steps</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__do_train</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">%</span><span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__add_summary</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__print_status</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__prepare_train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">summary_writer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">SummaryWriter</span><span class="p">(</span><span class="s">'logs'</span><span class="p">,</span> <span class="n">graph_def</span><span class="o">=</span><span class="n">session</span><span class="o">.</span><span class="n">graph_def</span><span class="p">)</span>
        <span class="n">session</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">initialize_all_variables</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">__do_train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">session</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">train_op</span><span class="p">,</span> <span class="n">feed_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">train_feed_dict</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__add_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">summary_str</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">merge_summaries</span><span class="p">,</span> <span class="n">feed_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">train_feed_dict</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
        <span class="n">summary_str</span> <span class="o">+=</span> <span class="n">session</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">merge_summaries</span><span class="p">,</span> <span class="n">feed_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_feed_dict</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">summary_writer</span><span class="o">.</span><span class="n">add_summary</span><span class="p">(</span><span class="n">summary_str</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__print_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="c"># 現在のモデルを利用して推移した利益と実際の利益の相関を、訓練データ、テストデータそれぞれで計算し出力する</span>
        <span class="n">train_accuracy</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">accuracy</span><span class="p">,</span> <span class="n">feed_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">train_feed_dict</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
        <span class="n">test_accuracy</span>  <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">accuracy</span><span class="p">,</span> <span class="n">feed_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_feed_dict</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
        <span class="k">print</span> <span class="s">'step {} ,train_accuracy={} ,test_accuracy={} '</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">i</span><span class="p">,</span> <span class="n">train_accuracy</span><span class="p">,</span> <span class="n">test_accuracy</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">train_feed_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trade_data</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">train_data</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">actual_class</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">train_up_down</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">keep_prob</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">:</span> <span class="s">"train"</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">test_feed_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trade_data</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">test_data</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">actual_class</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">test_up_down</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">keep_prob</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">:</span> <span class="s">"test"</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">__reshape</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">profit_or_loss</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">profit_or_loss</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">profit_or_loss</span><span class="o">.</span><span class="n">values</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Estimator</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">estimate</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">data</span> <span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">feed_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">estimate_feed_dict</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">estimate_feed_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trade_data</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">keep_prob</span><span class="p">:</span> <span class="mi">1</span>
        <span class="p">}</span>
</pre></div></div>

<h3>
<span id="trainpy" class="fragment"></span><a href="#trainpy"><i class="fa fa-link"></i></a>train.py</h3>

<ul>
<li>トレーニングをキックするスクリプトです。</li>
<li>
<code>TradeResultsLoader</code> を使って取得したトレードデータを <code>Trainer</code> に渡して訓練を行っています。</li>
<li>訓練が終わったら、モデルを <code>./model.ckpt</code> に永続化します。</li>
</ul>

<div class="code-frame" data-lang="py"><div class="highlight"><pre>
<span class="c"># -*- coding: utf-8 -*-</span>

<span class="kn">from</span> <span class="nn">trade_results_loader</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">model</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">loader</span> <span class="o">=</span> <span class="n">TradeResultsLoader</span><span class="p">()</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">TradeResults</span><span class="p">(</span><span class="n">loader</span><span class="o">.</span><span class="n">retrieve_trade_data</span><span class="p">())</span>

<span class="k">with</span> <span class="n">Trainer</span><span class="p">()</span> <span class="k">as</span> <span class="n">trainer</span><span class="p">:</span>
    <span class="n">trainer</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="mi">10001</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="n">trainer</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s">"./model.ckpt"</span><span class="p">)</span>
</pre></div></div>

<h3>
<span id="trainpy-の実行" class="fragment"></span><a href="#trainpy-%E3%81%AE%E5%AE%9F%E8%A1%8C"><i class="fa fa-link"></i></a>train.py の実行</h3>

<p>前述のとおり、必要なスクリプトはコンテナ作成時にコピーしているので、コンテナ内で実行すれば、訓練を開始できます。</p>

<p>まずは、TensorFlowコンテナに入ります。</p>

<div class="code-frame" data-lang="shell-session"><div class="highlight"><pre>
<span class="go">$ docker exec -it jiji_example__tensorflow /bin/bash</span>
</pre></div></div>

<p>コンテナ内で以下を実行します。</p>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre>
<span class="nv">$ </span><span class="nb">cd</span> /scripts
<span class="nv">$ </span>python train.py
step <span class="m">0</span> ,train_accuracy<span class="o">=</span>0.671568632126 ,test_accuracy<span class="o">=</span>0.607843160629 
step <span class="m">100</span> ,train_accuracy<span class="o">=</span>0.671568632126 ,test_accuracy<span class="o">=</span>0.607843160629 
step <span class="m">200</span> ,train_accuracy<span class="o">=</span>0.671568632126 ,test_accuracy<span class="o">=</span>0.607843160629 
step <span class="m">300</span> ,train_accuracy<span class="o">=</span>0.671568632126 ,test_accuracy<span class="o">=</span>0.607843160629 
<span class="c"># 略</span>
step <span class="m">9600</span> ,train_accuracy<span class="o">=</span>0.936274528503 ,test_accuracy<span class="o">=</span>0.568627476692 
step <span class="m">9700</span> ,train_accuracy<span class="o">=</span>0.965686261654 ,test_accuracy<span class="o">=</span>0.578431367874 
step <span class="m">9800</span> ,train_accuracy<span class="o">=</span>0.946078419685 ,test_accuracy<span class="o">=</span>0.558823525906 
step <span class="m">9900</span> ,train_accuracy<span class="o">=</span>0.946078419685 ,test_accuracy<span class="o">=</span>0.558823525906 
</pre></div></div>

<p>100ステップごとに、モデルを使って訓練データを予測した時の精度と、テストデータを予測した時の精度が出力されます。<br>
訓練は、とりあえず 10000ステップ行うようにしてみました。</p>

<p>最終的には以下の精度になりました。</p>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre>
step <span class="m">9900</span> ,train_accuracy<span class="o">=</span>0.946078419685 ,test_accuracy<span class="o">=</span>0.558823525906 
</pre></div></div>

<p>訓練データでの精度は高いのですが、テストデータでの精度は微妙・・・。あてずっぽうよりはましかな・・・。</p>

<h2>
<span id="5-バックテストで検証" class="fragment"></span><a href="#5-%E3%83%90%E3%83%83%E3%82%AF%E3%83%86%E3%82%B9%E3%83%88%E3%81%A7%E6%A4%9C%E8%A8%BC"><i class="fa fa-link"></i></a>5. バックテストで検証</h2>

<p>精度に一抹の不安が残りますが、このまま突き進みます。<br>
次は、訓練したモデルを使って予測した結果を返すREST APIを作ります。</p>

<h3>
<span id="rest-api-を作る" class="fragment"></span><a href="#rest-api-%E3%82%92%E4%BD%9C%E3%82%8B"><i class="fa fa-link"></i></a>REST API を作る</h3>

<ul>
<li>
<code>Estimator</code> で推測した結果を返す機能を、<code>Flask</code> を使ってREST APIで公開します。</li>
<li>リクエストボディで渡された指標データを正規化して <code>Estimator</code> に渡し、予測させた損益結果(<code>up</code> or <code>down</code>)を返却します。

<ul>
<li>データの正規化に訓練時に使用したデータが必要なので、<code>TradeResultsLoader</code> でトレードデータを取得して、<code>TradeResults</code> で正規化する処理を入れています。</li>
</ul>
</li>
</ul>

<div class="code-frame" data-lang="py"><div class="highlight"><pre>
<span class="n">loader</span> <span class="o">=</span> <span class="n">TradeResultsLoader</span><span class="p">()</span>

<span class="n">estimator</span> <span class="o">=</span> <span class="n">Estimator</span><span class="p">()</span>
<span class="n">estimator</span><span class="o">.</span><span class="n">__enter__</span><span class="p">()</span>
<span class="n">estimator</span><span class="o">.</span><span class="n">restore</span><span class="p">(</span><span class="s">"./model.ckpt"</span><span class="p">)</span>

<span class="n">trade_data</span>  <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">retrieve_trade_data</span><span class="p">()</span>

<span class="c"># webapp</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/api/estimator'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'POST'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">estimate</span><span class="p">():</span>
    <span class="c"># 値を正規化するため、リクエストボディで渡された指標データと訓練で使用したデータを統合。</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trade_data</span><span class="p">)</span>
    <span class="c"># 正規化したデータを渡して、損益を予測</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">estimator</span><span class="o">.</span><span class="n">estimate</span><span class="p">(</span><span class="n">TradeResults</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">all_data</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[[</span><span class="mi">0</span><span class="p">]])</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">result</span><span class="o">=</span><span class="p">(</span><span class="s">"up"</span> <span class="k">if</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s">"down"</span><span class="p">))</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s">'0.0.0.0'</span><span class="p">)</span>
</pre></div></div>

<p>サーバーのソースコードもコンテナにコピーしているので、以下のコマンドでサーバーを起動できます。</p>

<div class="code-frame" data-lang="sh"><div class="highlight"><pre>
<span class="nv">$ </span><span class="nb">cd</span> /scripts
<span class="nv">$ </span>python server.py 
</pre></div></div>

<h3>
<span id="フィルタの効果検証" class="fragment"></span><a href="#%E3%83%95%E3%82%A3%E3%83%AB%E3%82%BF%E3%81%AE%E5%8A%B9%E6%9E%9C%E6%A4%9C%E8%A8%BC"><i class="fa fa-link"></i></a>フィルタの効果検証</h3>

<p>REST APIができたので、Jijiのトレードアルゴリズムから実際に使用してフィルタの効果を検証します。</p>

<ul>
<li>訓練には2006～2014の結果を利用したので、2014～2016 の期間で効果を検証します。</li>
<li>TensorFlowの予測を使用しない <code>test</code> モードでのトレード結果と、予測を使用する <code>trade</code> モードでそれぞれバックテストを行い結果を比較します。</li>
</ul>

<p>まずは、test モードで実行。</p>

<ol>
<li>[バックテスト] - [テストの作成] を開きます。</li>
<li>テストの設定を行います。

<ul>
<li>「テスト名」は適当に入力。</li>
<li>「テスト期間」は、2014-09-01 ～ 2016-08-01 に設定。</li>
<li>「レート間隔」は「1日」にします。</li>
<li>「使用する通貨ペア」で「USDJPY」を選択</li>
<li>「エージェント」の「＋」ボタンを押して、<code>TensorflowSampleAgent@tensorflow_sample_agent.rb</code> を追加します。追加後、右下のプロパティで「動作モード」を <code>test</code> に設定します。</li>
</ul>
</li>
<li>設定が完了したら、[以下の設定でバックテストを開始] ボタンを押して、テストを実行します。</li>
</ol>

<p>フィルタなしの場合のトレード結果は以下の通りでした。</p>

<p><a href="https://qiita-image-store.s3.amazonaws.com/0/137010/5ac69aff-ec74-135f-4260-9db9b40f4748.png" target="_blank" rel="nofollow noopener"><img src="https://qiita-image-store.s3.amazonaws.com/0/137010/5ac69aff-ec74-135f-4260-9db9b40f4748.png" alt="テスト結果_改善前.png"></a></p>

<p>同様の設定で、動作モードを <code>trade</code> にして再度テストを実行。TensorFlow フィルタが適用されます。</p>

<p><a href="https://qiita-image-store.s3.amazonaws.com/0/137010/0b90792c-9787-8bfd-6d93-fc7f8b3bf265.png" target="_blank" rel="nofollow noopener"><img src="https://qiita-image-store.s3.amazonaws.com/0/137010/0b90792c-9787-8bfd-6d93-fc7f8b3bf265.png" alt="テスト結果_改善後.png"></a></p>

<p>うーん、微妙。損益とProfit Factorは改善していますが、トレード回数が大幅減・・・。トレードしていないわけではないので、すべて「マイナス」と判定している訳ではなそさそうですが、「マイナス」寄りに大きく傾いている気がしますね・・・。</p>

<h2>
<span id="6-アルゴリズムを使って実際の口座でトレード" class="fragment"></span><a href="#6-%E3%82%A2%E3%83%AB%E3%82%B4%E3%83%AA%E3%82%BA%E3%83%A0%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6%E5%AE%9F%E9%9A%9B%E3%81%AE%E5%8F%A3%E5%BA%A7%E3%81%A7%E3%83%88%E3%83%AC%E3%83%BC%E3%83%89"><i class="fa fa-link"></i></a>6. アルゴリズムを使って実際の口座でトレード</h2>

<p>最後に、一応、アルゴリズムを使って実際の口座でトレードするところまで解説しておきます。といっても、アルゴリズム(エージェント)を [リアルトレード]-[エージェント]に登録するだけですが。</p>

<p><a href="https://qiita-image-store.s3.amazonaws.com/0/137010/28de6c1d-df6e-fecf-4854-a66a7983b4d8.png" target="_blank" rel="nofollow noopener"><img src="https://qiita-image-store.s3.amazonaws.com/0/137010/28de6c1d-df6e-fecf-4854-a66a7983b4d8.png" alt="リアルトレード.png"></a></p>

<p>登録すれば、実際の口座(個人口座orデモ口座)でアルゴリズムの運用を開始できます。<br>
もちろん、事前に十分な動作確認を行ってくださいね。</p>

<h2>
<span id="まとめ" class="fragment"></span><a href="#%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>まとめ</h2>

<p>チュートリアルは以上です。</p>

<p>フィルタとしての効果は微妙でしたが、説明変数として渡すデータやモデルの設定を調整すれば改善できる余地はあるかもしれません。また、そもそも、ベースとしている移動平均を使ったトレードアルゴリズムの予測能力も低いので、これをもっと良いものに変えることで結果を良くすることができる可能性もあります。興味がある方は、環境を作っていろいろ試してみてください。</p>

<p>TensorFlowのような機械学習ライブラリやOANDA REST APIの登場で、個人でも手軽に先端技術を利用したシステムトレードを試せる環境が整ってきているように思います。データ分析や機械学習の勉強も兼ねて、システムトレードに取り組んでみるのも面白いのではないでしょうか?</p>
<div class="hidden"><form class="js-task-list-update" action="/jiji_platform/items/268377c542706e6f44b1" accept-charset="UTF-8" method="post"><input name="utf8" type="hidden" value="&#x2713;" /><input type="hidden" name="_method" value="patch" /><input type="hidden" name="authenticity_token" value="o0TuUiA0FxFexd7Owj2zevyG1J9iioq99lb3v98cabz8dedEKYF4QC64ukQr+EvusHMhNGtGXgSYtgJsO/Tqkg==" /><input type="hidden" name="updated_at_confirmation_in_unixtime" id="updated_at_confirmation_in_unixtime" value="1471905912" class="js-task-list-updated-at" /><textarea name="raw_body" id="raw_body" class="js-task-list-field">
[機械学習ライブラリ「TensorFlow」](https://www.tensorflow.org)と、[オープンソースのシステムトレードフレームワーク「Jiji」](http://jiji2.unageanu.net/)を組み合わせて、&lt;b&gt;機械学習を使った為替(FX)のトレードシステム&lt;/b&gt;を作るチュートリアルです。

システムのセットアップからはじめて、機械学習モデルの作成、トレーニング、それを使って実際にトレードを行うところまで、具体例を交えて解説します。

# システム構成

次のようなシステムを作ります。

![システム構成.png](https://qiita-image-store.s3.amazonaws.com/0/137010/8808e9ff-9cd3-7ed7-3d05-5d226b34db5e.png)

- Jijiのバックテスト機能を使ってトレードデータを収集。これをTensorFlowに入力してモデルをトレーニングします。
  - 予測する内容については後述。
- 訓練したモデルを使って予測結果を返すREST APIを作り、トレード時にJijiから呼び出して使います。
- レート情報の取得やトレードには、[OANDA REST API](http://www.oanda.jp/api/) を利用
- トレード状況の確認やアルゴリズムの管理は、ブラウザ or スマホアプリで
  - 外出先でも状況の確認や、緊急メンテナンスが行えるようにします。
- システムは、Docker上に構築します。
  - AWSなどDockerをサポートしているクラウド環境でも、同様の手順で構築できるはずです。
  - 確認はローカルマシンにインストールしたDockerで行っています。


# TensorFlowで予測する内容

機械学習の使い方はいろいろ考えられると思いますが、このチュートリアルでは&lt;b&gt;「トレード時の各種指標から損益を予測し、マイナスになるトレードをフィルタリングする」&lt;/b&gt;形での利用を試してみます。

- 移動平均の交差ルールでトレードするシンプルなアルゴリズムを作成し、トレード時の各種指標を記録。
- 記録した指標とトレードの損益データをTensorFlowに入力して学習させ、「プラス or マイナス」を予測させます。
- 予測結果が「プラス」となった場合のみトレードを行うことで、損益を改善します。
 


# チュートリアル

順に解説していきます。

## 0. 前提条件

docker, docker-compose を使用します。事前にインストールをお願いします。
手順の確認は以下の環境で行っています。

- CentOS 7
- Docker 1.10.2
- Docker Compose 1.6.2

## 1. OANDA Japan アカウントの用意

[OANDA REST API](http://www.oanda.jp/api/) を利用するため、OANDA のアカウントが必要になります。
とりあえず試すには、無料のデモアカウントが手軽で便利です。[アカウント作成はこちらから。](http://www.oanda.jp)

アカウントを作成したら、[こちら](http://jiji2.unageanu.net/install/010000_prepare_account.html)の手順にしたがってパーソナルアクセストークンを発行してください。トークンはJijiの初期設定で使用します。

## 2. システムのセットアップ

`docker-compose.yml` など必要な設定ファイル/ソースコード一式は [GitHub](https://github.com/unageanu/jiji-with-tensorflow-example) に置いています。まずはこれをダウンロード。

```shell-session
$ git clone https://github.com/unageanu/jiji-with-tensorflow-example.git
$ cd jiji-with-tensorflow-example
```

### サーバー証明書の準備

通信内容を暗号化するため、TLSを使用します。
ドメインがある場合は[Let’s Encrypt](https://letsencrypt.org/) を利用するのが良いと思いますが、ローカルマシンなのでとりあえず自己署名証明書を使います。

```shell-session
$ mkdir -p ./cert
$ cd ./cert

# 秘密鍵を生成
$ openssl genrsa 2048 &gt; server.key
# CSRを作成
$ openssl req -new -key server.key &gt; server.csr
# サーバー証明書を作成
$ openssl x509 -sha256 -days 365 -req -signkey server.key &lt; server.csr &gt; server.crt
# アクセス権を制限
$ sudo chown root.root server.key
$ sudo chmod 600 server.key

$ cd ../
```

### 設定ファイルの編集

次に `./docker-compose.yml` を開き、Jijiのシークレットキーを適当に変更します。

```yaml
jiji:
  # 略
  environment:
    # サーバー内部で秘匿データの暗号化に使うキー
    # 必ず変更して使用してください。
    # UIから入力を求められることはないので、任意の長い文字列を使用すればOKです。
    USER_SECRET: d41d8cd98f00b204e9800998ecf8427e
```

### システムの起動

以上で準備は完了。`docker-compose` でシステムを起動します。

```shell-session
$ docker-compose up -d
```

`jiji_example__nginx`, `jiji_example__jiji`, `jiji_example__mongodb`, `jiji_example__tensorflow` の各コンテナが起動していればOK。

```shell-session
$ docker ps -a
CONTAINER ID        IMAGE                                         COMMAND                  CREATED             STATUS                      PORTS                                                        NAMES
f083efd4ab5c        unageanu/jiji-nginx:latest                    &quot;nginx -g &#39;daemon off&quot;   8 seconds ago       Up 4 seconds                80/tcp, 0.0.0.0:10443-&gt;443/tcp                               jiji_example__nginx
ac72354363c9        unageanu/jiji:latest                          &quot;puma -C /app/jiji2/c&quot;   10 seconds ago      Up 8 seconds                8080/tcp                                                     jiji_example__jiji
8acc4e79e5cb        jijiwithtensorflowexample_tensorflow          &quot;/run_jupyter.sh&quot;        16 seconds ago      Up 10 seconds               8888/tcp, 0.0.0.0:15000-&gt;5000/tcp, 0.0.0.0:16006-&gt;6006/tcp   jiji_example__tensorflow
3e02f8b562f1        mongo:3.0.7                                   &quot;/entrypoint.sh mongo&quot;   20 seconds ago      Up 16 seconds               0.0.0.0:37017-&gt;27017/tcp                                     jiji_example__mongodb
```

### Jijiの初期設定

以下のURLをブラウザで開くと、Jijiの初期設定画面が開きます。

```
https://&lt;インストール先ホスト&gt;:10443
```

![初期設定.png](https://qiita-image-store.s3.amazonaws.com/0/137010/bd21215c-6b5b-26fe-a960-7dd6344576c2.png)


画面が表示されたら、[こちらの手順](http://jiji2.unageanu.net/install/030000_initial_setting.html)に従って初期設定を行ってください。


## 3. トレードデータの収集

Jijiのセットアップが完了したら、トレードデータの収集に移ります。
移動平均でトレードするアルゴリズムを作り、Jijiのバックテスト機能を使って実行。このとき、「トレード損益+トレード時の各種指標」をMongoDBに記録し、これをTensorFlowの訓練データとして使います。

### トレードアルゴリズム(エージェント)を作る

ソースコードは[こちら](https://github.com/unageanu/jiji-with-tensorflow-example/blob/master/agents/tensorflow_sample_agent.rb)にあります。主要なクラスを簡単に解説しておきます。

#### TradeAndSignals

- トレード結果とトレード時の各種指標を格納するクラスです。
- これをTensorFlowに入力して、トレーニングを行います。
- 指標には、移動平均の傾き/乖離率、RSI、MACDの乖離を使うようにしました。

```rb
# トレード結果とトレード時の各種指標。
# MongoDBに格納してTensorFlowの学習データにする
class TradeAndSignals

  include Mongoid::Document

  store_in collection: &#39;tensorflow_example_trade_and_signals&#39;

  field :macd_difference,    type: Float # macd - macd_signal

  field :rsi,                type: Float

  field :slope_10,           type: Float # 10日移動平均線の傾き
  field :slope_25,           type: Float # 25日移動平均線の傾き
  field :slope_50,           type: Float # 50日移動平均線の傾き

  field :ma_10_estrangement, type: Float # 10日移動平均からの乖離率
  field :ma_25_estrangement, type: Float
  field :ma_50_estrangement, type: Float

  field :profit_or_loss,     type: Float
  field :sell_or_buy,        type: Symbol
  field :entered_at,         type: Time
  field :exited_at,          type: Time

  def self.create_from( signal_data, position )
    TradeAndSignals.new do |ts|
      signal_data.each do |pair|
        next if pair[0] == :ma5|| pair[0] == :ma10
        ts.send( &quot;#{pair[0]}=&quot;.to_sym, pair[1] )
      end
      ts.profit_or_loss = position.profit_or_loss
      ts.sell_or_buy    = position.sell_or_buy
      ts.entered_at     = position.entered_at
      ts.exited_at      = position.exited_at
    end
  end
end
```

#### SignalCalculator

- シグナルを計算するクラス
- Jijiに標準添付されている `Signals` ライブラリを利用してRSIや移動平均を計算します。

```rb
# シグナルを計算するクラス
class SignalCalculator

  def initialize(broker)
    @broker = broker
  end

  def next_tick(tick)
    prepare_signals(tick) unless @macd
    calculate_signals(tick[:USDJPY])
  end

  def calculate_signals(tick)
    price = tick.bid
    macd = @macd.next_data(price)
    ma5  = @ma5.next_data(price)
    ma10 = @ma10.next_data(price)
    ma25 = @ma25.next_data(price)
    ma50 = @ma50.next_data(price)
    {
      ma5:  ma5,
      ma10: ma10,
      macd_difference: macd ? macd[:macd] - macd[:signal] : nil,
      rsi:  @rsi.next_data(price),
      slope_10: ma10 ? @ma10v.next_data(ma10) : nil,
      slope_25: ma25 ? @ma25v.next_data(ma25) : nil,
      slope_50: ma50 ? @ma50v.next_data(ma50) : nil,
      ma_10_estrangement: ma10 ? calculate_estrangement(price, ma10) : nil,
      ma_25_estrangement: ma25 ? calculate_estrangement(price, ma25) : nil,
      ma_50_estrangement: ma50 ? calculate_estrangement(price, ma50) : nil
    }
  end

  def prepare_signals(tick)
    create_signals
    retrieve_rates(tick.timestamp).each do |rate|
      calculate_signals(rate.close)
    end
  end

  def create_signals
    @macd  = Signals::MACD.new
    @ma5   = Signals::MovingAverage.new(5)
    @ma10  = Signals::MovingAverage.new(10)
    @ma25  = Signals::MovingAverage.new(25)
    @ma50  = Signals::MovingAverage.new(50)
    @ma5v  = Signals::Vector.new(5)
    @ma10v = Signals::Vector.new(10)
    @ma25v = Signals::Vector.new(25)
    @ma50v = Signals::Vector.new(50)
    @rsi   = Signals::RSI.new(9)
  end

  def retrieve_rates(time)
    @broker.retrieve_rates(:USDJPY, :one_day, time - 60*60*24*60, time )
  end

  def calculate_estrangement(price, ma)
    ((BigDecimal.new(price, 10) - ma) / ma * 100).to_f
  end

end
```

#### TensorFlowSampleAgent

- トレードアルゴリズムの本体。
- `SignalCalculator` で計算した5日移動平均と10日移動平均のクロスでトレードを行います。
  - 5日移動平均 &gt; 10日移動平均 の場合、買
  - 5日移動平均 &lt; 10日移動平均 の場合、売
- プロパティで、動作モードを次の3つから選べるようにしています。
  - `collect` : トレードデータ収集時に使います。ポジションの決済時に `TradeAndSignals` をMongoDBに保存します。
  - `trade` : TensorFlowでの予測を使用してトレードを行うモードです。訓練後の評価で使います。
  - `test` : TensorFlowでの予測を使用せずトレードを行うモード。`trade` モードの結果を評価する際に比較用に使用します。

```rb
# TensorFlowと連携してトレードするエージェントのサンプル
class TensorFlowSampleAgent

  include Jiji::Model::Agents::Agent

  def self.description
    &lt;&lt;-STR
TensorFlowと連携してトレードするエージェントのサンプル
      STR
  end

  def self.property_infos
    [
      Property.new(&#39;exec_mode&#39;,
        &#39;動作モード(&quot;collect&quot; or &quot;trade&quot; or &quot;test&quot;)&#39;, &quot;collect&quot;)
    ]
  end

  def post_create
    @calculator = SignalCalculator.new(broker)
    @cross = Cross.new
    @mode  = create_mode(@exec_mode)

    @graph = graph_factory.create(&#39;移動平均&#39;,
      :rate, :last, [&#39;#FF6633&#39;, &#39;#FFAA22&#39;])
  end

  # 次のレートを受け取る
  def next_tick(tick)
    date = tick.timestamp.to_date
    return if !@current_date.nil? &amp;&amp; @current_date == date
    @current_date = date

    signal = @calculator.next_tick(tick)
    @cross.next_data(signal[:ma5], signal[:ma10])

    @graph &lt;&lt; [signal[:ma5], signal[:ma10]]
    do_trade(signal)
  end

  def do_trade(signal)
    # 5日移動平均と10日移動平均のクロスでトレード
    if @cross.cross_up?
      buy(signal)
    elsif @cross.cross_down?
      sell(signal)
    end
  end

  def buy(signal)
    close_exist_positions
    return unless @mode.do_trade?(signal, &quot;buy&quot;)
    result = broker.buy(:USDJPY, 10000)
    @current_position = broker.positions[result.trade_opened.internal_id]
    @current_signal = signal
  end

  def sell(signal)
    close_exist_positions
    return unless @mode.do_trade?(signal, &quot;sell&quot;)
    result = broker.sell(:USDJPY, 10000)
    @current_position = broker.positions[result.trade_opened.internal_id]
    @current_signal = signal
  end

  def close_exist_positions
    return unless @current_position
    @current_position.close
    @mode.after_position_closed( @current_signal, @current_position )
    @current_position = nil
    @current_signal = nil
  end

  def create_mode(mode)
    case mode
    when &#39;trade&#39; then
      TradeMode.new
    when &#39;collect&#39; then
      CollectMode.new
    else
      TestMode.new
    end
  end

  # データ収集モード
  #
  # TensorFlowでの予測を使用せずに移動平均のシグナルのみでトレードを行い、
  # 結果をDBに保存する
  #
  class CollectMode
    def do_trade?(signal, sell_or_buy)
      true
    end
    # ポジションが閉じられたら、トレード結果とシグナルをDBに登録する
    def after_position_closed( signal, position )
      TradeAndSignals.create_from( signal, position).save
    end
  end

  # テストモード
  #
  # TensorFlowでの予測を使用せずに移動平均のシグナルのみでトレードする
  # トレード結果は収集しない
  #
  class TestMode
    def do_trade?(signal, sell_or_buy)
      true
    end
    def after_position_closed( signal, position )
      # do nothing.
    end
  end

  # 取引モード
  #
  # TensorFlowでの予測を使用してトレードする。
  # トレード結果は収集しない
  #
  class TradeMode
    def initialize
      @client = HTTPClient.new
    end
    # トレードを勝敗予測をtensorflowに問い合わせる
    def do_trade?(signal, sell_or_buy)
      body = {sell_or_buy: sell_or_buy}.merge(signal)
      body.delete(:ma5)
      body.delete(:ma10)
      result = @client.post(&quot;http://tensorflow:5000/api/estimator&quot;, {
        body: JSON.generate(body),
        header: {
          &#39;Content-Type&#39; =&gt; &#39;application/json&#39;
        }
      })
      return JSON.parse(result.body)[&quot;result&quot;] == &quot;up&quot;
      # up と予測された場合のみトレード
    end
    def after_position_closed( signal, position )
      # do nothing.
    end
  end
end
```

### 訓練用データを取集する

エージェントができたら、Jijiのバックテスト機能を利用してアルゴリズムを実行し、トレードデータを収集します。

#### エージェントの登録

1. [エージェント] 画面を開いて、「＋」ボタンで新しいエージェントを追加します。
2. エージェント名を「`tensorflow-sample-agent.rb`」に設定、エディタに [tensorflow_sample_agent.rb](https://github.com/unageanu/jiji-with-tensorflow-example/blob/master/agents/tensorflow_sample_agent.rb) の内容をコピペして貼り付け。
3. 最後に、保存ボタンを押して、エージェントを登録します。

![エージェント登録.png](https://qiita-image-store.s3.amazonaws.com/0/137010/50759a81-9529-bc0b-6c5a-cd69953b3c2b.png)


#### バックテストの実行

1. [バックテスト] - [テストの作成] を開きます。
2. テストの設定を行います。
  - 「テスト名」は適当に入力。
  - 過去10年のデータでテストができるので、2006～2014のトレード結果をトレーニングに使い、2014～2016はフィルタの評価に使用することにします。「テスト期間」は、2006-09-01 ～ 2014-08-31 に設定。
  - 日足データのみ使用するため、「レート間隔」は「1日」にします。
  - 「使用する通貨ペア」で「USDJPY」を選択
  - 「エージェント」の「＋」ボタンを押して、`TensorflowSampleAgent@tensorflow_sample_agent.rb` を追加します。追加後、右下のプロパティで「動作モード」を `collect` に設定します。
3. 設定が完了したら、[以下の設定でバックテストを開始] ボタンを押して、テストを実行します。

![トレーニング.png](https://qiita-image-store.s3.amazonaws.com/0/137010/cdf28009-cfd5-e0ea-c7bc-18a78315fb7a.png)

テストの実行が完了したら、MongoDBにトレードデータが保存されているはず。接続して確認。

```shell-session
$ docker exec -it jiji_example__mongodb  mongo 
MongoDB shell version: 3.0.7
connecting to: test
Welcome to the MongoDB shell.
&gt; show dbs                                                                                                                                                                                                                                                   
jiji   0.203GB
local  0.078GB
&gt; use jiji                                                                                                                                                                                                                                                   
switched to db jiji
&gt; db.tensorflow_example_trade_and_signals.find()                                                                                                                                                                                                             
{ &quot;_id&quot; : ObjectId(&quot;57b1593a52de170001577542&quot;), &quot;macd_difference&quot; : 0.2377196586449014, &quot;rsi&quot; : 20.774818401937026, &quot;slope_10&quot; : 0.08290969696969225, &quot;slope_25&quot; : 0.05338855384616181, &quot;slope_50&quot; : null, &quot;ma_10_estrangement&quot; : -0.9403938769738917, &quot;ma_25_estrangement&quot; : -0.5138962727847769, &quot;ma_50_estrangement&quot; : -0.07730379529748173, &quot;profit_or_loss&quot; : -17860, &quot;sell_or_buy&quot; : &quot;sell&quot;, &quot;entered_at&quot; : ISODate(&quot;2006-09-04T15:00:00Z&quot;), &quot;exited_at&quot; : ISODate(&quot;2006-09-11T15:00:00Z&quot;) }
{ &quot;_id&quot; : ObjectId(&quot;57b1593b52de170001577549&quot;), &quot;macd_difference&quot; : 0.02080019102510705, &quot;rsi&quot; : 60.18461538461548, &quot;slope_10&quot; : -0.0560551515151482, &quot;slope_25&quot; : 0.06835978461537653, &quot;slope_50&quot; : null, &quot;ma_10_estrangement&quot; : 0.8251919080828378, &quot;ma_25_estrangement&quot; : 0.8220139255524603, &quot;ma_50_estrangement&quot; : 1.4264079514333357, &quot;profit_or_loss&quot; : -4970, &quot;sell_or_buy&quot; : &quot;buy&quot;, &quot;entered_at&quot; : ISODate(&quot;2006-09-11T15:00:00Z&quot;), &quot;exited_at&quot; : ISODate(&quot;2006-09-20T15:00:00Z&quot;) }
# 略
&gt; quit()
```

ちなみにトレード結果は以下の通りでした。シンプルなアルゴリズムなので、こんなもんですかね。

![テスト結果_収集.png](https://qiita-image-store.s3.amazonaws.com/0/137010/d237b381-5a0a-9e43-bd47-6bf72501f485.png)


## 4. トレーニング

データができたので、TensorFlowのモデルをトレーニングしていきます。

訓練で必要なソースコードはコンテナ作成時にコピーしているので `/scripts/train.py` を実行すればOKだったりしますが、用意したコードを軽く解説しておきます。

### TradeResultsLoader

- MongoDBからトレードデータを取得するクラスです。
- PyMongo を使っています。

```py
class TradeResultsLoader:

    DB_HOST=&#39;mongodb&#39;
    DB_PORT=27017

    DB=&#39;jiji&#39;
    COLLECTION=&#39;tensorflow_example_trade_and_signals&#39;

    def retrieve_trade_data(self):
        client = pymongo.MongoClient(
            TradeResultsLoader.DB_HOST, TradeResultsLoader.DB_PORT)
        collection = client[TradeResultsLoader.DB][TradeResultsLoader.COLLECTION]
        cursor = collection.find().sort(&quot;entered_at&quot;)
        return pd.DataFrame(list(cursor))
```

### TradeResults

- トレードデータを整形するクラス。
- 以下のような処理を行います。
   - データをトレーニング用とテスト用に分割。
     - トレードデータの 2/3 を実際の訓練に、残りをテストデータとして訓練課程でのモデルの評価に使います。 
   - `z-score` での値の正規化
   - 目的変数とする損益データを取り出して、 `up`, `down` の `DataFrame` に変換。

```py
class TradeResults:

    def __init__(self, data):
        self.raw  = data.copy()
        self.data = TradeResults.normalize(TradeResults.clean(data))

    def all_data(self):
        return self.__drop_profit_or_loss(self.data)

    def train_data(self):
        return self.__drop_profit_or_loss(self.__train_data())

    def test_data(self):
        return self.__drop_profit_or_loss(self.__test_data())

    def train_profit_or_loss(self):
        return self.__train_data()[&quot;normalized_profit_or_loss&quot;]

    def test_profit_or_loss(self):
        return self.__test_data()[&quot;normalized_profit_or_loss&quot;]

    def train_up_down(self):
        return self.__up_down(self.__train_data()[&quot;profit_or_loss&quot;])

    def test_up_down(self):
        return self.__up_down(self.__test_data()[&quot;profit_or_loss&quot;])

    def __train_data(self):
        # 全データの 2/3 を訓練データとして使う。
        # トレード時の地合いの影響を分散させるため、時系列でソートしたものから均等に抜き出す。
        return self.data.loc[lambda df: df.index % 3 != 0, :]

    def __test_data(self):
        # 全データの 1/3 をテストデータとして使う。
        return self.data.loc[lambda df: df.index % 3 == 0, :]

    def __drop_profit_or_loss(self, data):
        return data.drop(&quot;profit_or_loss&quot;, axis=1).drop(&quot;normalized_profit_or_loss&quot;, axis=1)

    def __up_down(self, profit_or_loss):
        return profit_or_loss.apply(
            lambda p: pd.Series([
                1 if p &gt;  0  else 0,
                1 if p &lt;= 0  else 0
            ], index=[&#39;up&#39;, &#39;down&#39;]))

    @staticmethod
    def clean(data):
        del data[&#39;_id&#39;]
        del data[&#39;entered_at&#39;]
        del data[&#39;exited_at&#39;]
        data[&#39;sell_or_buy&#39;] = data[&#39;sell_or_buy&#39;].apply(
            lambda sell_or_buy: 0 if sell_or_buy == &quot;sell&quot; else 1)
        return data

    @staticmethod
    def normalize(data):
        # すべてのデータをz-scoreで正規化する
        for col in data.columns:
            key = &#39;normalized_&#39; + col if col == &#39;profit_or_loss&#39; else col
            data[key] = (data[col] - data[col].mean())/data[col].std(ddof=0)
        data = data.fillna(0)
        return data
```

### Trainer &amp; Estimator &amp; Model

- Modelクラスに TensorFlowのモデルを定義して、派生クラスのTrainer(訓練を行うクラス)とEstimator(予測を行うクラス)で共有する形にしています。
- モデルはコピペです。隠れ層2のシンプルなものにしてみました。

```py
class Model:
    HIDDEN_UNIT_SIZE  = 32
    HIDDEN_UNIT_SIZE2 = 16
    COLUMN_SIZE = 9

    def __init__(self):
        self.__setup_placeholder()
        self.__setup_model()
        self.__setup_ops()

    def __enter__(self):
        self.session = tf.Session()
        return self

    def __exit__(self, exc_type, exc_value, traceback):
        self.session.close()
        return False

    def save(self, path):
        saver = tf.train.Saver()
        saver.save(self.session, path)

    def restore(self, path):
        saver = tf.train.Saver()
        saver.restore(self.session, path)

    def __setup_placeholder(self):
        column_size = Model.COLUMN_SIZE
        self.trade_data   = tf.placeholder(&quot;float&quot;, [None, column_size])
        self.actual_class = tf.placeholder(&quot;float&quot;, [None, 2])
        self.keep_prob    = tf.placeholder(&quot;float&quot;)
        self.label        = tf.placeholder(&quot;string&quot;)

    def __setup_model(self):
        column_size = Model.COLUMN_SIZE
        w1 = tf.Variable(tf.truncated_normal([column_size, Estimator.HIDDEN_UNIT_SIZE], stddev=0.1))
        b1 = tf.Variable(tf.constant(0.1, shape=[Estimator.HIDDEN_UNIT_SIZE]))
        h1 = tf.nn.relu(tf.matmul(self.trade_data, w1) + b1)

        w2 = tf.Variable(tf.truncated_normal([Estimator.HIDDEN_UNIT_SIZE, Estimator.HIDDEN_UNIT_SIZE2], stddev=0.1))
        b2 = tf.Variable(tf.constant(0.1, shape=[Estimator.HIDDEN_UNIT_SIZE2]))
        h2 = tf.nn.relu(tf.matmul(h1, w2) + b2)

        h2_drop = tf.nn.dropout(h2, self.keep_prob)
        w2 = tf.Variable(tf.truncated_normal([Estimator.HIDDEN_UNIT_SIZE2, 2], stddev=0.1))
        b2 = tf.Variable(tf.constant(0.1, shape=[2]))
        self.output = tf.nn.softmax(tf.matmul(h2_drop, w2) + b2)

    def __setup_ops(self):
        cross_entropy = -tf.reduce_sum(self.actual_class * tf.log(self.output))
        self.summary = tf.scalar_summary(self.label, cross_entropy)
        self.train_op = tf.train.AdamOptimizer(0.0001).minimize(cross_entropy)
        self.merge_summaries = tf.merge_summary([self.summary])
        correct_prediction = tf.equal(tf.argmax(self.output,1), tf.argmax(self.actual_class,1))
        self.accuracy = tf.reduce_mean(tf.cast(correct_prediction, &quot;float&quot;))


class Trainer(Model):

    def train(self, steps, data):
        self.__prepare_train(self.session)
        for i in range(steps):
            self.__do_train(self.session, i, data)
            if i %100 == 0:
                self.__add_summary(self.session, i, data)
                self.__print_status(self.session, i, data)

    def __prepare_train(self, session):
        self.summary_writer = tf.train.SummaryWriter(&#39;logs&#39;, graph_def=session.graph_def)
        session.run(tf.initialize_all_variables())

    def __do_train(self, session, i, data):
        session.run(self.train_op, feed_dict=self.train_feed_dict(data))

    def __add_summary(self, session, i, data):
        summary_str = session.run(self.merge_summaries, feed_dict=self.train_feed_dict(data))
        summary_str += session.run(self.merge_summaries, feed_dict=self.test_feed_dict(data))
        self.summary_writer.add_summary(summary_str, i)

    def __print_status(self, session, i, data):
        # 現在のモデルを利用して推移した利益と実際の利益の相関を、訓練データ、テストデータそれぞれで計算し出力する
        train_accuracy = session.run(self.accuracy, feed_dict=self.train_feed_dict(data))
        test_accuracy  = session.run(self.accuracy, feed_dict=self.test_feed_dict(data))
        print &#39;step {} ,train_accuracy={} ,test_accuracy={} &#39;.format(
            i, train_accuracy, test_accuracy)

    def train_feed_dict(self, data):
        return {
            self.trade_data: data.train_data(),
            self.actual_class: data.train_up_down(),
            self.keep_prob: 0.8,
            self.label: &quot;train&quot;
        }

    def test_feed_dict(self, data):
        return {
            self.trade_data: data.test_data(),
            self.actual_class: data.test_up_down(),
            self.keep_prob: 1,
            self.label: &quot;test&quot;
        }

    def __reshape(self, profit_or_loss):
        return profit_or_loss.values.reshape(len(profit_or_loss.values), 1)


class Estimator(Model):

    def estimate( self, data ):
        return self.session.run(tf.argmax(self.output,1), feed_dict=self.estimate_feed_dict(data))

    def estimate_feed_dict(self, data):
        return {
            self.trade_data: data,
            self.keep_prob: 1
        }
```


### train.py

- トレーニングをキックするスクリプトです。
- `TradeResultsLoader` を使って取得したトレードデータを `Trainer` に渡して訓練を行っています。
- 訓練が終わったら、モデルを `./model.ckpt` に永続化します。

```py
# -*- coding: utf-8 -*-

from trade_results_loader import *
from model import *

loader = TradeResultsLoader()
data = TradeResults(loader.retrieve_trade_data())

with Trainer() as trainer:
    trainer.train(10001, data)
    trainer.save(&quot;./model.ckpt&quot;)
```

### train.py の実行

前述のとおり、必要なスクリプトはコンテナ作成時にコピーしているので、コンテナ内で実行すれば、訓練を開始できます。

まずは、TensorFlowコンテナに入ります。

```shell-session
$ docker exec -it jiji_example__tensorflow /bin/bash
```

コンテナ内で以下を実行します。

```sh
$ cd /scripts
$ python train.py
step 0 ,train_accuracy=0.671568632126 ,test_accuracy=0.607843160629 
step 100 ,train_accuracy=0.671568632126 ,test_accuracy=0.607843160629 
step 200 ,train_accuracy=0.671568632126 ,test_accuracy=0.607843160629 
step 300 ,train_accuracy=0.671568632126 ,test_accuracy=0.607843160629 
# 略
step 9600 ,train_accuracy=0.936274528503 ,test_accuracy=0.568627476692 
step 9700 ,train_accuracy=0.965686261654 ,test_accuracy=0.578431367874 
step 9800 ,train_accuracy=0.946078419685 ,test_accuracy=0.558823525906 
step 9900 ,train_accuracy=0.946078419685 ,test_accuracy=0.558823525906 
```

100ステップごとに、モデルを使って訓練データを予測した時の精度と、テストデータを予測した時の精度が出力されます。
訓練は、とりあえず 10000ステップ行うようにしてみました。

最終的には以下の精度になりました。

```sh
step 9900 ,train_accuracy=0.946078419685 ,test_accuracy=0.558823525906 
```

訓練データでの精度は高いのですが、テストデータでの精度は微妙・・・。あてずっぽうよりはましかな・・・。


## 5. バックテストで検証

精度に一抹の不安が残りますが、このまま突き進みます。
次は、訓練したモデルを使って予測した結果を返すREST APIを作ります。

### REST API を作る

- `Estimator` で推測した結果を返す機能を、`Flask` を使ってREST APIで公開します。
- リクエストボディで渡された指標データを正規化して `Estimator` に渡し、予測させた損益結果(`up` or `down`)を返却します。
  - データの正規化に訓練時に使用したデータが必要なので、`TradeResultsLoader` でトレードデータを取得して、`TradeResults` で正規化する処理を入れています。

```py
loader = TradeResultsLoader()

estimator = Estimator()
estimator.__enter__()
estimator.restore(&quot;./model.ckpt&quot;)

trade_data  = loader.retrieve_trade_data()

# webapp
app = Flask(__name__)

@app.route(&#39;/api/estimator&#39;, methods=[&#39;POST&#39;])
def estimate():
    # 値を正規化するため、リクエストボディで渡された指標データと訓練で使用したデータを統合。
    data = pd.DataFrame({k: [v] for k, v in request.json.items()}).append(trade_data)
    # 正規化したデータを渡して、損益を予測
    results = estimator.estimate(TradeResults(data).all_data().iloc[[0]])
    return jsonify(result=(&quot;up&quot; if results[0] == 0 else &quot;down&quot;))

if __name__ == &#39;__main__&#39;:
    app.run(host=&#39;0.0.0.0&#39;)
```

サーバーのソースコードもコンテナにコピーしているので、以下のコマンドでサーバーを起動できます。

```sh
$ cd /scripts
$ python server.py 
```

### フィルタの効果検証

REST APIができたので、Jijiのトレードアルゴリズムから実際に使用してフィルタの効果を検証します。

- 訓練には2006～2014の結果を利用したので、2014～2016 の期間で効果を検証します。
- TensorFlowの予測を使用しない `test` モードでのトレード結果と、予測を使用する `trade` モードでそれぞれバックテストを行い結果を比較します。

まずは、test モードで実行。

1. [バックテスト] - [テストの作成] を開きます。
2. テストの設定を行います。
  - 「テスト名」は適当に入力。
  - 「テスト期間」は、2014-09-01 ～ 2016-08-01 に設定。
  - 「レート間隔」は「1日」にします。
  - 「使用する通貨ペア」で「USDJPY」を選択
  - 「エージェント」の「＋」ボタンを押して、`TensorflowSampleAgent@tensorflow_sample_agent.rb` を追加します。追加後、右下のプロパティで「動作モード」を `test` に設定します。
3. 設定が完了したら、[以下の設定でバックテストを開始] ボタンを押して、テストを実行します。

フィルタなしの場合のトレード結果は以下の通りでした。

![テスト結果_改善前.png](https://qiita-image-store.s3.amazonaws.com/0/137010/5ac69aff-ec74-135f-4260-9db9b40f4748.png)

同様の設定で、動作モードを `trade` にして再度テストを実行。TensorFlow フィルタが適用されます。

![テスト結果_改善後.png](https://qiita-image-store.s3.amazonaws.com/0/137010/0b90792c-9787-8bfd-6d93-fc7f8b3bf265.png)

うーん、微妙。損益とProfit Factorは改善していますが、トレード回数が大幅減・・・。トレードしていないわけではないので、すべて「マイナス」と判定している訳ではなそさそうですが、「マイナス」寄りに大きく傾いている気がしますね・・・。

## 6. アルゴリズムを使って実際の口座でトレード

最後に、一応、アルゴリズムを使って実際の口座でトレードするところまで解説しておきます。といっても、アルゴリズム(エージェント)を [リアルトレード]-[エージェント]に登録するだけですが。

![リアルトレード.png](https://qiita-image-store.s3.amazonaws.com/0/137010/28de6c1d-df6e-fecf-4854-a66a7983b4d8.png)


登録すれば、実際の口座(個人口座orデモ口座)でアルゴリズムの運用を開始できます。
もちろん、事前に十分な動作確認を行ってくださいね。

## まとめ

チュートリアルは以上です。

フィルタとしての効果は微妙でしたが、説明変数として渡すデータやモデルの設定を調整すれば改善できる余地はあるかもしれません。また、そもそも、ベースとしている移動平均を使ったトレードアルゴリズムの予測能力も低いので、これをもっと良いものに変えることで結果を良くすることができる可能性もあります。興味がある方は、環境を作っていろいろ試してみてください。

TensorFlowのような機械学習ライブラリやOANDA REST APIの登場で、個人でも手軽に先端技術を利用したシステムトレードを試せる環境が整ってきているように思います。データ分析や機械学習の勉強も兼ねて、システムトレードに取り組んでみるのも面白いのではないでしょうか?
</textarea><input type="submit" name="commit" value="Save changes" data-disable-with="Save changes" /></form></div></section></div><div class="col-sm-3"><div class="socialButtons"><div class="socialButtons_twitter"><a class="twitter-share-button" data-text="TensorFlowを使った為替(FX)のトレードシステムを作るチュートリアル  ～システムのセットアップからトレードまで～ by @jiji_platform on @Qiita" data-url="http://qiita.com/jiji_platform/items/268377c542706e6f44b1" href="https://twitter.com/share">Tweet</a></div><div class="socialButtons_hatebu"><a class="hatena-bookmark-button" data-hatena-bookmark-layout="simple-balloon" data-hatena-bookmark-title="TensorFlowを使った為替(FX)のトレードシステムを作るチュートリアル  ～システムのセットアップからトレードまで～" href="http://b.hatena.ne.jp/entry/http://qiita.com/jiji_platform/items/268377c542706e6f44b1" title="Add to Hatena Bookmark"><img alt="Add to Hatena Bookmark" height="20" src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" style="border: none;" width="20" /></a><script async="async" charset="utf-8" src="https://b.st-hatena.com/js/bookmark_button.js" type="text/javascript"></script></div><div class="socialButtons_googlePlus"><div class="g-plusone" data-href="http://qiita.com/jiji_platform/items/268377c542706e6f44b1" data-size="medium"></div></div><div class="socialButtons_facebook"><div class="fb-like" data-action="like" data-href="http://qiita.com/jiji_platform/items/268377c542706e6f44b1" data-layout="button_count" data-share="false" data-show-faces="false"></div></div><div class="socialButtons_pocket"><a class="pocket-btn" data-lang="en" data-pocket-count="horizontal" data-pocket-label="pocket"></a></div></div><section class="itemsShowAuthorInfo" itemprop="author" itemscope="" itemtype="http://schema.org/Person"><a href="/jiji_platform"><img alt="" class="itemsShowAuthorInfo_userIcon" itemprop="image" src="https://qiita-image-store.s3.amazonaws.com/0/137010/profile-images/1473720139" /></a><div class="itemsShowAuthorInfo_profileStats"><strong class="itemsShowAuthorInfo_userName" itemprop="name"><a itemprop="url" href="/jiji_platform">jiji_platform</a></strong><div class="itemsShowAuthorInfo_contribution"><span class="itemsShowAuthorInfo_count">894</span><span class="itemsShowAuthorInfo_unit">Contribution</span></div><div id="js-react-on-rails-context" data-rails-context="{}"></div>
<div class="js-react-on-rails-component" data-component-name="UserFollowButton" data-props="{&quot;initial_followed_by&quot;:false,&quot;position&quot;:&quot;author-info&quot;,&quot;size&quot;:&quot;btn-xs&quot;,&quot;url_name&quot;:&quot;jiji_platform&quot;}" data-trace="false" data-dom-id="UserFollowButton-react-component-490f3253-207b-4ddf-b521-69ece0e6ce0b"></div>
    <div id="UserFollowButton-react-component-490f3253-207b-4ddf-b521-69ece0e6ce0b"></div>
    
</div><section class="itemsShowAuthorPopularItems"><h5 class="itemsShowAuthorPopularItems_sectionTitle">人気の投稿</h5><ul class="itemsShowAuthorPopularItems_posts list-unstyled"><li itemscope="" itemtype="http://schema.org/Article"> <a itemprop="url" track="click" data-label="AuthorPopularItemsAtSidebar" href="/jiji_platform/items/268377c542706e6f44b1">TensorFlowを使った為替(FX)のトレードシステムを作るチュートリアル  ～システムのセットアップからトレードまで～</a></li></ul></section></section><div class="scroll-chaser"><div class="google-adsense"><style>.test-text-responsible { width: 200px; height: 200px; }@media(min-width: 1200px) {  .test-text-responsible { width: 250px; height: 250px; }}@media(max-width: 979px) and (min-width: 768px) {  .test-text-responsible { width: 120px; height: 240px; }}@media(max-width: 767px) {  .test-text-responsible { width: 320px; height: 50px; }}</style><script async="" src="http://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><ins class="adsbygoogle test-text-responsible" data-ad-client="ca-pub-8127218772604357" data-ad-slot="3880091879" style="display:inline-block"></ins><script>(adsbygoogle = window.adsbygoogle || []).push({});</script></div></div><div class="js-react-on-rails-component" data-component-name="Toc" data-props="{&quot;body&quot;:&quot;\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E6%A7%8B%E6%88%90\&quot;\u003eシステム構成\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#tensorflow%E3%81%A7%E4%BA%88%E6%B8%AC%E3%81%99%E3%82%8B%E5%86%85%E5%AE%B9\&quot;\u003eTensorFlowで予測する内容\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E3%83%81%E3%83%A5%E3%83%BC%E3%83%88%E3%83%AA%E3%82%A2%E3%83%AB\&quot;\u003eチュートリアル\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#0-%E5%89%8D%E6%8F%90%E6%9D%A1%E4%BB%B6\&quot;\u003e0. 前提条件\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#1-oanda-japan-%E3%82%A2%E3%82%AB%E3%82%A6%E3%83%B3%E3%83%88%E3%81%AE%E7%94%A8%E6%84%8F\&quot;\u003e1. OANDA Japan アカウントの用意\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#2-%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E3%81%AE%E3%82%BB%E3%83%83%E3%83%88%E3%82%A2%E3%83%83%E3%83%97\&quot;\u003e2. システムのセットアップ\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC%E8%A8%BC%E6%98%8E%E6%9B%B8%E3%81%AE%E6%BA%96%E5%82%99\&quot;\u003eサーバー証明書の準備\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E8%A8%AD%E5%AE%9A%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%AE%E7%B7%A8%E9%9B%86\&quot;\u003e設定ファイルの編集\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E3%81%AE%E8%B5%B7%E5%8B%95\&quot;\u003eシステムの起動\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#jiji%E3%81%AE%E5%88%9D%E6%9C%9F%E8%A8%AD%E5%AE%9A\&quot;\u003eJijiの初期設定\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#3-%E3%83%88%E3%83%AC%E3%83%BC%E3%83%89%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E5%8F%8E%E9%9B%86\&quot;\u003e3. トレードデータの収集\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E3%83%88%E3%83%AC%E3%83%BC%E3%83%89%E3%82%A2%E3%83%AB%E3%82%B4%E3%83%AA%E3%82%BA%E3%83%A0%E3%82%A8%E3%83%BC%E3%82%B8%E3%82%A7%E3%83%B3%E3%83%88%E3%82%92%E4%BD%9C%E3%82%8B\&quot;\u003eトレードアルゴリズム(エージェント)を作る\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#tradeandsignals\&quot;\u003eTradeAndSignals\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#signalcalculator\&quot;\u003eSignalCalculator\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#tensorflowsampleagent\&quot;\u003eTensorFlowSampleAgent\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E8%A8%93%E7%B7%B4%E7%94%A8%E3%83%87%E3%83%BC%E3%82%BF%E3%82%92%E5%8F%96%E9%9B%86%E3%81%99%E3%82%8B\&quot;\u003e訓練用データを取集する\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E3%82%A8%E3%83%BC%E3%82%B8%E3%82%A7%E3%83%B3%E3%83%88%E3%81%AE%E7%99%BB%E9%8C%B2\&quot;\u003eエージェントの登録\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E3%83%90%E3%83%83%E3%82%AF%E3%83%86%E3%82%B9%E3%83%88%E3%81%AE%E5%AE%9F%E8%A1%8C\&quot;\u003eバックテストの実行\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#4-%E3%83%88%E3%83%AC%E3%83%BC%E3%83%8B%E3%83%B3%E3%82%B0\&quot;\u003e4. トレーニング\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#traderesultsloader\&quot;\u003eTradeResultsLoader\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#traderesults\&quot;\u003eTradeResults\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#trainer--estimator--model\&quot;\u003eTrainer \u0026amp; Estimator \u0026amp; Model\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#trainpy\&quot;\u003etrain.py\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#trainpy-%E3%81%AE%E5%AE%9F%E8%A1%8C\&quot;\u003etrain.py の実行\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#5-%E3%83%90%E3%83%83%E3%82%AF%E3%83%86%E3%82%B9%E3%83%88%E3%81%A7%E6%A4%9C%E8%A8%BC\&quot;\u003e5. バックテストで検証\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#rest-api-%E3%82%92%E4%BD%9C%E3%82%8B\&quot;\u003eREST API を作る\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E3%83%95%E3%82%A3%E3%83%AB%E3%82%BF%E3%81%AE%E5%8A%B9%E6%9E%9C%E6%A4%9C%E8%A8%BC\&quot;\u003eフィルタの効果検証\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#6-%E3%82%A2%E3%83%AB%E3%82%B4%E3%83%AA%E3%82%BA%E3%83%A0%E3%82%92%E4%BD%BF%E3%81%A3%E3%81%A6%E5%AE%9F%E9%9A%9B%E3%81%AE%E5%8F%A3%E5%BA%A7%E3%81%A7%E3%83%88%E3%83%AC%E3%83%BC%E3%83%89\&quot;\u003e6. アルゴリズムを使って実際の口座でトレード\u003c/a\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003ca href=\&quot;#%E3%81%BE%E3%81%A8%E3%82%81\&quot;\u003eまとめ\u003c/a\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n&quot;,&quot;wrapper&quot;:&quot;#article-body-wrapper&quot;}" data-trace="false" data-dom-id="Toc-react-component-0395d6c0-3136-4851-afc9-5e31ed11cbab"></div>
    <div id="Toc-react-component-0395d6c0-3136-4851-afc9-5e31ed11cbab"></div>
    
</div></div><div class="row"><div class="col-sm-9"><div class="ArticleFooter__menu"><div class="s-flex-align-center"><div class="js-likebutton" data-props="{&quot;like_status&quot;:false,&quot;like_count&quot;:893,&quot;show_count&quot;:true,&quot;uuid&quot;:&quot;268377c542706e6f44b1&quot;,&quot;likable_type&quot;:&quot;Article&quot;,&quot;position&quot;:&quot;article-footer&quot;}"></div><div class="ArticleFooter__userList"><div class="ArticleFooter__user"><div class="js-hovercard" data-hovercard-target-name="sliker-kiley"><a itemprop="url" href="/sliker-kiley"><img alt="sliker-kiley" class="thumb thumb--xs" src="https://qiita-image-store.s3.amazonaws.com/0/87567/profile-images/1473704134" /></a></div></div><div class="ArticleFooter__user"><div class="js-hovercard" data-hovercard-target-name="immmmmmmm"><a itemprop="url" href="/immmmmmmm"><img alt="immmmmmmm" class="thumb thumb--xs" src="https://qiita-image-store.s3.amazonaws.com/0/82303/profile-images/1473702402" /></a></div></div><div class="ArticleFooter__user"><div class="js-hovercard" data-hovercard-target-name="toyolab"><a itemprop="url" href="/toyolab"><img alt="toyolab" class="thumb thumb--xs" src="https://qiita-image-store.s3.amazonaws.com/0/131169/profile-images/1473718172" /></a></div></div><div class="ArticleFooter__user"><div class="js-hovercard" data-hovercard-target-name="Tamann17"><a itemprop="url" href="/Tamann17"><img alt="Tamann17" class="thumb thumb--xs" src="https://qiita-image-store.s3.amazonaws.com/0/41493/profile-images/1482496501" /></a></div></div><div class="ArticleFooter__user"><div class="js-hovercard" data-hovercard-target-name="high5"><a itemprop="url" href="/high5"><img alt="high5" class="thumb thumb--xs" src="https://qiita-image-store.s3.amazonaws.com/0/42885/profile-images/1473689327" /></a></div></div><div class="ArticleFooter__user"><div class="js-hovercard" data-hovercard-target-name="driller"><a itemprop="url" href="/driller"><img alt="driller" class="thumb thumb--xs" src="https://qiita-image-store.s3.amazonaws.com/0/22023/profile-images/1477644793" /></a></div></div><div class="ArticleFooter__user"><div class="js-hovercard" data-hovercard-target-name="mofoolog"><a itemprop="url" href="/mofoolog"><img alt="mofoolog" class="thumb thumb--xs" src="https://qiita-image-store.s3.amazonaws.com/0/73019/profile-images/1473699355" /></a></div></div><div class="ArticleFooter__user"><div class="js-hovercard" data-hovercard-target-name="danzig1972"><a itemprop="url" href="/danzig1972"><img alt="danzig1972" class="thumb thumb--xs" src="https://qiita-image-store.s3.amazonaws.com/0/100755/profile-images/1473708196" /></a></div></div><div class="ArticleFooter__user"><div class="js-hovercard" data-hovercard-target-name="MakitoTashiro"><a itemprop="url" href="/MakitoTashiro"><img alt="MakitoTashiro" class="thumb thumb--xs" src="https://qiita-image-store.s3.amazonaws.com/0/66608/profile-images/1473697262" /></a></div></div><div class="ArticleFooter__user"><div class="js-hovercard" data-hovercard-target-name="nabeen"><a itemprop="url" href="/nabeen"><img alt="nabeen" class="thumb thumb--xs" src="https://qiita-image-store.s3.amazonaws.com/0/44007/profile-images/1474941720" /></a></div></div><div class="ArticleFooter__user"><a href="/jiji_platform/items/268377c542706e6f44b1/likers"><span class="fa fa-ellipsis-h"></span></a></div></div></div><div class="u-flex u-align-center"><div class="ArticleFooter__stock"><div class="js-stockbutton" data-position="footer_menu" data-props="{&quot;stock_status&quot;:false}"></div></div><div class="ArticleFooter__editRequest"><a class="u-link-no-underline" data-toggle="tooltip" title="You can propose improvements about the article to the author 💪" href="/drafts/268377c542706e6f44b1/edit"><span class="fa fa-send-o fa-lg"></span> <span>Edit request</span></a></div><div class="dropdown ArticleFooter__dropdown"><a class="dropdown-toggle" data-toggle="dropdown" href="#"><span class="fa fa-ellipsis-h"></span></a><ul class="dropdown-menu dropdown-menu-right"><li><a href="/jiji_platform/items/268377c542706e6f44b1.md"><span class="fa fa-fw fa-file-text-o"></span> Show article as Markdown</a></li><li><a data-target=".js-report-form" data-toggle="modal" href="#"><i class="fa fa-fw fa-flag"></i> Report article</a></li></ul></div></div></div><ul class="references js-referencesView"><li class="references_header"><i class="fa fa-fw fa-link"></i> Linked from these articles</li><a class="references_toggleOldReferences js-toggleOldReferences" href="#"><i class="fa fa-expand js-toggleOldReferencesIcon"></i><span class="js-toggleOldReferencesText">Show old 1 links</span></a><li class="references_reference js-reference js-oldReference"><span>Linked from </span><a href="/ryo_grid/items/7746528f8cae8026b936#_reference-01dadab7aebfde7cf523"><img alt="" width="18" height="18" src="https://qiita-image-store.s3.amazonaws.com/0/12325/profile-images/1473682364" />ディープラーニングでFXシステムトレード</a><time class="references_datetime js-dateTimeView" datetime="2016-08-16T12:12:26+00:00">7 months ago</time></li><li class="references_reference js-reference"><span>Linked from </span><a href="/regonn/items/4dac96d6c609d9fbe038#_reference-006c60e0573f4603e236"><img alt="" width="18" height="18" src="https://qiita-image-store.s3.amazonaws.com/0/10375/profile-images/1473681690" />FXシステムトーレードツール jiji の Tensorflow サンプルを複数通貨対応 + Digital Ocean VPS(CentOS7) で動かす</a><time class="references_datetime js-dateTimeView" datetime="2016-10-26T00:48:10+00:00">5 months ago</time></li><li class="references_reference js-reference"><span>Linked from </span><a href="/egplnt/items/3246711349bc1d97bdb8#_reference-9d8b9b178805e24b7daf"><img alt="" width="18" height="18" src="https://qiita-image-store.s3.amazonaws.com/0/125842/profile-images/1473716363" />TensorFlowを使ってIoTデータを人工知能してみる</a><time class="references_datetime js-dateTimeView" datetime="2016-10-31T06:15:58+00:00">5 months ago</time></li><li class="references_reference js-reference"><span>Linked from </span><a href="/egplnt/items/217df26ad2d34a8cc7d4#_reference-9d52044a2a9201edacc4"><img alt="" width="18" height="18" src="https://qiita-image-store.s3.amazonaws.com/0/125842/profile-images/1473716363" />TensorFlowで位置情報を人工知能してみる</a><time class="references_datetime js-dateTimeView" datetime="2016-10-31T07:08:57+00:00">5 months ago</time></li><li class="references_reference js-reference"><span>Linked from </span><a href="/egplnt/items/57858179911c814476a1#_reference-c1579d89846727f63912"><img alt="" width="18" height="18" src="https://qiita-image-store.s3.amazonaws.com/0/125842/profile-images/1473716363" />TensorFlowを使ってIoTデータを人工知能してみる - 練習</a><time class="references_datetime js-dateTimeView" datetime="2016-11-06T23:54:54+00:00">4 months ago</time></li><li class="references_reference js-reference"><span>Linked from </span><a href="/hayatoy/items/b9ddf4d6d8e026dc15e5#_reference-248d22fe19e14009849d"><img alt="" width="18" height="18" src="https://qiita-image-store.s3.amazonaws.com/0/162369/profile-images/1486219951" />TensorFlow (ディープラーニング)で為替(FX)の予測をしてみる</a><time class="references_datetime js-dateTimeView" datetime="2017-02-04T14:39:15+00:00">about 1 month ago</time></li></ul><div class="itemsShowBody_articleColumnFooter"><div class="socialButtons"><div class="socialButtons_twitter"><a class="twitter-share-button" data-text="TensorFlowを使った為替(FX)のトレードシステムを作るチュートリアル  ～システムのセットアップからトレードまで～ by @jiji_platform on @Qiita" data-url="http://qiita.com/jiji_platform/items/268377c542706e6f44b1" href="https://twitter.com/share">Tweet</a></div><div class="socialButtons_hatebu"><a class="hatena-bookmark-button" data-hatena-bookmark-layout="simple-balloon" data-hatena-bookmark-title="TensorFlowを使った為替(FX)のトレードシステムを作るチュートリアル  ～システムのセットアップからトレードまで～" href="http://b.hatena.ne.jp/entry/http://qiita.com/jiji_platform/items/268377c542706e6f44b1" title="Add to Hatena Bookmark"><img alt="Add to Hatena Bookmark" height="20" src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" style="border: none;" width="20" /></a><script async="async" charset="utf-8" src="https://b.st-hatena.com/js/bookmark_button.js" type="text/javascript"></script></div><div class="socialButtons_googlePlus"><div class="g-plusone" data-href="http://qiita.com/jiji_platform/items/268377c542706e6f44b1" data-size="medium"></div></div><div class="socialButtons_facebook"><div class="fb-like" data-action="like" data-href="http://qiita.com/jiji_platform/items/268377c542706e6f44b1" data-layout="button_count" data-share="false" data-show-faces="false"></div></div><div class="socialButtons_pocket"><a class="pocket-btn" data-lang="en" data-pocket-count="horizontal" data-pocket-label="pocket"></a></div></div></div><div class="itemsShowComment_wrapper" id="comments"><div class="js-react-on-rails-component" data-component-name="CommentListContainer" data-props="{&quot;currentUser&quot;:null,&quot;initialComments&quot;:[{&quot;banned&quot;:false,&quot;body&quot;:&quot;\u003cp\u003eとてもおもしろい記事、ありがとうございます。時間があるときに試してみたいと思います！\u003c/p\u003e\n&quot;,&quot;created_at&quot;:&quot;2016-09-15T14:18:06+09:00&quot;,&quot;expanded_references&quot;:&quot;&quot;,&quot;id&quot;:636847,&quot;is_team&quot;:false,&quot;item_id&quot;:415694,&quot;item_type&quot;:&quot;PublicDomainArticle&quot;,&quot;item_uuid&quot;:&quot;268377c542706e6f44b1&quot;,&quot;likable&quot;:false,&quot;liked&quot;:false,&quot;public_likes_count&quot;:0,&quot;raw_body&quot;:&quot;とてもおもしろい記事、ありがとうございます。時間があるときに試してみたいと思います！\n&quot;,&quot;reaction_types&quot;:[{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f44d.png&quot;,&quot;name&quot;:&quot;+1&quot;},{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f64f.png&quot;,&quot;name&quot;:&quot;pray&quot;},{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f389.png&quot;,&quot;name&quot;:&quot;tada&quot;},{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f647.png&quot;,&quot;name&quot;:&quot;bow&quot;},{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f631.png&quot;,&quot;name&quot;:&quot;scream&quot;},{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f440.png&quot;,&quot;name&quot;:&quot;eyes&quot;}],&quot;reactions&quot;:[],&quot;team&quot;:null,&quot;team_membership&quot;:null,&quot;updatable&quot;:false,&quot;url&quot;:&quot;http://qiita.com/jiji_platform/items/268377c542706e6f44b1#comment-6158fc2e97d27e59a106&quot;,&quot;user&quot;:{&quot;contribution&quot;:155,&quot;created_at&quot;:&quot;2015-05-06T12:49:55+09:00&quot;,&quot;id&quot;:77722,&quot;is_admin&quot;:false,&quot;profile_image_url&quot;:&quot;https://qiita-image-store.s3.amazonaws.com/0/77722/profile-images/1473700920&quot;,&quot;suspended&quot;:false,&quot;url_name&quot;:&quot;windows222&quot;},&quot;uuid&quot;:&quot;6158fc2e97d27e59a106&quot;,&quot;via_email&quot;:false},{&quot;banned&quot;:false,&quot;body&quot;:&quot;\u003cp\u003e面白いので、動かしてみています。\u003cbr\u003e\n通貨ペアはドル円のみでしょうか？\u003cbr\u003e\njijiのテストで南アランドを指定するとエラーが出てしまいました。\u003c/p\u003e\n&quot;,&quot;created_at&quot;:&quot;2016-09-18T01:44:09+09:00&quot;,&quot;expanded_references&quot;:&quot;&quot;,&quot;id&quot;:638551,&quot;is_team&quot;:false,&quot;item_id&quot;:415694,&quot;item_type&quot;:&quot;PublicDomainArticle&quot;,&quot;item_uuid&quot;:&quot;268377c542706e6f44b1&quot;,&quot;likable&quot;:false,&quot;liked&quot;:false,&quot;public_likes_count&quot;:0,&quot;raw_body&quot;:&quot;面白いので、動かしてみています。\n通貨ペアはドル円のみでしょうか？\njijiのテストで南アランドを指定するとエラーが出てしまいました。\n&quot;,&quot;reaction_types&quot;:[{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f44d.png&quot;,&quot;name&quot;:&quot;+1&quot;},{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f64f.png&quot;,&quot;name&quot;:&quot;pray&quot;},{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f389.png&quot;,&quot;name&quot;:&quot;tada&quot;},{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f647.png&quot;,&quot;name&quot;:&quot;bow&quot;},{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f631.png&quot;,&quot;name&quot;:&quot;scream&quot;},{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f440.png&quot;,&quot;name&quot;:&quot;eyes&quot;}],&quot;reactions&quot;:[],&quot;team&quot;:null,&quot;team_membership&quot;:null,&quot;updatable&quot;:false,&quot;url&quot;:&quot;http://qiita.com/jiji_platform/items/268377c542706e6f44b1#comment-ce3c7d50c7a11e7ebba1&quot;,&quot;user&quot;:{&quot;contribution&quot;:0,&quot;created_at&quot;:&quot;2015-12-01T08:34:21+09:00&quot;,&quot;id&quot;:103267,&quot;is_admin&quot;:false,&quot;profile_image_url&quot;:&quot;https://qiita-image-store.s3.amazonaws.com/0/103267/profile-images/1473708960&quot;,&quot;suspended&quot;:false,&quot;url_name&quot;:&quot;k501&quot;},&quot;uuid&quot;:&quot;ce3c7d50c7a11e7ebba1&quot;,&quot;via_email&quot;:false},{&quot;banned&quot;:false,&quot;body&quot;:&quot;\u003cp\u003eチュートリアルのサンプルは ドル円 を使うようになっています。\u003cbr\u003e\n以下のように改変すれば南アランドも試せます。\u003c/p\u003e\n\n\u003col\u003e\n\u003cli\u003e\n\u003ca href=\&quot;https://github.com/unageanu/jiji-with-tensorflow-example/blob/master/agents/tensorflow_sample_agent.rb\&quot; rel=\&quot;nofollow noopener\&quot; target=\&quot;_blank\&quot;\u003eエージェント\u003c/a\u003eで \u003ccode\u003e:USDJPY\u003c/code\u003e を使用している箇所を \u003ccode\u003e:ZARJPY\u003c/code\u003e に置換\u003c/li\u003e\n\u003cli\u003eバックテスト作成時の「使用する通貨ペア」で \u003ccode\u003e:ZARJPY\u003c/code\u003e を選択\u003c/li\u003e\n\u003c/ol\u003e\n&quot;,&quot;created_at&quot;:&quot;2016-09-18T05:53:54+09:00&quot;,&quot;expanded_references&quot;:&quot;&quot;,&quot;id&quot;:638556,&quot;is_team&quot;:false,&quot;item_id&quot;:415694,&quot;item_type&quot;:&quot;PublicDomainArticle&quot;,&quot;item_uuid&quot;:&quot;268377c542706e6f44b1&quot;,&quot;likable&quot;:false,&quot;liked&quot;:false,&quot;public_likes_count&quot;:0,&quot;raw_body&quot;:&quot;チュートリアルのサンプルは ドル円 を使うようになっています。\n以下のように改変すれば南アランドも試せます。\n\n1. [エージェント](https://github.com/unageanu/jiji-with-tensorflow-example/blob/master/agents/tensorflow_sample_agent.rb)で `:USDJPY` を使用している箇所を `:ZARJPY` に置換\n2. バックテスト作成時の「使用する通貨ペア」で `:ZARJPY` を選択\n&quot;,&quot;reaction_types&quot;:[{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f44d.png&quot;,&quot;name&quot;:&quot;+1&quot;},{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f64f.png&quot;,&quot;name&quot;:&quot;pray&quot;},{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f389.png&quot;,&quot;name&quot;:&quot;tada&quot;},{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f647.png&quot;,&quot;name&quot;:&quot;bow&quot;},{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f631.png&quot;,&quot;name&quot;:&quot;scream&quot;},{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f440.png&quot;,&quot;name&quot;:&quot;eyes&quot;}],&quot;reactions&quot;:[],&quot;team&quot;:null,&quot;team_membership&quot;:null,&quot;updatable&quot;:false,&quot;url&quot;:&quot;http://qiita.com/jiji_platform/items/268377c542706e6f44b1#comment-3c8f19b5ebf9c1433c96&quot;,&quot;user&quot;:{&quot;contribution&quot;:894,&quot;created_at&quot;:&quot;2016-08-13T09:19:55+09:00&quot;,&quot;id&quot;:137010,&quot;is_admin&quot;:false,&quot;profile_image_url&quot;:&quot;https://qiita-image-store.s3.amazonaws.com/0/137010/profile-images/1473720139&quot;,&quot;suspended&quot;:false,&quot;url_name&quot;:&quot;jiji_platform&quot;},&quot;uuid&quot;:&quot;3c8f19b5ebf9c1433c96&quot;,&quot;via_email&quot;:false},{&quot;banned&quot;:false,&quot;body&quot;:&quot;\u003cp\u003eありがとうございますー。試してみます！\u003c/p\u003e\n&quot;,&quot;created_at&quot;:&quot;2016-09-19T01:19:24+09:00&quot;,&quot;expanded_references&quot;:&quot;&quot;,&quot;id&quot;:638689,&quot;is_team&quot;:false,&quot;item_id&quot;:415694,&quot;item_type&quot;:&quot;PublicDomainArticle&quot;,&quot;item_uuid&quot;:&quot;268377c542706e6f44b1&quot;,&quot;likable&quot;:false,&quot;liked&quot;:false,&quot;public_likes_count&quot;:0,&quot;raw_body&quot;:&quot;ありがとうございますー。試してみます！\n&quot;,&quot;reaction_types&quot;:[{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f44d.png&quot;,&quot;name&quot;:&quot;+1&quot;},{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f64f.png&quot;,&quot;name&quot;:&quot;pray&quot;},{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f389.png&quot;,&quot;name&quot;:&quot;tada&quot;},{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f647.png&quot;,&quot;name&quot;:&quot;bow&quot;},{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f631.png&quot;,&quot;name&quot;:&quot;scream&quot;},{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f440.png&quot;,&quot;name&quot;:&quot;eyes&quot;}],&quot;reactions&quot;:[],&quot;team&quot;:null,&quot;team_membership&quot;:null,&quot;updatable&quot;:false,&quot;url&quot;:&quot;http://qiita.com/jiji_platform/items/268377c542706e6f44b1#comment-f11968af271810c0ea5d&quot;,&quot;user&quot;:{&quot;contribution&quot;:0,&quot;created_at&quot;:&quot;2015-12-01T08:34:21+09:00&quot;,&quot;id&quot;:103267,&quot;is_admin&quot;:false,&quot;profile_image_url&quot;:&quot;https://qiita-image-store.s3.amazonaws.com/0/103267/profile-images/1473708960&quot;,&quot;suspended&quot;:false,&quot;url_name&quot;:&quot;k501&quot;},&quot;uuid&quot;:&quot;f11968af271810c0ea5d&quot;,&quot;via_email&quot;:false},{&quot;banned&quot;:false,&quot;body&quot;:&quot;\u003cp\u003eherokuでpythonをうまく走らせられずやきもきしてます。そのあたりのチュートリアルもあると助かります。\u003c/p\u003e\n&quot;,&quot;created_at&quot;:&quot;2016-09-20T01:02:06+09:00&quot;,&quot;expanded_references&quot;:&quot;&quot;,&quot;id&quot;:638916,&quot;is_team&quot;:false,&quot;item_id&quot;:415694,&quot;item_type&quot;:&quot;PublicDomainArticle&quot;,&quot;item_uuid&quot;:&quot;268377c542706e6f44b1&quot;,&quot;likable&quot;:false,&quot;liked&quot;:false,&quot;public_likes_count&quot;:0,&quot;raw_body&quot;:&quot;herokuでpythonをうまく走らせられずやきもきしてます。そのあたりのチュートリアルもあると助かります。\n&quot;,&quot;reaction_types&quot;:[{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f44d.png&quot;,&quot;name&quot;:&quot;+1&quot;},{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f64f.png&quot;,&quot;name&quot;:&quot;pray&quot;},{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f389.png&quot;,&quot;name&quot;:&quot;tada&quot;},{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f647.png&quot;,&quot;name&quot;:&quot;bow&quot;},{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f631.png&quot;,&quot;name&quot;:&quot;scream&quot;},{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f440.png&quot;,&quot;name&quot;:&quot;eyes&quot;}],&quot;reactions&quot;:[],&quot;team&quot;:null,&quot;team_membership&quot;:null,&quot;updatable&quot;:false,&quot;url&quot;:&quot;http://qiita.com/jiji_platform/items/268377c542706e6f44b1#comment-8dabc6be19dbb80d24fc&quot;,&quot;user&quot;:{&quot;contribution&quot;:10,&quot;created_at&quot;:&quot;2016-01-29T09:21:07+09:00&quot;,&quot;id&quot;:111231,&quot;is_admin&quot;:false,&quot;profile_image_url&quot;:&quot;https://qiita-image-store.s3.amazonaws.com/0/111231/profile-images/1473711493&quot;,&quot;suspended&quot;:false,&quot;url_name&quot;:&quot;tanizya&quot;},&quot;uuid&quot;:&quot;8dabc6be19dbb80d24fc&quot;,&quot;via_email&quot;:false},{&quot;banned&quot;:false,&quot;body&quot;:&quot;\u003cp\u003e私の環境では、通常のyumインストールの他に下記のコマンドを実行する必要がありました。\u003cbr\u003e\n sudo yum install -y python-devel\u003cbr\u003e\n sudo pip install backports.ssl_match_hostname --upgrade\u003c/p\u003e\n&quot;,&quot;created_at&quot;:&quot;2016-09-20T20:18:53+09:00&quot;,&quot;expanded_references&quot;:&quot;&quot;,&quot;id&quot;:639572,&quot;is_team&quot;:false,&quot;item_id&quot;:415694,&quot;item_type&quot;:&quot;PublicDomainArticle&quot;,&quot;item_uuid&quot;:&quot;268377c542706e6f44b1&quot;,&quot;likable&quot;:false,&quot;liked&quot;:false,&quot;public_likes_count&quot;:1,&quot;raw_body&quot;:&quot;私の環境では、通常のyumインストールの他に下記のコマンドを実行する必要がありました。\n sudo yum install -y python-devel\n sudo pip install backports.ssl_match_hostname --upgrade\n&quot;,&quot;reaction_types&quot;:[{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f44d.png&quot;,&quot;name&quot;:&quot;+1&quot;},{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f64f.png&quot;,&quot;name&quot;:&quot;pray&quot;},{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f389.png&quot;,&quot;name&quot;:&quot;tada&quot;},{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f647.png&quot;,&quot;name&quot;:&quot;bow&quot;},{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f631.png&quot;,&quot;name&quot;:&quot;scream&quot;},{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f440.png&quot;,&quot;name&quot;:&quot;eyes&quot;}],&quot;reactions&quot;:[],&quot;team&quot;:null,&quot;team_membership&quot;:null,&quot;updatable&quot;:false,&quot;url&quot;:&quot;http://qiita.com/jiji_platform/items/268377c542706e6f44b1#comment-e8bb9be9a51f5ca66fe3&quot;,&quot;user&quot;:{&quot;contribution&quot;:155,&quot;created_at&quot;:&quot;2015-05-06T12:49:55+09:00&quot;,&quot;id&quot;:77722,&quot;is_admin&quot;:false,&quot;profile_image_url&quot;:&quot;https://qiita-image-store.s3.amazonaws.com/0/77722/profile-images/1473700920&quot;,&quot;suspended&quot;:false,&quot;url_name&quot;:&quot;windows222&quot;},&quot;uuid&quot;:&quot;e8bb9be9a51f5ca66fe3&quot;,&quot;via_email&quot;:false},{&quot;banned&quot;:false,&quot;body&quot;:&quot;\u003cp\u003eチュートリアルの下記コマンドを実行してみましたがjijiが起動しません。\u003cbr\u003e\n\u003ccode\u003esudo docker-compose up -d\u003c/code\u003e\u003c/p\u003e\n\n\u003cp\u003eメッセージは下記です。証明書のオープンでエラーとなってしまっている様です。。。\u003c/p\u003e\n\n\u003cdiv class=\&quot;code-frame\&quot; data-lang=\&quot;\&quot;\u003e\n\u003cdiv class=\&quot;code-lang\&quot;\u003e\u003cspan class=\&quot;bold\&quot;\u003e実行結果\u003c/span\u003e\u003c/div\u003e\n\u003cdiv class=\&quot;highlight\&quot;\u003e\u003cpre\u003e\n...\njiji_example__nginx | nginx: [emerg] BIO_new_file(\&quot;/etc/nginx/cert/ssl.crt\&quot;) failed (SSL: error:0200100D:system library:fopen:Permission denied:fopen(&#39;/etc/nginx/cert/ssl.crt&#39;,&#39;r&#39;) error:2006D002:BIO routines:BIO_new_file:system lib)\njiji_example__tensorflow | [I 14:37:43.607 NotebookApp] Writing notebook server cookie secret to /root/.local/share/jupyter/runtime/notebook_cookie_secret\njiji_example__nginx exited with code 1\n\u003c/pre\u003e\u003c/div\u003e\n\u003c/div\u003e\n&quot;,&quot;created_at&quot;:&quot;2016-09-20T23:48:20+09:00&quot;,&quot;expanded_references&quot;:&quot;&quot;,&quot;id&quot;:639702,&quot;is_team&quot;:false,&quot;item_id&quot;:415694,&quot;item_type&quot;:&quot;PublicDomainArticle&quot;,&quot;item_uuid&quot;:&quot;268377c542706e6f44b1&quot;,&quot;likable&quot;:false,&quot;liked&quot;:false,&quot;public_likes_count&quot;:0,&quot;raw_body&quot;:&quot;チュートリアルの下記コマンドを実行してみましたがjijiが起動しません。\n``sudo docker-compose up -d``\n\nメッセージは下記です。証明書のオープンでエラーとなってしまっている様です。。。\n\n```:実行結果\n...\njiji_example__nginx | nginx: [emerg] BIO_new_file(\&quot;/etc/nginx/cert/ssl.crt\&quot;) failed (SSL: error:0200100D:system library:fopen:Permission denied:fopen(&#39;/etc/nginx/cert/ssl.crt&#39;,&#39;r&#39;) error:2006D002:BIO routines:BIO_new_file:system lib)\njiji_example__tensorflow | [I 14:37:43.607 NotebookApp] Writing notebook server cookie secret to /root/.local/share/jupyter/runtime/notebook_cookie_secret\njiji_example__nginx exited with code 1\n```\n&quot;,&quot;reaction_types&quot;:[{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f44d.png&quot;,&quot;name&quot;:&quot;+1&quot;},{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f64f.png&quot;,&quot;name&quot;:&quot;pray&quot;},{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f389.png&quot;,&quot;name&quot;:&quot;tada&quot;},{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f647.png&quot;,&quot;name&quot;:&quot;bow&quot;},{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f631.png&quot;,&quot;name&quot;:&quot;scream&quot;},{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f440.png&quot;,&quot;name&quot;:&quot;eyes&quot;}],&quot;reactions&quot;:[],&quot;team&quot;:null,&quot;team_membership&quot;:null,&quot;updatable&quot;:false,&quot;url&quot;:&quot;http://qiita.com/jiji_platform/items/268377c542706e6f44b1#comment-1d593bb5b853800bf128&quot;,&quot;user&quot;:{&quot;contribution&quot;:155,&quot;created_at&quot;:&quot;2015-05-06T12:49:55+09:00&quot;,&quot;id&quot;:77722,&quot;is_admin&quot;:false,&quot;profile_image_url&quot;:&quot;https://qiita-image-store.s3.amazonaws.com/0/77722/profile-images/1473700920&quot;,&quot;suspended&quot;:false,&quot;url_name&quot;:&quot;windows222&quot;},&quot;uuid&quot;:&quot;1d593bb5b853800bf128&quot;,&quot;via_email&quot;:false},{&quot;banned&quot;:false,&quot;body&quot;:&quot;\u003cp\u003e上記の問題は、下記コマンドを実行して、SELinuxを無効化することで解決しました。自己証明書を使ったときにのみ発生する問題で有る様です\u003cbr\u003e\n\u003ccode\u003esudo setenforce 0\u003c/code\u003e\u003c/p\u003e\n&quot;,&quot;created_at&quot;:&quot;2016-09-20T23:50:45+09:00&quot;,&quot;expanded_references&quot;:&quot;&quot;,&quot;id&quot;:639706,&quot;is_team&quot;:false,&quot;item_id&quot;:415694,&quot;item_type&quot;:&quot;PublicDomainArticle&quot;,&quot;item_uuid&quot;:&quot;268377c542706e6f44b1&quot;,&quot;likable&quot;:false,&quot;liked&quot;:false,&quot;public_likes_count&quot;:1,&quot;raw_body&quot;:&quot;上記の問題は、下記コマンドを実行して、SELinuxを無効化することで解決しました。自己証明書を使ったときにのみ発生する問題で有る様です\n``sudo setenforce 0 ``\n&quot;,&quot;reaction_types&quot;:[{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f44d.png&quot;,&quot;name&quot;:&quot;+1&quot;},{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f64f.png&quot;,&quot;name&quot;:&quot;pray&quot;},{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f389.png&quot;,&quot;name&quot;:&quot;tada&quot;},{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f647.png&quot;,&quot;name&quot;:&quot;bow&quot;},{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f631.png&quot;,&quot;name&quot;:&quot;scream&quot;},{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f440.png&quot;,&quot;name&quot;:&quot;eyes&quot;}],&quot;reactions&quot;:[],&quot;team&quot;:null,&quot;team_membership&quot;:null,&quot;updatable&quot;:false,&quot;url&quot;:&quot;http://qiita.com/jiji_platform/items/268377c542706e6f44b1#comment-74bb2e54d0fac7a760bb&quot;,&quot;user&quot;:{&quot;contribution&quot;:155,&quot;created_at&quot;:&quot;2015-05-06T12:49:55+09:00&quot;,&quot;id&quot;:77722,&quot;is_admin&quot;:false,&quot;profile_image_url&quot;:&quot;https://qiita-image-store.s3.amazonaws.com/0/77722/profile-images/1473700920&quot;,&quot;suspended&quot;:false,&quot;url_name&quot;:&quot;windows222&quot;},&quot;uuid&quot;:&quot;74bb2e54d0fac7a760bb&quot;,&quot;via_email&quot;:false},{&quot;banned&quot;:false,&quot;body&quot;:&quot;\u003cp\u003eなお、setenforceコマンドでは、disabledにはできません。\u003c/p\u003e\n\n\u003cp\u003e次回起動以降の有効／無効\u003cbr\u003e\n$ sudo gedit /etc/selinux/config\u003cbr\u003e\n以下の部分を変更します：\u003c/p\u003e\n\n\u003cp\u003eSELINUX=enforcing\u003c/p\u003e\n&quot;,&quot;created_at&quot;:&quot;2016-09-22T23:55:47+09:00&quot;,&quot;expanded_references&quot;:&quot;&quot;,&quot;id&quot;:640879,&quot;is_team&quot;:false,&quot;item_id&quot;:415694,&quot;item_type&quot;:&quot;PublicDomainArticle&quot;,&quot;item_uuid&quot;:&quot;268377c542706e6f44b1&quot;,&quot;likable&quot;:false,&quot;liked&quot;:false,&quot;public_likes_count&quot;:0,&quot;raw_body&quot;:&quot;なお、setenforceコマンドでは、disabledにはできません。\n\n次回起動以降の有効／無効\n$ sudo gedit /etc/selinux/config\n以下の部分を変更します：\n\nSELINUX=enforcing\n&quot;,&quot;reaction_types&quot;:[{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f44d.png&quot;,&quot;name&quot;:&quot;+1&quot;},{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f64f.png&quot;,&quot;name&quot;:&quot;pray&quot;},{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f389.png&quot;,&quot;name&quot;:&quot;tada&quot;},{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f647.png&quot;,&quot;name&quot;:&quot;bow&quot;},{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f631.png&quot;,&quot;name&quot;:&quot;scream&quot;},{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f440.png&quot;,&quot;name&quot;:&quot;eyes&quot;}],&quot;reactions&quot;:[],&quot;team&quot;:null,&quot;team_membership&quot;:null,&quot;updatable&quot;:false,&quot;url&quot;:&quot;http://qiita.com/jiji_platform/items/268377c542706e6f44b1#comment-452e897d5a8d74f7cae7&quot;,&quot;user&quot;:{&quot;contribution&quot;:155,&quot;created_at&quot;:&quot;2015-05-06T12:49:55+09:00&quot;,&quot;id&quot;:77722,&quot;is_admin&quot;:false,&quot;profile_image_url&quot;:&quot;https://qiita-image-store.s3.amazonaws.com/0/77722/profile-images/1473700920&quot;,&quot;suspended&quot;:false,&quot;url_name&quot;:&quot;windows222&quot;},&quot;uuid&quot;:&quot;452e897d5a8d74f7cae7&quot;,&quot;via_email&quot;:false},{&quot;banned&quot;:false,&quot;body&quot;:&quot;\u003cp\u003e一度はアクセスできたのですが、システムを再起動したら設定が全て消えてしまいました。dockerの設定だとも思うのですが、データを残しておくにはどうしたら良いでしょうか？\u003c/p\u003e\n&quot;,&quot;created_at&quot;:&quot;2016-09-23T00:03:42+09:00&quot;,&quot;expanded_references&quot;:&quot;&quot;,&quot;id&quot;:640882,&quot;is_team&quot;:false,&quot;item_id&quot;:415694,&quot;item_type&quot;:&quot;PublicDomainArticle&quot;,&quot;item_uuid&quot;:&quot;268377c542706e6f44b1&quot;,&quot;likable&quot;:false,&quot;liked&quot;:false,&quot;public_likes_count&quot;:0,&quot;raw_body&quot;:&quot;一度はアクセスできたのですが、システムを再起動したら設定が全て消えてしまいました。dockerの設定だとも思うのですが、データを残しておくにはどうしたら良いでしょうか？\n&quot;,&quot;reaction_types&quot;:[{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f44d.png&quot;,&quot;name&quot;:&quot;+1&quot;},{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f64f.png&quot;,&quot;name&quot;:&quot;pray&quot;},{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f389.png&quot;,&quot;name&quot;:&quot;tada&quot;},{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f647.png&quot;,&quot;name&quot;:&quot;bow&quot;},{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f631.png&quot;,&quot;name&quot;:&quot;scream&quot;},{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f440.png&quot;,&quot;name&quot;:&quot;eyes&quot;}],&quot;reactions&quot;:[],&quot;team&quot;:null,&quot;team_membership&quot;:null,&quot;updatable&quot;:false,&quot;url&quot;:&quot;http://qiita.com/jiji_platform/items/268377c542706e6f44b1#comment-afdc8b4747b86a46b364&quot;,&quot;user&quot;:{&quot;contribution&quot;:155,&quot;created_at&quot;:&quot;2015-05-06T12:49:55+09:00&quot;,&quot;id&quot;:77722,&quot;is_admin&quot;:false,&quot;profile_image_url&quot;:&quot;https://qiita-image-store.s3.amazonaws.com/0/77722/profile-images/1473700920&quot;,&quot;suspended&quot;:false,&quot;url_name&quot;:&quot;windows222&quot;},&quot;uuid&quot;:&quot;afdc8b4747b86a46b364&quot;,&quot;via_email&quot;:false},{&quot;banned&quot;:false,&quot;body&quot;:&quot;\u003cblockquote\u003e\n\u003cp\u003eSELinuxを無効化\u003c/p\u003e\n\u003c/blockquote\u003e\n\n\u003cp\u003eこちら、ホスト側の話でしょうか、それともゲスト側の話でしょうか?\u003cbr\u003e\nホスト側であればOSや環境(ローカルマシン/AWSなどのクラウド環境)の情報があれば、何かわかるかもしれません。\u003c/p\u003e\n&quot;,&quot;created_at&quot;:&quot;2016-09-23T08:03:49+09:00&quot;,&quot;expanded_references&quot;:&quot;&quot;,&quot;id&quot;:640913,&quot;is_team&quot;:false,&quot;item_id&quot;:415694,&quot;item_type&quot;:&quot;PublicDomainArticle&quot;,&quot;item_uuid&quot;:&quot;268377c542706e6f44b1&quot;,&quot;likable&quot;:false,&quot;liked&quot;:false,&quot;public_likes_count&quot;:0,&quot;raw_body&quot;:&quot;\u003e SELinuxを無効化\n\nこちら、ホスト側の話でしょうか、それともゲスト側の話でしょうか?\nホスト側であればOSや環境(ローカルマシン/AWSなどのクラウド環境)の情報があれば、何かわかるかもしれません。\n&quot;,&quot;reaction_types&quot;:[{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f44d.png&quot;,&quot;name&quot;:&quot;+1&quot;},{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f64f.png&quot;,&quot;name&quot;:&quot;pray&quot;},{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f389.png&quot;,&quot;name&quot;:&quot;tada&quot;},{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f647.png&quot;,&quot;name&quot;:&quot;bow&quot;},{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f631.png&quot;,&quot;name&quot;:&quot;scream&quot;},{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f440.png&quot;,&quot;name&quot;:&quot;eyes&quot;}],&quot;reactions&quot;:[],&quot;team&quot;:null,&quot;team_membership&quot;:null,&quot;updatable&quot;:false,&quot;url&quot;:&quot;http://qiita.com/jiji_platform/items/268377c542706e6f44b1#comment-ebfd9d5cda03740f5b8c&quot;,&quot;user&quot;:{&quot;contribution&quot;:894,&quot;created_at&quot;:&quot;2016-08-13T09:19:55+09:00&quot;,&quot;id&quot;:137010,&quot;is_admin&quot;:false,&quot;profile_image_url&quot;:&quot;https://qiita-image-store.s3.amazonaws.com/0/137010/profile-images/1473720139&quot;,&quot;suspended&quot;:false,&quot;url_name&quot;:&quot;jiji_platform&quot;},&quot;uuid&quot;:&quot;ebfd9d5cda03740f5b8c&quot;,&quot;via_email&quot;:false},{&quot;banned&quot;:false,&quot;body&quot;:&quot;\u003cp\u003e｜SELinuxを無効化\u003c/p\u003e\n\n\u003cp\u003eこちらはホスト側の話です。\u003cbr\u003e\n質問はSELinuxに関係なく、dockerを再起動した際にデータが残らない状況をなんとかしたいという点です。\u003c/p\u003e\n&quot;,&quot;created_at&quot;:&quot;2016-09-23T19:39:46+09:00&quot;,&quot;expanded_references&quot;:&quot;&quot;,&quot;id&quot;:641498,&quot;is_team&quot;:false,&quot;item_id&quot;:415694,&quot;item_type&quot;:&quot;PublicDomainArticle&quot;,&quot;item_uuid&quot;:&quot;268377c542706e6f44b1&quot;,&quot;likable&quot;:false,&quot;liked&quot;:false,&quot;public_likes_count&quot;:0,&quot;raw_body&quot;:&quot;｜SELinuxを無効化\n\nこちらはホスト側の話です。\n質問はSELinuxに関係なく、dockerを再起動した際にデータが残らない状況をなんとかしたいという点です。\n&quot;,&quot;reaction_types&quot;:[{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f44d.png&quot;,&quot;name&quot;:&quot;+1&quot;},{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f64f.png&quot;,&quot;name&quot;:&quot;pray&quot;},{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f389.png&quot;,&quot;name&quot;:&quot;tada&quot;},{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f647.png&quot;,&quot;name&quot;:&quot;bow&quot;},{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f631.png&quot;,&quot;name&quot;:&quot;scream&quot;},{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f440.png&quot;,&quot;name&quot;:&quot;eyes&quot;}],&quot;reactions&quot;:[],&quot;team&quot;:null,&quot;team_membership&quot;:null,&quot;updatable&quot;:false,&quot;url&quot;:&quot;http://qiita.com/jiji_platform/items/268377c542706e6f44b1#comment-850400cbb7d957ab19a9&quot;,&quot;user&quot;:{&quot;contribution&quot;:155,&quot;created_at&quot;:&quot;2015-05-06T12:49:55+09:00&quot;,&quot;id&quot;:77722,&quot;is_admin&quot;:false,&quot;profile_image_url&quot;:&quot;https://qiita-image-store.s3.amazonaws.com/0/77722/profile-images/1473700920&quot;,&quot;suspended&quot;:false,&quot;url_name&quot;:&quot;windows222&quot;},&quot;uuid&quot;:&quot;850400cbb7d957ab19a9&quot;,&quot;via_email&quot;:false},{&quot;banned&quot;:false,&quot;body&quot;:&quot;\u003cp\u003eJijiの設定データの話でしたか、失礼しました。\u003cbr\u003e\nJijiの設定や各種データはすべてMongoDBに格納しているので、こちらのデータがリセットされた可能性がありますね。チュートリアルの設定ではMongoDBコンテナ内に作成しているので、このコンテナを再作成するとデータはリセットされます。\u003cbr\u003e\n↓の手順に記載している \&quot;MongoDBデータの保存先\&quot; の変更を試してみてください。\u003cbr\u003e\n\u003ca href=\&quot;http://jiji2.unageanu.net/install/020300_install_server_to_docker.html\&quot; class=\&quot;autolink\&quot; rel=\&quot;nofollow noopener\&quot; target=\&quot;_blank\&quot;\u003ehttp://jiji2.unageanu.net/install/020300_install_server_to_docker.html\u003c/a\u003e\u003c/p\u003e\n&quot;,&quot;created_at&quot;:&quot;2016-09-23T19:54:17+09:00&quot;,&quot;expanded_references&quot;:&quot;&quot;,&quot;id&quot;:641515,&quot;is_team&quot;:false,&quot;item_id&quot;:415694,&quot;item_type&quot;:&quot;PublicDomainArticle&quot;,&quot;item_uuid&quot;:&quot;268377c542706e6f44b1&quot;,&quot;likable&quot;:false,&quot;liked&quot;:false,&quot;public_likes_count&quot;:1,&quot;raw_body&quot;:&quot;Jijiの設定データの話でしたか、失礼しました。\nJijiの設定や各種データはすべてMongoDBに格納しているので、こちらのデータがリセットされた可能性がありますね。チュートリアルの設定ではMongoDBコンテナ内に作成しているので、このコンテナを再作成するとデータはリセットされます。\n↓の手順に記載している \&quot;MongoDBデータの保存先\&quot; の変更を試してみてください。\nhttp://jiji2.unageanu.net/install/020300_install_server_to_docker.html\n&quot;,&quot;reaction_types&quot;:[{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f44d.png&quot;,&quot;name&quot;:&quot;+1&quot;},{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f64f.png&quot;,&quot;name&quot;:&quot;pray&quot;},{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f389.png&quot;,&quot;name&quot;:&quot;tada&quot;},{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f647.png&quot;,&quot;name&quot;:&quot;bow&quot;},{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f631.png&quot;,&quot;name&quot;:&quot;scream&quot;},{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f440.png&quot;,&quot;name&quot;:&quot;eyes&quot;}],&quot;reactions&quot;:[],&quot;team&quot;:null,&quot;team_membership&quot;:null,&quot;updatable&quot;:false,&quot;url&quot;:&quot;http://qiita.com/jiji_platform/items/268377c542706e6f44b1#comment-65d0f4f91a6f113ede15&quot;,&quot;user&quot;:{&quot;contribution&quot;:894,&quot;created_at&quot;:&quot;2016-08-13T09:19:55+09:00&quot;,&quot;id&quot;:137010,&quot;is_admin&quot;:false,&quot;profile_image_url&quot;:&quot;https://qiita-image-store.s3.amazonaws.com/0/137010/profile-images/1473720139&quot;,&quot;suspended&quot;:false,&quot;url_name&quot;:&quot;jiji_platform&quot;},&quot;uuid&quot;:&quot;65d0f4f91a6f113ede15&quot;,&quot;via_email&quot;:false},{&quot;banned&quot;:false,&quot;body&quot;:&quot;\u003cp\u003e興味深い記事ありがとうございます．\u003cbr\u003e\nトレーニングデータの収集について質問なのですが，python側から単純に，例えばある時刻から過去1時間分の値動き+各テクリカルのリストを取得するようなことは出来ないでしょうか？\u003cbr\u003e\nバックテストでランダムにトレードして，各トレードで過去1時間分のデータをデータベースに格納するのでもいいのですが．．．\u003c/p\u003e\n&quot;,&quot;created_at&quot;:&quot;2016-10-11T05:18:36+09:00&quot;,&quot;expanded_references&quot;:&quot;&quot;,&quot;id&quot;:653358,&quot;is_team&quot;:false,&quot;item_id&quot;:415694,&quot;item_type&quot;:&quot;PublicDomainArticle&quot;,&quot;item_uuid&quot;:&quot;268377c542706e6f44b1&quot;,&quot;likable&quot;:false,&quot;liked&quot;:false,&quot;public_likes_count&quot;:1,&quot;raw_body&quot;:&quot;興味深い記事ありがとうございます．\nトレーニングデータの収集について質問なのですが，python側から単純に，例えばある時刻から過去1時間分の値動き+各テクリカルのリストを取得するようなことは出来ないでしょうか？\nバックテストでランダムにトレードして，各トレードで過去1時間分のデータをデータベースに格納するのでもいいのですが．．．\n&quot;,&quot;reaction_types&quot;:[{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f44d.png&quot;,&quot;name&quot;:&quot;+1&quot;},{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f64f.png&quot;,&quot;name&quot;:&quot;pray&quot;},{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f389.png&quot;,&quot;name&quot;:&quot;tada&quot;},{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f647.png&quot;,&quot;name&quot;:&quot;bow&quot;},{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f631.png&quot;,&quot;name&quot;:&quot;scream&quot;},{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f440.png&quot;,&quot;name&quot;:&quot;eyes&quot;}],&quot;reactions&quot;:[],&quot;team&quot;:null,&quot;team_membership&quot;:null,&quot;updatable&quot;:false,&quot;url&quot;:&quot;http://qiita.com/jiji_platform/items/268377c542706e6f44b1#comment-e4c7150704af842ee76a&quot;,&quot;user&quot;:{&quot;contribution&quot;:164,&quot;created_at&quot;:&quot;2015-12-20T08:15:42+09:00&quot;,&quot;id&quot;:106352,&quot;is_admin&quot;:false,&quot;profile_image_url&quot;:&quot;https://qiita-image-store.s3.amazonaws.com/0/106352/profile-images/1473709905&quot;,&quot;suspended&quot;:false,&quot;url_name&quot;:&quot;ymfj&quot;},&quot;uuid&quot;:&quot;e4c7150704af842ee76a&quot;,&quot;via_email&quot;:false},{&quot;banned&quot;:false,&quot;body&quot;:&quot;\u003cblockquote\u003e\n\u003cp\u003eある時刻から過去1時間分の値動き+各テクリカルのリストを取得する\u003c/p\u003e\n\u003c/blockquote\u003e\n\n\u003cp\u003eぱっと思いつくやり方は、次の2つです。\u003c/p\u003e\n\n\u003col\u003e\n\u003cli\u003e↑のエージェントのロジックを変更して、トレードの有無にかかわらず、「過去1時間分の値動き+各テクリカルのリスト」を保存する形にする\n\n\u003cul\u003e\n\u003cli\u003eデータサイズが大きくなりそうなのが課題ですが・・・。\u003c/li\u003e\n\u003cli\u003e一時間ごとに保存するとかなら問題ないかと。\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003epython側から直接OANDA APIを呼び出して取得する\n\n\u003cul\u003e\n\u003cli\u003e\n\u003ca href=\&quot;https://github.com/oanda/oandapy\&quot; rel=\&quot;nofollow noopener\&quot; target=\&quot;_blank\&quot;\u003eoandapy\u003c/a\u003e 等を利用すれば比較的簡単に実現できるかと思います。\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n&quot;,&quot;created_at&quot;:&quot;2016-10-11T07:27:10+09:00&quot;,&quot;expanded_references&quot;:&quot;&quot;,&quot;id&quot;:653366,&quot;is_team&quot;:false,&quot;item_id&quot;:415694,&quot;item_type&quot;:&quot;PublicDomainArticle&quot;,&quot;item_uuid&quot;:&quot;268377c542706e6f44b1&quot;,&quot;likable&quot;:false,&quot;liked&quot;:false,&quot;public_likes_count&quot;:0,&quot;raw_body&quot;:&quot;\u003e ある時刻から過去1時間分の値動き+各テクリカルのリストを取得する\n\nぱっと思いつくやり方は、次の2つです。\n\n1. ↑のエージェントのロジックを変更して、トレードの有無にかかわらず、「過去1時間分の値動き+各テクリカルのリスト」を保存する形にする\n   - データサイズが大きくなりそうなのが課題ですが・・・。\n   - 一時間ごとに保存するとかなら問題ないかと。\n2. python側から直接OANDA APIを呼び出して取得する\n   - [oandapy](https://github.com/oanda/oandapy) 等を利用すれば比較的簡単に実現できるかと思います。\n\n&quot;,&quot;reaction_types&quot;:[{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f44d.png&quot;,&quot;name&quot;:&quot;+1&quot;},{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f64f.png&quot;,&quot;name&quot;:&quot;pray&quot;},{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f389.png&quot;,&quot;name&quot;:&quot;tada&quot;},{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f647.png&quot;,&quot;name&quot;:&quot;bow&quot;},{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f631.png&quot;,&quot;name&quot;:&quot;scream&quot;},{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f440.png&quot;,&quot;name&quot;:&quot;eyes&quot;}],&quot;reactions&quot;:[],&quot;team&quot;:null,&quot;team_membership&quot;:null,&quot;updatable&quot;:false,&quot;url&quot;:&quot;http://qiita.com/jiji_platform/items/268377c542706e6f44b1#comment-7c683eeca1a32083a532&quot;,&quot;user&quot;:{&quot;contribution&quot;:894,&quot;created_at&quot;:&quot;2016-08-13T09:19:55+09:00&quot;,&quot;id&quot;:137010,&quot;is_admin&quot;:false,&quot;profile_image_url&quot;:&quot;https://qiita-image-store.s3.amazonaws.com/0/137010/profile-images/1473720139&quot;,&quot;suspended&quot;:false,&quot;url_name&quot;:&quot;jiji_platform&quot;},&quot;uuid&quot;:&quot;7c683eeca1a32083a532&quot;,&quot;via_email&quot;:false},{&quot;banned&quot;:false,&quot;body&quot;:&quot;\u003cp\u003eなるほど，ありがとうございます．\u003cbr\u003e\nまずは少しruby触ってみることにします．\u003c/p\u003e\n&quot;,&quot;created_at&quot;:&quot;2016-10-11T21:54:31+09:00&quot;,&quot;expanded_references&quot;:&quot;&quot;,&quot;id&quot;:654070,&quot;is_team&quot;:false,&quot;item_id&quot;:415694,&quot;item_type&quot;:&quot;PublicDomainArticle&quot;,&quot;item_uuid&quot;:&quot;268377c542706e6f44b1&quot;,&quot;likable&quot;:false,&quot;liked&quot;:false,&quot;public_likes_count&quot;:0,&quot;raw_body&quot;:&quot;なるほど，ありがとうございます．\nまずは少しruby触ってみることにします．\n&quot;,&quot;reaction_types&quot;:[{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f44d.png&quot;,&quot;name&quot;:&quot;+1&quot;},{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f64f.png&quot;,&quot;name&quot;:&quot;pray&quot;},{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f389.png&quot;,&quot;name&quot;:&quot;tada&quot;},{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f647.png&quot;,&quot;name&quot;:&quot;bow&quot;},{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f631.png&quot;,&quot;name&quot;:&quot;scream&quot;},{&quot;image_url&quot;:&quot;https://cdn.qiita.com/emoji/twemoji/unicode/1f440.png&quot;,&quot;name&quot;:&quot;eyes&quot;}],&quot;reactions&quot;:[],&quot;team&quot;:null,&quot;team_membership&quot;:null,&quot;updatable&quot;:false,&quot;url&quot;:&quot;http://qiita.com/jiji_platform/items/268377c542706e6f44b1#comment-57fa651b638deccd68d0&quot;,&quot;user&quot;:{&quot;contribution&quot;:164,&quot;created_at&quot;:&quot;2015-12-20T08:15:42+09:00&quot;,&quot;id&quot;:106352,&quot;is_admin&quot;:false,&quot;profile_image_url&quot;:&quot;https://qiita-image-store.s3.amazonaws.com/0/106352/profile-images/1473709905&quot;,&quot;suspended&quot;:false,&quot;url_name&quot;:&quot;ymfj&quot;},&quot;uuid&quot;:&quot;57fa651b638deccd68d0&quot;,&quot;via_email&quot;:false}],&quot;monthly_public_image_uploadable_size_limit&quot;:null,&quot;total_uploaded_public_image_size_in_current_month&quot;:null,&quot;item&quot;:{&quot;id&quot;:415694,&quot;uuid&quot;:&quot;268377c542706e6f44b1&quot;,&quot;suspended&quot;:false,&quot;secret&quot;:false},&quot;owner&quot;:{&quot;url_name&quot;:&quot;jiji_platform&quot;},&quot;is_team&quot;:false,&quot;is_project&quot;:false,&quot;logged_in&quot;:false,&quot;polling&quot;:false,&quot;mention_candidates&quot;:[{&quot;id&quot;:137010,&quot;url_name&quot;:&quot;jiji_platform&quot;,&quot;profile_image_url&quot;:&quot;https://qiita-image-store.s3.amazonaws.com/0/137010/profile-images/1473720139&quot;},{&quot;id&quot;:77722,&quot;url_name&quot;:&quot;windows222&quot;,&quot;profile_image_url&quot;:&quot;https://qiita-image-store.s3.amazonaws.com/0/77722/profile-images/1473700920&quot;},{&quot;id&quot;:103267,&quot;url_name&quot;:&quot;k501&quot;,&quot;profile_image_url&quot;:&quot;https://qiita-image-store.s3.amazonaws.com/0/103267/profile-images/1473708960&quot;},{&quot;id&quot;:111231,&quot;url_name&quot;:&quot;tanizya&quot;,&quot;profile_image_url&quot;:&quot;https://qiita-image-store.s3.amazonaws.com/0/111231/profile-images/1473711493&quot;},{&quot;id&quot;:106352,&quot;url_name&quot;:&quot;ymfj&quot;,&quot;profile_image_url&quot;:&quot;https://qiita-image-store.s3.amazonaws.com/0/106352/profile-images/1473709905&quot;}]}" data-trace="false" data-dom-id="CommentListContainer-react-component-30da15d1-3e1f-4e12-9963-dc2e1a6cc54f"></div>
    <div id="CommentListContainer-react-component-30da15d1-3e1f-4e12-9963-dc2e1a6cc54f"></div>
    
</div></div></div></div></article><div class="js-report-form modal fade reportForm"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><button name="button" type="submit" class="close" data-dismiss="modal">&times;</button><h4 class="modal-title">Report article</h4></div><div class="modal-body"><form action="/reports" accept-charset="UTF-8" method="post"><input name="utf8" type="hidden" value="&#x2713;" /><input type="hidden" name="authenticity_token" value="38eZFWuyKRtRy7BwcxS15WTtJnW7uy0ZwkGPyfYC3JqA9pADYgdGSiG21Pqa0U1xKBjT3rJ3+aCsoXoaEupftA==" /><input type="hidden" name="redirect_path" id="redirect_path" value="/jiji_platform/items/268377c542706e6f44b1" /><input type="hidden" name="item_uuid" id="item_uuid" value="268377c542706e6f44b1" /><p>Help us understand the problem. What is going on with this item?</p><br /><div class="form-group"><ul class="list-unstyled"><li><label><input type="radio" name="report_type" id="report_type_spam" value="spam" required="required" /> It&#39;s spam </label></li><li><label><input type="radio" name="report_type" id="report_type_harassment" value="harassment" required="required" /> It&#39;s abusive or harmful </label></li><li><label><input type="radio" name="report_type" id="report_type_inappropriate_content" value="inappropriate_content" required="required" /> It contains inappropriate content </label></li></ul></div><div class="reportForm_submitButtonContainer"><button name="button" type="submit" class="btn btn-primary reportForm_submitButton"><i class="fa fa-send"></i> Submit</button></div></form></div></div></div></div><script id="js-item" type="application/json">{ "url": "http://qiita.com/jiji_platform/items/268377c542706e6f44b1", "id": 415694, "uuid": "268377c542706e6f44b1" }</script><script class="js-user" type="application/json">{&quot;id&quot;:137010,&quot;url_name&quot;:&quot;jiji_platform&quot;,&quot;profile_image_url&quot;:&quot;https://qiita-image-store.s3.amazonaws.com/0/137010/profile-images/1473720139&quot;}</script><script language="JavaScript" src="//cdn.bigmining.com/private/js/qiita_bigmining.js" type="text/javascript"></script></div><footer class="footer"><div class="footer_inner"><div class="footer_container"><ul class="footer_links-left"><li class="footer_link"><a class="footer_copyright" href="http://increments.co.jp">© 2011-2017 Increments Inc.</a></li><li class="footer_link"><a href="http://qiita.com/terms">Terms</a></li><li class="footer_link"><a href="http://qiita.com/privacy">Privacy</a></li><li class="footer_link"><a href="http://help.qiita.com">Help</a></li><li class="footer_link"><a href="https://increments.zendesk.com/anonymous_requests/new">Contact</a></li></ul><ul class="footer_links-right"><li class="footer_link"><a href="http://qiita.com/about">About</a></li><li class="footer_link"><a href="/users">Users</a></li><li class="footer_link"><a href="/tags">Tags</a></li><li class="footer_link"><a href="http://blog.qiita.com">Blog</a></li><li class="footer_link"><a href="http://qiita.com/api/v2/docs">API</a></li><li class="footer_link"><a href="https://teams.qiita.com/">Team</a></li><li class="footer_link"><a href="http://kobito.qiita.com">Kobito</a></li><li class="footer_link"><a class="js-public-form-feedback-link" data-target=".js-feedback-form" data-toggle="modal" href=""><i class="fa fa-heart"></i> Feedback <i class="fa fa-caret-down"></i></a></li></ul></div></div></footer><div class="js-feedback-form modal fade feedbackForm"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><button name="button" type="submit" class="close" data-dismiss="modal">&times;</button><h4 class="modal-title">Feedback</h4></div><div class="modal-body"><form class="js-feedback-form-form" action="/feedbacks" accept-charset="UTF-8" method="post"><input name="utf8" type="hidden" value="&#x2713;" /><input type="hidden" name="authenticity_token" value="OVmAUoXybgkBJ0G2HgoyXAPBOi+EumShTZSZvGcWJIJmaIlEjEcBWHFaJTz3z8rITzTPhI12sBgjdGxvg/6nrA==" /><input type="hidden" name="redirect_path" id="redirect_path" value="/jiji_platform/items/268377c542706e6f44b1" /><div class="form-group"><textarea name="feedback[message]" id="feedback_message" class="form-control js-feedback-form-text-area" placeholder="Please give us any feedback about Qiita." required="required" rows="5">
</textarea></div><div class="feedbackForm_submitButtonContainer"><button name="button" type="submit" class="btn btn-primary feedbackForm_submitButton"><i class="fa fa-send"></i> Submit</button><p class="feedbackForm_note">We don&#39;t reply to any feedback.<br />If you need help with Qiita, please send a support request from <a href="https://increments.zendesk.com/anonymous_requests/new">here</a>.</p></div><div style="position:fixed;top:-99999px;opacity:0.0001;"><input name="feedback[name]" type="text" /></div></form></div></div></div></div><script>// if (window.mixpanel instanceof Element) {
//   window.mixpanel = [];
// }
// (function(f,b){if(!b.__SV){var a,e,i,g;window.mixpanel=b;b._i=[];b.init=function(a,e,d){function f(b,h){var a=h.split(".");2==a.length&&(b=b[a[0]],h=a[1]);b[h]=function(){b.push([h].concat(Array.prototype.slice.call(arguments,0)))}}var c=b;"undefined"!==typeof d?c=b[d]=[]:d="mixpanel";c.people=c.people||[];c.toString=function(b){var a="mixpanel";"mixpanel"!==d&&(a+="."+d);b||(a+=" (stub)");return a};c.people.toString=function(){return c.toString(1)+".people (stub)"};i="disable track track_pageview track_links track_forms register register_once alias unregister identify name_tag set_config people.set people.set_once people.increment people.append people.track_charge people.clear_charges people.delete_user".split(" ");
// for(g=0;g<i.length;g++)f(c,i[g]);b._i.push([a,e,d])};b.__SV=1.2;a=f.createElement("script");a.type="text/javascript";a.async=!0;a.src="//cdn.mxpnl.com/libs/mixpanel-2.2.min.js";e=f.getElementsByTagName("script")[0];e.parentNode.insertBefore(a,e)}})(document,window.mixpanel||[]);</script><script src="http://cdn.qiita.com/assets/public-3af9c1d29a49f3320bb796fb5e75304b.min.js"></script><script>
  (function () {
    var script = document.getElementsByTagName('script')[0];
    var load = function (src, id) {
      var el = document.createElement('script');
      el.async = true;
      el.src = src;
      el.id = id;
      script.parentNode.insertBefore(el, script);
    };
      // Optimizely
      load('//cdn.optimizely.com/js/52738645.js', 'optimizely-jssdk');
      // Google Analytics
      window._gaq = window._gaq || [];
      var isCareer = location.hostname.split('.')[0] == 'career';
      if (isCareer) {
        window._gaq.push(['_setAccount', 'UA-24675221-11']);
        window._gaq.push(['_setDomainName', 'qiita.com']);
      } else {
        window._gaq.push(['_setAccount', 'UA-24675221-1']);
      }
      window._gaq.push(['_setCustomVar', 1, 'logged_in', 'false', 2]);
      window._gaq.push(['_trackPageview']);
      var src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      load(src, 'google-analytics-jssdk');
    // Google Analytics - Universal Analytics
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-24675221-12', {
          
        });
          ga('create', 'UA-1267704-19', { name: 'user' });
          ga('user.send', 'pageview');
        ga('set', 'dimension1', 'false');
        ga('set', 'dimension3', 'false');
      ga('require', 'displayfeatures');
      ga('set', 'forceSSL', true);
      ga('send', 'pageview');
    // Google Tag Manager
      (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
      new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
      })(window,document,'script','dataLayer','GTM-TBQWPN');
  })();
</script>
</body></html>